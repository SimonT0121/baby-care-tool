<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#8ecae6">
    <meta name="description" content="嬰幼兒照顧輔助工具 - 輕鬆記錄寶寶的成長與日常照顧">
    <title>嬰幼兒照顧輔助工具</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary-color: #8ecae6;
            --primary-color-dark: #219ebc;
            --secondary-color: #219ebc;
            --accent-color: #ffb703;
            --danger-color: #e76f51;
            --success-color: #52b788;
            --neutral-color: #f8f9fa;
            --text-color: #444444;
            --light-text: #6c757d;
            --border-radius: 10px;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            
            /* 新增的變數 */
            --background-color: #f0f5f9;
            --card-bg-color: #ffffff;
            --border-color: #dee2e6;
            --input-bg-color: #ffffff;
            --input-border-color: #ced4da;
            --header-height: 60px;
            --bottom-nav-height: 65px;
        }

        /* 深色模式 */
        body.dark-mode {
            --primary-color: #3d85a7;
            --primary-color-dark: #2a6075;
            --secondary-color: #1a7999;
            --accent-color: #e09600;
            --danger-color: #c55a42;
            --success-color: #3c8461;
            --neutral-color: #2c2c2c;
            --text-color: #e0e0e0;
            --light-text: #a0a0a0;
            --background-color: #121212;
            --card-bg-color: #1e1e1e;
            --border-color: #333333;
            --input-bg-color: #2c2c2c;
            --input-border-color: #444444;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            -webkit-tap-highlight-color: transparent; /* 移除移動端點擊高亮 */
        }

        html, body {
            height: 100%;
            width: 100%;
            overscroll-behavior: none; /* 防止過度滾動 */
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        h1, h2, h3, h4, h5, h6 {
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            padding-bottom: calc(var(--bottom-nav-height) + 1rem);
        }

        /* 頂部標題區域 */
        header {
            background-color: var(--card-bg-color);
            padding: 1rem;
            box-shadow: var(--shadow);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            position: sticky;
            top: 0;
            z-index: 900;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .header-title {
            display: flex;
            align-items: center;
        }

        #appLogo {
            font-size: 24px;
            margin-right: 10px;
            color: var(--accent-color);
            transition: color 0.3s ease;
        }

        .header-title h1 {
            font-size: 1.5rem;
            margin: 0;
            color: var(--secondary-color);
            transition: color 0.3s ease;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .child-selector {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .child-selector select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--input-bg-color);
            color: var(--text-color);
            min-width: 120px;
            transition: all 0.3s ease;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            min-height: 38px;
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-color-dark);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #429e76;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c85a3f;
        }

        .btn-accent {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-accent:hover {
            background-color: #e29000;
        }

        .btn-icon {
            width: 38px;
            height: 38px;
            padding: 0;
            border-radius: 50%;
            background-color: var(--neutral-color);
            color: var(--text-color);
        }

        .btn-icon:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.85rem;
            min-height: 32px;
        }

        /* 快速記錄區域 */
        .quick-record-container {
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .quick-record-container h3 {
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .quick-record-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .quick-record-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background-color: var(--accent-color);
            color: white;
        }

        .quick-add-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background-color: var(--neutral-color);
            color: var(--text-color);
        }

        /* 導航欄 */
        .nav-tabs {
            display: flex;
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            overflow: hidden;
            box-shadow: var(--shadow);
            position: sticky;
            top: calc(var(--header-height) + 10px);
            z-index: 800;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .nav-tab {
            flex: 1;
            padding: 1rem 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--light-text);
            border-bottom: 3px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.9rem;
            user-select: none;
        }

        .nav-tab i {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .nav-tab.active {
            color: var(--secondary-color);
            border-bottom: 3px solid var(--secondary-color);
            background-color: rgba(33, 158, 188, 0.1);
        }

        .nav-tab:hover:not(.active) {
            background-color: var(--neutral-color);
        }

        /* 內容區塊 */
        .tab-content {
            display: none;
            background-color: var(--card-bg-color);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            animation: fadeIn 0.3s ease;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        /* 表單樣式 */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
            transition: color 0.3s ease;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--input-border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            background-color: var(--input-bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(142, 202, 230, 0.3);
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }

        .form-col {
            flex: 1;
            padding: 0 10px;
            min-width: 250px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        /* 輸入框特殊樣式 */
        .input-with-voice {
            display: flex;
            position: relative;
        }

        .input-with-voice .form-control {
            flex: 1;
            padding-right: 40px;
        }

        .input-with-voice .voice-input-btn {
            position: absolute;
            right: 0;
            top: 0;
            background: none;
            border: none;
            color: var(--light-text);
            padding: 8px;
            cursor: pointer;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input-with-voice .voice-input-btn:hover {
            color: var(--primary-color);
        }

        .input-with-voice .voice-input-btn.recording {
            color: var(--danger-color);
            animation: pulse 1.5s infinite;
        }

        .input-with-unit {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .input-with-unit .form-control {
            flex: 1;
        }

        .input-with-unit .unit-select {
            width: 80px;
            flex-shrink: 0;
        }

        .now-btn {
            position: absolute;
            right: 0;
            height: 100%;
            color: var(--light-text);
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }

        /* 記錄類型選擇 */
        .record-type-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 1.5rem;
        }

        .record-type-btn {
            flex: 1;
            min-width: 90px;
            padding: 15px 10px;
            text-align: center;
            background-color: var(--neutral-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none;
            color: var(--text-color);
        }

        .record-type-btn i {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .record-type-btn.active, .record-type-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* 卡片樣式 */
        .card {
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            transition: border-color 0.3s ease;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--secondary-color);
            transition: color 0.3s ease;
        }

        .card-body {
            padding: 1rem;
        }

        /* 底部導航欄 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--card-bg-color);
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .bottom-nav-item {
            flex: 1;
            text-align: center;
            padding: 10px 5px;
            font-size: 0.8rem;
            color: var(--light-text);
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
        }

        .bottom-nav-item i {
            display: block;
            font-size: 1.3rem;
            margin-bottom: 4px;
        }

        .bottom-nav-item.active {
            color: var(--secondary-color);
            background-color: rgba(33, 158, 188, 0.1);
        }

        /* 模態框樣式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.active {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: border-color 0.3s ease;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--light-text);
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: var(--danger-color);
        }

        .modal-body {
            padding: 1rem;
        }

        .modal-footer {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            transition: border-color 0.3s ease;
        }

        /* 評分系統 */
        .rating {
            display: flex;
            gap: 8px;
            margin: 10px 0;
        }

        .rating-star {
            cursor: pointer;
            font-size: 1.8rem;
            color: #ddd;
            transition: color 0.3s ease;
        }

        .rating-star.active {
            color: var(--accent-color);
        }

        /* 歷史記錄樣式 */
        .history-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 10px;
        }

        .history-date-selector {
            flex: 1;
            min-width: 150px;
        }

        .history-filter {
            flex: 1;
            min-width: 150px;
        }

        .history-day {
            margin-bottom: 1.5rem;
        }

        .history-day-header {
            background-color: var(--neutral-color);
            padding: 10px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        .history-records {
            margin-left: 10px;
        }

        .history-record {
            display: flex;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: var(--border-radius);
            margin-bottom: 5px;
        }

        .history-record:hover {
            background-color: var(--neutral-color);
        }

        .history-record:last-child {
            border-bottom: none;
        }

        .history-record-time {
            min-width: 60px;
            color: var(--light-text);
        }

        .history-record-type {
            min-width: 110px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-record-info {
            flex: 1;
        }

        /* 記錄類型特定樣式 */
        .record-color-feeding {
            border-left: 4px solid #8ecae6;
        }

        .record-color-sleep {
            border-left: 4px solid #9381ff;
        }

        .record-color-diaper {
            border-left: 4px solid #ffb703;
        }

        .record-color-emotion {
            border-left: 4px solid #e76f51;
        }

        .record-color-activity {
            border-left: 4px solid #52b788;
        }

        .record-color-other {
            border-left: 4px solid #6c757d;
        }

        /* 記錄圖標 */
        .record-icon {
            display: inline-flex;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        .record-icon-feeding {
            background-color: #8ecae6;
        }

        .record-icon-sleep {
            background-color: #9381ff;
        }

        .record-icon-diaper {
            background-color: #ffb703;
        }

        .record-icon-emotion {
            background-color: #e76f51;
        }

        .record-icon-activity {
            background-color: #52b788;
        }

        .record-icon-other {
            background-color: #6c757d;
        }

        /* 統計圖表樣式 */
        .stats-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stats-period-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .stats-period-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--card-bg-color);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stats-period-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .stats-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .chart-container {
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            box-shadow: var(--shadow);
            min-height: 300px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        /* 開關按鈕 */
        .toggle-switch {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .toggle-switch input {
            display: none;
        }

        .toggle-slider {
            position: relative;
            width: 50px;
            height: 24px;
            background-color: #ccc;
            border-radius: 24px;
            margin-right: 10px;
            transition: background-color 0.3s ease;
        }

        .toggle-slider:before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            left: 2px;
            top: 2px;
            background-color: white;
            transition: 0.3s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--success-color);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .toggle-label {
            color: var(--text-color);
            transition: color 0.3s ease;
        }

        /* 記錄列表 */
        .records-list {
            margin-top: 1rem;
        }

        .record-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        .record-item:hover {
            background-color: var(--neutral-color);
        }

        .record-item-content {
            flex: 1;
        }

        .record-item-title {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .record-item-subtitle {
            font-size: 0.9rem;
            color: var(--light-text);
        }

        .record-item-actions {
            display: flex;
            gap: 8px;
        }

        /* 吐司提示 */
        .toast {
            position: fixed;
            bottom: calc(var(--bottom-nav-height) + 20px);
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            z-index: 3000;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            pointer-events: none;
        }

        .toast.active {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast-icon {
            font-size: 1.2rem;
            color: var(--success-color);
        }

        .toast-message {
            font-size: 0.95rem;
        }

        /* 核取方塊樣式 */
        .checkbox-group {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .checkbox-label input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }

        /* 按鈕組 */
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        /* 兒童資訊卡片 */
        .child-info-card {
            background-color: var(--neutral-color);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            transition: background-color 0.3s ease;
        }

        .child-info-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--secondary-color);
        }

        .child-info-details {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 5px;
        }

        .child-info-note {
            font-size: 0.9rem;
            color: var(--light-text);
            margin-top: 10px;
            border-top: 1px solid var(--border-color);
            padding-top: 10px;
        }

        /* 動畫效果 */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        /* 特殊樣式輔助類 */
        .text-center {
            text-align: center;
        }

        .text-danger {
            color: var(--danger-color);
        }

        .mb-0 {
            margin-bottom: 0;
        }

        .mt-1 {
            margin-top: 0.5rem;
        }

        .mt-2 {
            margin-top: 1rem;
        }

        /* 深色模式特定樣式優化 */
        body.dark-mode .chart-container canvas {
            filter: invert(0.9) hue-rotate(180deg);
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .container {
                padding: 0.7rem;
            }
            
            .header-title h1 {
                font-size: 1.2rem;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .form-col {
                width: 100%;
                padding: 0;
                margin-bottom: 1rem;
            }
            
            .nav-tabs {
                display: none;
            }
            
            .bottom-nav {
                display: flex;
                height: var(--bottom-nav-height);
            }
            
            .record-type-btn {
                min-height: 80px;
                padding: 10px;
            }
            
            .btn {
                min-height: 44px;
            }
            
            .form-control {
                font-size: 16px; /* 避免iOS上的縮放 */
                padding: 12px;
            }
            
            /* 增大觸控區域 */
            .rating-star {
                font-size: 2rem;
                padding: 5px;
            }
            
            .checkbox-label {
                min-height: 44px;
                display: flex;
                align-items: center;
            }
            
            .checkbox-label input[type="checkbox"] {
                transform: scale(1.3);
                margin-right: 10px;
            }
            
            .modal-content {
                width: 95%;
            }
            
            /* 加強導航和按鈕可點擊區域 */
            .bottom-nav-item {
                min-height: 50px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }
            
            .bottom-nav-item i {
                font-size: 1.5rem;
            }
        }

        @media (min-width: 769px) {
            .bottom-nav {
                display: none;
            }
            
            /* 在桌面版顯示按鈕文字 */
            .btn .btn-text {
                display: inline;
            }
            
            /* 控制表單寬度 */
            .form-row {
                display: flex;
            }
        }

        /* Safari 修復 */
        @supports (-webkit-touch-callout: none) {
            .form-control, select, textarea {
                font-size: 16px; /* 修復iOS Safari上的縮放 */
            }
            
            body {
                -webkit-overflow-scrolling: touch; /* 平滑滾動 */
            }
        }

        /* 新增的改進樣式 */
        /* 淡入淡出動畫效果 */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        /* 新記錄高亮效果 */
        .new-record {
            animation: highlight 1.5s ease;
        }

        @keyframes highlight {
            0% {
                background-color: rgba(142, 202, 230, 0.3);
            }
            100% {
                background-color: transparent;
            }
        }

        /* 更大的觸控區域 */
        .record-item, .milestone-item, .btn {
            min-height: 44px; /* iOS建議的最小觸控高度 */
        }

        .history-record {
            padding: 15px 10px;
            transition: all 0.2s ease;
        }

        .history-record:active {
            transform: scale(0.98);
            background-color: var(--neutral-color);
        }

        /* 改進深色模式下的顏色 */
        body.dark-mode {
            --primary-color-dark: #1a7999;
            --accent-color: #d68c00;
        }

        body.dark-mode .chart-container {
            background-color: #252525;
        }

        /* 提升無障礙性 */
        .btn:focus, input:focus, select:focus, textarea:focus {
            outline: 3px solid rgba(33, 158, 188, 0.5);
        }

        /* 為大型屏幕優化統計視圖 */
        @media (min-width: 1200px) {
            .stats-charts {
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            }
        }
        
        /* 歷史記錄載入中指示器 */
        .history-records-placeholder {
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--light-text);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 頂部標題區域 -->
        <header>
            <div class="header-title">
                <i class="fas fa-baby" id="appLogo"></i>
                <h1>嬰幼兒照顧輔助工具</h1>
            </div>
            <div class="header-actions">
                <button id="darkModeToggle" class="btn btn-icon" title="切換深色模式">
                    <i class="fas fa-moon"></i>
                </button>
                <div class="child-selector">
                    <select id="childSelect">
                        <option value="">選擇兒童</option>
                    </select>
                    <button id="addChildBtn" class="btn btn-primary">
                        <i class="fas fa-plus"></i> <span class="btn-text">新增</span>
                    </button>
                    <button id="deleteChildBtn" class="btn btn-danger">
                        <i class="fas fa-trash"></i> <span class="btn-text">刪除</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- 快速記錄區域 -->
        <div id="quickRecordContainer" class="quick-record-container" style="display: none;">
            <h3>快速記錄</h3>
            <div id="quickRecordButtons" class="quick-record-buttons">
                <!-- 快速記錄按鈕將動態生成 -->
            </div>
        </div>

        <!-- 頂部導航欄 -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="record">
                <i class="fas fa-pen"></i>
                <span>記錄</span>
            </div>
            <div class="nav-tab" data-tab="history">
                <i class="fas fa-history"></i>
                <span>歷史</span>
            </div>
            <div class="nav-tab" data-tab="milestone">
                <i class="fas fa-flag"></i>
                <span>里程碑</span>
            </div>
            <div class="nav-tab" data-tab="growth">
                <i class="fas fa-chart-line"></i>
                <span>成長</span>
            </div>
            <div class="nav-tab" data-tab="stats">
                <i class="fas fa-chart-bar"></i>
                <span>統計</span>
            </div>
            <div class="nav-tab" data-tab="export">
                <i class="fas fa-file-export"></i>
                <span>匯出</span>
            </div>
        </div>

        <!-- 內容區域 -->
        <div id="recordTab" class="tab-content active">
            <h2>新增記錄</h2>
            <p id="currentChildInfo">請先選擇或新增一位兒童</p>

            <div class="record-type-selector">
                <div class="record-type-btn active" data-record-type="feeding">
                    <i class="fas fa-utensils"></i>
                    <span>餵食</span>
                </div>
                <div class="record-type-btn" data-record-type="sleep">
                    <i class="fas fa-bed"></i>
                    <span>睡眠</span>
                </div>
                <div class="record-type-btn" data-record-type="diaper">
                    <i class="fas fa-baby"></i>
                    <span>尿布</span>
                </div>
                <div class="record-type-btn" data-record-type="emotion">
                    <i class="fas fa-smile"></i>
                    <span>情緒</span>
                </div>
                <div class="record-type-btn" data-record-type="activity">
                    <i class="fas fa-walking"></i>
                    <span>活動</span>
                </div>
                <div class="record-type-btn" data-record-type="other">
                    <i class="fas fa-plus-circle"></i>
                    <span>其他</span>
                </div>
            </div>

            <!-- 餵食記錄表單 -->
            <div id="feedingForm" class="record-form active">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="feedingType">餵食類型</label>
                            <div class="input-with-voice">
                                <select id="feedingType" class="form-control">
                                    <option value="母乳">母乳</option>
                                    <option value="配方奶">配方奶</option>
                                    <option value="副食品">副食品</option>
                                    <option value="水果">水果</option>
                                    <option value="水/飲料">水/飲料</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="feedingAmount">數量/時間</label>
                            <div class="input-with-unit">
                                <input type="number" id="feedingAmount" class="form-control" inputmode="decimal">
                                <select id="feedingUnit" class="form-control unit-select">
                                    <option value="ml">毫升</option>
                                    <option value="min">分鐘</option>
                                    <option value="份">份</option>
                                    <option value="湯匙">湯匙</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="feedingTime">時間</label>
                            <div class="input-with-voice">
                                <input type="datetime-local" id="feedingTime" class="form-control">
                                <button type="button" class="btn btn-icon now-btn" title="設為現在時間" onclick="setCurrentTime('feedingTime')">
                                    <i class="fas fa-clock"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="feedingNote">備註</label>
                            <div class="input-with-voice">
                                <textarea id="feedingNote" class="form-control" rows="3"></textarea>
                                <button type="button" class="btn btn-icon voice-input-btn" title="語音輸入" data-target="feedingNote">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button id="saveFeedingBtn" class="btn btn-primary">
                        <i class="fas fa-save"></i> 儲存記錄
                    </button>
                    <button id="saveAsFeedingTemplateBtn" class="btn btn-accent">
                        <i class="fas fa-bookmark"></i> 儲存為模板
                    </button>
                </div>
            </div>

            <!-- 睡眠記錄表單 -->
            <div id="sleepForm" class="record-form" style="display: none;">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="sleepStart">開始時間</label>
                            <div class="input-with-voice">
                                <input type="datetime-local" id="sleepStart" class="form-control">
                                <button type="button" class="btn btn-icon now-btn" title="設為現在時間" onclick="setCurrentTime('sleepStart')">
                                    <i class="fas fa-clock"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="sleepEnd">結束時間</label>
                            <div class="input-with-voice">
                                <input type="datetime-local" id="sleepEnd" class="form-control">
                                <button type="button" class="btn btn-icon now-btn" title="設為現在時間" onclick="setCurrentTime('sleepEnd')">
                                    <i class="fas fa-clock"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="sleepQuality">睡眠品質 (1-5分)</label>
                            <div class="rating" id="sleepQualityRating">
                                <span class="rating-star" data-value="1"><i class="fas fa-star"></i></span>
                                <span class="rating-star" data-value="2"><i class="fas fa-star"></i></span>
                                <span class="rating-star" data-value="3"><i class="fas fa-star"></i></span>
                                <span class="rating-star" data-value="4"><i class="fas fa-star"></i></span>
                                <span class="rating-star" data-value="5"><i class="fas fa-star"></i></span>
                            </div>
                            <input type="hidden" id="sleepQuality" value="3">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="sleepNote">備註</label>
                            <div class="input-with-voice">
                                <textarea id="sleepNote" class="form-control" rows="3"></textarea>
                                <button type="button" class="btn btn-icon voice-input-btn" title="語音輸入" data-target="sleepNote">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button id="saveSleepBtn" class="btn btn-primary">
                        <i class="fas fa-save"></i> 儲存記錄
                    </button>
                    <button id="saveAsSleepTemplateBtn" class="btn btn-accent">
                        <i class="fas fa-bookmark"></i> 儲存為模板
                    </button>
                </div>
            </div>

            <!-- 尿布記錄表單 -->
            <div id="diaperForm" class="record-form" style="display: none;">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label>排泄類型</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="diaperUrine" checked> 小便
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="diaperStool"> 大便
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="diaperCondition">狀況</label>
                            <div class="input-with-voice">
                                <select id="diaperCondition" class="form-control">
                                    <option value="正常">正常</option>
                                    <option value="異常">異常</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="diaperTime">時間</label>
                            <div class="input-with-voice">
                                <input type="datetime-local" id="diaperTime" class="form-control">
                                <button type="button" class="btn btn-icon now-btn" title="設為現在時間" onclick="setCurrentTime('diaperTime')">
                                    <i class="fas fa-clock"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="diaperNote">備註</label>
                            <div class="input-with-voice">
                                <textarea id="diaperNote" class="form-control" rows="3" placeholder="若狀況異常，請說明異常情況"></textarea>
                                <button type="button" class="btn btn-icon voice-input-btn" title="語音輸入" data-target="diaperNote">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button id="saveDiaperBtn" class="btn btn-primary">
                        <i class="fas fa-save"></i> 儲存記錄
                    </button>
                    <button id="saveAsDiaperTemplateBtn" class="btn btn-accent">
                        <i class="fas fa-bookmark"></i> 儲存為模板
                    </button>
                </div>
            </div>

            <!-- 情緒記錄表單 -->
            <div id="emotionForm" class="record-form" style="display: none;">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="emotionType">情緒類別</label>
                            <select id="emotionType" class="form-control">
                                <option value="開心">開心</option>
                                <option value="難過">難過</option>
                                <option value="生氣">生氣</option>
                                <option value="害怕">害怕</option>
                                <option value="驚訝">驚訝</option>
                                <option value="平靜">平靜</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="emotionIntensity">強度 (1-5分)</label>
                            <div class="rating" id="emotionIntensityRating">
                                <span class="rating-star" data-value="1"><i class="fas fa-star"></i></span>
                                <span class="rating-star" data-value="2"><i class="fas fa-star"></i></span>
                                <span class="rating-star" data-value="3"><i class="fas fa-star"></i></span>
                                <span class="rating-star" data-value="4"><i class="fas fa-star"></i></span>
                                <span class="rating-star" data-value="5"><i class="fas fa-star"></i></span>
                            </div>
                            <input type="hidden" id="emotionIntensity" value="3">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="emotionTime">時間</label>
                            <div class="input-with-voice">
                                <input type="datetime-local" id="emotionTime" class="form-control">
                                <button type="button" class="btn btn-icon now-btn" title="設為現在時間" onclick="setCurrentTime('emotionTime')">
                                    <i class="fas fa-clock"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="emotionNote">備註</label>
                            <div class="input-with-voice">
                                <textarea id="emotionNote" class="form-control" rows="3" placeholder="描述情緒發生的情境和可能的原因"></textarea>
                                <button type="button" class="btn btn-icon voice-input-btn" title="語音輸入" data-target="emotionNote">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button id="saveEmotionBtn" class="btn btn-primary">
                        <i class="fas fa-save"></i> 儲存記錄
                    </button>
                    <button id="saveAsEmotionTemplateBtn" class="btn btn-accent">
                        <i class="fas fa-bookmark"></i> 儲存為模板
                    </button>
                </div>
            </div>

            <!-- 活動記錄表單 -->
            <div id="activityForm" class="record-form" style="display: none;">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="activityType">活動類型</label>
                            <select id="activityType" class="form-control">
                                <option value="遊戲">遊戲</option>
                                <option value="洗澡">洗澡</option>
                                <option value="戶外">戶外</option>
                                <option value="學習">學習</option>
                                <option value="社交">社交</option>
                                <option value="運動">運動</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="activityDuration">持續時間 (分鐘)</label>
                            <input type="number" id="activityDuration" class="form-control" inputmode="decimal">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="activityTime">開始時間</label>
                            <div class="input-with-voice">
                                <input type="datetime-local" id="activityTime" class="form-control">
                                <button type="button" class="btn btn-icon now-btn" title="設為現在時間" onclick="setCurrentTime('activityTime')">
                                    <i class="fas fa-clock"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="activityNote">備註</label>
                            <div class="input-with-voice">
                                <textarea id="activityNote" class="form-control" rows="3" placeholder="描述活動內容和兒童反應"></textarea>
                                <button type="button" class="btn btn-icon voice-input-btn" title="語音輸入" data-target="activityNote">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button id="saveActivityBtn" class="btn btn-primary">
                        <i class="fas fa-save"></i> 儲存記錄
                    </button>
                    <button id="saveAsActivityTemplateBtn" class="btn btn-accent">
                        <i class="fas fa-bookmark"></i> 儲存為模板
                    </button>
                </div>
            </div>

            <!-- 其他記錄表單 -->
            <div id="otherForm" class="record-form" style="display: none;">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="otherTitle">標題</label>
                            <input type="text" id="otherTitle" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="otherTime">時間</label>
                            <div class="input-with-voice">
                                <input type="datetime-local" id="otherTime" class="form-control">
                                <button type="button" class="btn btn-icon now-btn" title="設為現在時間" onclick="setCurrentTime('otherTime')">
                                    <i class="fas fa-clock"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="otherContent">內容</label>
                    <div class="input-with-voice">
                        <textarea id="otherContent" class="form-control" rows="5"></textarea>
                        <button type="button" class="btn btn-icon voice-input-btn" title="語音輸入" data-target="otherContent">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                </div>
                <div class="form-actions">
                    <button id="saveOtherBtn" class="btn btn-primary">
                        <i class="fas fa-save"></i> 儲存記錄
                    </button>
                    <button id="saveAsOtherTemplateBtn" class="btn btn-accent">
                        <i class="fas fa-bookmark"></i> 儲存為模板
                    </button>
                </div>
            </div>
        </div>

        <div id="historyTab" class="tab-content">
            <h2>歷史記錄</h2>
            <p id="historyChildInfo">請先選擇或新增一位兒童</p>

            <div class="history-controls">
                <div class="history-date-selector">
                    <input type="date" id="historyDate" class="form-control">
                </div>
                <div class="history-filter">
                    <select id="historyFilter" class="form-control">
                        <option value="all">所有類型</option>
                        <option value="feeding">餵食</option>
                        <option value="sleep">睡眠</option>
                        <option value="diaper">尿布</option>
                        <option value="emotion">情緒</option>
                        <option value="activity">活動</option>
                        <option value="other">其他</option>
                    </select>
                </div>
            </div>

            <div id="historyContent">
                <!-- 歷史記錄將在這裡動態生成 -->
            </div>
        </div>

        <div id="milestoneTab" class="tab-content">
            <h2>發展里程碑</h2>
            <p id="milestoneChildInfo">請先選擇或新增一位兒童</p>

            <div class="milestone-controls">
                <select id="milestoneFilter" class="form-control">
                    <option value="all">所有年齡段</option>
                    <option value="0-3">0-3個月</option>
                    <option value="4-6">4-6個月</option>
                    <option value="7-9">7-9個月</option>
                    <option value="10-12">10-12個月</option>
                    <option value="13-18">13-18個月</option>
                    <option value="19-24">19-24個月</option>
                </select>
            </div>

            <div id="milestoneContent">
                <!-- 里程碑內容將在這裡動態生成 -->
            </div>
        </div>

        <div id="growthTab" class="tab-content">
            <h2>成長記錄</h2>
            <p id="growthChildInfo">請先選擇或新增一位兒童</p>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">身高體重記錄</div>
                    <button id="addGrowthBtn" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i> 新增記錄
                    </button>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="growthChart"></canvas>
                    </div>
                    <div id="growthRecordsList" class="records-list">
                        <!-- 記錄將在這裡動態生成 -->
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">疫苗接種記錄</div>
                    <button id="addVaccineBtn" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i> 新增記錄
                    </button>
                </div>
                <div class="card-body">
                    <div id="vaccineRecordsList" class="records-list">
                        <!-- 疫苗記錄將在這裡動態生成 -->
                    </div>
                </div>
            </div>
        </div>

        <div id="statsTab" class="tab-content">
            <h2>統計分析</h2>
            <p id="statsChildInfo">請先選擇或新增一位兒童</p>

            <div class="stats-controls">
                <div class="stats-period-selector">
                    <button class="stats-period-btn active" data-period="week">週</button>
                    <button class="stats-period-btn" data-period="month">月</button>
                    <button class="stats-period-btn" data-period="3months">三個月</button>
                    <button class="stats-period-btn" data-period="custom">自訂</button>
                </div>
                <div class="stats-custom-period" style="display: none;">
                    <input type="date" id="statsStartDate" class="form-control" style="margin-right: 10px;">
                    <span>至</span>
                    <input type="date" id="statsEndDate" class="form-control" style="margin-left: 10px;">
                    <button id="statsApplyCustom" class="btn btn-primary">套用</button>
                </div>
            </div>

            <div class="stats-charts">
                <div class="chart-container">
                    <h3>睡眠時間與品質</h3>
                    <canvas id="sleepChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>餵食量變化</h3>
                    <canvas id="feedingChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>排泄頻率</h3>
                    <canvas id="diaperChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>情緒變化</h3>
                    <canvas id="emotionChart"></canvas>
                </div>
            </div>
        </div>

        <div id="exportTab" class="tab-content">
            <h2>匯出資料</h2>
            <p id="exportChildInfo">請先選擇或新增一位兒童</p>

            <div class="export-options">
                <div class="export-option">
                    <h3>選擇記錄類型</h3>
                    <div style="margin-top: 10px;">
                        <label style="display: flex; align-items: center; margin-bottom: 5px;">
                            <input type="checkbox" id="exportAllTypes" checked style="margin-right: 5px;"> 所有類型
                        </label>
                        <div id="exportTypeOptions">
                            <label style="display: flex; align-items: center; margin-bottom: 5px;">
                                <input type="checkbox" name="exportType" value="feeding" style="margin-right: 5px;"> 餵食
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 5px;">
                                <input type="checkbox" name="exportType" value="sleep" style="margin-right: 5px;"> 睡眠
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 5px;">
                                <input type="checkbox" name="exportType" value="diaper" style="margin-right: 5px;"> 尿布
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 5px;">
                                <input type="checkbox" name="exportType" value="emotion" style="margin-right: 5px;"> 情緒
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 5px;">
                                <input type="checkbox" name="exportType" value="activity" style="margin-right: 5px;"> 活動
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 5px;">
                                <input type="checkbox" name="exportType" value="other" style="margin-right: 5px;"> 其他
                            </label>
                        </div>
                    </div>
                </div>
                <div class="export-option">
                    <h3>選擇日期範圍</h3>
                    <div style="margin-top: 10px;">
                        <label style="display: flex; align-items: center; margin-bottom: 5px;">
                            <input type="checkbox" id="exportAllDates" checked style="margin-right: 5px;"> 所有日期
                        </label>
                        <div id="exportDateRange" style="display: none;">
                            <div class="export-date-range">
                                <span>從:</span>
                                <input type="date" id="exportStartDate" class="form-control">
                            </div>
                            <div class="export-date-range">
                                <span>至:</span>
                                <input type="date" id="exportEndDate" class="form-control">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button id="exportCSVBtn" class="btn btn-primary">
                <i class="fas fa-file-csv"></i> 匯出為CSV
            </button>
            
            <!-- 全部數據匯出與匯入功能 -->
            <hr>
            <h3>全部數據匯出與備份</h3>
            <p>匯出所有兒童及其所有記錄，可用於備份或跨設備轉移數據。</p>
            <button id="exportAllDataBtn" class="btn btn-accent" style="margin-right: 10px;">
                <i class="fas fa-download"></i> 匯出所有數據
            </button>
            
            <div style="margin-top: 20px;">
                <h3>匯入數據</h3>
                <p>從先前匯出的檔案中匯入數據。</p>
                <div style="display: flex; align-items: center;">
                    <input type="file" id="importFileInput" accept=".json" style="display: none;">
                    <button id="importFileBtn" class="btn btn-primary" style="margin-right: 10px;">
                        <i class="fas fa-upload"></i> 選擇檔案
                    </button>
                    <span id="importFileName">未選擇檔案</span>
                </div>
                <div style="margin-top: 10px;">
                    <div class="form-group">
                        <label>匯入選項：</label>
                        <label style="display: flex; align-items: center; margin: 5px 0;">
                            <input type="radio" name="importOption" value="merge" checked style="margin-right: 5px;"> 合併數據（保留現有數據）
                        </label>
                        <label style="display: flex; align-items: center; margin: 5px 0;">
                            <input type="radio" name="importOption" value="replace" style="margin-right: 5px;"> 完全替換（刪除所有現有數據）
                        </label>
                    </div>
                    <button id="importDataBtn" class="btn btn-success" disabled>
                        <i class="fas fa-check"></i> 開始匯入
                    </button>
                </div>
            </div>
        </div>

        <!-- 底部導航欄 -->
        <div class="bottom-nav">
            <div class="bottom-nav-item active" data-tab="record">
                <i class="fas fa-pen"></i>
                <span>記錄</span>
            </div>
            <div class="bottom-nav-item" data-tab="history">
                <i class="fas fa-history"></i>
                <span>歷史</span>
            </div>
            <div class="bottom-nav-item" data-tab="milestone">
                <i class="fas fa-flag"></i>
                <span>里程碑</span>
            </div>
            <div class="bottom-nav-item" data-tab="growth">
                <i class="fas fa-chart-line"></i>
                <span>成長</span>
            </div>
            <div class="bottom-nav-item" data-tab="stats">
                <i class="fas fa-chart-bar"></i>
                <span>統計</span>
            </div>
        </div>
    </div>

    <!-- 模態框 -->
    <div id="addChildModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>新增兒童</h3>
                <button class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="childName">姓名</label>
                    <input type="text" id="childName" class="form-control" placeholder="輸入兒童姓名">
                </div>
                <div class="form-group">
                    <label for="childBirthday">出生日期</label>
                    <input type="date" id="childBirthday" class="form-control">
                </div>
                <div class="form-group">
                    <label for="childGender">性別</label>
                    <select id="childGender" class="form-control">
                        <option value="男">男</option>
                        <option value="女">女</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="childNote">備註</label>
                    <textarea id="childNote" class="form-control" rows="3" placeholder="其他重要資訊，如過敏史、特殊需求等"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="saveChildBtn">儲存</button>
                <button class="btn" id="cancelAddChildBtn">取消</button>
            </div>
        </div>
    </div>

    <div id="editRecordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="editRecordTitle">編輯記錄</h3>
                <button class="modal-close">×</button>
            </div>
            <div class="modal-body" id="editRecordBody">
                <!-- 編輯表單將根據記錄類型動態生成 -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="deleteRecordBtn">刪除</button>
                <button class="btn btn-primary" id="updateRecordBtn">更新</button>
                <button class="btn" id="cancelEditRecordBtn">取消</button>
            </div>
        </div>
    </div>

    <div id="deleteChildModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>刪除兒童</h3>
                <button class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <p>確定要刪除「<span id="deleteChildName"></span>」嗎？</p>
                <p class="text-danger"><strong>警告：</strong>此操作將刪除與該兒童相關的所有記錄和里程碑資料，且無法復原！</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="confirmDeleteChildBtn">確認刪除</button>
                <button class="btn" id="cancelDeleteChildBtn">取消</button>
            </div>
        </div>
    </div>

    <div id="addTemplateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>儲存為快速記錄模板</h3>
                <button class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="templateName">模板名稱</label>
                    <input type="text" id="templateName" class="form-control" placeholder="例如：早餐奶粉">
                </div>
                <div class="form-group">
                    <label class="toggle-switch">
                        <input type="checkbox" id="templateAutoSave">
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">使用時自動儲存</span>
                    </label>
                </div>
                <input type="hidden" id="templateType" value="">
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="saveTemplateBtn">儲存</button>
                <button class="btn" id="cancelTemplateBtn">取消</button>
            </div>
        </div>
    </div>

    <div id="addGrowthRecordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>新增身高體重記錄</h3>
                <button class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="growthDate">日期</label>
                    <input type="date" id="growthDate" class="form-control">
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="weightInput">體重 (公斤)</label>
                            <input type="number" id="weightInput" class="form-control" step="0.1" min="0" max="30" inputmode="decimal">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="heightInput">身高 (公分)</label>
                            <input type="number" id="heightInput" class="form-control" step="0.1" min="0" max="200" inputmode="decimal">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="growthNote">備註</label>
                    <textarea id="growthNote" class="form-control" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="saveGrowthBtn">儲存</button>
                <button class="btn" id="cancelGrowthBtn">取消</button>
            </div>
        </div>
    </div>

    <div id="importConfirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>確認匯入</h3>
                <button class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <p>您即將匯入以下數據：</p>
                <div id="importSummary" style="margin: 10px 0; padding: 10px; background-color: #f0f5f9; border-radius: 5px;"></div>
                <p id="importWarning" style="color: #e76f51;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" id="confirmImportBtn">確認匯入</button>
                <button class="btn" id="cancelImportBtn">取消</button>
            </div>
        </div>
    </div>

    <!-- 提示框 -->
    <div id="toast" class="toast">
        <div class="toast-content">
            <i class="fas fa-check-circle toast-icon"></i>
            <div class="toast-message">操作成功</div>
        </div>
    </div>

    <script>
        // 核心資料模型
        const appData = {
            children: [],
            selectedChild: null,
            records: {},
            milestones: {},
            growth: {},
            vaccines: {},
            settings: {
                darkMode: false,
                autoBackup: false,
                reminders: false,
                cloudBackup: 'none',
                language: 'zh-TW'
            },
            templates: []
        };

        // 里程碑定義
        const milestonesDefinition = {
            "0-3": {
                "運動技能": [
                    { name: "抬頭", typicalAge: "1-2個月" },
                    { name: "翻身 (從腹部到背部)", typicalAge: "3-4個月" },
                    { name: "抓握物品", typicalAge: "3個月" },
                    { name: "雙手合十", typicalAge: "3個月" }
                ],
                "語言能力": [
                    { name: "發出咕咕聲", typicalAge: "1-2個月" },
                    { name: "笑聲回應", typicalAge: "2個月" },
                    { name: "模仿聲音", typicalAge: "2-3個月" }
                ],
                "社交/情緒發展": [
                    { name: "社交性微笑", typicalAge: "1-2個月" },
                    { name: "認人", typicalAge: "2-3個月" },
                    { name: "對聲音表現出興趣", typicalAge: "0-3個月" }
                ],
                "認知發展": [
                    { name: "追視移動物體", typicalAge: "1-2個月" },
                    { name: "注視臉部", typicalAge: "0-1個月" },
                    { name: "開始認識物體恆存", typicalAge: "3個月" }
                ]
            },
            "4-6": {
                "運動技能": [
                    { name: "翻身 (從背部到腹部)", typicalAge: "4-5個月" },
                    { name: "支撐坐立", typicalAge: "5-6個月" },
                    { name: "傳遞物品", typicalAge: "5-6個月" },
                    { name: "用拇指和食指抓取小物品", typicalAge: "6個月" }
                ],
                "語言能力": [
                    { name: "發出連續音節", typicalAge: "4-6個月" },
                    { name: "對自己名字有反應", typicalAge: "4-5個月" },
                    { name: "開始模仿語音", typicalAge: "6個月" }
                ],
                "社交/情緒發展": [
                    { name: "不熟悉陌生人", typicalAge: "4-5個月" },
                    { name: "對鏡中影像產生興趣", typicalAge: "5-6個月" },
                    { name: "表現出喜悅、憤怒等情緒", typicalAge: "4-6個月" }
                ],
                "認知發展": [
                    { name: "開始理解因果關係", typicalAge: "4-6個月" },
                    { name: "對藏起來的物體表現出興趣", typicalAge: "5-6個月" },
                    { name: "開始區分不同的顏色", typicalAge: "5-6個月" }
                ]
            },
            "7-9": {
                "運動技能": [
                    { name: "獨自坐立", typicalAge: "7-8個月" },
                    { name: "爬行", typicalAge: "8-9個月" },
                    { name: "扶著東西站立", typicalAge: "9個月" },
                    { name: "精細抓握", typicalAge: "7-8個月" }
                ],
                "語言能力": [
                    { name: "牙牙學語", typicalAge: "7-9個月" },
                    { name: "理解簡單的指令", typicalAge: "7-9個月" },
                    { name: "模仿聲音和手勢", typicalAge: "7-9個月" }
                ],
                "社交/情緒發展": [
                    { name: "陌生人焦慮", typicalAge: "7-9個月" },
                    { name: "分離焦慮", typicalAge: "8-9個月" },
                    { name: "玩躲貓貓遊戲", typicalAge: "7-8個月" }
                ],
                "認知發展": [
                    { name: "尋找藏起來的物體", typicalAge: "7-8個月" },
                    { name: "記住簡單的動作序列", typicalAge: "8-9個月" },
                    { name: "開始分類物體", typicalAge: "9個月" }
                ]
            },
            "10-12": {
                "運動技能": [
                    { name: "獨自站立", typicalAge: "10-11個月" },
                    { name: "扶著東西走路", typicalAge: "10-12個月" },
                    { name: "嘗試獨自走路", typicalAge: "11-12個月" },
                    { name: "可以坐下", typicalAge: "10-11個月" }
                ],
                "語言能力": [
                    { name: "說出第一個單詞", typicalAge: "10-12個月" },
                    { name: "理解更多的單詞", typicalAge: "10-12個月" },
                    { name: "指向物體表達需求", typicalAge: "10-12個月" }
                ],
                "社交/情緒發展": [
                    { name: "模仿成人行為", typicalAge: "10-12個月" },
                    { name: "表現喜好", typicalAge: "10-12個月" },
                    { name: "與照顧者建立更強的情感連結", typicalAge: "10-12個月" }
                ],
                "認知發展": [
                    { name: "依照指示完成簡單任務", typicalAge: "10-12個月" },
                    { name: "開始理解物體功能", typicalAge: "10-12個月" },
                    { name: "展示記憶力", typicalAge: "10-12個月" }
                ]
            },
            "13-18": {
                "運動技能": [
                    { name: "獨立行走", typicalAge: "13-15個月" },
                    { name: "爬樓梯", typicalAge: "16-18個月" },
                    { name: "拉、推玩具走路", typicalAge: "13-15個月" },
                    { name: "開始跑步", typicalAge: "16-18個月" }
                ],
                "語言能力": [
                    { name: "詞彙量增加 (5-20個單詞)", typicalAge: "13-18個月" },
                    { name: "開始組合單詞", typicalAge: "16-18個月" },
                    { name: "遵循簡單的二步驟指令", typicalAge: "16-18個月" }
                ],
                "社交/情緒發展": [
                    { name: "表現出同理心", typicalAge: "13-18個月" },
                    { name: "參與平行遊戲", typicalAge: "13-18個月" },
                    { name: "主動表達情感", typicalAge: "13-18個月" }
                ],
                "認知發展": [
                    { name: "解決簡單問題", typicalAge: "13-18個月" },
                    { name: "象徵性遊戲", typicalAge: "13-18個月" },
                    { name: "開始理解數量概念", typicalAge: "16-18個月" }
                ]
            },
            "19-24": {
                "運動技能": [
                    { name: "上下樓梯", typicalAge: "19-24個月" },
                    { name: "踢球", typicalAge: "20-24個月" },
                    { name: "站立跳躍", typicalAge: "21-24個月" },
                    { name: "精細運動技能提升", typicalAge: "19-24個月" }
                ],
                "語言能力": [
                    { name: "詞彙量急速增加 (50+單詞)", typicalAge: "19-24個月" },
                    { name: "開始形成簡單句子", typicalAge: "20-24個月" },
                    { name: "使用代詞", typicalAge: "21-24個月" }
                ],
                "社交/情緒發展": [
                    { name: "增強的自我意識", typicalAge: "19-24個月" },
                    { name: "開始出現情緒自我調節", typicalAge: "19-24個月" },
                    { name: "與其他兒童互動增多", typicalAge: "19-24個月" }
                ],
                "認知發展": [
                    { name: "分類能力增強", typicalAge: "19-24個月" },
                    { name: "記憶力提升", typicalAge: "19-24個月" },
                    { name: "開始理解更複雜的概念", typicalAge: "22-24個月" },
                    { name: "開始展現創造力", typicalAge: "19-24個月" }
                ]
            }
        };

        // 疫苗接種時間表
        const vaccineSchedule = {
            "出生": [
                { name: "B型肝炎疫苗第1劑", recommended: true },
                { name: "卡介苗", recommended: true }
            ],
            "1個月": [
                { name: "B型肝炎疫苗第2劑", recommended: true }
            ],
            "2個月": [
                { name: "輪狀病毒疫苗第1劑", recommended: true },
                { name: "五合一疫苗第1劑", recommended: true },
                { name: "肺炎鏈球菌疫苗第1劑", recommended: true }
            ],
            "4個月": [
                { name: "輪狀病毒疫苗第2劑", recommended: true },
                { name: "五合一疫苗第2劑", recommended: true },
                { name: "肺炎鏈球菌疫苗第2劑", recommended: true }
            ],
            "6個月": [
                { name: "五合一疫苗第3劑", recommended: true },
                { name: "B型肝炎疫苗第3劑", recommended: true },
                { name: "流感疫苗", recommended: true }
            ],
            "12個月": [
                { name: "麻疹、腮腺炎、德國麻疹混合疫苗第1劑", recommended: true },
                { name: "水痘疫苗", recommended: true },
                { name: "肺炎鏈球菌疫苗追加劑", recommended: true }
            ],
            "15個月": [
                { name: "日本腦炎疫苗第1劑", recommended: true }
            ],
            "18個月": [
                { name: "五合一疫苗追加劑", recommended: true },
                { name: "A型肝炎疫苗第1劑", recommended: false }
            ]
        };

        // 匯入數據臨時存儲
        let importedData = null;
        
        // 初始化應用程式
        function initApp() {
            loadData();
            setupDarkMode();
            initEventListeners();
            setCurrentDateTime();
            updateChildSelector();
            checkSelectedChild();
            setupQuickRecordButtons();
            setupVoiceInput();
            
            // 設置自動備份提醒
            setupBackupReminder();
            
            // 檢測系統主題偏好
            detectSystemTheme();
            
            // 綁定評分系統
            document.querySelectorAll('.rating-star').forEach(star => {
                star.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    const ratingGroup = this.closest('.rating');
                    const ratingId = ratingGroup.id;
                    const hiddenInput = document.getElementById(ratingId.replace('Rating', ''));
                    
                    if (hiddenInput) {
                        hiddenInput.value = value;
                        
                        // 更新星星顯示
                        ratingGroup.querySelectorAll('.rating-star').forEach(s => {
                            if (parseInt(s.getAttribute('data-value')) <= parseInt(value)) {
                                s.classList.add('active');
                            } else {
                                s.classList.remove('active');
                            }
                        });
                    }
                });
            });
            
            // 顯示歡迎訊息
            setTimeout(() => {
                showToast('歡迎使用嬰幼兒照顧輔助工具！', 'info');
            }, 1000);
        }

        // 載入資料
        function loadData() {
            // 載入設定
            const savedSettings = localStorage.getItem('settings');
            if (savedSettings) {
                appData.settings = JSON.parse(savedSettings);
                
                // 應用深色模式設定
                if (appData.settings.darkMode) {
                    document.body.classList.add('dark-mode');
                    document.getElementById('darkModeToggle').innerHTML = '<i class="fas fa-sun"></i>';
                }
            }

            // 載入模板
            const savedTemplates = localStorage.getItem('templates');
            if (savedTemplates) {
                appData.templates = JSON.parse(savedTemplates);
            }
            
            // 載入兒童數據
            const savedChildren = localStorage.getItem('children');
            if (savedChildren) {
                appData.children = JSON.parse(savedChildren);
            }
            
            // 載入選擇的兒童
            const selectedChildId = localStorage.getItem('selectedChild');
            if (selectedChildId) {
                appData.selectedChild = selectedChildId;
                loadChildData(selectedChildId);
            }
        }

        // 載入特定兒童的資料
        function loadChildData(childId) {
            if (!childId) return;
            
            // 載入記錄
            const records = localStorage.getItem(`records_${childId}`);
            if (records) {
                appData.records[childId] = JSON.parse(records);
            } else {
                appData.records[childId] = [];
            }
            
            // 載入里程碑
            const milestones = localStorage.getItem(`milestones_${childId}`);
            if (milestones) {
                appData.milestones[childId] = JSON.parse(milestones);
            } else {
                // 初始化里程碑資料
                initMilestones(childId);
            }
            
            // 載入成長記錄
            const growth = localStorage.getItem(`growth_${childId}`);
            if (growth) {
                appData.growth[childId] = JSON.parse(growth);
            } else {
                appData.growth[childId] = [];
            }
            
            // 載入疫苗記錄
            const vaccines = localStorage.getItem(`vaccines_${childId}`);
            if (vaccines) {
                appData.vaccines[childId] = JSON.parse(vaccines);
            } else {
                // 初始化疫苗記錄
                initVaccines(childId);
            }
        }

        // 初始化里程碑資料
        function initMilestones(childId) {
            appData.milestones[childId] = {};
            
            // 根據里程碑定義初始化
            for (const ageGroup in milestonesDefinition) {
                for (const category in milestonesDefinition[ageGroup]) {
                    milestonesDefinition[ageGroup][category].forEach(milestone => {
                        const milestoneId = `${ageGroup}_${category}_${milestone.name}`;
                        if (!appData.milestones[childId]) {
                            appData.milestones[childId] = {};
                        }
                        appData.milestones[childId][milestoneId] = {
                            achieved: false,
                            date: ''
                        };
                    });
                }
            }
            
            saveMilestones(childId);
        }

        // 初始化疫苗記錄
        function initVaccines(childId) {
            appData.vaccines[childId] = {};
            
            // 根據疫苗時間表初始化
            for (const age in vaccineSchedule) {
                vaccineSchedule[age].forEach(vaccine => {
                    const vaccineId = `${age}_${vaccine.name}`;
                    if (!appData.vaccines[childId]) {
                        appData.vaccines[childId] = {};
                    }
                    appData.vaccines[childId][vaccineId] = {
                        completed: false,
                        date: '',
                        note: ''
                    };
                });
            }
            
            saveVaccines(childId);
        }

        // 儲存里程碑資料
        function saveMilestones(childId) {
            localStorage.setItem(`milestones_${childId}`, JSON.stringify(appData.milestones[childId]));
        }

        // 儲存疫苗記錄
        function saveVaccines(childId) {
            localStorage.setItem(`vaccines_${childId}`, JSON.stringify(appData.vaccines[childId]));
        }

        // 儲存成長記錄
        function saveGrowth(childId) {
            localStorage.setItem(`growth_${childId}`, JSON.stringify(appData.growth[childId]));
        }

        // 儲存兒童資料
        function saveChildren() {
            localStorage.setItem('children', JSON.stringify(appData.children));
        }

        // 儲存記錄資料
        function saveRecords(childId) {
            localStorage.setItem(`records_${childId}`, JSON.stringify(appData.records[childId]));
        }

        // 儲存設定
        function saveSettings() {
            localStorage.setItem('settings', JSON.stringify(appData.settings));
        }

        // 儲存模板
        function saveTemplates() {
            localStorage.setItem('templates', JSON.stringify(appData.templates));
        }

        // 設定深色模式
        function setupDarkMode() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            
            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', toggleDarkMode);
            }
            
            // 初始應用深色模式
            if (appData.settings.darkMode) {
                applyDarkMode(true);
            }
        }

        // 切換深色模式
        function toggleDarkMode() {
            const isDarkMode = !appData.settings.darkMode;
            appData.settings.darkMode = isDarkMode;
            saveSettings();
            applyDarkMode(isDarkMode);
        }

        // 應用深色模式
        function applyDarkMode(isDarkMode) {
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('darkModeToggle').innerHTML = '<i class="fas fa-moon"></i>';
            }
            
            // 更新所有圖表以適應當前主題
            updateAllCharts();
        }

        // 初始化事件監聽器
        function initEventListeners() {
            // 導航切換
            document.querySelectorAll('.nav-tab, .bottom-nav-item').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
            
            // 新增兒童按鈕
            document.getElementById('addChildBtn').addEventListener('click', showAddChildModal);
            
            // 兒童選擇器變更
            document.getElementById('childSelect').addEventListener('change', function() {
                const childId = this.value;
                selectChild(childId);
            });
            
            // 模態框關閉按鈕
            document.querySelectorAll('.modal-close, #cancelAddChildBtn').forEach(btn => {
                btn.addEventListener('click', closeModals);
            });
            
            // 儲存兒童按鈕
            document.getElementById('saveChildBtn').addEventListener('click', saveChild);
            
            // 記錄類型選擇器
            document.querySelectorAll('.record-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const recordType = this.getAttribute('data-record-type');
                    switchRecordForm(recordType);
                });
            });
            
            // 評分系統
            document.querySelectorAll('.rating-star').forEach(star => {
                star.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    const ratingGroup = this.closest('.rating');
                    const ratingId = ratingGroup.id;
                    const hiddenInput = document.getElementById(ratingId.replace('Rating', ''));
                    hiddenInput.value = value;
                    
                    // 更新星星顯示
                    ratingGroup.querySelectorAll('.rating-star').forEach(s => {
                        if (parseInt(s.getAttribute('data-value')) <= parseInt(value)) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                });
            });
            
            // 各類型記錄表單儲存按鈕
            document.getElementById('saveFeedingBtn').addEventListener('click', () => saveRecord('feeding'));
            document.getElementById('saveSleepBtn').addEventListener('click', () => saveRecord('sleep'));
            document.getElementById('saveDiaperBtn').addEventListener('click', () => saveRecord('diaper'));
            document.getElementById('saveEmotionBtn').addEventListener('click', () => saveRecord('emotion'));
            document.getElementById('saveActivityBtn').addEventListener('click', () => saveRecord('activity'));
            document.getElementById('saveOtherBtn').addEventListener('click', () => saveRecord('other'));
            
            // 儲存為模板按鈕
            document.getElementById('saveAsFeedingTemplateBtn').addEventListener('click', () => showSaveTemplateModal('feeding'));
            document.getElementById('saveAsSleepTemplateBtn').addEventListener('click', () => showSaveTemplateModal('sleep'));
            document.getElementById('saveAsDiaperTemplateBtn').addEventListener('click', () => showSaveTemplateModal('diaper'));
            document.getElementById('saveAsEmotionTemplateBtn').addEventListener('click', () => showSaveTemplateModal('emotion'));
            document.getElementById('saveAsActivityTemplateBtn').addEventListener('click', () => showSaveTemplateModal('activity'));
            document.getElementById('saveAsOtherTemplateBtn').addEventListener('click', () => showSaveTemplateModal('other'));
            
            // 儲存模板按鈕
            document.getElementById('saveTemplateBtn').addEventListener('click', saveTemplate);
            document.getElementById('cancelTemplateBtn').addEventListener('click', closeModals);
            
            // 歷史記錄日期選擇和篩選
            const historyDate = document.getElementById('historyDate');
            const historyFilter = document.getElementById('historyFilter');
            
            if (historyDate) {
                historyDate.addEventListener('change', updateHistoryView);
            }
            
            if (historyFilter) {
                historyFilter.addEventListener('change', updateHistoryView);
            }
            
            // 里程碑篩選
            const milestoneFilter = document.getElementById('milestoneFilter');
            if (milestoneFilter) {
                milestoneFilter.addEventListener('change', updateMilestoneView);
            }
            
            // 統計時間範圍選擇
            document.querySelectorAll('.stats-period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.stats-period-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const period = this.getAttribute('data-period');
                    if (period === 'custom') {
                        document.querySelector('.stats-custom-period').style.display = 'flex';
                    } else {
                        document.querySelector('.stats-custom-period').style.display = 'none';
                        updateStatsView(period);
                    }
                });
            });
            
            // 套用自訂統計時間範圍
            const statsApplyCustom = document.getElementById('statsApplyCustom');
            if (statsApplyCustom) {
                statsApplyCustom.addEventListener('click', function() {
                    const startDate = document.getElementById('statsStartDate').value;
                    const endDate = document.getElementById('statsEndDate').value;
                    if (startDate && endDate) {
                        updateStatsView('custom', { startDate, endDate });
                    }
                });
            }
            
            // 匯出選項
            const exportAllTypes = document.getElementById('exportAllTypes');
            if (exportAllTypes) {
                exportAllTypes.addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('input[name="exportType"]');
                    checkboxes.forEach(cb => {
                        cb.checked = this.checked;
                        cb.disabled = this.checked;
                    });
                });
            }
            
            const exportAllDates = document.getElementById('exportAllDates');
            if (exportAllDates) {
                exportAllDates.addEventListener('change', function() {
                    const dateRange = document.getElementById('exportDateRange');
                    dateRange.style.display = this.checked ? 'none' : 'block';
                });
            }
            
            // 匯出按鈕
            const exportCSVBtn = document.getElementById('exportCSVBtn');
            if (exportCSVBtn) {
                exportCSVBtn.addEventListener('click', exportToCSV);
            }
            
            // 編輯記錄模態框按鈕
            const updateRecordBtn = document.getElementById('updateRecordBtn');
            const deleteRecordBtn = document.getElementById('deleteRecordBtn');
            const cancelEditRecordBtn = document.getElementById('cancelEditRecordBtn');
            
            if (updateRecordBtn) updateRecordBtn.addEventListener('click', updateRecord);
            if (deleteRecordBtn) deleteRecordBtn.addEventListener('click', deleteRecord);
            if (cancelEditRecordBtn) cancelEditRecordBtn.addEventListener('click', closeModals);
            
            // 新增：刪除兒童按鈕和模態框
            const deleteChildBtn = document.getElementById('deleteChildBtn');
            const confirmDeleteChildBtn = document.getElementById('confirmDeleteChildBtn');
            const cancelDeleteChildBtn = document.getElementById('cancelDeleteChildBtn');
            
            if (deleteChildBtn) deleteChildBtn.addEventListener('click', showDeleteChildModal);
            if (confirmDeleteChildBtn) confirmDeleteChildBtn.addEventListener('click', deleteSelectedChild);
            if (cancelDeleteChildBtn) cancelDeleteChildBtn.addEventListener('click', closeModals);
            
            // 匯出所有數據按鈕
            const exportAllDataBtn = document.getElementById('exportAllDataBtn');
            if (exportAllDataBtn) {
                exportAllDataBtn.addEventListener('click', exportAllData);
            }
            
            // 匯入按鈕
            const importFileBtn = document.getElementById('importFileBtn');
            if (importFileBtn) {
                importFileBtn.addEventListener('click', function() {
                    document.getElementById('importFileInput').click();
                });
            }
            
            // 匯入文件選擇
            const importFileInput = document.getElementById('importFileInput');
            if (importFileInput) {
                importFileInput.addEventListener('change', handleFileSelect);
            }
            
            // 開始匯入按鈕
            const importDataBtn = document.getElementById('importDataBtn');
            if (importDataBtn) {
                importDataBtn.addEventListener('click', importData);
            }
            
            // 添加成長記錄按鈕
            const addGrowthBtn = document.getElementById('addGrowthBtn');
            if (addGrowthBtn) {
                addGrowthBtn.addEventListener('click', showAddGrowthModal);
            }
            
            // 儲存成長記錄按鈕
            const saveGrowthBtn = document.getElementById('saveGrowthBtn');
            if (saveGrowthBtn) {
                saveGrowthBtn.addEventListener('click', saveGrowthRecord);
            }
            
            // 新增疫苗記錄按鈕
            const addVaccineBtn = document.getElementById('addVaccineBtn');
            if (addVaccineBtn) {
                addVaccineBtn.addEventListener('click', showAddVaccineModal);
            }
            
            // 取消添加成長記錄按鈕
            const cancelGrowthBtn = document.getElementById('cancelGrowthBtn');
            if (cancelGrowthBtn) {
                cancelGrowthBtn.addEventListener('click', closeModals);
            }
            
            // 匯入確認按鈕
            const confirmImportBtn = document.getElementById('confirmImportBtn');
            const cancelImportBtn = document.getElementById('cancelImportBtn');
            if (confirmImportBtn) confirmImportBtn.addEventListener('click', function() {
                performImport(document.querySelector('input[name="importOption"]:checked').value);
                closeModals();
            });
            if (cancelImportBtn) cancelImportBtn.addEventListener('click', closeModals);
        }

        // 設定語音輸入
        function setupVoiceInput() {
            // 為所有帶有 data-target 屬性的語音輸入按鈕添加事件監聽器
            document.querySelectorAll('.voice-input-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    if (targetId) {
                        startVoiceInput(targetId, this);
                    }
                });
            });
        }

        // 提升語音輸入兼容性
        function startVoiceInput(targetId, button) {
            const targetElement = document.getElementById(targetId);
            if (!targetElement) return;
            
            // 增強對瀏覽器兼容性的檢查
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showToast('您的瀏覽器不支援語音輸入，請手動輸入', 'error');
                return;
            }
            
            // 使用可用的語音識別API
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            // 設定語言為用戶偏好設定或預設值
            recognition.lang = appData.settings.language || 'zh-TW';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            // 更改按鈕樣式以指示正在錄音
            button.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            button.classList.add('recording');
            
            // 錄音結果處理
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                
                // 將識別結果添加到目標元素
                if (targetElement.tagName === 'TEXTAREA' || targetElement.tagName === 'INPUT') {
                    targetElement.value += transcript;
                } else {
                    targetElement.textContent += transcript;
                }
                
                showToast('語音輸入成功');
            };
            
            // 改進錯誤處理
            recognition.onerror = function(event) {
                console.error('語音識別錯誤:', event.error);
                button.innerHTML = '<i class="fas fa-microphone"></i>';
                button.classList.remove('recording');
                
                let errorMessage = '語音輸入失敗';
                // 提供更具體的錯誤信息
                switch(event.error) {
                    case 'no-speech':
                        errorMessage = '未檢測到語音，請再試一次';
                        break;
                    case 'audio-capture':
                        errorMessage = '無法訪問麥克風，請檢查設備權限';
                        break;
                    case 'not-allowed':
                        errorMessage = '麥克風權限被拒絕，請在瀏覽器設置中允許';
                        break;
                    case 'network':
                        errorMessage = '網絡連接錯誤，請檢查網絡連接';
                        break;
                }
                showToast(errorMessage, 'error');
            };
            
            // 錄音結束處理
            recognition.onend = function() {
                button.innerHTML = '<i class="fas fa-microphone"></i>';
                button.classList.remove('recording');
            };
            
            // 使用 try-catch 處理可能的啟動錯誤
            try {
                recognition.start();
            } catch (e) {
                console.error('啟動語音輸入錯誤:', e);
                button.innerHTML = '<i class="fas fa-microphone"></i>';
                button.classList.remove('recording');
                showToast('無法啟動語音輸入，請手動輸入', 'error');
            }
        }

        // 設定當前日期時間
        function setCurrentDateTime() {
            const now = new Date();
            const isoString = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                .toISOString()
                .slice(0, 16);
            
            // 設定所有日期時間輸入欄位
            const dateTimeInputs = document.querySelectorAll('input[type="datetime-local"]');
            dateTimeInputs.forEach(input => {
                input.value = isoString;
            });
            
            // 設定歷史記錄日期為今天
            const historyDateInput = document.getElementById('historyDate');
            if (historyDateInput) {
                historyDateInput.value = isoString.split('T')[0];
            }
            
            // 設定成長記錄日期為今天
            const growthDateInput = document.getElementById('growthDate');
            if (growthDateInput) {
                growthDateInput.value = isoString.split('T')[0];
            }
            
            // 設定統計和匯出的日期範圍
            const today = now.toISOString().split('T')[0];
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            const statsStartDate = document.getElementById('statsStartDate');
            const statsEndDate = document.getElementById('statsEndDate');
            const exportStartDate = document.getElementById('exportStartDate');
            const exportEndDate = document.getElementById('exportEndDate');
            
            if (statsStartDate) statsStartDate.value = oneWeekAgo;
            if (statsEndDate) statsEndDate.value = today;
            if (exportStartDate) exportStartDate.value = oneWeekAgo;
            if (exportEndDate) exportEndDate.value = today;
        }

        // 設定當前時間
        function setCurrentTime(inputId) {
            const now = new Date();
            const isoString = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                .toISOString()
                .slice(0, 16);
            
            document.getElementById(inputId).value = isoString;
        }

        // 設定快速記錄按鈕
        function setupQuickRecordButtons() {
            const container = document.getElementById('quickRecordButtons');
            if (!container) return;
            
            // 清空容器
            container.innerHTML = '';
            
            // 新增一個添加模板按鈕
            const addButton = document.createElement('button');
            addButton.className = 'quick-add-btn';
            addButton.innerHTML = '<i class="fas fa-plus"></i> 新增快速記錄';
            addButton.addEventListener('click', () => showSaveTemplateModal(null, true));
            container.appendChild(addButton);
            
            // 如果沒有選擇兒童或沒有模板，則返回
            if (!appData.selectedChild || !appData.templates || appData.templates.length === 0) {
                return;
            }
            
            // 添加模板按鈕
            appData.templates.forEach((template, index) => {
                const button = document.createElement('button');
                button.className = 'quick-record-btn';
                button.innerHTML = `<i class="${getIconForRecordType(template.type)}"></i> ${template.name}`;
                button.addEventListener('click', () => useTemplate(template));
                container.appendChild(button);
            });
        }

        // 獲取記錄類型的圖標
        function getIconForRecordType(type) {
            switch (type) {
                case 'feeding': return 'fas fa-utensils';
                case 'sleep': return 'fas fa-bed';
                case 'diaper': return 'fas fa-baby';
                case 'emotion': return 'fas fa-smile';
                case 'activity': return 'fas fa-walking';
                case 'other': return 'fas fa-plus-circle';
                default: return 'fas fa-clipboard';
            }
        }

        // 使用模板
        function useTemplate(template) {
            // 切換到相應的記錄表單
            switchRecordForm(template.type);
            
            // 根據模板類型填充表單
            switch (template.type) {
                case 'feeding':
                    document.getElementById('feedingType').value = template.data.feedingType || '';
                    document.getElementById('feedingAmount').value = template.data.amount || '';
                    document.getElementById('feedingUnit').value = template.data.unit || 'ml';
                    // 更新時間為當前時間
                    setCurrentTime('feedingTime');
                    document.getElementById('feedingNote').value = template.data.note || '';
                    break;
                
                case 'sleep':
                    setCurrentTime('sleepStart');
                    setCurrentTime('sleepEnd');
                    document.getElementById('sleepQuality').value = template.data.quality || '3';
                    resetRating('sleepQualityRating', template.data.quality || 3);
                    document.getElementById('sleepNote').value = template.data.note || '';
                    break;
                
                case 'diaper':
                    document.getElementById('diaperUrine').checked = template.data.urine === undefined ? true : template.data.urine;
                    document.getElementById('diaperStool').checked = template.data.stool || false;
                    document.getElementById('diaperCondition').value = template.data.condition || '正常';
                    setCurrentTime('diaperTime');
                    document.getElementById('diaperNote').value = template.data.note || '';
                    break;
                
                case 'emotion':
                    document.getElementById('emotionType').value = template.data.emotionType || '開心';
                    document.getElementById('emotionIntensity').value = template.data.intensity || '3';
                    resetRating('emotionIntensityRating', template.data.intensity || 3);
                    setCurrentTime('emotionTime');
                    document.getElementById('emotionNote').value = template.data.note || '';
                    break;
                
                case 'activity':
                    document.getElementById('activityType').value = template.data.activityType || '遊戲';
                    document.getElementById('activityDuration').value = template.data.duration || '';
                    setCurrentTime('activityTime');
                    document.getElementById('activityNote').value = template.data.note || '';
                    break;
                
                case 'other':
                    document.getElementById('otherTitle').value = template.data.title || '';
                    setCurrentTime('otherTime');
                    document.getElementById('otherContent').value = template.data.content || '';
                    break;
            }
            
            // 如果設置了自動保存，則自動保存記錄
            if (template.autoSave) {
                setTimeout(() => {
                    saveRecord(template.type);
                }, 500);
            }
        }

        // 顯示保存模板模態框
        function showSaveTemplateModal(recordType, isQuickAdd = false) {
            if (!appData.selectedChild && !isQuickAdd) {
                showToast('請先選擇一位兒童', 'error');
                return;
            }
            
            const modal = document.getElementById('addTemplateModal');
            const templateNameInput = document.getElementById('templateName');
            const templateAutoSave = document.getElementById('templateAutoSave');
            const templateTypeInput = document.getElementById('templateType');
            
            // 重置表單
            templateNameInput.value = '';
            templateAutoSave.checked = false;
            templateTypeInput.value = recordType || '';
            
            // 顯示模態框
            modal.classList.add('active');
        }

        // 保存模板
        function saveTemplate() {
            const templateName = document.getElementById('templateName').value.trim();
            const templateAutoSave = document.getElementById('templateAutoSave').checked;
            const templateType = document.getElementById('templateType').value;
            
            if (!templateName) {
                showToast('請輸入模板名稱', 'error');
                return;
            }
            
            if (!templateType) {
                showToast('請先選擇記錄類型', 'error');
                return;
            }
            
            // 獲取當前表單數據
            let templateData = {};
            
            switch (templateType) {
                case 'feeding':
                    templateData = {
                        feedingType: document.getElementById('feedingType').value,
                        amount: document.getElementById('feedingAmount').value,
                        unit: document.getElementById('feedingUnit').value,
                        note: document.getElementById('feedingNote').value
                    };
                    break;
                
                case 'sleep':
                    templateData = {
                        quality: document.getElementById('sleepQuality').value,
                        note: document.getElementById('sleepNote').value
                    };
                    break;
                
                case 'diaper':
                    templateData = {
                        urine: document.getElementById('diaperUrine').checked,
                        stool: document.getElementById('diaperStool').checked,
                        condition: document.getElementById('diaperCondition').value,
                        note: document.getElementById('diaperNote').value
                    };
                    break;
                
                case 'emotion':
                    templateData = {
                        emotionType: document.getElementById('emotionType').value,
                        intensity: document.getElementById('emotionIntensity').value,
                        note: document.getElementById('emotionNote').value
                    };
                    break;
                
                case 'activity':
                    templateData = {
                        activityType: document.getElementById('activityType').value,
                        duration: document.getElementById('activityDuration').value,
                        note: document.getElementById('activityNote').value
                    };
                    break;
                
                case 'other':
                    templateData = {
                        title: document.getElementById('otherTitle').value,
                        content: document.getElementById('otherContent').value
                    };
                    break;
            }
            
            // 創建新模板
            const newTemplate = {
                id: 'template_' + Date.now(),
                name: templateName,
                type: templateType,
                autoSave: templateAutoSave,
                data: templateData
            };
            
            // 添加到模板列表
            if (!appData.templates) {
                appData.templates = [];
            }
            
            appData.templates.push(newTemplate);
            saveTemplates();
            
            // 更新快速記錄按鈕
            setupQuickRecordButtons();
            
            // 關閉模態框
            closeModals();
            
            // 顯示成功消息
            showToast('模板已成功儲存');
        }

        // 更新兒童選擇器
        function updateChildSelector() {
            const select = document.getElementById('childSelect');
            select.innerHTML = '<option value="">選擇兒童</option>';
            
            appData.children.forEach(child => {
                const option = document.createElement('option');
                option.value = child.id;
                option.textContent = child.name;
                select.appendChild(option);
            });
            
            if (appData.selectedChild) {
                select.value = appData.selectedChild;
            }
        }

        // 檢查是否已選擇兒童
        function checkSelectedChild() {
            const hasSelectedChild = appData.selectedChild !== null;
            updateChildInfo();
            
            // 控制刪除按鈕的顯示
            document.getElementById('deleteChildBtn').style.display = hasSelectedChild ? 'inline-block' : 'none';
            
            // 控制快速記錄區域顯示
            const quickRecordContainer = document.getElementById('quickRecordContainer');
            if (quickRecordContainer) {
                quickRecordContainer.style.display = hasSelectedChild ? 'block' : 'none';
            }
            
            // 更新各頁面顯示
            if (hasSelectedChild) {
                updateHistoryView();
                updateMilestoneView();
                updateGrowthView();
                updateStatsView('week');
            }
        }

        // 更新兒童信息顯示
        function updateChildInfo() {
            const infoElements = document.querySelectorAll('[id$="ChildInfo"]');
            
            if (appData.selectedChild) {
                const child = appData.children.find(c => c.id === appData.selectedChild);
                if (child) {
                    const birthday = new Date(child.birthday);
                    const now = new Date();
                    const ageInMonths = Math.floor((now - birthday) / (30.44 * 24 * 60 * 60 * 1000));
                    const ageYears = Math.floor(ageInMonths / 12);
                    const ageMonths = ageInMonths % 12;
                    
                    let ageDisplay = '';
                    if (ageYears > 0) {
                        ageDisplay = `${ageYears}歲${ageMonths}個月`;
                    } else {
                        ageDisplay = `${ageInMonths}個月`;
                    }
                    
                    infoElements.forEach(element => {
                        element.innerHTML = `
                            <div class="child-info-card">
                                <div class="child-info-name">${child.name}</div>
                                <div class="child-info-details">
                                    <span>${child.gender}</span> | 
                                    <span>${ageDisplay}</span> | 
                                    <span>出生: ${formatDate(child.birthday)}</span>
                                </div>
                                ${child.note ? `<div class="child-info-note">${child.note}</div>` : ''}
                            </div>
                        `;
                    });
                }
            } else {
                infoElements.forEach(element => {
                    element.textContent = '請先選擇或新增一位兒童';
                });
            }
        }

        // 切換標籤頁
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab, .bottom-nav-item').forEach(tab => {
                if (tab.getAttribute('data-tab') === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                if (content.id === tabName + 'Tab') {
                    content.classList.add('active');
                    
                    // 更新對應標籤頁的資料
                    if (tabName === 'history') {
                        updateHistoryView();
                    } else if (tabName === 'milestone') {
                        updateMilestoneView();
                    } else if (tabName === 'growth') {
                        updateGrowthView();
                    } else if (tabName === 'stats') {
                        updateStatsView('week');
                    }
                } else {
                    content.classList.remove('active');
                }
            });
        }

        // 儲存兒童資料
        function saveChild() {
            const name = document.getElementById('childName').value.trim();
            const birthday = document.getElementById('childBirthday').value;
            const gender = document.getElementById('childGender').value;
            const note = document.getElementById('childNote').value.trim();
            
            if (!name || !birthday) {
                showToast('請填寫姓名和出生日期', 'error');
                return;
            }
            
            const childId = 'child_' + Date.now();
            const newChild = {
                id: childId,
                name,
                birthday,
                gender,
                note
            };
            
            appData.children.push(newChild);
            saveChildren();
            
            // 初始化新兒童的記錄和里程碑資料
            appData.records[childId] = [];
            saveRecords(childId);
            initMilestones(childId);
            
            // 初始化成長記錄和疫苗記錄
            appData.growth[childId] = [];
            saveGrowth(childId);
            initVaccines(childId);
            
            // 更新選擇器並選擇新兒童
            updateChildSelector();
            selectChild(childId);
            
            // 關閉模態框
            closeModals();
            
            // 顯示成功訊息
            showToast('兒童資料已成功新增');
        }

        // 選擇兒童
        function selectChild(childId) {
            appData.selectedChild = childId;
            localStorage.setItem('selectedChild', childId);
            
            if (childId) {
                loadChildData(childId);
            }
            
            updateChildInfo();
            updateHistoryView();
            updateMilestoneView();
            updateGrowthView();
            updateStatsView('week');
            
            // 控制刪除按鈕的顯示
            document.getElementById('deleteChildBtn').style.display = childId ? 'inline-block' : 'none';
            
            // 控制快速記錄區域顯示
            const quickRecordContainer = document.getElementById('quickRecordContainer');
            if (quickRecordContainer) {
                quickRecordContainer.style.display = childId ? 'block' : 'none';
            }
            
            // 更新快速記錄按鈕
            setupQuickRecordButtons();
        }

        // 切換記錄表單
        function switchRecordForm(recordType) {
            document.querySelectorAll('.record-type-btn').forEach(btn => {
                if (btn.getAttribute('data-record-type') === recordType) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            document.querySelectorAll('.record-form').forEach(form => {
                form.style.display = 'none';
            });
            
            document.getElementById(recordType + 'Form').style.display = 'block';
        }
        // 改進記錄驗證和儲存功能
        function saveRecord(recordType) {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童', 'error');
                return;
            }
            
            const recordId = 'record_' + Date.now();
            let record = {
                id: recordId,
                type: recordType,
                date: new Date().toISOString()
            };
            
            let isValid = true;
            let errorMessage = '';
            
            // 根據記錄類型收集和驗證資料
            switch (recordType) {
                case 'feeding':
                    const feedingType = document.getElementById('feedingType').value;
                    const feedingAmount = document.getElementById('feedingAmount').value;
                    const feedingUnit = document.getElementById('feedingUnit').value;
                    const feedingTime = document.getElementById('feedingTime').value;
                    const feedingNote = document.getElementById('feedingNote').value;
                    
                    // 驗證必填欄位
                    if (!feedingTime) {
                        isValid = false;
                        errorMessage = '請選擇餵食時間';
                    } else if (!feedingAmount && feedingType !== '母乳') {
                        // 奶量只在非母乳情況下必填
                        isValid = false;
                        errorMessage = '請填寫餵食量';
                    }
                    
                    record.feedingType = feedingType;
                    record.amount = feedingAmount;
                    record.unit = feedingUnit;
                    record.time = feedingTime;
                    record.note = feedingNote;
                    break;
                    
                case 'sleep':
                    const sleepStart = document.getElementById('sleepStart').value;
                    const sleepEnd = document.getElementById('sleepEnd').value;
                    const sleepQuality = document.getElementById('sleepQuality').value;
                    const sleepNote = document.getElementById('sleepNote').value;
                    
                    // 驗證必填欄位及時間邏輯
                    if (!sleepStart) {
                        isValid = false;
                        errorMessage = '請選擇睡眠開始時間';
                    } else if (!sleepEnd) {
                        isValid = false;
                        errorMessage = '請選擇睡眠結束時間';
                    } else if (new Date(sleepEnd) <= new Date(sleepStart)) {
                        isValid = false;
                        errorMessage = '睡眠結束時間必須晚於開始時間';
                    }
                    
                    record.startTime = sleepStart;
                    record.endTime = sleepEnd;
                    record.quality = sleepQuality;
                    record.note = sleepNote;
                    break;
                    
                case 'diaper':
                    const diaperUrine = document.getElementById('diaperUrine').checked;
                    const diaperStool = document.getElementById('diaperStool').checked;
                    const diaperCondition = document.getElementById('diaperCondition').value;
                    const diaperTime = document.getElementById('diaperTime').value;
                    const diaperNote = document.getElementById('diaperNote').value;
                    
                    // 驗證必填欄位和邏輯
                    if (!diaperTime) {
                        isValid = false;
                        errorMessage = '請選擇尿布更換時間';
                    } else if (!diaperUrine && !diaperStool) {
                        isValid = false;
                        errorMessage = '請至少選擇一種排泄類型';
                    } else if (diaperCondition === '異常' && !diaperNote.trim()) {
                        isValid = false;
                        errorMessage = '狀況為異常時，請提供備註說明';
                    }
                    
                    record.urine = diaperUrine;
                    record.stool = diaperStool;
                    record.condition = diaperCondition;
                    record.time = diaperTime;
                    record.note = diaperNote;
                    break;
                    
                case 'emotion':
                    const emotionType = document.getElementById('emotionType').value;
                    const emotionIntensity = document.getElementById('emotionIntensity').value;
                    const emotionTime = document.getElementById('emotionTime').value;
                    const emotionNote = document.getElementById('emotionNote').value;
                    
                    // 驗證必填欄位
                    if (!emotionTime) {
                        isValid = false;
                        errorMessage = '請選擇情緒發生時間';
                    } else if (!emotionType) {
                        isValid = false;
                        errorMessage = '請選擇情緒類型';
                    }
                    
                    record.emotionType = emotionType;
                    record.intensity = emotionIntensity;
                    record.time = emotionTime;
                    record.note = emotionNote;
                    break;
                    
                case 'activity':
                    const activityType = document.getElementById('activityType').value;
                    const activityDuration = document.getElementById('activityDuration').value;
                    const activityTime = document.getElementById('activityTime').value;
                    const activityNote = document.getElementById('activityNote').value;
                    
                    // 驗證必填欄位
                    if (!activityTime) {
                        isValid = false;
                        errorMessage = '請選擇活動時間';
                    } else if (!activityType) {
                        isValid = false;
                        errorMessage = '請選擇活動類型';
                    } else if (!activityDuration) {
                        isValid = false;
                        errorMessage = '請填寫活動持續時間';
                    }
                    
                    record.activityType = activityType;
                    record.duration = activityDuration;
                    record.time = activityTime;
                    record.note = activityNote;
                    break;
                    
                case 'other':
                    const otherTitle = document.getElementById('otherTitle').value;
                    const otherContent = document.getElementById('otherContent').value;
                    const otherTime = document.getElementById('otherTime').value;
                    
                    // 驗證必填欄位
                    if (!otherTime) {
                        isValid = false;
                        errorMessage = '請選擇時間';
                    } else if (!otherTitle.trim()) {
                        isValid = false;
                        errorMessage = '請填寫標題';
                    }
                    
                    record.title = otherTitle;
                    record.content = otherContent;
                    record.time = otherTime;
                    break;
            }
            
            // 如果驗證失敗，顯示錯誤訊息並返回
            if (!isValid) {
                showToast(errorMessage, 'error');
                return;
            }
            
            // 添加記錄
            if (!appData.records[appData.selectedChild]) {
                appData.records[appData.selectedChild] = [];
            }
            
            appData.records[appData.selectedChild].push(record);
            saveRecords(appData.selectedChild);
            
            // 清空表單
            resetRecordForm(recordType);
            
            // 顯示成功訊息
            showToast('記錄已成功儲存');
            
            // 即時更新相關視圖
            updateHistoryView();
            updateStatsView('week');
            
            // 如果添加的是成長記錄，更新成長視圖
            if (recordType === 'growth') {
                updateGrowthView();
            }
            
            return record; // 返回記錄對象，便於進一步處理或測試
        }

        // 重置記錄表單
        function resetRecordForm(recordType) {
            // 設定當前時間
            const now = new Date();
            const isoString = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                .toISOString()
                .slice(0, 16);
            
            switch (recordType) {
                case 'feeding':
                    document.getElementById('feedingAmount').value = '';
                    document.getElementById('feedingTime').value = isoString;
                    document.getElementById('feedingNote').value = '';
                    break;
                    
                case 'sleep':
                    document.getElementById('sleepStart').value = isoString;
                    document.getElementById('sleepEnd').value = isoString;
                    document.getElementById('sleepQuality').value = '3';
                    resetRating('sleepQualityRating', 3);
                    document.getElementById('sleepNote').value = '';
                    break;
                    
                case 'diaper':
                    document.getElementById('diaperUrine').checked = true;
                    document.getElementById('diaperStool').checked = false;
                    document.getElementById('diaperCondition').value = '正常';
                    document.getElementById('diaperTime').value = isoString;
                    document.getElementById('diaperNote').value = '';
                    break;
                    
                case 'emotion':
                    document.getElementById('emotionType').value = '開心';
                    document.getElementById('emotionIntensity').value = '3';
                    resetRating('emotionIntensityRating', 3);
                    document.getElementById('emotionTime').value = isoString;
                    document.getElementById('emotionNote').value = '';
                    break;
                    
                case 'activity':
                    document.getElementById('activityType').value = '遊戲';
                    document.getElementById('activityDuration').value = '';
                    document.getElementById('activityTime').value = isoString;
                    document.getElementById('activityNote').value = '';
                    break;
                    
                case 'other':
                    document.getElementById('otherTitle').value = '';
                    document.getElementById('otherContent').value = '';
                    document.getElementById('otherTime').value = isoString;
                    break;
            }
        }

        // 重置評分系統
        function resetRating(ratingId, value) {
            const ratingGroup = document.getElementById(ratingId);
            if (!ratingGroup) return;
            
            ratingGroup.querySelectorAll('.rating-star').forEach(star => {
                const starValue = parseInt(star.getAttribute('data-value'));
                if (starValue <= value) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        // 改進更新記錄函數
        function updateRecord() {
            const modal = document.getElementById('editRecordModal');
            const recordId = modal.getAttribute('data-record-id');
            const modalTitle = document.getElementById('editRecordTitle').textContent;
            
            // 找到要更新的記錄
            const childId = appData.selectedChild;
            const recordIndex = appData.records[childId].findIndex(r => r.id === recordId);
            
            if (recordIndex === -1) {
                showToast('找不到要更新的記錄', 'error');
                return;
            }
            
            const record = appData.records[childId][recordIndex];
            let isValid = true;
            let errorMessage = '';
            
            // 根據記錄類型更新資料並驗證
            switch (record.type) {
                case 'feeding':
                    const feedingType = document.getElementById('editFeedingType').value;
                    const feedingAmount = document.getElementById('editFeedingAmount').value;
                    const feedingUnit = document.getElementById('editFeedingUnit').value;
                    const feedingTime = document.getElementById('editFeedingTime').value;
                    const feedingNote = document.getElementById('editFeedingNote').value;
                    
                    // 驗證必填欄位
                    if (!feedingTime) {
                        isValid = false;
                        errorMessage = '請選擇餵食時間';
                    } else if (!feedingAmount && feedingType !== '母乳') {
                        isValid = false;
                        errorMessage = '請填寫餵食量';
                    }
                    
                    if (isValid) {
                        record.feedingType = feedingType;
                        record.amount = feedingAmount;
                        record.unit = feedingUnit;
                        record.time = feedingTime;
                        record.note = feedingNote;
                    }
                    break;
                    
                case 'sleep':
                    const sleepStart = document.getElementById('editSleepStart').value;
                    const sleepEnd = document.getElementById('editSleepEnd').value;
                    const sleepQuality = document.getElementById('editSleepQuality').value;
                    const sleepNote = document.getElementById('editSleepNote').value;
                    
                    if (!sleepStart) {
                        isValid = false;
                        errorMessage = '請選擇睡眠開始時間';
                    } else if (!sleepEnd) {
                        isValid = false;
                        errorMessage = '請選擇睡眠結束時間';
                    } else if (new Date(sleepEnd) <= new Date(sleepStart)) {
                        isValid = false;
                        errorMessage = '睡眠結束時間必須晚於開始時間';
                    }
                    
                    if (isValid) {
                        record.startTime = sleepStart;
                        record.endTime = sleepEnd;
                        record.quality = sleepQuality;
                        record.note = sleepNote;
                    }
                    break;
                    
                // 其他記錄類型的驗證和更新也需要實現，這裡省略...
                case 'diaper':
                    const diaperUrine = document.getElementById('editDiaperUrine').checked;
                    const diaperStool = document.getElementById('editDiaperStool').checked;
                    const diaperCondition = document.getElementById('editDiaperCondition').value;
                    const diaperTime = document.getElementById('editDiaperTime').value;
                    const diaperNote = document.getElementById('editDiaperNote').value;
                    
                    if (!diaperTime) {
                        isValid = false;
                        errorMessage = '請選擇尿布更換時間';
                    } else if (!diaperUrine && !diaperStool) {
                        isValid = false;
                        errorMessage = '請至少選擇一種排泄類型';
                    } else if (diaperCondition === '異常' && !diaperNote.trim()) {
                        isValid = false;
                        errorMessage = '狀況為異常時，請提供備註說明';
                    }
                    
                    if (isValid) {
                        record.urine = diaperUrine;
                        record.stool = diaperStool;
                        record.condition = diaperCondition;
                        record.time = diaperTime;
                        record.note = diaperNote;
                    }
                    break;
                    
                case 'emotion':
                    const emotionType = document.getElementById('editEmotionType').value;
                    const emotionIntensity = document.getElementById('editEmotionIntensity').value;
                    const emotionTime = document.getElementById('editEmotionTime').value;
                    const emotionNote = document.getElementById('editEmotionNote').value;
                    
                    if (!emotionTime) {
                        isValid = false;
                        errorMessage = '請選擇情緒發生時間';
                    } else if (!emotionType) {
                        isValid = false;
                        errorMessage = '請選擇情緒類型';
                    }
                    
                    if (isValid) {
                        record.emotionType = emotionType;
                        record.intensity = emotionIntensity;
                        record.time = emotionTime;
                        record.note = emotionNote;
                    }
                    break;
                    
                case 'activity':
                    const activityType = document.getElementById('editActivityType').value;
                    const activityDuration = document.getElementById('editActivityDuration').value;
                    const activityTime = document.getElementById('editActivityTime').value;
                    const activityNote = document.getElementById('editActivityNote').value;
                    
                    if (!activityTime) {
                        isValid = false;
                        errorMessage = '請選擇活動時間';
                    } else if (!activityType) {
                        isValid = false;
                        errorMessage = '請選擇活動類型';
                    } else if (!activityDuration) {
                        isValid = false;
                        errorMessage = '請填寫活動持續時間';
                    }
                    
                    if (isValid) {
                        record.activityType = activityType;
                        record.duration = activityDuration;
                        record.time = activityTime;
                        record.note = activityNote;
                    }
                    break;
                    
                case 'other':
                    const otherTitle = document.getElementById('editOtherTitle').value;
                    const otherTime = document.getElementById('editOtherTime').value;
                    const otherContent = document.getElementById('editOtherContent').value;
                    
                    if (!otherTime) {
                        isValid = false;
                        errorMessage = '請選擇時間';
                    } else if (!otherTitle.trim()) {
                        isValid = false;
                        errorMessage = '請填寫標題';
                    }
                    
                    if (isValid) {
                        record.title = otherTitle;
                        record.time = otherTime;
                        record.content = otherContent;
                    }
                    break;
            }
            
            // 如果驗證失敗，顯示錯誤訊息並返回
            if (!isValid) {
                showToast(errorMessage, 'error');
                return;
            }
            
            // 更新記錄
            appData.records[childId][recordIndex] = record;
            saveRecords(childId);
            
            // 關閉模態框並即時更新相關視圖
            closeModals();
            updateHistoryView();
            updateStatsView('week');
            
            // 顯示成功訊息
            showToast('記錄已成功更新');
        }

        // 改進的刪除記錄函數
        function deleteRecord() {
            const modal = document.getElementById('editRecordModal');
            const recordId = modal.getAttribute('data-record-id');
            
            // 確認刪除
            if (!confirm('確定要刪除此記錄嗎？此操作無法復原。')) {
                return;
            }
            
            // 找到要刪除的記錄
            const childId = appData.selectedChild;
            const recordIndex = appData.records[childId].findIndex(r => r.id === recordId);
            
            if (recordIndex === -1) {
                showToast('找不到要刪除的記錄', 'error');
                return;
            }
            
            // 刪除前記錄類型，用於更新相應視圖
            const recordType = appData.records[childId][recordIndex].type;
            
            // 刪除記錄
            appData.records[childId].splice(recordIndex, 1);
            saveRecords(childId);
            
            // 關閉模態框並即時更新相關視圖
            closeModals();
            updateHistoryView();
            updateStatsView('week');
            
            // 如果刪除的是成長記錄，更新成長視圖
            if (recordType === 'growth') {
                updateGrowthView();
            }
            
            // 顯示成功訊息
            showToast('記錄已成功刪除');
        }

        // 改進歷史記錄視圖，使用虛擬滾動以提升大量數據的性能
        function updateHistoryView() {
            const historyContent = document.getElementById('historyContent');
            if (!historyContent) return;
            
            historyContent.innerHTML = '';
            
            if (!appData.selectedChild || !appData.records[appData.selectedChild]) {
                return;
            }
            
            // 獲取篩選條件
            const date = document.getElementById('historyDate')?.value;
            const filterType = document.getElementById('historyFilter')?.value || 'all';
            
            // 篩選記錄
            let filteredRecords = appData.records[appData.selectedChild].filter(record => {
                let recordDate;
                
                // 依照記錄類型獲取日期
                if (record.type === 'feeding' || record.type === 'diaper' || 
                    record.type === 'emotion' || record.type === 'other') {
                    recordDate = record.time ? record.time.split('T')[0] : '';
                } else if (record.type === 'sleep') {
                    recordDate = record.startTime ? record.startTime.split('T')[0] : '';
                } else if (record.type === 'activity') {
                    recordDate = record.time ? record.time.split('T')[0] : '';
                }
                
                // 過濾日期
                const dateMatch = date ? recordDate === date : true;
                
                // 過濾類型
                const typeMatch = filterType === 'all' ? true : record.type === filterType;
                
                return dateMatch && typeMatch;
            });
            
            // 依日期排序（從新到舊）
            filteredRecords.sort((a, b) => {
                let aTime, bTime;
                
                if (a.type === 'feeding' || a.type === 'diaper' || 
                    a.type === 'emotion' || a.type === 'other') {
                    aTime = a.time || '';
                } else if (a.type === 'sleep') {
                    aTime = a.startTime || '';
                } else if (a.type === 'activity') {
                    aTime = a.time || '';
                }
                
                if (b.type === 'feeding' || b.type === 'diaper' || 
                    b.type === 'emotion' || b.type === 'other') {
                    bTime = b.time || '';
                } else if (b.type === 'sleep') {
                    bTime = b.startTime || '';
                } else if (b.type === 'activity') {
                    bTime = b.time || '';
                }
                
                return new Date(bTime) - new Date(aTime);
            });
            
            if (filteredRecords.length === 0) {
                historyContent.innerHTML = '<p class="text-center">此日期無記錄</p>';
                return;
            }
            
            // 依日期分組顯示
            const recordsByDate = {};
            
            filteredRecords.forEach(record => {
                let recordDate;
                
                if (record.type === 'feeding' || record.type === 'diaper' || 
                    record.type === 'emotion' || record.type === 'other') {
                    recordDate = record.time ? record.time.split('T')[0] : '';
                } else if (record.type === 'sleep') {
                    recordDate = record.startTime ? record.startTime.split('T')[0] : '';
                } else if (record.type === 'activity') {
                    recordDate = record.time ? record.time.split('T')[0] : '';
                }
                
                if (!recordsByDate[recordDate]) {
                    recordsByDate[recordDate] = [];
                }
                
                recordsByDate[recordDate].push(record);
            });
            
            // 對日期進行排序（從新到舊）
            const sortedDates = Object.keys(recordsByDate).sort((a, b) => new Date(b) - new Date(a));
            
            // 使用 Intersection Observer 實現虛擬滾動
            const observer = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const dayElement = entry.target;
                        const date = dayElement.getAttribute('data-date');
                        
                        // 如果尚未渲染內容
                        if (!dayElement.querySelector('.history-records')) {
                            renderDayRecords(dayElement, date, recordsByDate[date]);
                        }
                        
                        // 如果已經渲染，可以取消觀察
                        observer.unobserve(dayElement);
                    }
                });
            }, { threshold: 0.1 });
            
            // 創建日期容器但尚不填充記錄
            sortedDates.forEach(date => {
                const dayElement = document.createElement('div');
                dayElement.className = 'history-day';
                dayElement.setAttribute('data-date', date);
                
                const header = document.createElement('div');
                header.className = 'history-day-header';
                header.textContent = formatDate(date);
                dayElement.appendChild(header);
                
                // 添加記錄容器的占位符
                const placeholder = document.createElement('div');
                placeholder.className = 'history-records-placeholder';
                placeholder.style.height = `${recordsByDate[date].length * 70}px`; // 估計高度
                placeholder.innerHTML = `<div class="text-center" style="padding: 20px;">載入中...</div>`;
                dayElement.appendChild(placeholder);
                
                historyContent.appendChild(dayElement);
                observer.observe(dayElement);
            });
        }

        // 渲染單天的歷史記錄
        function renderDayRecords(dayElement, date, records) {
            // 移除占位符
            const placeholder = dayElement.querySelector('.history-records-placeholder');
            if (placeholder) {
                dayElement.removeChild(placeholder);
            }
            
            // 建立記錄容器
            const recordsContainer = document.createElement('div');
            recordsContainer.className = 'history-records';
            
            // 填充記錄
            records.forEach(record => {
                const recordElement = document.createElement('div');
                recordElement.className = `history-record record-color-${record.type}`;
                recordElement.setAttribute('data-record-id', record.id);
                recordElement.addEventListener('click', () => showEditRecordModal(record));
                
                // 獲取時間
                let recordTime;
                if (record.type === 'feeding' || record.type === 'diaper' || 
                    record.type === 'emotion' || record.type === 'other') {
                    recordTime = record.time ? record.time.split('T')[1].substr(0, 5) : '';
                } else if (record.type === 'sleep') {
                    recordTime = record.startTime ? record.startTime.split('T')[1].substr(0, 5) : '';
                } else if (record.type === 'activity') {
                    recordTime = record.time ? record.time.split('T')[1].substr(0, 5) : '';
                }
                
                let recordTypeDisplay = '';
                let recordInfo = '';
                
                // 依照記錄類型顯示內容
                switch (record.type) {
                    case 'feeding':
                        recordTypeDisplay = `<span class="record-icon record-icon-feeding"><i class="fas fa-utensils"></i></span> 餵食`;
                        recordInfo = `${record.feedingType || ''} ${record.amount || ''} ${record.unit || ''}`;
                        break;
                        
                    case 'sleep':
                        recordTypeDisplay = `<span class="record-icon record-icon-sleep"><i class="fas fa-bed"></i></span> 睡眠`;
                        const startTime = record.startTime ? record.startTime.split('T')[1].substr(0, 5) : '';
                        const endTime = record.endTime ? record.endTime.split('T')[1].substr(0, 5) : '';
                        const duration = calculateDuration(record.startTime, record.endTime);
                        recordInfo = `${startTime} - ${endTime} (${duration}) | 品質: ${record.quality || ''}/5`;
                        break;
                        
                    case 'diaper':
                        recordTypeDisplay = `<span class="record-icon record-icon-diaper"><i class="fas fa-baby"></i></span> 尿布`;
                        const diaperType = [];
                        if (record.urine) diaperType.push('小便');
                        if (record.stool) diaperType.push('大便');
                        recordInfo = `${diaperType.join('、')} | ${record.condition || ''}`;
                        break;
                        
                    case 'emotion':
                        recordTypeDisplay = `<span class="record-icon record-icon-emotion"><i class="fas fa-smile"></i></span> 情緒`;
                        recordInfo = `${record.emotionType || ''} | 強度: ${record.intensity || ''}/5`;
                        break;
                        
                    case 'activity':
                        recordTypeDisplay = `<span class="record-icon record-icon-activity"><i class="fas fa-walking"></i></span> 活動`;
                        recordInfo = `${record.activityType || ''} | ${record.duration || ''} 分鐘`;
                        break;
                        
                    case 'other':
                        recordTypeDisplay = `<span class="record-icon record-icon-other"><i class="fas fa-plus-circle"></i></span> 其他`;
                        recordInfo = record.title || '';
                        break;
                }
                
                recordElement.innerHTML = `
                    <div class="history-record-time">${recordTime}</div>
                    <div class="history-record-type">${recordTypeDisplay}</div>
                    <div class="history-record-info">${recordInfo}</div>
                `;
                
                recordsContainer.appendChild(recordElement);
            });
            
            dayElement.appendChild(recordsContainer);
            
            // 添加淡入效果
            recordsContainer.classList.add('fade-in');
        }

        // 顯示編輯記錄模態框
        function showEditRecordModal(record) {
            const modal = document.getElementById('editRecordModal');
            const modalBody = document.getElementById('editRecordBody');
            const modalTitle = document.getElementById('editRecordTitle');
            
            // 設定記錄ID
            modal.setAttribute('data-record-id', record.id);
            
            // 依記錄類型顯示不同的編輯表單
            switch (record.type) {
                case 'feeding':
                    modalTitle.textContent = '編輯餵食記錄';
                    modalBody.innerHTML = `
                        <div class="form-group">
                            <label for="editFeedingType">餵食類型</label>
                            <select id="editFeedingType" class="form-control">
                                <option value="母乳" ${record.feedingType === '母乳' ? 'selected' : ''}>母乳</option>
                                <option value="配方奶" ${record.feedingType === '配方奶' ? 'selected' : ''}>配方奶</option>
                                <option value="副食品" ${record.feedingType === '副食品' ? 'selected' : ''}>副食品</option>
                                <option value="水果" ${record.feedingType === '水果' ? 'selected' : ''}>水果</option>
                                <option value="水/飲料" ${record.feedingType === '水/飲料' ? 'selected' : ''}>水/飲料</option>
                                <option value="其他" ${record.feedingType === '其他' ? 'selected' : ''}>其他</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="editFeedingAmount">數量/時間</label>
                                    <div style="display: flex; align-items: center;">
                                        <input type="number" id="editFeedingAmount" class="form-control" style="flex: 1; margin-right: 10px;" value="${record.amount || ''}">
                                        <select id="editFeedingUnit" class="form-control" style="width: 80px;">
                                            <option value="ml" ${record.unit === 'ml' ? 'selected' : ''}>毫升</option>
                                            <option value="min" ${record.unit === 'min' ? 'selected' : ''}>分鐘</option>
                                            <option value="份" ${record.unit === '份' ? 'selected' : ''}>份</option>
                                            <option value="湯匙" ${record.unit === '湯匙' ? 'selected' : ''}>湯匙</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editFeedingTime">時間</label>
                            <input type="datetime-local" id="editFeedingTime" class="form-control" value="${record.time || ''}">
                        </div>
                        <div class="form-group">
                            <label for="editFeedingNote">備註</label>
                            <textarea id="editFeedingNote" class="form-control" rows="3">${record.note || ''}</textarea>
                        </div>
                    `;
                    break;
                    
                case 'sleep':
                    modalTitle.textContent = '編輯睡眠記錄';
                    modalBody.innerHTML = `
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="editSleepStart">開始時間</label>
                                    <input type="datetime-local" id="editSleepStart" class="form-control" value="${record.startTime || ''}">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="editSleepEnd">結束時間</label>
                                    <input type="datetime-local" id="editSleepEnd" class="form-control" value="${record.endTime || ''}">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editSleepQuality">睡眠品質 (1-5分)</label>
                            <div class="rating" id="editSleepQualityRating">
                                <span class="rating-star ${parseInt(record.quality) >= 1 ? 'active' : ''}" data-value="1"><i class="fas fa-star"></i></span>
                                <span class="rating-star ${parseInt(record.quality) >= 2 ? 'active' : ''}" data-value="2"><i class="fas fa-star"></i></span>
                                <span class="rating-star ${parseInt(record.quality) >= 3 ? 'active' : ''}" data-value="3"><i class="fas fa-star"></i></span>
                                <span class="rating-star ${parseInt(record.quality) >= 4 ? 'active' : ''}" data-value="4"><i class="fas fa-star"></i></span>
                                <span class="rating-star ${parseInt(record.quality) >= 5 ? 'active' : ''}" data-value="5"><i class="fas fa-star"></i></span>
                            </div>
                            <input type="hidden" id="editSleepQuality" value="${record.quality || '3'}">
                        </div>
                        <div class="form-group">
                            <label for="editSleepNote">備註</label>
                            <textarea id="editSleepNote" class="form-control" rows="3">${record.note || ''}</textarea>
                        </div>
                    `;
                    
                    // 添加評分系統事件監聽器
                    setTimeout(() => {
                        document.querySelectorAll('#editSleepQualityRating .rating-star').forEach(star => {
                            star.addEventListener('click', function() {
                                const value = this.getAttribute('data-value');
                                document.getElementById('editSleepQuality').value = value;
                                
                                // 更新星星顯示
                                document.querySelectorAll('#editSleepQualityRating .rating-star').forEach(s => {
                                    if (parseInt(s.getAttribute('data-value')) <= parseInt(value)) {
                                        s.classList.add('active');
                                    } else {
                                        s.classList.remove('active');
                                    }
                                });
                            });
                        });
                    }, 100);
                    break;
                    
                case 'diaper':
                    modalTitle.textContent = '編輯尿布記錄';
                    modalBody.innerHTML = `
                        <div class="form-group">
                            <label>排泄類型</label>
                            <div style="display: flex; gap: 10px;">
                                <label style="display: flex; align-items: center;">
                                    <input type="checkbox" id="editDiaperUrine" ${record.urine ? 'checked' : ''} style="margin-right: 5px;"> 小便
                                </label>
                                <label style="display: flex; align-items: center;">
                                    <input type="checkbox" id="editDiaperStool" ${record.stool ? 'checked' : ''} style="margin-right: 5px;"> 大便
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editDiaperCondition">狀況</label>
                            <select id="editDiaperCondition" class="form-control">
                                <option value="正常" ${record.condition === '正常' ? 'selected' : ''}>正常</option>
                                <option value="異常" ${record.condition === '異常' ? 'selected' : ''}>異常</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editDiaperTime">時間</label>
                            <input type="datetime-local" id="editDiaperTime" class="form-control" value="${record.time || ''}">
                        </div>
                        <div class="form-group">
                            <label for="editDiaperNote">備註</label>
                            <textarea id="editDiaperNote" class="form-control" rows="3">${record.note || ''}</textarea>
                        </div>
                    `;
                    break;
                    
                case 'emotion':
                    modalTitle.textContent = '編輯情緒記錄';
                    modalBody.innerHTML = `
                        <div class="form-group">
                            <label for="editEmotionType">情緒類別</label>
                            <select id="editEmotionType" class="form-control">
                                <option value="開心" ${record.emotionType === '開心' ? 'selected' : ''}>開心</option>
                                <option value="難過" ${record.emotionType === '難過' ? 'selected' : ''}>難過</option>
                                <option value="生氣" ${record.emotionType === '生氣' ? 'selected' : ''}>生氣</option>
                                <option value="害怕" ${record.emotionType === '害怕' ? 'selected' : ''}>害怕</option>
                                <option value="驚訝" ${record.emotionType === '驚訝' ? 'selected' : ''}>驚訝</option>
                                <option value="平靜" ${record.emotionType === '平靜' ? 'selected' : ''}>平靜</option>
                                <option value="其他" ${record.emotionType === '其他' ? 'selected' : ''}>其他</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editEmotionIntensity">強度 (1-5分)</label>
                            <div class="rating" id="editEmotionIntensityRating">
                                <span class="rating-star ${parseInt(record.intensity) >= 1 ? 'active' : ''}" data-value="1"><i class="fas fa-star"></i></span>
                                <span class="rating-star ${parseInt(record.intensity) >= 2 ? 'active' : ''}" data-value="2"><i class="fas fa-star"></i></span>
                                <span class="rating-star ${parseInt(record.intensity) >= 3 ? 'active' : ''}" data-value="3"><i class="fas fa-star"></i></span>
                                <span class="rating-star ${parseInt(record.intensity) >= 4 ? 'active' : ''}" data-value="4"><i class="fas fa-star"></i></span>
                                <span class="rating-star ${parseInt(record.intensity) >= 5 ? 'active' : ''}" data-value="5"><i class="fas fa-star"></i></span>
                            </div>
                            <input type="hidden" id="editEmotionIntensity" value="${record.intensity || '3'}">
                        </div>
                        <div class="form-group">
                            <label for="editEmotionTime">時間</label>
                            <input type="datetime-local" id="editEmotionTime" class="form-control" value="${record.time || ''}">
                        </div>
                        <div class="form-group">
                            <label for="editEmotionNote">備註</label>
                            <textarea id="editEmotionNote" class="form-control" rows="3">${record.note || ''}</textarea>
                        </div>
                    `;
                    
                    // 添加評分系統事件監聽器
                    setTimeout(() => {
                        document.querySelectorAll('#editEmotionIntensityRating .rating-star').forEach(star => {
                            star.addEventListener('click', function() {
                                const value = this.getAttribute('data-value');
                                document.getElementById('editEmotionIntensity').value = value;
                                
                                // 更新星星顯示
                                document.querySelectorAll('#editEmotionIntensityRating .rating-star').forEach(s => {
                                    if (parseInt(s.getAttribute('data-value')) <= parseInt(value)) {
                                        s.classList.add('active');
                                    } else {
                                        s.classList.remove('active');
                                    }
                                });
                            });
                        });
                    }, 100);
                    break;
                    
                case 'activity':
                    modalTitle.textContent = '編輯活動記錄';
                    modalBody.innerHTML = `
                        <div class="form-group">
                            <label for="editActivityType">活動類型</label>
                            <select id="editActivityType" class="form-control">
                                <option value="遊戲" ${record.activityType === '遊戲' ? 'selected' : ''}>遊戲</option>
                                <option value="洗澡" ${record.activityType === '洗澡' ? 'selected' : ''}>洗澡</option>
                                <option value="戶外" ${record.activityType === '戶外' ? 'selected' : ''}>戶外</option>
                                <option value="學習" ${record.activityType === '學習' ? 'selected' : ''}>學習</option>
                                <option value="社交" ${record.activityType === '社交' ? 'selected' : ''}>社交</option>
                                <option value="運動" ${record.activityType === '運動' ? 'selected' : ''}>運動</option>
                                <option value="其他" ${record.activityType === '其他' ? 'selected' : ''}>其他</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editActivityDuration">持續時間 (分鐘)</label>
                            <input type="number" id="editActivityDuration" class="form-control" value="${record.duration || ''}">
                        </div>
                        <div class="form-group">
                            <label for="editActivityTime">開始時間</label>
                            <input type="datetime-local" id="editActivityTime" class="form-control" value="${record.time || ''}">
                        </div>
                        <div class="form-group">
                            <label for="editActivityNote">備註</label>
                            <textarea id="editActivityNote" class="form-control" rows="3">${record.note || ''}</textarea>
                        </div>
                    `;
                    break;
                    
                case 'other':
                    modalTitle.textContent = '編輯其他記錄';
                    modalBody.innerHTML = `
                        <div class="form-group">
                            <label for="editOtherTitle">標題</label>
                            <input type="text" id="editOtherTitle" class="form-control" value="${record.title || ''}">
                        </div>
                        <div class="form-group">
                            <label for="editOtherTime">時間</label>
                            <input type="datetime-local" id="editOtherTime" class="form-control" value="${record.time || ''}">
                        </div>
                        <div class="form-group">
                            <label for="editOtherContent">內容</label>
                            <textarea id="editOtherContent" class="form-control" rows="5">${record.content || ''}</textarea>
                        </div>
                    `;
                    break;
            }
            
            modal.classList.add('active');
        }

        // 更新里程碑視圖
        function updateMilestoneView() {
            const milestoneContent = document.getElementById('milestoneContent');
            if (!milestoneContent) return;
            
            milestoneContent.innerHTML = '';
            
            if (!appData.selectedChild) {
                return;
            }
            
            // 獲取篩選條件
            const filter = document.getElementById('milestoneFilter')?.value || 'all';
            
            // 檢查里程碑數據
            if (!appData.milestones[appData.selectedChild]) {
                initMilestones(appData.selectedChild);
            }
            
            // 生成里程碑HTML
            for (const ageGroup in milestonesDefinition) {
                // 如果有篩選，則跳過不符合的年齡組
                if (filter !== 'all' && filter !== ageGroup) {
                    continue;
                }
                
                const ageGroupElement = document.createElement('div');
                ageGroupElement.className = 'milestone-category';
                
                const ageGroupHeader = document.createElement('h3');
                ageGroupHeader.textContent = getAgeGroupLabel(ageGroup);
                ageGroupElement.appendChild(ageGroupHeader);
                
                for (const category in milestonesDefinition[ageGroup]) {
                    const categoryElement = document.createElement('div');
                    categoryElement.className = 'milestone-subcategory';
                    
                    const categoryHeader = document.createElement('h4');
                    categoryHeader.textContent = category;
                    categoryElement.appendChild(categoryHeader);
                    
                    const milestoneList = document.createElement('ul');
                    milestoneList.className = 'milestone-list';
                    
                    milestonesDefinition[ageGroup][category].forEach(milestone => {
                        const milestoneId = `${ageGroup}_${category}_${milestone.name}`;
                        
                        // 檢查里程碑存在
                        if (!appData.milestones[appData.selectedChild][milestoneId]) {
                            appData.milestones[appData.selectedChild][milestoneId] = {
                                achieved: false,
                                date: ''
                            };
                        }
                        
                        const milestoneData = appData.milestones[appData.selectedChild][milestoneId];
                        
                        const milestoneItem = document.createElement('li');
                        milestoneItem.className = 'milestone-item';
                        
                        const milestoneInfo = document.createElement('div');
                        milestoneInfo.className = 'milestone-info';
                        
                        const milestoneName = document.createElement('div');
                        milestoneName.className = 'milestone-name';
                        milestoneName.textContent = milestone.name;
                        milestoneInfo.appendChild(milestoneName);
                        
                        const milestoneAge = document.createElement('div');
                        milestoneAge.className = 'milestone-age';
                        milestoneAge.textContent = `典型發展年齡: ${milestone.typicalAge}`;
                        milestoneInfo.appendChild(milestoneAge);
                        
                        milestoneItem.appendChild(milestoneInfo);
                        
                        const milestoneStatus = document.createElement('div');
                        milestoneStatus.className = 'milestone-status';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'milestone-checkbox';
                        checkbox.checked = milestoneData.achieved;
                        checkbox.setAttribute('data-milestone-id', milestoneId);
                        checkbox.addEventListener('change', function() {
                            updateMilestoneStatus(milestoneId, this.checked);
                        });
                        milestoneStatus.appendChild(checkbox);
                        
                        const dateInput = document.createElement('input');
                        dateInput.type = 'date';
                        dateInput.className = 'milestone-date';
                        dateInput.value = milestoneData.date;
                        dateInput.disabled = !milestoneData.achieved;
                        dateInput.setAttribute('data-milestone-id', milestoneId);
                        dateInput.addEventListener('change', function() {
                            updateMilestoneDate(milestoneId, this.value);
                        });
                        milestoneStatus.appendChild(dateInput);
                        
                        milestoneItem.appendChild(milestoneStatus);
                        milestoneList.appendChild(milestoneItem);
                    });
                    
                    categoryElement.appendChild(milestoneList);
                    ageGroupElement.appendChild(categoryElement);
                }
                
                milestoneContent.appendChild(ageGroupElement);
            }
        }

        // 獲取年齡組標籤
        function getAgeGroupLabel(ageGroup) {
            switch (ageGroup) {
                case '0-3': return '0-3個月';
                case '4-6': return '4-6個月';
                case '7-9': return '7-9個月';
                case '10-12': return '10-12個月';
                case '13-18': return '13-18個月';
                case '19-24': return '19-24個月';
                default: return ageGroup;
            }
        }

        // 更新里程碑狀態
        function updateMilestoneStatus(milestoneId, achieved) {
            if (!appData.selectedChild) return;
            
            if (!appData.milestones[appData.selectedChild][milestoneId]) {
                appData.milestones[appData.selectedChild][milestoneId] = {
                    achieved: false,
                    date: ''
                };
            }
            
            appData.milestones[appData.selectedChild][milestoneId].achieved = achieved;
            
            // 如果已達成，則設定日期為今天；否則清空日期
            if (achieved) {
                const today = new Date().toISOString().split('T')[0];
                appData.milestones[appData.selectedChild][milestoneId].date = today;
                
                // 更新日期輸入欄位
                const dateInputs = document.querySelectorAll('.milestone-date');
                dateInputs.forEach(input => {
                    if (input.getAttribute('data-milestone-id') === milestoneId) {
                        input.value = today;
                        input.disabled = false;
                    }
                });
            } else {
                appData.milestones[appData.selectedChild][milestoneId].date = '';
                
                // 更新日期輸入欄位
                const dateInputs = document.querySelectorAll('.milestone-date');
                dateInputs.forEach(input => {
                    if (input.getAttribute('data-milestone-id') === milestoneId) {
                        input.value = '';
                        input.disabled = true;
                    }
                });
            }
            
            saveMilestones(appData.selectedChild);
        }

        // 更新里程碑日期
        function updateMilestoneDate(milestoneId, date) {
            if (!appData.selectedChild) return;
            
            if (!appData.milestones[appData.selectedChild][milestoneId]) {
                appData.milestones[appData.selectedChild][milestoneId] = {
                    achieved: true,
                    date: date
                };
            } else {
                appData.milestones[appData.selectedChild][milestoneId].date = date;
            }
            
            saveMilestones(appData.selectedChild);
        }
        
        // 更新睡眠統計圖表，支持深色模式
        function updateSleepChart(records, startDate, endDate) {
            const sleepRecords = records.filter(record => record.type === 'sleep');
            const ctx = document.getElementById('sleepChart');
            
            if (!ctx) return;
            
            // 判斷當前模式是否為深色
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            // 深色模式和淺色模式的顏色配置
            const colors = {
                lightMode: {
                    duration: {
                        background: 'rgba(142, 202, 230, 0.5)',
                        border: 'rgba(142, 202, 230, 1)'
                    },
                    quality: {
                        background: 'rgba(147, 129, 255, 0.5)',
                        border: 'rgba(147, 129, 255, 1)'
                    }
                },
                darkMode: {
                    duration: {
                        background: 'rgba(100, 150, 190, 0.5)',
                        border: 'rgba(100, 150, 190, 1)'
                    },
                    quality: {
                        background: 'rgba(120, 100, 220, 0.5)',
                        border: 'rgba(120, 100, 220, 1)'
                    }
                }
            };
            
            // 選擇當前模式的顏色
            const currentColors = isDarkMode ? colors.darkMode : colors.lightMode;
            
            // 如果沒有記錄，顯示空圖表
            if (sleepRecords.length === 0) {
                if (window.sleepChart) {
                    window.sleepChart.destroy();
                }
                window.sleepChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['無資料'],
                        datasets: [{
                            label: '睡眠時間 (小時)',
                            data: [0],
                            backgroundColor: currentColors.duration.background,
                            borderColor: currentColors.duration.border,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: isDarkMode ? '#e0e0e0' : '#444444'
                                }
                            }
                        }
                    }
                });
                return;
            }
            
            // 按日期分組睡眠記錄並處理數據...
            // (現有的數據處理邏輯)
            const sleepByDate = {};
            const dateLabels = [];
            
            // 生成日期範圍內的所有日期
            const dateRange = [];
            const currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                const dateString = currentDate.toISOString().split('T')[0];
                dateRange.push(dateString);
                sleepByDate[dateString] = {
                    totalDuration: 0,
                    qualitySum: 0,
                    count: 0
                };
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // 計算每日睡眠時間和品質
            sleepRecords.forEach(record => {
                if (!record.startTime || !record.endTime) return;
                
                const startTime = new Date(record.startTime);
                const endTime = new Date(record.endTime);
                const dateString = startTime.toISOString().split('T')[0];
                
                // 計算持續時間（小時）
                const durationHours = (endTime - startTime) / (1000 * 60 * 60);
                
                if (sleepByDate[dateString]) {
                    sleepByDate[dateString].totalDuration += durationHours;
                    sleepByDate[dateString].qualitySum += parseInt(record.quality || 3);
                    sleepByDate[dateString].count++;
                }
            });
            
            // 準備圖表資料
            const durations = [];
            const qualities = [];
            
            dateRange.forEach(date => {
                dateLabels.push(formatDate(date, 'short'));
                
                const sleepData = sleepByDate[date];
                durations.push(sleepData.totalDuration.toFixed(1));
                
                // 計算平均品質
                const avgQuality = sleepData.count > 0 ? (sleepData.qualitySum / sleepData.count) : 0;
                qualities.push(avgQuality.toFixed(1));
            });
            
            // 繪製圖表，使用適合深色/淺色模式的配色
            if (window.sleepChart) {
                window.sleepChart.destroy();
            }
            window.sleepChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dateLabels,
                    datasets: [
                        {
                            label: '睡眠時間 (小時)',
                            data: durations,
                            backgroundColor: currentColors.duration.background,
                            borderColor: currentColors.duration.border,
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: '睡眠品質 (1-5分)',
                            data: qualities,
                            type: 'line',
                            fill: false,
                            borderColor: currentColors.quality.border,
                            backgroundColor: currentColors.quality.background,
                            tension: 0.1,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '睡眠時間 (小時)',
                                color: isDarkMode ? '#e0e0e0' : '#444444'
                            },
                            grid: {
                                color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: isDarkMode ? '#e0e0e0' : '#444444'
                            }
                        },
                        y1: {
                            beginAtZero: true,
                            max: 5,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                                color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            title: {
                                display: true,
                                text: '睡眠品質',
                                color: isDarkMode ? '#e0e0e0' : '#444444'
                            },
                            ticks: {
                                color: isDarkMode ? '#e0e0e0' : '#444444'
                            }
                        },
                        x: {
                            grid: {
                                color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: isDarkMode ? '#e0e0e0' : '#444444'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: isDarkMode ? '#e0e0e0' : '#444444'
                            }
                        }
                    }
                }
            });
        }

        // 更新所有圖表，支持深色模式
        function updateAllCharts() {
            if (appData.selectedChild) {
                // 取得當前視圖的期間設定
                const activeTab = document.querySelector('.stats-period-btn.active');
                const period = activeTab ? activeTab.getAttribute('data-period') : 'week';
                
                // 如果是自訂期間，需要取得日期範圍
                let customDates = null;
                if (period === 'custom') {
                    const startDate = document.getElementById('statsStartDate').value;
                    const endDate = document.getElementById('statsEndDate').value;
                    if (startDate && endDate) {
                        customDates = { startDate, endDate };
                    }
                }
                
                // 更新統計圖表
                updateStatsView(period, customDates);
                
                // 更新成長圖表
                updateGrowthView();
            }
        }

        // 更新統計圖表
        function updateStatsView(period, customDates) {
            if (!appData.selectedChild || !appData.records[appData.selectedChild]) {
                return;
            }
            
            // 設定日期範圍
            let startDate, endDate;
            const today = new Date();
            
            switch (period) {
                case 'week':
                    startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    endDate = today;
                    break;
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
                    endDate = today;
                    break;
                case '3months':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 3, today.getDate());
                    endDate = today;
                    break;
                case 'custom':
                    if (customDates) {
                        startDate = new Date(customDates.startDate);
                        endDate = new Date(customDates.endDate);
                    } else {
                        startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                        endDate = today;
                    }
                    break;
                default:
                    startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    endDate = today;
            }
            
            // 將時間設為當天的 23:59:59 以包含整天
            endDate.setHours(23, 59, 59, 999);
            
            // 篩選在日期範圍內的記錄
            const filteredRecords = appData.records[appData.selectedChild].filter(record => {
                let recordDate;
                
                if (record.type === 'feeding' || record.type === 'diaper' || 
                    record.type === 'emotion' || record.type === 'other') {
                    recordDate = record.time ? new Date(record.time) : null;
                } else if (record.type === 'sleep') {
                    recordDate = record.startTime ? new Date(record.startTime) : null;
                } else if (record.type === 'activity') {
                    recordDate = record.time ? new Date(record.time) : null;
                }
                
                return recordDate && recordDate >= startDate && recordDate <= endDate;
            });
            
            // 更新各統計圖表
            updateSleepChart(filteredRecords, startDate, endDate);
            
            // 其他圖表更新函數
            // updateFeedingChart(filteredRecords, startDate, endDate);
            // updateDiaperChart(filteredRecords, startDate, endDate);
            // updateEmotionChart(filteredRecords, startDate, endDate);
        }

        // 更新成長圖表和疫苗記錄視圖
        function updateGrowthView() {
            // 實現成長圖表更新...
        }

        // 顯示刪除兒童確認模態框
        function showDeleteChildModal() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童', 'error');
                return;
            }
            
            const selectedChild = appData.children.find(child => child.id === appData.selectedChild);
            if (!selectedChild) {
                showToast('找不到選擇的兒童', 'error');
                return;
            }
            
            document.getElementById('deleteChildName').textContent = selectedChild.name;
            document.getElementById('deleteChildModal').classList.add('active');
        }

        // 刪除選定的兒童
        function deleteSelectedChild() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童', 'error');
                closeModals();
                return;
            }
            
            // 從children數組中刪除
            const childIndex = appData.children.findIndex(child => child.id === appData.selectedChild);
            if (childIndex !== -1) {
                appData.children.splice(childIndex, 1);
                saveChildren();
            }
            
            // 刪除相關的記錄和里程碑資料
            localStorage.removeItem(`records_${appData.selectedChild}`);
            localStorage.removeItem(`milestones_${appData.selectedChild}`);
            localStorage.removeItem(`growth_${appData.selectedChild}`);
            localStorage.removeItem(`vaccines_${appData.selectedChild}`);
            
            // 刪除記錄和里程碑的內存中數據
            delete appData.records[appData.selectedChild];
            delete appData.milestones[appData.selectedChild];
            delete appData.growth[appData.selectedChild];
            delete appData.vaccines[appData.selectedChild];
            
            // 清除selectedChild
            appData.selectedChild = null;
            localStorage.removeItem('selectedChild');
            
            // 更新UI
            updateChildSelector();
            updateChildInfo();
            
            // 隱藏快速記錄區域
            const quickRecordContainer = document.getElementById('quickRecordContainer');
            if (quickRecordContainer) {
                quickRecordContainer.style.display = 'none';
            }
            
            // 清空各標籤頁內容
            document.getElementById('historyContent').innerHTML = '';
            
            const milestoneContent = document.getElementById('milestoneContent');
            if (milestoneContent) milestoneContent.innerHTML = '';
            
            const growthRecordsList = document.getElementById('growthRecordsList');
            if (growthRecordsList) growthRecordsList.innerHTML = '';
            
            const vaccineRecordsList = document.getElementById('vaccineRecordsList');
            if (vaccineRecordsList) vaccineRecordsList.innerHTML = '';
            
            // 清空圖表
            if (window.growthChart) window.growthChart.destroy();
            if (window.sleepChart) window.sleepChart.destroy();
            if (window.feedingChart) window.feedingChart.destroy();
            if (window.diaperChart) window.diaperChart.destroy();
            if (window.emotionChart) window.emotionChart.destroy();
            
            closeModals();
            showToast('兒童資料已成功刪除');
        }

        // 改進匯入數據功能
        function importData() {
            if (!importedData) {
                showToast('請先選擇有效的匯入檔案', 'error');
                return;
            }
            
            try {
                // 數據驗證
                if (!importedData.version || !importedData.children || !Array.isArray(importedData.children)) {
                    throw new Error('無效的數據格式');
                }
                
                const importOption = document.querySelector('input[name="importOption"]:checked').value;
                
                // 顯示確認模態框
                const modal = document.getElementById('importConfirmModal');
                const summary = document.getElementById('importSummary');
                const warning = document.getElementById('importWarning');
                
                // 準備摘要信息
                let summaryText = `<p>兒童數量: ${importedData.children.length}</p>`;
                summaryText += `<p>檔案版本: ${importedData.version}</p>`;
                summaryText += `<p>匯出日期: ${formatDateTime(importedData.exportDate)}</p>`;
                
                let recordCount = 0;
                for (const childId in importedData.records) {
                    if (importedData.records[childId] && Array.isArray(importedData.records[childId])) {
                        recordCount += importedData.records[childId].length;
                    }
                }
                summaryText += `<p>記錄總數: ${recordCount}</p>`;
                
                summary.innerHTML = summaryText;
                
                // 準備警告信息
                let warningText = '';
                if (importOption === 'replace') {
                    warningText = '<strong>警告：完全替換模式將刪除所有現有數據，此操作無法撤銷。</strong>';
                } else {
                    // 檢查ID衝突
                    const existingChildIds = appData.children.map(child => child.id);
                    const importChildIds = importedData.children.map(child => child.id);
                    const conflictIds = existingChildIds.filter(id => importChildIds.includes(id));
                    
                    if (conflictIds.length > 0) {
                        warningText = `<strong>注意：有 ${conflictIds.length} 個兒童資料有衝突，將使用新ID匯入這些記錄。</strong>`;
                    }
                }
                
                warning.innerHTML = warningText;
                
                // 顯示確認視窗
                modal.classList.add('active');
                
            } catch (error) {
                showToast(`匯入錯誤: ${error.message}`, 'error');
                console.error('匯入錯誤:', error);
                
                // 重置匯入狀態
                document.getElementById('importFileInput').value = '';
                document.getElementById('importFileName').textContent = '未選擇檔案';
                document.getElementById('importDataBtn').disabled = true;
                importedData = null;
            }
        }

        // 執行實際的匯入操作
        function performImport(importOption) {
            try {
                if (importOption === 'replace') {
                    // 全部替換模式：清除所有現有數據
                    appData.children = [];
                    appData.records = {};
                    appData.milestones = {};
                    appData.growth = {};
                    appData.vaccines = {};
                    appData.selectedChild = null;
                    
                    localStorage.removeItem('selectedChild');
                    
                    // 清除所有兒童的記錄和里程碑
                    const keys = Object.keys(localStorage);
                    keys.forEach(key => {
                        if (key.startsWith('records_') || key.startsWith('milestones_') || 
                            key.startsWith('growth_') || key.startsWith('vaccines_')) {
                            localStorage.removeItem(key);
                        }
                    });
                }
                
                // 匯入兒童數據
                importedData.children.forEach(importChild => {
                    // 檢查是否已存在相同ID的兒童
                    const existingChildIndex = appData.children.findIndex(c => c.id === importChild.id);
                    
                    if (existingChildIndex === -1) {
                        // 如果不存在，直接添加
                        appData.children.push(importChild);
                    } else if (importOption === 'merge') {
                        // 如果存在且為合併模式，生成新ID並添加
                        const newChild = {...importChild};
                        newChild.id = 'child_' + Date.now() + '_import';
                        newChild.name = newChild.name + ' (匯入)';
                        appData.children.push(newChild);
                        
                        // 更新記錄和里程碑中的ID引用
                        if (importedData.records[importChild.id]) {
                            importedData.records[newChild.id] = importedData.records[importChild.id];
                        }
                        if (importedData.milestones[importChild.id]) {
                            importedData.milestones[newChild.id] = importedData.milestones[importChild.id];
                        }
                        if (importedData.growth[importChild.id]) {
                            importedData.growth[newChild.id] = importedData.growth[importChild.id];
                        }
                        if (importedData.vaccines[importChild.id]) {
                            importedData.vaccines[newChild.id] = importedData.vaccines[importChild.id];
                        }
                    }
                    // 如果是replace模式且存在相同ID，會覆蓋原有的
                });
                
                // 儲存兒童數據
                saveChildren();
                
                // 匯入記錄和里程碑
                for (const childId in importedData.records) {
                    if (importedData.records[childId] && Array.isArray(importedData.records[childId])) {
                        // 檢查該兒童是否已被匯入（或已存在）
                        const childExists = appData.children.some(c => c.id === childId);
                        
                        if (childExists) {
                            // 如果是合併模式，與現有記錄合併
                            if (importOption === 'merge' && appData.records[childId]) {
                                appData.records[childId] = [...appData.records[childId], ...importedData.records[childId]];
                            } else {
                                // 否則直接替換/設置
                                appData.records[childId] = importedData.records[childId];
                            }
                            
                            // 儲存到localStorage
                            localStorage.setItem(`records_${childId}`, JSON.stringify(appData.records[childId]));
                        }
                    }
                }
                
                // 匯入里程碑
                for (const childId in importedData.milestones) {
                    if (importedData.milestones[childId]) {
                        // 檢查該兒童是否已被匯入（或已存在）
                        const childExists = appData.children.some(c => c.id === childId);
                        
                        if (childExists) {
                            // 如果是合併模式，與現有里程碑合併
                            if (importOption === 'merge' && appData.milestones[childId]) {
                                appData.milestones[childId] = {...appData.milestones[childId], ...importedData.milestones[childId]};
                            } else {
                                // 否則直接替換/設置
                                appData.milestones[childId] = importedData.milestones[childId];
                            }
                            
                            // 儲存到localStorage
                            localStorage.setItem(`milestones_${childId}`, JSON.stringify(appData.milestones[childId]));
                        }
                    }
                }
                
                // 匯入成長記錄
                for (const childId in importedData.growth) {
                    if (importedData.growth[childId] && Array.isArray(importedData.growth[childId])) {
                        // 檢查該兒童是否已被匯入（或已存在）
                        const childExists = appData.children.some(c => c.id === childId);
                        
                        if (childExists) {
                            // 如果是合併模式，與現有記錄合併
                            if (importOption === 'merge' && appData.growth[childId]) {
                                appData.growth[childId] = [...appData.growth[childId], ...importedData.growth[childId]];
                            } else {
                                // 否則直接替換/設置
                                appData.growth[childId] = importedData.growth[childId];
                            }
                            
                            // 儲存到localStorage
                            localStorage.setItem(`growth_${childId}`, JSON.stringify(appData.growth[childId]));
                        }
                    }
                }
                
                // 匯入疫苗記錄
                for (const childId in importedData.vaccines) {
                    if (importedData.vaccines[childId]) {
                        // 檢查該兒童是否已被匯入（或已存在）
                        const childExists = appData.children.some(c => c.id === childId);
                        
                        if (childExists) {
                            // 如果是合併模式，與現有疫苗記錄合併
                            if (importOption === 'merge' && appData.vaccines[childId]) {
                                appData.vaccines[childId] = {...appData.vaccines[childId], ...importedData.vaccines[childId]};
                            } else {
                                // 否則直接替換/設置
                                appData.vaccines[childId] = importedData.vaccines[childId];
                            }
                            
                            // 儲存到localStorage
                            localStorage.setItem(`vaccines_${childId}`, JSON.stringify(appData.vaccines[childId]));
                        }
                    }
                }
                
                // 匯入設定
                if (importedData.settings && importOption === 'replace') {
                    appData.settings = importedData.settings;
                    saveSettings();
                    
                    // 應用深色模式設定
                    applyDarkMode(appData.settings.darkMode);
                }
                
                // 匯入模板
                if (importedData.templates && Array.isArray(importedData.templates)) {
                    if (importOption === 'merge' && appData.templates) {
                        appData.templates = [...appData.templates, ...importedData.templates];
                    } else {
                        appData.templates = importedData.templates;
                    }
                    saveTemplates();
                }
                
                // 更新UI
                updateChildSelector();
                
                // 如果有兒童被匯入，選擇第一個
                if (appData.children.length > 0 && !appData.selectedChild) {
                    selectChild(appData.children[0].id);
                } else if (appData.selectedChild) {
                    // 重新載入當前選擇的兒童資料
                    updateChildInfo();
                    updateHistoryView();
                    updateMilestoneView();
                    updateGrowthView();
                    updateStatsView('week');
                }
                
                // 重置匯入狀態
                document.getElementById('importFileInput').value = '';
                document.getElementById('importFileName').textContent = '未選擇檔案';
                document.getElementById('importDataBtn').disabled = true;
                importedData = null;
                
                showToast('數據匯入成功！');
                
            } catch (error) {
                showToast(`匯入錯誤: ${error.message}`, 'error');
                console.error('匯入錯誤:', error);
            }
        }

        // 定期備份提醒功能
        function setupBackupReminder() {
            // 檢查上次提醒時間
            let lastReminder = localStorage.getItem('lastBackupReminder');
            const now = new Date().getTime();
            
            // 如果從未提醒或上次提醒已超過7天
            if (!lastReminder || (now - parseInt(lastReminder)) > 7 * 24 * 60 * 60 * 1000) {
                // 檢查是否有足夠的數據需要備份
                let needBackup = false;
                let recordCount = 0;
                
                for (const childId in appData.records) {
                    if (appData.records[childId] && Array.isArray(appData.records[childId])) {
                        recordCount += appData.records[childId].length;
                        if (recordCount > 20) { // 如果記錄超過20條，建議備份
                            needBackup = true;
                            break;
                        }
                    }
                }
                
                if (needBackup) {
                    setTimeout(() => {
                        showToast('建議定期匯出數據進行備份，避免資料遺失', 'info');
                        localStorage.setItem('lastBackupReminder', now.toString());
                    }, 60000); // 等待1分鐘後顯示提醒
                }
            }
        }

        // 檢測系統主題偏好
        function detectSystemTheme() {
            // 如果用戶未設置深色模式偏好，檢查系統主題
            if (!localStorage.getItem('settings')) {
                const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
                
                if (prefersDarkScheme.matches) {
                    appData.settings.darkMode = true;
                    saveSettings();
                    applyDarkMode(true);
                }
                
                // 監聽系統主題變更
                prefersDarkScheme.addEventListener('change', (e) => {
                    appData.settings.darkMode = e.matches;
                    saveSettings();
                    applyDarkMode(e.matches);
                });
            }
        }

        // 匯入文件選擇處理
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                document.getElementById('importFileName').textContent = '未選擇檔案';
                document.getElementById('importDataBtn').disabled = true;
                importedData = null;
                return;
            }
            
            document.getElementById('importFileName').textContent = file.name;
            
            // 讀取文件
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    // 驗證數據格式
                    if (!data.version || !data.children) {
                        throw new Error('無效的數據格式');
                    }
                    
                    importedData = data;
                    document.getElementById('importDataBtn').disabled = false;
                    showToast('檔案已準備好匯入');
                } catch (error) {
                    showToast('無法解析文件: ' + error.message, 'error');
                    document.getElementById('importFileName').textContent = '無效的檔案格式';
                    document.getElementById('importDataBtn').disabled = true;
                    importedData = null;
                }
            };
            reader.readAsText(file);
        }

        // 匯出所有數據
        function exportAllData() {
            // 準備要匯出的數據
            const exportData = {
                version: '1.1',
                exportDate: new Date().toISOString(),
                children: appData.children,
                records: {},
                milestones: {},
                growth: {},
                vaccines: {},
                settings: appData.settings,
                templates: appData.templates
            };
            
            // 收集所有兒童的記錄和里程碑
            appData.children.forEach(child => {
                const childId = child.id;
                
                // 獲取記錄
                if (appData.records[childId]) {
                    exportData.records[childId] = appData.records[childId];
                } else {
                    // 嘗試從localStorage加載
                    const recordsStr = localStorage.getItem(`records_${childId}`);
                    if (recordsStr) {
                        exportData.records[childId] = JSON.parse(recordsStr);
                    } else {
                        exportData.records[childId] = [];
                    }
                }
                
                // 獲取里程碑
                if (appData.milestones[childId]) {
                    exportData.milestones[childId] = appData.milestones[childId];
                } else {
                    // 嘗試從localStorage加載
                    const milestonesStr = localStorage.getItem(`milestones_${childId}`);
                    if (milestonesStr) {
                        exportData.milestones[childId] = JSON.parse(milestonesStr);
                    } else {
                        exportData.milestones[childId] = {};
                    }
                }
                
                // 獲取成長記錄
                if (appData.growth[childId]) {
                    exportData.growth[childId] = appData.growth[childId];
                } else {
                    // 嘗試從localStorage加載
                    const growthStr = localStorage.getItem(`growth_${childId}`);
                    if (growthStr) {
                        exportData.growth[childId] = JSON.parse(growthStr);
                    } else {
                        exportData.growth[childId] = [];
                    }
                }
                
                // 獲取疫苗記錄
                if (appData.vaccines[childId]) {
                    exportData.vaccines[childId] = appData.vaccines[childId];
                } else {
                    // 嘗試從localStorage加載
                    const vaccinesStr = localStorage.getItem(`vaccines_${childId}`);
                    if (vaccinesStr) {
                        exportData.vaccines[childId] = JSON.parse(vaccinesStr);
                    } else {
                        exportData.vaccines[childId] = {};
                    }
                }
            });
            
            // 將數據轉為JSON字符串
            const jsonString = JSON.stringify(exportData, null, 2);
            
            // 創建Blob和下載鏈接
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `寶寶記錄完整備份_${formatDate(new Date())}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('所有數據已成功匯出！');
        }

        // 匯出為CSV
        function exportToCSV() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童', 'error');
                return;
            }
            
            // 獲取篩選條件
            const exportAllTypes = document.getElementById('exportAllTypes').checked;
            const exportAllDates = document.getElementById('exportAllDates').checked;
            
            // 篩選記錄類型
            let selectedTypes = [];
            if (exportAllTypes) {
                selectedTypes = ['feeding', 'sleep', 'diaper', 'emotion', 'activity', 'other'];
            } else {
                document.querySelectorAll('input[name="exportType"]:checked').forEach(checkbox => {
                    selectedTypes.push(checkbox.value);
                });
            }
            
            // 篩選日期範圍
            let startDate, endDate;
            if (exportAllDates) {
                startDate = new Date(0); // 最早日期
                endDate = new Date(); // 現在
            } else {
                startDate = new Date(document.getElementById('exportStartDate').value);
                endDate = new Date(document.getElementById('exportEndDate').value);
                endDate.setHours(23, 59, 59, 999); // 設定為當天結束
            }
            
            // 篩選記錄
            let filteredRecords = appData.records[appData.selectedChild].filter(record => {
                // 檢查記錄類型
                if (!selectedTypes.includes(record.type)) {
                    return false;
                }
                
                // 檢查日期範圍
                let recordDate;
                
                if (record.type === 'feeding' || record.type === 'diaper' || 
                    record.type === 'emotion' || record.type === 'other') {
                    recordDate = record.time ? new Date(record.time) : null;
                } else if (record.type === 'sleep') {
                    recordDate = record.startTime ? new Date(record.startTime) : null;
                } else if (record.type === 'activity') {
                  recordDate = record.time ? new Date(record.time) : null;
                } else if (record.type === 'sleep') {
                    recordDate = record.startTime ? new Date(record.startTime) : null;
                } else if (record.type === 'activity') {
                    recordDate = record.time ? new Date(record.time) : null;
                }
                
                return recordDate && recordDate >= startDate && recordDate <= endDate;
            });
            
            // 如果沒有記錄，顯示提示
            if (filteredRecords.length === 0) {
                showToast('沒有符合條件的記錄', 'error');
                return;
            }
            
            // 生成CSV內容
            let csvContent = '';
            
            // 添加標題行
            csvContent += '記錄類型,日期時間,詳細資訊,備註\n';
            
            // 添加記錄行
            filteredRecords.forEach(record => {
                let recordType = '';
                let dateTime = '';
                let details = '';
                let note = '';
                
                // 處理記錄類型
                switch (record.type) {
                    case 'feeding':
                        recordType = '餵食';
                        dateTime = record.time || '';
                        details = `${record.feedingType || ''}, ${record.amount || ''} ${record.unit || ''}`;
                        note = record.note || '';
                        break;
                        
                    case 'sleep':
                        recordType = '睡眠';
                        dateTime = record.startTime || '';
                        const duration = calculateDuration(record.startTime, record.endTime);
                        details = `開始: ${formatDateTime(record.startTime)}, 結束: ${formatDateTime(record.endTime)}, 持續: ${duration}, 品質: ${record.quality || ''}`;
                        note = record.note || '';
                        break;
                        
                    case 'diaper':
                        recordType = '尿布';
                        dateTime = record.time || '';
                        const diaperType = [];
                        if (record.urine) diaperType.push('小便');
                        if (record.stool) diaperType.push('大便');
                        details = `類型: ${diaperType.join('、')}, 狀況: ${record.condition || ''}`;
                        note = record.note || '';
                        break;
                        
                    case 'emotion':
                        recordType = '情緒';
                        dateTime = record.time || '';
                        details = `類型: ${record.emotionType || ''}, 強度: ${record.intensity || ''}`;
                        note = record.note || '';
                        break;
                        
                    case 'activity':
                        recordType = '活動';
                        dateTime = record.time || '';
                        details = `類型: ${record.activityType || ''}, 持續: ${record.duration || ''} 分鐘`;
                        note = record.note || '';
                        break;
                        
                    case 'other':
                        recordType = '其他';
                        dateTime = record.time || '';
                        details = record.title || '';
                        note = record.content || '';
                        break;
                }
                
                // 替換逗號，避免CSV格式問題
                details = details.replace(/,/g, '，');
                note = note.replace(/,/g, '，');
                
                // 添加記錄行
                csvContent += `${recordType},${dateTime},${details},${note}\n`;
            });
            
            // 觸發下載
            const child = appData.children.find(c => c.id === appData.selectedChild);
            const filename = `${child.name}_記錄_${formatDate(new Date())}.csv`;
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('CSV檔案已成功匯出');
        }

        // 格式化日期
        function formatDate(dateString, format = 'full') {
            const date = new Date(dateString);
            
            if (isNaN(date.getTime())) {
                return '';
            }
            
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            
            if (format === 'short') {
                return `${month}/${day}`;
            } else if (format === 'datetime') {
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${month}/${day} ${hours}:${minutes}`;
            } else {
                return `${year}-${month}-${day}`;
            }
        }

        // 格式化日期時間
        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '';
            
            const date = new Date(dateTimeString);
            
            if (isNaN(date.getTime())) {
                return '';
            }
            
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        // 計算持續時間
        function calculateDuration(startTime, endTime) {
            if (!startTime || !endTime) return '';
            
            const start = new Date(startTime);
            const end = new Date(endTime);
            
            if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                return '';
            }
            
            let diff = end - start; // 毫秒
            
            if (diff < 0) {
                return '時間錯誤';
            }
            
            // 轉換為小時和分鐘
            const hours = Math.floor(diff / (1000 * 60 * 60));
            diff -= hours * (1000 * 60 * 60);
            const minutes = Math.floor(diff / (1000 * 60));
            
            if (hours === 0) {
                return `${minutes}分鐘`;
            } else {
                return `${hours}小時${minutes}分鐘`;
            }
        }

        // 顯示通知吐司訊息
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastIcon = toast.querySelector('.toast-icon');
            const toastMessage = toast.querySelector('.toast-message');
            
            // 設定圖示和訊息
            if (type === 'success') {
                toastIcon.className = 'fas fa-check-circle toast-icon';
                toastIcon.style.color = 'var(--success-color)';
            } else if (type === 'error') {
                toastIcon.className = 'fas fa-exclamation-circle toast-icon';
                toastIcon.style.color = 'var(--danger-color)';
            } else if (type === 'info') {
                toastIcon.className = 'fas fa-info-circle toast-icon';
                toastIcon.style.color = 'var(--primary-color)';
            }
            
            toastMessage.textContent = message;
            
            // 顯示吐司訊息
            toast.classList.add('active');
            
            // 3秒後自動隱藏
            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }

        // 關閉所有模態框
        function closeModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
        }

        // 顯示添加成長記錄模態框
        function showAddGrowthModal() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童', 'error');
                return;
            }
            
            const modal = document.getElementById('addGrowthRecordModal');
            
            // 重置表單
            document.getElementById('growthDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('weightInput').value = '';
            document.getElementById('heightInput').value = '';
            document.getElementById('growthNote').value = '';
            
            // 顯示模態框
            modal.classList.add('active');
        }

        // 儲存成長記錄
        function saveGrowthRecord() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童', 'error');
                return;
            }
            
            const date = document.getElementById('growthDate').value;
            const weight = document.getElementById('weightInput').value;
            const height = document.getElementById('heightInput').value;
            const note = document.getElementById('growthNote').value;
            
            if (!date || !weight || !height) {
                showToast('請填寫日期、體重和身高', 'error');
                return;
            }
            
            // 創建記錄
            const record = {
                id: 'growth_' + Date.now(),
                date: date,
                weight: weight,
                height: height,
                note: note
            };
            
            // 添加記錄
            if (!appData.growth[appData.selectedChild]) {
                appData.growth[appData.selectedChild] = [];
            }
            
            appData.growth[appData.selectedChild].push(record);
            saveGrowth(appData.selectedChild);
            
            // 關閉模態框
            closeModals();
            
            // 更新視圖
            updateGrowthView();
            
            // 顯示成功訊息
            showToast('成長記錄已成功儲存');
        }

        // 顯示添加疫苗記錄模態框
        function showAddVaccineModal() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童', 'error');
                return;
            }
            
            // 尚未實現，留作未來功能
            showToast('此功能開發中', 'info');
        }

        // 執行應用程式初始化
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>  