<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>嬰幼兒照顧輔助工具</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary-color: #8ecae6;
            --secondary-color: #219ebc;
            --accent-color: #ffb703;
            --danger-color: #e76f51;
            --success-color: #52b788;
            --neutral-color: #f8f9fa;
            --text-color: #444444;
            --light-text: #6c757d;
            --border-radius: 10px;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --medical-color: #ff9a8b;
            --growth-color: #98d4bb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f0f5f9;
            color: var(--text-color);
            line-height: 1.6;
        }

        h1, h2, h3, h4, h5, h6 {
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* 頂部標題區域 */
        header {
            background-color: white;
            padding: 1rem;
            box-shadow: var(--shadow);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header-title {
            display: flex;
            align-items: center;
        }

        .header-title img {
            height: 40px;
            margin-right: 10px;
        }

        .header-title h1 {
            font-size: 1.5rem;
            margin: 0;
            color: var(--secondary-color);
        }

        .child-selector {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }

        .child-selector select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            margin-right: 10px;
            min-width: 150px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #429e76;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c85a3f;
        }

        .btn-accent {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-accent:hover {
            background-color: #e29000;
        }

        .btn i {
            margin-right: 5px;
        }

        /* 導航欄 */
        .nav-tabs {
            display: flex;
            background-color: white;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            overflow: hidden;
            box-shadow: var(--shadow);
            flex-wrap: wrap;
        }

        .nav-tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--light-text);
            border-bottom: 3px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.9rem;
            min-width: 100px;
        }

        .nav-tab i {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .nav-tab.active {
            color: var(--secondary-color);
            border-bottom: 3px solid var(--secondary-color);
            background-color: #f0f8ff;
        }

        .nav-tab:hover {
            background-color: #f8f9fa;
        }

        /* 內容區塊 */
        .tab-content {
            display: none;
            background-color: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 60px; /* 為底部導航留出空間 */
        }

        .tab-content.active {
            display: block;
        }

        /* 表單樣式 */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }

        .form-col {
            flex: 1;
            padding: 0 10px;
            min-width: 250px;
        }

        /* 記錄類型選擇 */
        .record-type-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 1.5rem;
        }

        .record-type-btn {
            flex: 1;
            min-width: 80px;
            padding: 10px;
            text-align: center;
            background-color: var(--neutral-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .record-type-btn i {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .record-type-btn.active, .record-type-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* 卡片樣式 */
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--secondary-color);
        }

        /* 里程碑樣式 */
        .milestone-category {
            margin-bottom: 1.5rem;
        }

        .milestone-list {
            list-style: none;
        }

        .milestone-item {
            padding: 10px;
            border-radius: var(--border-radius);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa;
        }

        .milestone-info {
            flex: 1;
        }

        .milestone-name {
            font-weight: 500;
        }

        .milestone-age {
            font-size: 0.9rem;
            color: var(--light-text);
        }

        .milestone-status {
            display: flex;
            align-items: center;
        }

        .milestone-checkbox {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .milestone-date {
            font-size: 0.9rem;
            min-width: 100px;
        }

        /* 歷史記錄樣式 */
        .history-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 10px;
        }

        .history-date-selector {
            display: flex;
            align-items: center;
        }

        .history-filter {
            display: flex;
            gap: 10px;
        }

        .history-day {
            margin-bottom: 1.5rem;
        }

        .history-day-header {
            background-color: var(--neutral-color);
            padding: 10px;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            font-weight: 500;
        }

        .history-records {
            margin-left: 10px;
        }

        .history-record {
            display: flex;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .history-record:last-child {
            border-bottom: none;
        }

        .history-record-time {
            min-width: 60px;
            color: var(--light-text);
        }

        .history-record-type {
            min-width: 100px;
            font-weight: 500;
        }

        .history-record-info {
            flex: 1;
        }

        /* 統計圖表樣式 */
        .stats-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stats-period-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .stats-period-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            background-color: white;
            cursor: pointer;
        }

        .stats-period-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .stats-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .chart-container {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 1rem;
            box-shadow: var(--shadow);
            min-height: 300px;
        }

        /* 匯出樣式 */
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .export-option {
            background-color: var(--neutral-color);
            padding: 1rem;
            border-radius: var(--border-radius);
        }

        .export-date-range {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 1rem;
        }

        /* 底部導航欄 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: white;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            height: 60px; /* 固定高度 */
            overflow-x: auto;
        }

        .bottom-nav-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            font-size: 0.8rem;
            color: var(--light-text);
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-width: 70px;
        }

        .bottom-nav-item i {
            display: block;
            font-size: 1.2rem;
            margin-bottom: 2px;
        }

        .bottom-nav-item.active {
            color: var(--secondary-color);
            background-color: #f0f8ff;
        }

        /* 新增：底部中間快捷按鈕 */
        .bottom-nav-center {
            position: relative;
            width: 70px;
            display: flex;
            justify-content: center;
        }

        .quick-action-btn {
            position: absolute;
            bottom: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 1001;
        }

        /* 底部快捷動作選單 */
        .quick-action-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: white;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -3px 10px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            padding: 20px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .quick-action-menu.active {
            transform: translateY(0);
        }

        .quick-action-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .quick-action-menu-header h3 {
            margin: 0;
        }

        .quick-action-menu-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--light-text);
            cursor: pointer;
        }

        .quick-action-menu-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .quick-action-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-action-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }

        .quick-action-item i {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .quick-action-feeding i { color: #8ecae6; }
        .quick-action-sleep i { color: #9381ff; }
        .quick-action-diaper i { color: #ffb703; }
        .quick-action-other i { color: #6c757d; }

        /* 模態框樣式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--light-text);
        }

        .modal-close:hover {
            color: var(--danger-color);
        }

        .modal-body {
            padding: 1rem;
        }

        .modal-footer {
            padding: 1rem;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* 工具提示和標記 */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .badge-success {
            background-color: var(--success-color);
            color: white;
        }

        .badge-warning {
            background-color: var(--accent-color);
            color: white;
        }

        .badge-danger {
            background-color: var(--danger-color);
            color: white;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }

            .form-col {
                width: 100%;
                padding: 0;
                margin-bottom: 1rem;
            }

            .nav-tabs {
                display: none;
            }

            .bottom-nav {
                display: flex;
            }

            .header-title h1 {
                font-size: 1.2rem;
            }

            .stats-charts {
                grid-template-columns: 1fr;
            }

            .export-options {
                grid-template-columns: 1fr;
            }
        }

        @media (min-width: 769px) {
            .bottom-nav {
                display: none;
            }
        }

        /* 進度條 */
        .progress-container {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 50px;
            height: 10px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }

        /* 評分系統 */
        .rating {
            display: flex;
            gap: 5px;
        }

        .rating-star {
            cursor: pointer;
            font-size: 1.5rem;
            color: #ddd;
        }

        .rating-star.active {
            color: var(--accent-color);
        }

        /* 搜尋框 */
        .search-container {
            display: flex;
            margin-bottom: 1rem;
        }

        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius) 0 0 var(--border-radius);
            font-size: 1rem;
        }

        .search-btn {
            padding: 8px 16px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            cursor: pointer;
        }

        /* 記錄類型特定樣式 */
        .record-color-feeding {
            border-left: 4px solid #8ecae6;
        }

        .record-color-sleep {
            border-left: 4px solid #9381ff;
        }

        .record-color-diaper {
            border-left: 4px solid #ffb703;
        }

        .record-color-emotion {
            border-left: 4px solid #e76f51;
        }

        .record-color-activity {
            border-left: 4px solid #52b788;
        }

        .record-color-other {
            border-left: 4px solid #6c757d;
        }

        .record-color-growth {
            border-left: 4px solid var(--growth-color);
        }

        .record-color-medical {
            border-left: 4px solid var(--medical-color);
        }

        .record-color-medicine {
            border-left: 4px solid #9381ff;
        }

        /* 記錄圖標 */
        .record-icon {
            display: inline-flex;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            color: white;
        }

        .record-icon-feeding {
            background-color: #8ecae6;
        }

        .record-icon-sleep {
            background-color: #9381ff;
        }

        .record-icon-diaper {
            background-color: #ffb703;
        }

        .record-icon-emotion {
            background-color: #e76f51;
        }

        .record-icon-activity {
            background-color: #52b788;
        }

        .record-icon-other {
            background-color: #6c757d;
        }

        .record-icon-growth {
            background-color: var(--growth-color);
        }

        .record-icon-medical {
            background-color: var(--medical-color);
        }

        .record-icon-medicine {
            background-color: #9381ff;
        }

        /* 折線圖設定 */
        .emotion-scale, .sleep-quality-scale {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
        }

        .emotion-scale-item, .sleep-quality-scale-item {
            text-align: center;
            font-size: 0.8rem;
            color: var(--light-text);
        }

        /* 動畫效果 */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        /* 成長日誌 */
        .growth-log-item {
            margin-bottom: 1rem;
        }

        .growth-log-date {
            font-size: 0.9rem;
            color: var(--light-text);
            margin-bottom: 0.25rem;
        }

        .growth-log-content {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: var(--border-radius);
        }

        /* 新增樣式 */
        hr {
            margin: 20px 0;
            border: 0;
            border-top: 1px solid #eee;
        }
        
        .text-danger {
            color: var(--danger-color);
        }

        /* 照顧提示樣式 - 新增 */
        .caretips-controls {
            margin-bottom: 1.5rem;
        }

        .caretips-age-group {
            margin-bottom: 2rem;
        }

        .caretips-age-header {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .caretips-category {
            margin-bottom: 1.5rem;
        }

        .caretips-category-header {
            display: flex;
            align-items: center;
            background-color: var(--neutral-color);
            padding: 10px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            font-weight: 500;
            cursor: pointer;
        }

        .caretips-category-header i {
            margin-right: 10px;
            color: var(--secondary-color);
            font-size: 1.2rem;
        }

        .caretips-category-items {
            padding-left: 15px;
        }

        .caretip-item {
            background-color: white;
            border-left: 4px solid var(--secondary-color);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: var(--shadow);
        }

        .caretip-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--secondary-color);
        }

        .caretip-description {
            color: var(--text-color);
            line-height: 1.6;
        }

        .caretip-item.important {
            border-left-color: var(--danger-color);
        }

        .caretip-item.important .caretip-title {
            color: var(--danger-color);
        }

        .caretip-tag {
            display: inline-block;
            padding: 3px 8px;
            background-color: var(--neutral-color);
            border-radius: 50px;
            font-size: 0.8rem;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .caretip-tag-feeding {
            background-color: #e0f2fe;
            color: #0369a1;
        }

        .caretip-tag-sleep {
            background-color: #e0e7ff;
            color: #4338ca;
        }

        .caretip-tag-activity {
            background-color: #dcfce7;
            color: #15803d;
        }

        .caretip-tag-safety {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        .caretip-tag-health {
            background-color: #ffedd5;
            color: #c2410c;
        }

        .caretip-tag-development {
            background-color: #ddd6fe;
            color: #7e22ce;
        }

        /* 類別圖標樣式 */
        .category-icon-feeding {
            color: #0369a1;
        }

        .category-icon-sleep {
            color: #4338ca;
        }

        .category-icon-activity {
            color: #15803d;
        }

        .category-icon-safety {
            color: #b91c1c;
        }

        .category-icon-health {
            color: #c2410c;
        }

        .category-icon-development {
            color: #7e22ce;
        }

        /* 睡眠計時狀態指示器 */
        .sleep-timer-badge {
            position: fixed;
            left: 20px;
            bottom: 80px;
            background-color: #9381ff;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 1500;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .sleep-timer-badge i {
            font-size: 1.2rem;
        }

        .sleep-timer-badge.active {
            display: flex;
        }

        /* 成功提示框 */
        .toast-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background-color: var(--success-color);
            color: white;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 3000;
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast-notification.active {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast-notification i {
            font-size: 1.2rem;
        }

        /* 快速尿布選項樣式 */
        .diaper-quick-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .diaper-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 10px;
            cursor: pointer;
            flex: 1;
            min-width: 120px;
            transition: all 0.2s ease;
        }

        .diaper-option:hover, .diaper-option.active {
            background-color: var(--accent-color);
            color: white;
        }

        .diaper-option i {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        /* 遮罩層效果 */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            display: none;
        }

        .overlay.active {
            display: block;
        }

        /* 提醒樣式 - 新增 */
        .reminder-list {
            list-style: none;
            padding: 0;
        }

        .reminder-item {
            background-color: white;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
            margin-bottom: 10px;
            padding: 15px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reminder-item.active {
            border-left-color: var(--success-color);
        }

        .reminder-item.expired {
            border-left-color: var(--light-text);
            opacity: 0.7;
        }

        .reminder-info {
            flex: 1;
        }

        .reminder-title {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .reminder-time {
            font-size: 0.9rem;
            color: var(--light-text);
        }

        .reminder-message {
            margin-top: 5px;
            font-size: 0.9rem;
        }

        .reminder-actions {
            display: flex;
            gap: 5px;
        }

        .reminder-type-icon {
            display: inline-flex;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            color: white;
        }

        .reminder-type-feeding {
            background-color: #8ecae6;
        }

        .reminder-type-sleep {
            background-color: #9381ff;
        }

        .reminder-type-medicine {
            background-color: #e76f51;
        }

        .reminder-type-vaccine {
            background-color: #52b788;
        }

        .reminder-type-other {
            background-color: #6c757d;
        }

        .reminder-repeat-options {
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
        }

        .reminder-repeat-toggle {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .reminder-repeat-toggle input {
            margin-right: 8px;
        }

        .reminder-repeat-details {
            display: none;
            margin-top: 10px;
        }

        .reminder-repeat-details.active {
            display: block;
        }

        .reminder-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--danger-color);
            color: white;
            font-size: 0.7rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translate(25%, -25%);
        }

        .reminder-quick-add {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .reminder-quick-add-item {
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .reminder-quick-add-item:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .reminder-quick-add-item i {
            font-size: 24px;
            margin-bottom: 8px;
        }

        /* 提醒通知徽章 */
        .reminder-count-badge {
            position: relative;
        }

        /* 成長記錄樣式 - 新增 */
        .growth-record-form {
            margin-bottom: 20px;
        }

        .growth-record-list {
            margin-top: 20px;
        }

        .growth-record-item {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--growth-color);
        }

        .growth-record-item .record-date {
            font-size: 0.9rem;
            color: var(--light-text);
            margin-bottom: 5px;
        }

        .growth-record-data {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 10px;
        }

        .growth-data-item {
            flex: 1;
            min-width: 120px;
        }

        .growth-data-item h4 {
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: var(--text-color);
        }

        .growth-data-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .growth-data-unit {
            font-size: 0.9rem;
            color: var(--light-text);
        }

        .growth-chart-container {
            margin-top: 30px;
        }

        .growth-chart-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .growth-chart-tab {
            padding: 8px 15px;
            background-color: var(--neutral-color);
            border-radius: var(--border-radius);
            cursor: pointer;
        }

        .growth-chart-tab.active {
            background-color: var(--growth-color);
            color: white;
        }

        /* 醫療記錄樣式 - 新增 */
        .medical-record-form {
            margin-bottom: 20px;
        }

        .medical-record-list {
            margin-top: 20px;
        }

        .medical-record-item {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--medical-color);
        }

        .medical-record-date {
            font-size: 0.9rem;
            color: var(--light-text);
            margin-bottom: 5px;
        }

        .medical-record-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--secondary-color);
            font-size: 1.1rem;
        }

        .medical-record-detail {
            margin-bottom: 8px;
        }

        .medical-record-detail label {
            font-weight: 500;
            margin-right: 5px;
        }

        .medical-record-note {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        /* 藥物記錄樣式 - 新增與改進 */
        .medicine-record-form {
            margin-bottom: 20px;
        }

        .medicine-list {
            margin-top: 20px;
        }

        .medicine-item {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border-left: 4px solid #9381ff;
        }

        .medicine-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .medicine-title {
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 1.1rem;
        }

        .medicine-status {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .medicine-status-active {
            background-color: #dcfce7;
            color: #15803d;
        }

        .medicine-status-completed {
            background-color: #e5e7eb;
            color: #6b7280;
        }

        .medicine-detail {
            margin-bottom: 8px;
        }

        .medicine-detail label {
            font-weight: 500;
            margin-right: 5px;
        }

        .medicine-dose-history {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .medicine-dose-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .medicine-dose-date {
            font-size: 0.9rem;
        }

        .medicine-dose-status {
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 20px;
            background-color: #e5e7eb;
        }

        .medicine-dose-taken {
            background-color: #dcfce7;
            color: #15803d;
        }

        .medicine-dose-missed {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        .medicine-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* 新增：服用紀錄核取表 */
        .medicine-checklist {
            margin-top: 15px;
        }

        .medicine-checklist-title {
            font-weight: 500;
            margin-bottom: 10px;
        }

        .medicine-checklist-day {
            margin-bottom: 15px;
        }

        .medicine-checklist-date {
            font-weight: 500;
            margin-bottom: 5px;
            padding: 5px 10px;
            background-color: #f0f5f9;
            border-radius: var(--border-radius);
        }

        .medicine-checklist-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .medicine-checklist-item {
            flex: 1;
            min-width: 120px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            text-align: center;
        }

        .medicine-checklist-item.taken {
            background-color: #dcfce7;
            color: #15803d;
        }

        .medicine-checklist-item.missed {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        .medicine-checklist-time {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .medicine-checklist-status {
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .tab-badge {
            position: relative;
        }

        .tab-badge::after {
            content: attr(data-count);
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            font-size: 0.7rem;
            min-width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px;
        }

        /* 藥物管理樣式 */
        .medicine-management-section {
            margin-top: 30px;
        }

        .medicine-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .medicine-filter-btn {
            padding: 8px 15px;
            background-color: var(--neutral-color);
            border-radius: var(--border-radius);
            cursor: pointer;
        }

        .medicine-filter-btn.active {
            background-color: #9381ff;
            color: white;
        }

        /* 切換開關樣式 */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--success-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* 標籤樣式 */
        .tabs-container {
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .tab {
            padding: 8px 15px;
            cursor: pointer;
            white-space: nowrap;
        }

        .tab.active {
            color: var(--secondary-color);
            border-bottom: 2px solid var(--secondary-color);
        }

        /* 標準值參考樣式 */
        .reference-values {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f8ff;
            border-radius: var(--border-radius);
        }

        .reference-values h4 {
            margin-bottom: 10px;
            color: var(--secondary-color);
        }

        .reference-table {
            width: 100%;
            border-collapse: collapse;
        }

        .reference-table th, .reference-table td {
            padding: 8px 12px;
            border: 1px solid #ddd;
            text-align: left;
        }

        .reference-table th {
            background-color: var(--primary-color);
            color: white;
        }

        .reference-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        /* 百分位數標記樣式 */
        .percentile-marker {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .percentile-p3 {
            background-color: #fee2e2;
        }

        .percentile-p15 {
            background-color: #fef3c7;
        }

        .percentile-p50 {
            background-color: #ecfccb;
        }

        .percentile-p85 {
            background-color: #dbeafe;
        }

        .percentile-p97 {
            background-color: #e0e7ff;
        }

        .percentile-legend {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .percentile-legend-item {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 頂部標題區域 -->
        <header>
            <div class="header-title">
                <i class="fas fa-baby" style="font-size: 24px; margin-right: 10px; color: var(--accent-color);"></i>
                <h1>嬰幼兒照顧輔助工具</h1>
            </div>
            <div class="child-selector">
                <select id="childSelect">
                    <option value="">選擇兒童</option>
                </select>
                <button id="addChildBtn" class="btn btn-primary">
                    <i class="fas fa-plus"></i> 新增兒童
                </button>
                <button id="deleteChildBtn" class="btn btn-danger" style="margin-left: 10px;">
                    <i class="fas fa-trash"></i> 刪除
                </button>
            </div>
        </header>

        <!-- 頂部導航欄 - 添加照顧提示標籤 -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="record">
                <i class="fas fa-pen"></i>
                <span>記錄</span>
            </div>
            <div class="nav-tab" data-tab="history">
                <i class="fas fa-history"></i>
                <span>歷史</span>
            </div>
            <div class="nav-tab" data-tab="reminder">
                <i class="fas fa-bell reminder-count-badge"></i>
                <span>提醒</span>
            </div>
            <div class="nav-tab" data-tab="medicine">
                <i class="fas fa-pills"></i>
                <span>用藥</span>
            </div>
            <div class="nav-tab" data-tab="growth">
                <i class="fas fa-chart-line"></i>
                <span>成長</span>
            </div>
            <div class="nav-tab" data-tab="medical">
                <i class="fas fa-hospital"></i>
                <span>就醫</span>
            </div>
            <div class="nav-tab" data-tab="milestone">
                <i class="fas fa-flag"></i>
                <span>里程碑</span>
            </div>
            <div class="nav-tab" data-tab="stats">
                <i class="fas fa-chart-bar"></i>
                <span>統計</span>
            </div>
            <div class="nav-tab" data-tab="caretips">
                <i class="fas fa-lightbulb"></i>
                <span>照顧提示</span>
            </div>
            <div class="nav-tab" data-tab="export">
                <i class="fas fa-file-export"></i>
                <span>匯出</span>
            </div>
        </div>

        <!-- 內容區域 -->
        <div id="recordTab" class="tab-content active">
            <h2>新增記錄</h2>
            <p id="currentChildInfo">請先選擇或新增一位兒童</p>

            <div class="record-type-selector">
                <div class="record-type-btn active" data-record-type="feeding">
                    <i class="fas fa-utensils"></i>
                    <span>餵食</span>
                </div>
                <div class="record-type-btn" data-record-type="sleep">
                    <i class="fas fa-bed"></i>
                    <span>睡眠</span>
                </div>
                <div class="record-type-btn" data-record-type="diaper">
                    <i class="fas fa-baby"></i>
                    <span>尿布</span>
                </div>
                <div class="record-type-btn" data-record-type="emotion">
                    <i class="fas fa-smile"></i>
                    <span>情緒</span>
                </div>
                <div class="record-type-btn" data-record-type="activity">
                    <i class="fas fa-walking"></i>
                    <span>活動</span>
                </div>
                <div class="record-type-btn" data-record-type="other">
                    <i class="fas fa-plus-circle"></i>
                    <span>其他</span>
                </div>
            </div>

            <!-- 餵食記錄表單 -->
            <div id="feedingForm" class="record-form active">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="feedingType">餵食類型</label>
                            <select id="feedingType" class="form-control">
                                <option value="母乳">母乳</option>
                                <option value="配方奶">配方奶</option>
                                <option value="副食品">副食品</option>
                                <option value="水果">水果</option>
                                <option value="水/飲料">水/飲料</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="feedingAmount">數量/時間</label>
                            <div style="display: flex; align-items: center;">
                                <input type="number" id="feedingAmount" class="form-control" style="flex: 1; margin-right: 10px;">
                                <select id="feedingUnit" class="form-control" style="width: 80px;">
                                    <option value="ml">毫升</option>
                                    <option value="min">分鐘</option>
                                    <option value="份">份</option>
                                    <option value="湯匙">湯匙</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="feedingTime">時間</label>
                            <input type="datetime-local" id="feedingTime" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="feedingNote">備註</label>
                            <textarea id="feedingNote" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="feedingSetReminder" style="margin-right: 5px;"> 設定下次餵食提醒
                    </label>
                    <div id="feedingReminderOptions" style="margin-top: 10px; display: none;">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="feedingReminderTime">提醒時間</label>
                                    <select id="feedingReminderInterval" class="form-control">
                                        <option value="2">2小時後</option>
                                        <option value="3" selected>3小時後</option>
                                        <option value="4">4小時後</option>
                                        <option value="custom">自訂時間</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col" id="feedingCustomTimeCol" style="display: none;">
                                <div class="form-group">
                                    <label for="feedingCustomTime">自訂時間</label>
                                    <input type="datetime-local" id="feedingCustomTime" class="form-control">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <button id="saveFeedingBtn" class="btn btn-primary">
                    <i class="fas fa-save"></i> 儲存記錄
                </button>
            </div>

            <!-- 睡眠記錄表單 -->
            <div id="sleepForm" class="record-form" style="display: none;">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="sleepStart">開始時間</label>
                            <input type="datetime-local" id="sleepStart" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="sleepEnd">結束時間</label>
                            <input type="datetime-local" id="sleepEnd" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="sleepQuality">睡眠品質 (1-5分)</label>
                            <div class="rating" id="sleepQualityRating">
                                <span class="rating-star" data-value="1"><i class="fas fa-star"></i></span>
                                <span class="rating-star" data-value="2"><i class="fas fa-star"></i></span>
                                <span class="rating-star" data-value="3"><i class="fas fa-star"></i></span>
                                <span class="rating-star" data-value="4"><i class="fas fa-star"></i></span>
                                <span class="rating-star" data-value="5"><i class="fas fa-star"></i></span>
                            </div>
                            <input type="hidden" id="sleepQuality" value="3">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="sleepNote">備註</label>
                            <textarea id="sleepNote" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="sleepSetReminder" style="margin-right: 5px;"> 設定下次睡眠提醒
                    </label>
                    <div id="sleepReminderOptions" style="margin-top: 10px; display: none;">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="sleepReminderType">提醒類型</label>
                                    <select id="sleepReminderType" class="form-control">
                                        <option value="nextSleep">下次睡眠時間</option>
                                        <option value="wakeup">預計醒來時間</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="sleepReminderInterval">提醒時間</label>
                                    <select id="sleepReminderInterval" class="form-control">
                                        <option value="3">3小時後</option>
                                        <option value="12" selected>12小時後</option>
                                        <option value="custom">自訂時間</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col" id="sleepCustomTimeCol" style="display: none;">
                                <div class="form-group">
                                    <label for="sleepCustomTime">自訂時間</label>
                                    <input type="datetime-local" id="sleepCustomTime" class="form-control">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <button id="saveSleepBtn" class="btn btn-primary">
                    <i class="fas fa-save"></i> 儲存記錄
                </button>
            </div>

            <!-- 尿布記錄表單 -->
            <div id="diaperForm" class="record-form" style="display: none;">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label>排泄類型</label>
                            <div style="display: flex; gap: 10px;">
                                <label style="display: flex; align-items: center;">
                                    <input type="checkbox" id="diaperUrine" checked style="margin-right: 5px;"> 小便
                                </label>
                                <label style="display: flex; align-items: center;">
                                    <input type="checkbox" id="diaperStool" style="margin-right: 5px;"> 大便
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="diaperCondition">狀況</label>
                            <select id="diaperCondition" class="form-control">
                                <option value="正常">正常</option>
                                <option value="異常">異常</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="diaperTime">時間</label>
                            <input type="datetime-local" id="diaperTime" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="diaperNote">備註</label>
                            <textarea id="diaperNote" class="form-control" rows="3" placeholder="若狀況異常，請說明異常情況"></textarea>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="diaperSetReminder" style="margin-right: 5px;"> 設定下次更換提醒
                    </label>
                    <div id="diaperReminderOptions" style="margin-top: 10px; display: none;">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="diaperReminderInterval">提醒時間</label>
                                    <select id="diaperReminderInterval" class="form-control">
                                        <option value="1">1小時後</option>
                                        <option value="2" selected>2小時後</option>
                                        <option value="3">3小時後</option>
                                        <option value="custom">自訂時間</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col" id="diaperCustomTimeCol" style="display: none;">
                                <div class="form-group">
                                    <label for="diaperCustomTime">自訂時間</label>
                                    <input type="datetime-local" id="diaperCustomTime" class="form-control">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <button id="saveDiaperBtn" class="btn btn-primary">
                    <i class="fas fa-save"></i> 儲存記錄
                </button>
            </div>

            <!-- 情緒記錄表單 -->
            <div id="emotionForm" class="record-form" style="display: none;">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="emotionType">情緒類別</label>
                            <select id="emotionType" class="form-control">
                                <option value="開心">開心</option>
                                <option value="難過">難過</option>
                                <option value="生氣">生氣</option>
                                <option value="害怕">害怕</option>
                                <option value="驚訝">驚訝</option>
                                <option value="平靜">平靜</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="emotionIntensity">強度 (1-5分)</label>
                            <div class="rating" id="emotionIntensityRating">
                                <span class="rating-star" data-value="1"><i class="fas fa-star"></i></span>
                                <span class="rating-star" data-value="2"><i class="fas fa-star"></i></span>
                                <span class="rating-star" data-value="3"><i class="fas fa-star"></i></span>
                                <span class="rating-star" data-value="4"><i class="fas fa-star"></i></span>
                                <span class="rating-star" data-value="5"><i class="fas fa-star"></i></span>
                            </div>
                            <input type="hidden" id="emotionIntensity" value="3">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="emotionTime">時間</label>
                            <input type="datetime-local" id="emotionTime" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="emotionNote">備註</label>
                            <textarea id="emotionNote" class="form-control" rows="3" placeholder="描述情緒發生的情境和可能的原因"></textarea>
                        </div>
                    </div>
                </div>
                <button id="saveEmotionBtn" class="btn btn-primary">
                    <i class="fas fa-save"></i> 儲存記錄
                </button>
            </div>

            <!-- 活動記錄表單 -->
            <div id="activityForm" class="record-form" style="display: none;">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="activityType">活動類型</label>
                            <select id="activityType" class="form-control">
                                <option value="遊戲">遊戲</option>
                                <option value="洗澡">洗澡</option>
                                <option value="戶外">戶外</option>
                                <option value="學習">學習</option>
                                <option value="社交">社交</option>
                                <option value="運動">運動</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="activityDuration">持續時間 (分鐘)</label>
                            <input type="number" id="activityDuration" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="activityTime">開始時間</label>
                            <input type="datetime-local" id="activityTime" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="activityNote">備註</label>
                            <textarea id="activityNote" class="form-control" rows="3" placeholder="描述活動內容和兒童反應"></textarea>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="activitySetReminder" style="margin-right: 5px;"> 設定下次活動提醒
                    </label>
                    <div id="activityReminderOptions" style="margin-top: 10px; display: none;">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="activityReminderInterval">提醒時間</label>
                                    <select id="activityReminderInterval" class="form-control">
                                        <option value="24">明天同一時間</option>
                                        <option value="168">一週後同一時間</option>
                                        <option value="custom">自訂時間</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col" id="activityCustomTimeCol" style="display: none;">
                                <div class="form-group">
                                    <label for="activityCustomTime">自訂時間</label>
                                    <input type="datetime-local" id="activityCustomTime" class="form-control">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <button id="saveActivityBtn" class="btn btn-primary">
                    <i class="fas fa-save"></i> 儲存記錄
                </button>
            </div>

            <!-- 其他記錄表單 -->
            <div id="otherForm" class="record-form" style="display: none;">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="otherTitle">標題</label>
                            <input type="text" id="otherTitle" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="otherTime">時間</label>
                            <input type="datetime-local" id="otherTime" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="otherContent">內容</label>
                    <textarea id="otherContent" class="form-control" rows="5"></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="otherSetReminder" style="margin-right: 5px;"> 設定提醒
                    </label>
                    <div id="otherReminderOptions" style="margin-top: 10px; display: none;">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="otherReminderTime">提醒時間</label>
                                    <input type="datetime-local" id="otherReminderTime" class="form-control">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="otherReminderMessage">提醒訊息</label>
                                    <input type="text" id="otherReminderMessage" class="form-control" placeholder="留空則使用標題">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <button id="saveOtherBtn" class="btn btn-primary">
                    <i class="fas fa-save"></i> 儲存記錄
                </button>
            </div>
        </div>
        <div id="historyTab" class="tab-content">
            <h2>歷史記錄</h2>
            <p id="historyChildInfo">請先選擇或新增一位兒童</p>

            <div class="history-controls">
                <div class="history-date-selector">
                    <input type="date" id="historyDate" class="form-control">
                </div>
                <div class="history-filter">
                    <select id="historyFilter" class="form-control">
                        <option value="all">所有類型</option>
                        <option value="feeding">餵食</option>
                        <option value="sleep">睡眠</option>
                        <option value="diaper">尿布</option>
                        <option value="emotion">情緒</option>
                        <option value="activity">活動</option>
                        <option value="growth">成長</option>
                        <option value="medical">就醫</option>
                        <option value="medicine">用藥</option>
                        <option value="other">其他</option>
                    </select>
                </div>
            </div>

            <div id="historyContent">
                <!-- 歷史記錄將在這裡動態生成 -->
            </div>
        </div>

        <!-- 新增：用藥標籤頁 -->
        <div id="medicineTab" class="tab-content">
            <h2>用藥管理</h2>
            <p id="medicineChildInfo">請先選擇或新增一位兒童</p>

            <div class="tabs-container">
                <div class="tabs">
                    <div class="tab active" data-tab-content="medicineList">正在使用的藥物</div>
                    <div class="tab" data-tab-content="medicineHistory">用藥歷史</div>
                    <div class="tab" data-tab-content="medicineAdd">新增藥物</div>
                </div>
            </div>

            <!-- 藥物列表 -->
            <div id="medicineList" class="tab-content-section active">
                <div class="medicine-filters">
                    <div class="medicine-filter-btn active" data-filter="all">全部</div>
                    <div class="medicine-filter-btn" data-filter="active">使用中</div>
                    <div class="medicine-filter-btn" data-filter="completed">已完成</div>
                </div>

                <div id="activeMedicineList" class="medicine-list">
                    <!-- 藥物列表將在這裡動態生成 -->
                    <p>目前沒有正在使用的藥物記錄</p>
                </div>
            </div>

            <!-- 用藥歷史 -->
            <div id="medicineHistory" class="tab-content-section" style="display: none;">
                <div class="form-group">
                    <label for="medicineHistoryPeriod">選擇時間範圍</label>
                    <select id="medicineHistoryPeriod" class="form-control" style="max-width: 200px;">
                        <option value="7">最近一週</option>
                        <option value="30" selected>最近一個月</option>
                        <option value="90">最近三個月</option>
                        <option value="all">全部歷史</option>
                    </select>
                </div>

                <div id="medicineHistoryList">
                    <!-- 用藥歷史記錄將在這裡動態生成 -->
                </div>
            </div>

            <!-- 新增藥物 -->
            <div id="medicineAdd" class="tab-content-section" style="display: none;">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="medicineName">藥物名稱 <span class="text-danger">*</span></label>
                            <input type="text" id="medicineName" class="form-control" placeholder="例：Amoxicillin、退燒藥">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="medicineCategory">藥物類別</label>
                            <select id="medicineCategory" class="form-control">
                                <option value="抗生素">抗生素</option>
                                <option value="退燒藥">退燒藥</option>
                                <option value="止咳藥">止咳藥</option>
                                <option value="止痛藥">止痛藥</option>
                                <option value="過敏藥">過敏藥</option>
                                <option value="腸胃藥">腸胃藥</option>
                                <option value="皮膚用藥">皮膚用藥</option>
                                <option value="眼藥">眼藥</option>
                                <option value="維他命">維他命/補充劑</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="medicineDosage">單次劑量 <span class="text-danger">*</span></label>
                            <div style="display: flex; align-items: center;">
                                <input type="text" id="medicineDosage" class="form-control" style="flex: 1; margin-right: 10px;" placeholder="例：5">
                                <select id="medicineDosageUnit" class="form-control" style="width: 100px;">
                                    <option value="ml">毫升 (ml)</option>
                                    <option value="mg">毫克 (mg)</option>
                                    <option value="滴">滴</option>
                                    <option value="顆">顆</option>
                                    <option value="湯匙">湯匙</option>
                                    <option value="茶匙">茶匙</option>
                                    <option value="包">包</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="medicineForm">藥物形式</label>
                            <select id="medicineForm" class="form-control">
                                <option value="口服液">口服液</option>
                                <option value="糖漿">糖漿</option>
                                <option value="藥丸">藥丸/藥錠</option>
                                <option value="藥粉">藥粉/顆粒</option>
                                <option value="軟膏">軟膏/乳霜</option>
                                <option value="噴劑">噴劑</option>
                                <option value="滴劑">滴劑</option>
                                <option value="栓劑">栓劑</option>
                                <option value="貼片">貼片</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="medicineFrequency">服用頻率 <span class="text-danger">*</span></label>
                            <select id="medicineFrequency" class="form-control">
                                <option value="once">每天1次</option>
                                <option value="twice">每天2次</option>
                                <option value="thrice">每天3次</option>
                                <option value="four">每天4次</option>
                                <option value="needed">需要時服用</option>
                                <option value="custom">自訂</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col" id="medicineCustomFrequencyCol" style="display: none;">
                        <div class="form-group">
                            <label for="medicineCustomFrequency">自訂頻率</label>
                            <input type="text" id="medicineCustomFrequency" class="form-control" placeholder="例：每週3次、每隔12小時">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>服藥時間</label>
                    <div id="medicineTimes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 10px;">
                        <div class="time-checkbox">
                            <input type="checkbox" id="medicineTimeMorning" value="morning" style="margin-right: 5px;"> 
                            <label for="medicineTimeMorning">早上</label>
                            <input type="time" id="medicineTimeMorningValue" class="form-control" style="margin-top: 5px;">
                        </div>
                        <div class="time-checkbox">
                            <input type="checkbox" id="medicineTimeNoon" value="noon" style="margin-right: 5px;"> 
                            <label for="medicineTimeNoon">中午</label>
                            <input type="time" id="medicineTimeNoonValue" class="form-control" style="margin-top: 5px;">
                        </div>
                        <div class="time-checkbox">
                            <input type="checkbox" id="medicineTimeEvening" value="evening" style="margin-right: 5px;"> 
                            <label for="medicineTimeEvening">傍晚</label>
                            <input type="time" id="medicineTimeEveningValue" class="form-control" style="margin-top: 5px;">
                        </div>
                        <div class="time-checkbox">
                            <input type="checkbox" id="medicineTimeNight" value="night" style="margin-right: 5px;"> 
                            <label for="medicineTimeNight">晚上</label>
                            <input type="time" id="medicineTimeNightValue" class="form-control" style="margin-top: 5px;">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="medicineStartDate">開始日期 <span class="text-danger">*</span></label>
                            <input type="date" id="medicineStartDate" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="medicineDuration">療程</label>
                            <div style="display: flex; align-items: center;">
                                <input type="number" id="medicineDuration" class="form-control" style="flex: 1; margin-right: 10px;" placeholder="例：7">
                                <select id="medicineDurationUnit" class="form-control" style="width: 80px;">
                                    <option value="days">天</option>
                                    <option value="weeks">週</option>
                                    <option value="months">月</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="medicineInstructions">服用說明</label>
                    <textarea id="medicineInstructions" class="form-control" rows="3" placeholder="例：飯後服用、與牛奶一起服用"></textarea>
                </div>
                <div class="form-group">
                    <label for="medicinePrescriber">處方者</label>
                    <input type="text" id="medicinePrescriber" class="form-control" placeholder="例：林醫師、台大醫院小兒科">
                </div>
                <div class="form-group">
                    <label for="medicineReason">用藥原因</label>
                    <input type="text" id="medicineReason" class="form-control" placeholder="例：中耳炎、感冒">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="medicineSetReminder" checked style="margin-right: 5px;"> 設定服藥提醒
                    </label>
                    <div id="medicineReminderOptions" style="margin-top: 10px;">
                        <label>
                            <input type="checkbox" id="medicineNotifyMissed" checked style="margin-right: 5px;"> 提醒漏服藥物
                        </label>
                        <p style="margin-top: 5px; font-size: 0.9rem; color: var(--light-text);">系統將根據服藥時間自動設定提醒，若超過1小時未記錄服藥，則會顯示漏服提醒。</p>
                    </div>
                </div>
                <button id="saveMedicineBtn" class="btn btn-primary">
                    <i class="fas fa-save"></i> 儲存藥物
                </button>
            </div>
        </div>

        <!-- 新增：成長紀錄標籤頁 -->
        <div id="growthTab" class="tab-content">
            <h2>成長記錄</h2>
            <p id="growthChildInfo">請先選擇或新增一位兒童</p>

            <div class="growth-record-form">
                <h3>新增成長記錄</h3>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="growthDate">記錄日期 <span class="text-danger">*</span></label>
                            <input type="date" id="growthDate" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="growthLocation">測量地點</label>
                            <input type="text" id="growthLocation" class="form-control" placeholder="例：家中、兒科診所、健康中心">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="growthHeight">身高 (公分)</label>
                            <input type="number" id="growthHeight" class="form-control" step="0.1">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="growthWeight">體重 (公斤)</label>
                            <input type="number" id="growthWeight" class="form-control" step="0.01">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="growthHeadCircumference">頭圍 (公分)</label>
                            <input type="number" id="growthHeadCircumference" class="form-control" step="0.1">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="growthNote">備註</label>
                    <textarea id="growthNote" class="form-control" rows="3" placeholder="任何有關發育或成長的觀察"></textarea>
                </div>
                <button id="saveGrowthBtn" class="btn btn-primary">
                    <i class="fas fa-save"></i> 儲存記錄
                </button>
            </div>

            <div class="growth-record-list">
                <h3>成長記錄歷史</h3>
                <div id="growthRecords">
                    <!-- 成長記錄將在這裡動態生成 -->
                </div>
            </div>

            <div class="growth-chart-container">
                <h3>成長曲線圖</h3>
                <div class="growth-chart-tabs">
                    <div class="growth-chart-tab active" data-chart="height">身高</div>
                    <div class="growth-chart-tab" data-chart="weight">體重</div>
                    <div class="growth-chart-tab" data-chart="headCircumference">頭圍</div>
                    <div class="growth-chart-tab" data-chart="bmi">BMI</div>
                </div>
                <div class="chart-container">
                    <canvas id="growthChart"></canvas>
                </div>
                
                <div class="reference-values">
                    <h4>WHO 成長標準參考值</h4>
                    <div class="percentile-legend">
                        <div class="percentile-legend-item">
                            <span class="percentile-marker percentile-p3"></span>
                            <span>第3百分位</span>
                        </div>
                        <div class="percentile-legend-item">
                            <span class="percentile-marker percentile-p15"></span>
                            <span>第15百分位</span>
                        </div>
                        <div class="percentile-legend-item">
                            <span class="percentile-marker percentile-p50"></span>
                            <span>第50百分位 (中位數)</span>
                        </div>
                        <div class="percentile-legend-item">
                            <span class="percentile-marker percentile-p85"></span>
                            <span>第85百分位</span>
                        </div>
                        <div class="percentile-legend-item">
                            <span class="percentile-marker percentile-p97"></span>
                            <span>第97百分位</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 新增：就醫紀錄標籤頁 -->
        <div id="medicalTab" class="tab-content">
            <h2>就醫記錄</h2>
            <p id="medicalChildInfo">請先選擇或新增一位兒童</p>

            <div class="medical-record-form">
                <h3>新增就醫記錄</h3>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="medicalDate">就醫日期 <span class="text-danger">*</span></label>
                            <input type="date" id="medicalDate" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="medicalType">就醫類型</label>
                            <select id="medicalType" class="form-control">
                                <option value="例行檢查">例行檢查</option>
                                <option value="疫苗接種">疫苗接種</option>
                                <option value="生病就診">生病就診</option>
                                <option value="專科諮詢">專科諮詢</option>
                                <option value="急診">急診</option>
                                <option value="住院">住院</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="medicalProvider">醫療機構/醫師</label>
                            <input type="text" id="medicalProvider" class="form-control" placeholder="例：台大醫院、林醫師">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="medicalSpecialty">科別</label>
                            <select id="medicalSpecialty" class="form-control">
                                <option value="兒科">兒科</option>
                                <option value="家醫科">家醫科</option>
                                <option value="耳鼻喉科">耳鼻喉科</option>
                                <option value="小兒皮膚科">小兒皮膚科</option>
                                <option value="小兒神經科">小兒神經科</option>
                                <option value="小兒腸胃科">小兒腸胃科</option>
                                <option value="小兒心臟科">小兒心臟科</option>
                                <option value="眼科">眼科</option>
                                <option value="牙科">牙科</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="medicalReason">就診原因/症狀</label>
                    <textarea id="medicalReason" class="form-control" rows="2" placeholder="例：發燒、咳嗽、皮疹、定期健康檢查"></textarea>
                </div>
                <div class="form-group">
                    <label for="medicalDiagnosis">診斷/結果</label>
                    <textarea id="medicalDiagnosis" class="form-control" rows="2" placeholder="例：中耳炎、過敏性鼻炎、生長發育正常"></textarea>
                </div>
                <div class="form-group">
                    <label for="medicalTreatment">治療/建議</label>
                    <textarea id="medicalTreatment" class="form-control" rows="3" placeholder="例：開立抗生素七天、建議多休息、安排回診"></textarea>
                </div>
                <div class="form-group">
                    <label for="medicalFollowUp">追蹤/回診</label>
                    <div class="form-row">
                        <div class="form-col">
                            <select id="medicalFollowUpNeeded" class="form-control">
                                <option value="no">不需回診</option>
                                <option value="yes">需要回診</option>
                                <option value="if">視情況而定</option>
                            </select>
                        </div>
                        <div class="form-col" id="medicalFollowUpDateCol" style="display: none;">
                            <input type="date" id="medicalFollowUpDate" class="form-control" placeholder="回診日期">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="medicalCost">費用</label>
                    <input type="number" id="medicalCost" class="form-control" placeholder="選填">
                </div>
                <div class="form-group">
                    <label for="medicalNote">額外備註</label>
                    <textarea id="medicalNote" class="form-control" rows="2" placeholder="任何其他重要資訊"></textarea>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="medicalSetFollowUpReminder" style="margin-right: 5px;"> 設定回診提醒
                    </label>
                    <div id="medicalFollowUpReminderOptions" style="margin-top: 10px; display: none;">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="medicalReminderDate">提醒日期</label>
                                    <input type="date" id="medicalReminderDate" class="form-control">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="medicalReminderMessage">提醒訊息</label>
                                    <input type="text" id="medicalReminderMessage" class="form-control" placeholder="例：回診預約">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button id="saveMedicalBtn" class="btn btn-primary">
                    <i class="fas fa-save"></i> 儲存記錄
                </button>
            </div>

            <div class="medical-record-list">
                <h3>就醫記錄歷史</h3>
                <div id="medicalRecords">
                    <!-- 就醫記錄將在這裡動態生成 -->
                </div>
            </div>
        </div>

        <div id="reminderTab" class="tab-content">
            <h2>提醒管理</h2>
            <p id="reminderChildInfo">請先選擇或新增一位兒童</p>

            <div style="margin-bottom: 20px;">
                <button id="addReminderBtn" class="btn btn-primary">
                    <i class="fas fa-plus"></i> 新增提醒
                </button>
            </div>

            <h3>快速新增提醒</h3>
            <div class="reminder-quick-add">
                <div class="reminder-quick-add-item" data-type="feeding">
                    <i class="fas fa-utensils" style="color: #8ecae6;"></i>
                    <span>餵食提醒</span>
                </div>
                <div class="reminder-quick-add-item" data-type="sleep">
                    <i class="fas fa-bed" style="color: #9381ff;"></i>
                    <span>睡眠提醒</span>
                </div>
                <div class="reminder-quick-add-item" data-type="medicine">
                    <i class="fas fa-pills" style="color: #e76f51;"></i>
                    <span>用藥提醒</span>
                </div>
                <div class="reminder-quick-add-item" data-type="vaccine">
                    <i class="fas fa-syringe" style="color: #52b788;"></i>
                    <span>疫苗提醒</span>
                </div>
                <div class="reminder-quick-add-item" data-type="medical">
                    <i class="fas fa-hospital" style="color: var(--medical-color);"></i>
                    <span>回診提醒</span>
                </div>
                <div class="reminder-quick-add-item" data-type="growth">
                    <i class="fas fa-ruler" style="color: var(--growth-color);"></i>
                    <span>成長檢測提醒</span>
                </div>
            </div>

            <div class="reminder-filters" style="display: flex; gap: 10px; margin-bottom: 15px;">
                <select id="reminderFilter" class="form-control" style="max-width: 150px;">
                    <option value="all">所有提醒</option>
                    <option value="active">活躍提醒</option>
                    <option value="completed">已完成提醒</option>
                </select>
                <button id="clearCompletedRemindersBtn" class="btn btn-danger">
                    <i class="fas fa-trash"></i> 清除已完成提醒
                </button>
            </div>

            <div id="reminderList">
                <!-- 提醒列表將在這裡動態生成 -->
                <p>目前沒有提醒項目。</p>
            </div>
        </div>

        <div id="milestoneTab" class="tab-content">
            <h2>發展里程碑</h2>
            <p id="milestoneChildInfo">請先選擇或新增一位兒童</p>

            <div class="milestone-controls">
                <select id="milestoneFilter" class="form-control">
                    <option value="all">所有年齡段</option>
                    <option value="0-3">0-3個月</option>
                    <option value="4-6">4-6個月</option>
                    <option value="7-9">7-9個月</option>
                    <option value="10-12">10-12個月</option>
                    <option value="13-18">13-18個月</option>
                    <option value="19-24">19-24個月</option>
                </select>
            </div>

            <div id="milestoneContent">
                <!-- 里程碑內容將在這裡動態生成 -->
            </div>
        </div>

        <div id="statsTab" class="tab-content">
            <h2>統計分析</h2>
            <p id="statsChildInfo">請先選擇或新增一位兒童</p>

            <div class="stats-controls">
                <div class="stats-period-selector">
                    <button class="stats-period-btn active" data-period="week">週</button>
                    <button class="stats-period-btn" data-period="month">月</button>
                    <button class="stats-period-btn" data-period="3months">三個月</button>
                    <button class="stats-period-btn" data-period="custom">自訂</button>
                </div>
                <div class="stats-custom-period" style="display: none;">
                    <input type="date" id="statsStartDate" class="form-control" style="margin-right: 10px;">
                    <span>至</span>
                    <input type="date" id="statsEndDate" class="form-control" style="margin-left: 10px;">
                    <button id="statsApplyCustom" class="btn btn-primary">套用</button>
                </div>
            </div>

            <div class="stats-charts">
                <div class="chart-container">
                    <h3>睡眠時間與品質</h3>
                    <canvas id="sleepChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>餵食量變化</h3>
                    <canvas id="feedingChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>排泄頻率</h3>
                    <canvas id="diaperChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>情緒變化</h3>
                    <canvas id="emotionChart"></canvas>
                </div>
                <!-- 新增藥物統計圖表 -->
                <div class="chart-container">
                    <h3>用藥依從性</h3>
                    <canvas id="medicineAdherenceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 照顧提示標籤頁 - 新增 -->
        <div id="caretipsTab" class="tab-content">
            <h2>照顧提示</h2>
            <p id="caretipsChildInfo">請先選擇或新增一位兒童</p>

            <div class="caretips-controls">
                <select id="caretipsCategory" class="form-control">
                    <option value="all">所有類別</option>
                    <option value="feeding">餵食</option>
                    <option value="sleep">睡眠</option>
                    <option value="activity">活動與遊戲</option>
                    <option value="safety">安全</option>
                    <option value="health">健康與衛生</option>
                    <option value="development">發展與學習</option>
                </select>
            </div>

            <div id="caretipsContent">
                <!-- 照顧提示內容將在這裡動態生成 -->
            </div>
        </div>

        <div id="exportTab" class="tab-content">
            <h2>匯出資料</h2>
            <p id="exportChildInfo">請先選擇或新增一位兒童</p>

            <div class="export-options">
                <div class="export-option">
                    <h3>選擇記錄類型</h3>
                    <div style="margin-top: 10px;">
                        <label style="display: flex; align-items: center; margin-bottom: 5px;">
                            <input type="checkbox" id="exportAllTypes" checked style="margin-right: 5px;"> 所有類型
                        </label>
                        <div id="exportTypeOptions">
                            <label style="display: flex; align-items: center; margin-bottom: 5px;">
                                <input type="checkbox" name="exportType" value="feeding" style="margin-right: 5px;"> 餵食
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 5px;">
                                <input type="checkbox" name="exportType" value="sleep" style="margin-right: 5px;"> 睡眠
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 5px;">
                                <input type="checkbox" name="exportType" value="diaper" style="margin-right: 5px;"> 尿布
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 5px;">
                                <input type="checkbox" name="exportType" value="emotion" style="margin-right: 5px;"> 情緒
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 5px;">
                                <input type="checkbox" name="exportType" value="activity" style="margin-right: 5px;"> 活動
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 5px;">
                                <input type="checkbox" name="exportType" value="growth" style="margin-right: 5px;"> 成長
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 5px;">
                                <input type="checkbox" name="exportType" value="medical" style="margin-right: 5px;"> 就醫
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 5px;">
                                <input type="checkbox" name="exportType" value="medicine" style="margin-right: 5px;"> 用藥
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 5px;">
                                <input type="checkbox" name="exportType" value="other" style="margin-right: 5px;"> 其他
                            </label>
                        </div>
                    </div>
                </div>
                <div class="export-option">
                    <h3>選擇日期範圍</h3>
                    <div style="margin-top: 10px;">
                        <label style="display: flex; align-items: center; margin-bottom: 5px;">
                            <input type="checkbox" id="exportAllDates" checked style="margin-right: 5px;"> 所有日期
                        </label>
                        <div id="exportDateRange" style="display: none;">
                            <div class="export-date-range">
                                <span>從:</span>
                                <input type="date" id="exportStartDate" class="form-control">
                            </div>
                            <div class="export-date-range">
                                <span>至:</span>
                                <input type="date" id="exportEndDate" class="form-control">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button id="exportCSVBtn" class="btn btn-primary">
                <i class="fas fa-file-csv"></i> 匯出為CSV
            </button>
            
            <!-- 新增部分：全部數據匯出與匯入功能 -->
            <hr>
            <h3>全部數據匯出與備份</h3>
            <p>匯出所有兒童及其所有記錄，可用於備份或跨設備轉移數據。</p>
            <button id="exportAllDataBtn" class="btn btn-accent" style="margin-right: 10px;">
                <i class="fas fa-download"></i> 匯出所有數據
            </button>
            
            <div style="margin-top: 20px;">
                <h3>匯入數據</h3>
                <p>從先前匯出的檔案中匯入數據。</p>
                <div style="display: flex; align-items: center;">
                    <input type="file" id="importFileInput" accept=".json" style="display: none;">
                    <button id="importFileBtn" class="btn btn-primary" style="margin-right: 10px;">
                        <i class="fas fa-upload"></i> 選擇檔案
                    </button>
                    <span id="importFileName">未選擇檔案</span>
                </div>
                <div style="margin-top: 10px;">
                    <div class="form-group">
                        <label>匯入選項：</label>
                        <label style="display: flex; align-items: center; margin: 5px 0;">
                            <input type="radio" name="importOption" value="merge" checked style="margin-right: 5px;"> 合併數據（保留現有數據）
                        </label>
                        <label style="display: flex; align-items: center; margin: 5px 0;">
                            <input type="radio" name="importOption" value="replace" style="margin-right: 5px;"> 完全替換（刪除所有現有數據）
                        </label>
                    </div>
                    <button id="importDataBtn" class="btn btn-success" disabled>
                        <i class="fas fa-check"></i> 開始匯入
                    </button>
                </div>
            </div>
        </div>

        <!-- 底部導航欄 - 改進版 -->
        <div class="bottom-nav">
            <div class="bottom-nav-item active" data-tab="record">
                <i class="fas fa-pen"></i>
                <span>記錄</span>
            </div>
            <div class="bottom-nav-item" data-tab="history">
                <i class="fas fa-history"></i>
                <span>歷史</span>
            </div>
            
            <!-- 新增：快捷按鈕 -->
            <div class="bottom-nav-center">
                <button id="quickActionBtn" class="quick-action-btn">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            
            <div class="bottom-nav-item" data-tab="reminder">
                <i class="fas fa-bell reminder-count-badge"></i>
                <span>提醒</span>
            </div>
            <div class="bottom-nav-item" data-tab="medicine">
                <i class="fas fa-pills"></i>
                <span>用藥</span>
            </div>
            <div class="bottom-nav-item" data-tab="growth">
                <i class="fas fa-chart-line"></i>
                <span>成長</span>
            </div>
            <div class="bottom-nav-item" data-tab="medical">
                <i class="fas fa-hospital"></i>
                <span>就醫</span>
            </div>
        </div>

        <!-- 新增：快捷動作選單 -->
        <div id="quickActionMenu" class="quick-action-menu">
            <div class="quick-action-menu-header">
                <h3>快速記錄</h3>
                <button id="quickActionMenuClose" class="quick-action-menu-close">&times;</button>
            </div>
            <div class="quick-action-menu-items">
                <div class="quick-action-item quick-action-feeding" id="quickActionFeeding">
                    <i class="fas fa-utensils"></i>
                    <span>餵食</span>
                </div>
                <div class="quick-action-item quick-action-sleep" id="quickActionSleep">
                    <i class="fas fa-bed"></i>
                    <span>睡眠</span>
                </div>
                <div class="quick-action-item quick-action-diaper" id="quickActionDiaper">
                    <i class="fas fa-baby"></i>
                    <span>尿布</span>
                </div>
                <div class="quick-action-item" id="quickActionGrowth">
                    <i class="fas fa-ruler" style="color: var(--growth-color);"></i>
                    <span>成長</span>
                </div>
                <div class="quick-action-item" id="quickActionMedicine">
                    <i class="fas fa-pills" style="color: #9381ff;"></i>
                    <span>服藥</span>
                </div>
                <div class="quick-action-item quick-action-other" id="quickActionOther">
                    <i class="fas fa-plus-circle"></i>
                    <span>其他</span>
                </div>
            </div>
        </div>

        <!-- 睡眠計時器指示器 -->
        <div class="sleep-timer-badge" id="sleepTimerBadge">
            <i class="fas fa-bed"></i>
            <span class="sleep-timer-text">正在睡眠中: 00:00:00</span>
        </div>

        <!-- 成功提示框 -->
        <div class="toast-notification" id="toastNotification">
            <i class="fas fa-check-circle"></i>
            <span id="toastMessage">記錄已成功儲存！</span>
        </div>

        <!-- 遮罩層 -->
        <div id="overlay" class="overlay"></div>
        <!-- 新增兒童模態框 -->
    <div id="addChildModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>新增兒童</h3>
                <button class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="childName">姓名</label>
                    <input type="text" id="childName" class="form-control">
                </div>
                <div class="form-group">
                    <label for="childBirthday">出生日期</label>
                    <input type="date" id="childBirthday" class="form-control">
                </div>
                <div class="form-group">
                    <label for="childGender">性別</label>
                    <select id="childGender" class="form-control">
                        <option value="男">男</option>
                        <option value="女">女</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="childNote">備註</label>
                    <textarea id="childNote" class="form-control" rows="3" placeholder="其他重要資訊，如過敏史、特殊需求等"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="saveChildBtn">儲存</button>
                <button class="btn" id="cancelAddChildBtn">取消</button>
            </div>
        </div>
    </div>

    <!-- 編輯記錄模態框 -->
    <div id="editRecordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="editRecordTitle">編輯記錄</h3>
                <button class="modal-close">×</button>
            </div>
            <div class="modal-body" id="editRecordBody">
                <!-- 編輯表單將根據記錄類型動態生成 -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="deleteRecordBtn">刪除</button>
                <button class="btn btn-primary" id="updateRecordBtn">更新</button>
                <button class="btn" id="cancelEditRecordBtn">取消</button>
            </div>
        </div>
    </div>
    
    <!-- 新增：刪除兒童確認模態框 -->
    <div id="deleteChildModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>刪除兒童</h3>
                <button class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <p>確定要刪除「<span id="deleteChildName"></span>」嗎？</p>
                <p class="text-danger"><strong>警告：</strong>此操作將刪除與該兒童相關的所有記錄和里程碑資料，且無法復原！</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="confirmDeleteChildBtn">確認刪除</button>
                <button class="btn" id="cancelDeleteChildBtn">取消</button>
            </div>
        </div>
    </div>
    
    <!-- 新增：匯入確認模態框 -->
    <div id="importConfirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>確認匯入</h3>
                <button class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <p>您即將匯入以下數據：</p>
                <div id="importSummary" style="margin: 10px 0; padding: 10px; background-color: #f0f5f9; border-radius: 5px;"></div>
                <p id="importWarning" style="color: #e76f51;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" id="confirmImportBtn">確認匯入</button>
                <button class="btn" id="cancelImportBtn">取消</button>
            </div>
        </div>
    </div>

    <!-- 快速餵食記錄模態框 -->
    <div id="quickFeedingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>快速餵食記錄</h3>
                <button class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="quickFeedingType">餵食類型</label>
                    <select id="quickFeedingType" class="form-control">
                        <option value="母乳">母乳</option>
                        <option value="配方奶">配方奶</option>
                        <option value="副食品">副食品</option>
                        <option value="水果">水果</option>
                        <option value="水/飲料">水/飲料</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="quickFeedingAmount">數量/時間</label>
                    <div style="display: flex; align-items: center;">
                        <input type="number" id="quickFeedingAmount" class="form-control" style="flex: 1; margin-right: 10px;">
                        <select id="quickFeedingUnit" class="form-control" style="width: 80px;">
                            <option value="ml">毫升</option>
                            <option value="min">分鐘</option>
                            <option value="份">份</option>
                            <option value="湯匙">湯匙</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="quickFeedingNote">備註</label>
                    <textarea id="quickFeedingNote" class="form-control" rows="2" placeholder="備註（選填）"></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="quickFeedingSetReminder" style="margin-right: 5px;"> 設定下次餵食提醒
                    </label>
                    <div id="quickFeedingReminderOptions" style="margin-top: 10px; display: none;">
                        <div class="form-group">
                            <label for="quickFeedingReminderInterval">提醒時間</label>
                            <select id="quickFeedingReminderInterval" class="form-control">
                                <option value="2">2小時後</option>
                                <option value="3" selected>3小時後</option>
                                <option value="4">4小時後</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="saveQuickFeedingBtn">儲存</button>
                <button class="btn" id="cancelQuickFeedingBtn">取消</button>
            </div>
        </div>
    </div>

    <!-- 快速尿布記錄模態框 -->
    <div id="quickDiaperModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>快速尿布記錄</h3>
                <button class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <div class="diaper-quick-options">
                    <div class="diaper-option active" data-type="urine">
                        <i class="fas fa-tint"></i>
                        <span>小便</span>
                    </div>
                    <div class="diaper-option" data-type="stool">
                        <i class="fas fa-poo"></i>
                        <span>大便</span>
                    </div>
                    <div class="diaper-option" data-type="both">
                        <i class="fas fa-poo-storm"></i>
                        <span>兩者</span>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label for="quickDiaperCondition">狀況</label>
                    <select id="quickDiaperCondition" class="form-control">
                        <option value="正常">正常</option>
                        <option value="異常">異常</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="quickDiaperNote">備註</label>
                    <textarea id="quickDiaperNote" class="form-control" rows="2" placeholder="備註（選填）"></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="quickDiaperSetReminder" style="margin-right: 5px;"> 設定下次更換提醒
                    </label>
                    <div id="quickDiaperReminderOptions" style="margin-top: 10px; display: none;">
                        <div class="form-group">
                            <label for="quickDiaperReminderInterval">提醒時間</label>
                            <select id="quickDiaperReminderInterval" class="form-control">
                                <option value="1">1小時後</option>
                                <option value="2" selected>2小時後</option>
                                <option value="3">3小時後</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="saveQuickDiaperBtn">儲存</button>
                <button class="btn" id="cancelQuickDiaperBtn">取消</button>
            </div>
        </div>
    </div>

    <!-- 快速其他記錄模態框 -->
    <div id="quickOtherModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>快速其他記錄</h3>
                <button class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="quickOtherType">記錄類型</label>
                    <select id="quickOtherType" class="form-control">
                        <option value="emotion_happy">情緒 - 開心</option>
                        <option value="emotion_sad">情緒 - 難過</option>
                        <option value="activity_bath">活動 - 洗澡</option>
                        <option value="activity_outdoor">活動 - 戶外</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="quickOtherNote">備註</label>
                    <textarea id="quickOtherNote" class="form-control" rows="2" placeholder="備註（選填）"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="saveQuickOtherBtn">儲存</button>
                <button class="btn" id="cancelQuickOtherBtn">取消</button>
            </div>
        </div>
    </div>

    <!-- 新增：快速成長記錄模態框 -->
    <div id="quickGrowthModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>快速成長記錄</h3>
                <button class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="quickGrowthLocation">測量地點</label>
                    <select id="quickGrowthLocation" class="form-control">
                        <option value="家中">家中</option>
                        <option value="診所">診所</option>
                        <option value="健康中心">健康中心</option>
                        <option value="醫院">醫院</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="quickGrowthHeight">身高 (公分)</label>
                            <input type="number" id="quickGrowthHeight" class="form-control" step="0.1" placeholder="例：80.5">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="quickGrowthWeight">體重 (公斤)</label>
                            <input type="number" id="quickGrowthWeight" class="form-control" step="0.01" placeholder="例：10.25">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="quickGrowthHeadCircumference">頭圍 (公分)</label>
                    <input type="number" id="quickGrowthHeadCircumference" class="form-control" step="0.1" placeholder="例：45.5">
                </div>
                <div class="form-group">
                    <label for="quickGrowthNote">備註</label>
                    <textarea id="quickGrowthNote" class="form-control" rows="2" placeholder="備註（選填）"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="saveQuickGrowthBtn">儲存</button>
                <button class="btn" id="cancelQuickGrowthBtn">取消</button>
            </div>
        </div>
    </div>

    <!-- 新增：快速服藥記錄模態框 -->
    <div id="quickMedicineRecordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>快速服藥記錄</h3>
                <button class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="quickMedicineSelect">選擇藥物</label>
                    <select id="quickMedicineSelect" class="form-control">
                        <!-- 藥物列表會動態生成 -->
                        <option value="">-- 請選擇藥物 --</option>
                    </select>
                </div>
                <div id="quickMedicineDetails" style="margin-top: 15px; display: none;">
                    <div class="form-group">
                        <label>正在記錄服用：<span id="quickMedicineName" style="font-weight: 600;"></span></label>
                        <div id="quickMedicineDosageInfo" style="margin-top: 5px; font-size: 0.9rem;"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="quickMedicineTime">服用時間</label>
                                <input type="datetime-local" id="quickMedicineTime" class="form-control">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="quickMedicineDoseStatus">服用狀態</label>
                                <select id="quickMedicineDoseStatus" class="form-control">
                                    <option value="taken">已服用</option>
                                    <option value="partial">部分服用</option>
                                    <option value="missed">未服用</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="quickMedicineNote">備註</label>
                        <textarea id="quickMedicineNote" class="form-control" rows="2" placeholder="例：服藥時的反應、副作用觀察等"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="saveQuickMedicineBtn" disabled>儲存</button>
                <button class="btn" id="cancelQuickMedicineBtn">取消</button>
            </div>
        </div>
    </div>

    <!-- 新增提醒模態框 -->
    <div id="addReminderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>新增提醒</h3>
                <button class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="reminderType">提醒類型</label>
                    <select id="reminderType" class="form-control">
                        <option value="feeding">餵食</option>
                        <option value="sleep">睡眠</option>
                        <option value="diaper">尿布更換</option>
                        <option value="medicine">用藥</option>
                        <option value="vaccine">疫苗</option>
                        <option value="medical">回診/看診</option>
                        <option value="growth">成長測量</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reminderTitle">提醒標題</label>
                    <input type="text" id="reminderTitle" class="form-control" placeholder="例：餵食時間、用藥提醒">
                </div>
                <div class="form-group">
                    <label for="reminderTime">提醒時間</label>
                    <input type="datetime-local" id="reminderTime" class="form-control">
                </div>
                <div class="form-group">
                    <label for="reminderMessage">提醒訊息</label>
                    <textarea id="reminderMessage" class="form-control" rows="2" placeholder="提醒內容（選填）"></textarea>
                </div>
                
                <div class="reminder-repeat-options">
                    <div class="reminder-repeat-toggle">
                        <input type="checkbox" id="reminderRepeat"> 
                        <label for="reminderRepeat">重複提醒</label>
                    </div>
                    
                    <div id="reminderRepeatDetails" class="reminder-repeat-details">
                        <div class="form-group">
                            <label for="reminderRepeatType">重複類型</label>
                            <select id="reminderRepeatType" class="form-control">
                                <option value="daily">每天</option>
                                <option value="weekly">每週</option>
                                <option value="monthly">每月</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="reminderRepeatDaysGroup" style="display: none;">
                            <label>重複日期</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                <label style="display: flex; align-items: center;">
                                    <input type="checkbox" name="reminderRepeatDay" value="1" style="margin-right: 5px;"> 週一
                                </label>
                                <label style="display: flex; align-items: center;">
                                    <input type="checkbox" name="reminderRepeatDay" value="2" style="margin-right: 5px;"> 週二
                                </label>
                                <label style="display: flex; align-items: center;">
                                    <input type="checkbox" name="reminderRepeatDay" value="3" style="margin-right: 5px;"> 週三
                                </label>
                                <label style="display: flex; align-items: center;">
                                    <input type="checkbox" name="reminderRepeatDay" value="4" style="margin-right: 5px;"> 週四
                                </label>
                                <label style="display: flex; align-items: center;">
                                    <input type="checkbox" name="reminderRepeatDay" value="5" style="margin-right: 5px;"> 週五
                                </label>
                                <label style="display: flex; align-items: center;">
                                    <input type="checkbox" name="reminderRepeatDay" value="6" style="margin-right: 5px;"> 週六
                                </label>
                                <label style="display: flex; align-items: center;">
                                    <input type="checkbox" name="reminderRepeatDay" value="0" style="margin-right: 5px;"> 週日
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group" id="reminderRepeatDateGroup" style="display: none;">
                            <label for="reminderRepeatDate">每月重複日期</label>
                            <select id="reminderRepeatDate" class="form-control">
                                <!-- 1-31日選項將由JavaScript動態生成 -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="saveReminderBtn">儲存提醒</button>
                <button class="btn" id="cancelAddReminderBtn">取消</button>
            </div>
        </div>
    </div>

    <!-- 快速添加用藥提醒模態框 -->
    <div id="quickMedicineModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>用藥提醒</h3>
                <button class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="medicineName">藥物名稱</label>
                    <input type="text" id="medicineName" class="form-control">
                </div>
                <div class="form-group">
                    <label for="medicineDosage">劑量</label>
                    <input type="text" id="medicineDosage" class="form-control" placeholder="例：5ml、1顆">
                </div>
                <div class="form-group">
                    <label for="medicineSchedule">服用時間</label>
                    <select id="medicineSchedule" class="form-control">
                        <option value="1">每日1次</option>
                        <option value="2">每日2次</option>
                        <option value="3">每日3次</option>
                        <option value="4">每日4次</option>
                        <option value="custom">自訂時間</option>
                    </select>
                </div>
                <div id="medicineCustomTimeGroup" style="display: none;">
                    <div class="form-group">
                        <label for="medicineFirstTime">首次服用時間</label>
                        <input type="datetime-local" id="medicineFirstTime" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label for="medicineDuration">服用天數</label>
                    <select id="medicineDuration" class="form-control">
                        <option value="3">3天</option>
                        <option value="5">5天</option>
                        <option value="7">7天</option>
                        <option value="14">14天</option>
                        <option value="0">持續服用</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="medicineNote">備註</label>
                    <textarea id="medicineNote" class="form-control" rows="2" placeholder="備註（選填）"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="saveMedicineReminderBtn">設定提醒</button>
                <button class="btn" id="cancelMedicineReminderBtn">取消</button>
            </div>
        </div>
    </div>

    <!-- 快速添加疫苗提醒模態框 -->
    <div id="quickVaccineModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>疫苗接種提醒</h3>
                <button class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="vaccineName">疫苗名稱</label>
                    <select id="vaccineName" class="form-control">
                        <option value="BCG">卡介苗 (BCG)</option>
                        <option value="B肝">B型肝炎疫苗</option>
                        <option value="五合一">五合一疫苗</option>
                        <option value="肺炎鏈球菌">肺炎鏈球菌疫苗</option>
                        <option value="輪狀病毒">輪狀病毒疫苗</option>
                        <option value="麻疹腮腺炎德國麻疹">麻疹腮腺炎德國麻疹混合疫苗</option>
                        <option value="水痘">水痘疫苗</option>
                        <option value="日本腦炎">日本腦炎疫苗</option>
                        <option value="流感">流感疫苗</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div id="vaccineOtherNameGroup" style="display: none;">
                    <div class="form-group">
                        <label for="vaccineOtherName">其他疫苗名稱</label>
                        <input type="text" id="vaccineOtherName" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label for="vaccineDate">接種日期</label>
                    <input type="date" id="vaccineDate" class="form-control">
                </div>
                <div class="form-group">
                    <label for="vaccineLocation">接種地點</label>
                    <input type="text" id="vaccineLocation" class="form-control" placeholder="例：衛生所、兒科診所">
                </div>
                <div class="form-group">
                    <label for="vaccineNote">備註</label>
                    <textarea id="vaccineNote" class="form-control" rows="2" placeholder="備註（選填）"></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="vaccineSetNextReminder" style="margin-right: 5px;"> 設定下一劑提醒
                    </label>
                    <div id="vaccineNextReminderOptions" style="margin-top: 10px; display: none;">
                        <div class="form-group">
                            <label for="vaccineNextDate">預計下一劑日期</label>
                            <input type="date" id="vaccineNextDate" class="form-control">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="saveVaccineReminderBtn">設定提醒</button>
                <button class="btn" id="cancelVaccineReminderBtn">取消</button>
            </div>
        </div>
    </div>

    <!-- 新增：快速添加回診提醒模態框 -->
    <div id="quickMedicalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>回診提醒</h3>
                <button class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="medicalReminderDate">回診日期 <span class="text-danger">*</span></label>
                    <input type="date" id="medicalReminderDate" class="form-control">
                </div>
                <div class="form-group">
                    <label for="medicalReminderProvider">醫療機構/醫師</label>
                    <input type="text" id="medicalReminderProvider" class="form-control" placeholder="例：台大醫院、林醫師">
                </div>
                <div class="form-group">
                    <label for="medicalReminderType">回診類型</label>
                    <select id="medicalReminderType" class="form-control">
                        <option value="例行檢查">例行檢查</option>
                        <option value="疫苗接種">疫苗接種</option>
                        <option value="複診">複診/回診</option>
                        <option value="專科諮詢">專科諮詢</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="medicalReminderReason">原因/備註</label>
                    <textarea id="medicalReminderReason" class="form-control" rows="2" placeholder="例：複診、檢查傷口癒合情況"></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="medicalSetPreReminder" checked style="margin-right: 5px;"> 設定提前提醒
                    </label>
                    <div id="medicalPreReminderOptions" style="margin-top: 10px;">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="medicalPreReminderDays">提前天數</label>
                                    <select id="medicalPreReminderDays" class="form-control">
                                        <option value="1">1天前</option>
                                        <option value="2" selected>2天前</option>
                                        <option value="3">3天前</option>
                                        <option value="7">1週前</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="saveMedicalReminderBtn">設定提醒</button>
                <button class="btn" id="cancelMedicalReminderBtn">取消</button>
            </div>
        </div>
    </div>

    <!-- 新增：快速添加成長檢測提醒模態框 -->
    <div id="quickGrowthReminderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>成長檢測提醒</h3>
                <button class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="growthReminderDate">檢測日期 <span class="text-danger">*</span></label>
                    <input type="date" id="growthReminderDate" class="form-control">
                </div>
                <div class="form-group">
                    <label for="growthReminderLocation">測量地點</label>
                    <select id="growthReminderLocation" class="form-control">
                        <option value="家中">家中</option>
                        <option value="診所">診所</option>
                        <option value="健康中心">健康中心</option>
                        <option value="醫院">醫院</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="growthReminderNote">備註</label>
                    <textarea id="growthReminderNote" class="form-control" rows="2" placeholder="額外資訊（選填）"></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="growthSetPreReminder" checked style="margin-right: 5px;"> 設定提前提醒
                    </label>
                    <div id="growthPreReminderOptions" style="margin-top: 10px;">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="growthPreReminderDays">提前天數</label>
                                    <select id="growthPreReminderDays" class="form-control">
                                        <option value="1">1天前</option>
                                        <option value="2" selected>2天前</option>
                                        <option value="3">3天前</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="growthSetRecurring" style="margin-right: 5px;"> 設定定期提醒
                    </label>
                    <div id="growthRecurringOptions" style="margin-top: 10px; display: none;">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="growthRecurringInterval">重複間隔</label>
                                    <select id="growthRecurringInterval" class="form-control">
                                        <option value="1">每月</option>
                                        <option value="2">每2個月</option>
                                        <option value="3">每3個月</option>
                                        <option value="6">每半年</option>
                                        <option value="12">每年</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="growthRecurringCount">重複次數</label>
                                    <select id="growthRecurringCount" class="form-control">
                                        <option value="2">2次</option>
                                        <option value="3">3次</option>
                                        <option value="4">4次</option>
                                        <option value="6">6次</option>
                                        <option value="12">12次</option>
                                        <option value="0">持續</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="saveGrowthReminderBtn">設定提醒</button>
                <button class="btn" id="cancelGrowthReminderBtn">取消</button>
            </div>
        </div>
    </div>

    <!-- 藥物詳情模態框 -->
    <div id="medicineDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>藥物詳情</h3>
                <button class="modal-close">×</button>
            </div>
            <div class="modal-body" id="medicineDetailContent">
                <!-- 藥物詳情內容將在這裡動態生成 -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="deleteMedicineBtn">刪除藥物</button>
                <button class="btn btn-primary" id="editMedicineBtn">編輯</button>
                <button class="btn" id="closeMedicineDetailBtn">關閉</button>
            </div>
        </div>
    </div>

    <!-- 藥物服用記錄模態框 -->
    <div id="medicineDoseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>記錄藥物服用</h3>
                <button class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>正在記錄服用：<span id="medicineDoseName" style="font-weight: 600;"></span></label>
                    <div id="medicineDoseInfo" style="margin-top: 5px; font-size: 0.9rem;"></div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="medicineDoseTime">服用時間</label>
                            <input type="datetime-local" id="medicineDoseTime" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="medicineDoseStatus">服用狀態</label>
                            <select id="medicineDoseStatus" class="form-control">
                                <option value="taken">已服用</option>
                                <option value="partial">部分服用</option>
                                <option value="missed">未服用</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="medicineDoseNote">備註</label>
                    <textarea id="medicineDoseNote" class="form-control" rows="3" placeholder="例：服藥時的反應、副作用觀察等"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="saveMedicineDoseBtn">儲存</button>
                <button class="btn" id="cancelMedicineDoseBtn">取消</button>
            </div>
        </div>
    </div>

    <script>
      // 核心資料模型
        const appData = {
            children: [],
            selectedChild: null,
            records: {},
            milestones: {},
            quickOptions: {
                feeding: [],
                lastFeeding: null,
                sleepStartTime: null
            },
            // 提醒數據結構
            reminders: {},
            // 新增：用藥數據結構
            medicines: {},
            // 新增：成長數據結構 
            growthData: {},
            // 新增：WHO成長參考標準
            growthStandards: {
                // 這裡將在初始化時加載標準數據
            }
        };

        // 新增：匯入數據臨時存儲
        let importedData = null;

        // 里程碑定義
        const milestonesDefinition = {
            "0-3": {
                "運動技能": [
                    { name: "抬頭", typicalAge: "1-2個月" },
                    { name: "翻身 (從腹部到背部)", typicalAge: "3-4個月" },
                    { name: "抓握物品", typicalAge: "3個月" },
                    { name: "雙手合十", typicalAge: "3個月" }
                ],
                "語言能力": [
                    { name: "發出咕咕聲", typicalAge: "1-2個月" },
                    { name: "笑聲回應", typicalAge: "2個月" },
                    { name: "模仿聲音", typicalAge: "2-3個月" }
                ],
                "社交/情緒發展": [
                    { name: "社交性微笑", typicalAge: "1-2個月" },
                    { name: "認人", typicalAge: "2-3個月" },
                    { name: "對聲音表現出興趣", typicalAge: "0-3個月" }
                ],
                "認知發展": [
                    { name: "追視移動物體", typicalAge: "1-2個月" },
                    { name: "注視臉部", typicalAge: "0-1個月" },
                    { name: "開始認識物體恆存", typicalAge: "3個月" }
                ]
            },
            // 其他年齡段數據保持不變...
        };

        // 照顧提示數據定義
        const careTipsData = {
            // 保留原有的照顧提示數據...
        };

        // 新增：WHO成長標準數據（簡化版）
        const whoGrowthStandards = {
            male: {
                height: {
                    // 格式: 月齡: [p3, p15, p50, p85, p97]
                    0: [46.3, 48.0, 49.9, 51.8, 53.4],
                    1: [51.1, 52.9, 54.7, 56.6, 58.2],
                    2: [54.5, 56.4, 58.4, 60.4, 62.1],
                    3: [57.2, 59.1, 61.4, 63.5, 65.3],
                    // 更多數據...
                },
                weight: {
                    0: [2.5, 2.9, 3.3, 3.9, 4.3],
                    1: [3.4, 3.9, 4.5, 5.1, 5.7],
                    2: [4.2, 4.9, 5.6, 6.3, 7.0],
                    3: [5.0, 5.7, 6.4, 7.2, 8.0],
                    // 更多數據...
                },
                headCircumference: {
                    0: [32.1, 33.1, 34.5, 35.7, 36.6],
                    1: [35.1, 36.1, 37.3, 38.4, 39.2],
                    2: [36.9, 37.9, 39.1, 40.2, 41.0],
                    3: [38.3, 39.2, 40.5, 41.7, 42.5],
                    // 更多數據...
                },
                bmi: {
                    // BMI數據
                }
            },
            female: {
                height: {
                    0: [45.6, 47.2, 49.1, 51.0, 52.7],
                    1: [50.0, 51.7, 53.7, 55.6, 57.4],
                    2: [53.0, 54.9, 57.1, 59.1, 61.0],
                    3: [55.4, 57.5, 59.8, 62.0, 63.9],
                    // 更多數據...
                },
                weight: {
                    0: [2.4, 2.8, 3.2, 3.7, 4.2],
                    1: [3.2, 3.6, 4.2, 4.8, 5.4],
                    2: [3.9, 4.5, 5.1, 5.8, 6.5],
                    3: [4.5, 5.2, 5.8, 6.6, 7.4],
                    // 更多數據...
                },
                headCircumference: {
                    0: [31.7, 32.7, 33.9, 35.1, 36.1],
                    1: [34.5, 35.4, 36.5, 37.7, 38.6],
                    2: [36.0, 37.0, 38.3, 39.5, 40.5],
                    3: [37.2, 38.2, 39.5, 40.8, 41.8],
                    // 更多數據...
                },
                bmi: {
                    // BMI數據
                }
            }
        };

        // 初始化應用程式
        function initApp() {
            loadData();
            initEventListeners();
            setCurrentDateTime();
            updateChildSelector();
            checkSelectedChild();
            initQuickActionButtons();
            checkPermission();
            checkAndUpdateReminders();
            
            // 新增：初始化成長標準數據
            appData.growthStandards = whoGrowthStandards;
            
            // 新增：初始化藥物管理標籤功能
            initMedicineTabFunctions();
        }

        // 載入資料
        function loadData() {
            const savedChildren = localStorage.getItem('children');
            if (savedChildren) {
                appData.children = JSON.parse(savedChildren);
            }
            
            const selectedChildId = localStorage.getItem('selectedChild');
            if (selectedChildId) {
                appData.selectedChild = selectedChildId;
                loadChildData(selectedChildId);
            }

            // 載入快速記錄選項
            const quickOptions = localStorage.getItem('quickOptions');
            if (quickOptions) {
                appData.quickOptions = JSON.parse(quickOptions);
            } else {
                // 初始化默認快速選項
                appData.quickOptions = {
                    feeding: [
                        { type: '母乳', amount: '15', unit: 'min' },
                        { type: '配方奶', amount: '120', unit: 'ml' },
                        { type: '副食品', amount: '1', unit: '份' }
                    ],
                    lastFeeding: null,
                    sleepStartTime: null
                };
                saveQuickOptions();
            }

            // 載入提醒資料
            const reminders = localStorage.getItem('reminders');
            if (reminders) {
                appData.reminders = JSON.parse(reminders);
            } else {
                appData.reminders = {};
                saveReminders();
            }
            
            // 新增：載入用藥資料
            const medicines = localStorage.getItem('medicines');
            if (medicines) {
                appData.medicines = JSON.parse(medicines);
            } else {
                appData.medicines = {};
                saveMedicines();
            }
            
            // 新增：載入成長資料
            const growthData = localStorage.getItem('growthData');
            if (growthData) {
                appData.growthData = JSON.parse(growthData);
            } else {
                appData.growthData = {};
                saveGrowthData();
            }

            // 檢查是否有進行中的睡眠記錄
            checkOngoingSleep();
        }

        // 載入特定兒童的資料
        function loadChildData(childId) {
            if (!childId) return;
            
            const records = localStorage.getItem(`records_${childId}`);
            if (records) {
                appData.records[childId] = JSON.parse(records);
            } else {
                appData.records[childId] = [];
            }
            
            const milestones = localStorage.getItem(`milestones_${childId}`);
            if (milestones) {
                appData.milestones[childId] = JSON.parse(milestones);
            } else {
                // 初始化里程碑資料
                initMilestones(childId);
            }
            
            // 確保藥物數據和成長數據結構存在
            if (!appData.medicines[childId]) {
                appData.medicines[childId] = [];
            }
            
            if (!appData.growthData[childId]) {
                appData.growthData[childId] = [];
            }
        }

        // 儲存快速記錄選項
        function saveQuickOptions() {
            localStorage.setItem('quickOptions', JSON.stringify(appData.quickOptions));
        }

        // 儲存提醒資料
        function saveReminders() {
            localStorage.setItem('reminders', JSON.stringify(appData.reminders));
        }
        
        // 新增：儲存用藥資料
        function saveMedicines() {
            localStorage.setItem('medicines', JSON.stringify(appData.medicines));
        }
        
        // 新增：儲存成長資料
        function saveGrowthData() {
            localStorage.setItem('growthData', JSON.stringify(appData.growthData));
        }

        // 檢查是否有進行中的睡眠記錄
        function checkOngoingSleep() {
            const sleepStartTime = appData.quickOptions.sleepStartTime;
            if (sleepStartTime) {
                const startTime = new Date(sleepStartTime);
                // 更新睡眠計時器顯示
                updateSleepTimerDisplay(startTime);
                document.getElementById('sleepTimerBadge').classList.add('active');
            }
        }

        // 初始化里程碑資料
        function initMilestones(childId) {
            appData.milestones[childId] = {};
            
            for (const ageGroup in milestonesDefinition) {
                for (const category in milestonesDefinition[ageGroup]) {
                    milestonesDefinition[ageGroup][category].forEach(milestone => {
                        const milestoneId = `${ageGroup}_${category}_${milestone.name}`;
                        if (!appData.milestones[childId]) {
                            appData.milestones[childId] = {};
                        }
                        appData.milestones[childId][milestoneId] = {
                            achieved: false,
                            date: ''
                        };
                    });
                }
            }
            
            saveMilestones(childId);
        }

        // 儲存里程碑資料
        function saveMilestones(childId) {
            localStorage.setItem(`milestones_${childId}`, JSON.stringify(appData.milestones[childId]));
        }

        // 儲存兒童資料
        function saveChildren() {
            localStorage.setItem('children', JSON.stringify(appData.children));
        }

        // 儲存記錄資料
        function saveRecords(childId) {
            localStorage.setItem(`records_${childId}`, JSON.stringify(appData.records[childId]));
        }

        // 初始化標籤頁功能
        function initMedicineTabFunctions() {
            // 藥物管理標籤切換
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabContent = this.getAttribute('data-tab-content');
                    
                    // 切換標籤激活狀態
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 切換內容區域
                    document.querySelectorAll('.tab-content-section').forEach(section => {
                        section.style.display = 'none';
                    });
                    document.getElementById(tabContent).style.display = 'block';
                    
                    // 更新特定標籤頁的內容
                    if (tabContent === 'medicineList') {
                        updateMedicineList();
                    } else if (tabContent === 'medicineHistory') {
                        updateMedicineHistory();
                    }
                });
            });
            
            // 藥物篩選按鈕
            document.querySelectorAll('.medicine-filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.medicine-filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const filter = this.getAttribute('data-filter');
                    updateMedicineList(filter);
                });
            });
            
            // 藥物服用頻率切換
            document.getElementById('medicineFrequency').addEventListener('change', function() {
                const customFrequencyCol = document.getElementById('medicineCustomFrequencyCol');
                if (this.value === 'custom') {
                    customFrequencyCol.style.display = 'block';
                } else {
                    customFrequencyCol.style.display = 'none';
                }
                
                // 更新服藥時間選項
                updateMedicineTimeOptions(this.value);
            });
            
            // 保存藥物按鈕
            document.getElementById('saveMedicineBtn').addEventListener('click', saveMedicine);
            
            // 快速服藥選擇藥物下拉框變更
            document.getElementById('quickMedicineSelect').addEventListener('change', function() {
                const medicineId = this.value;
                const detailsSection = document.getElementById('quickMedicineDetails');
                
                if (!medicineId) {
                    detailsSection.style.display = 'none';
                    document.getElementById('saveQuickMedicineBtn').disabled = true;
                    return;
                }
                
                // 查找所選的藥物
                const medicine = findMedicineById(medicineId);
                if (!medicine) {
                    detailsSection.style.display = 'none';
                    document.getElementById('saveQuickMedicineBtn').disabled = true;
                    return;
                }
                
                // 顯示藥物詳情
                document.getElementById('quickMedicineName').textContent = medicine.name;
                document.getElementById('quickMedicineDosageInfo').textContent = 
                    `${medicine.dosage} ${medicine.dosageUnit} ${medicine.form} | ${getMedicineFrequencyText(medicine.frequency)}`;
                
                // 設置當前時間為默認服藥時間
                const now = new Date();
                const isoString = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                document.getElementById('quickMedicineTime').value = isoString;
                
                // 顯示詳情區域
                detailsSection.style.display = 'block';
                document.getElementById('saveQuickMedicineBtn').disabled = false;
            });
            
            // 保存快速服藥記錄
            document.getElementById('saveQuickMedicineBtn').addEventListener('click', saveQuickMedicineRecord);
            
            // 成長圖表標籤切換
            document.querySelectorAll('.growth-chart-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.growth-chart-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    const chartType = this.getAttribute('data-chart');
                    updateGrowthChart(chartType);
                });
            });
            
            // 保存成長記錄
            document.getElementById('saveGrowthBtn').addEventListener('click', saveGrowthRecord);
            
            // 保存就醫記錄
            document.getElementById('saveMedicalBtn').addEventListener('click', saveMedicalRecord);
            
            // 就醫回診選項
            document.getElementById('medicalFollowUpNeeded').addEventListener('change', function() {
                const followUpDateCol = document.getElementById('medicalFollowUpDateCol');
                if (this.value === 'yes') {
                    followUpDateCol.style.display = 'block';
                } else {
                    followUpDateCol.style.display = 'none';
                }
            });
            
            // 回診提醒選項
            document.getElementById('medicalSetFollowUpReminder').addEventListener('change', function() {
                const reminderOptions = document.getElementById('medicalFollowUpReminderOptions');
                reminderOptions.style.display = this.checked ? 'block' : 'none';
            });
            
            // 快速記錄成長按鈕
            document.getElementById('saveQuickGrowthBtn').addEventListener('click', saveQuickGrowthRecord);
            
            // 成長提醒設定選項
            document.getElementById('growthSetRecurring').addEventListener('change', function() {
                const recurringOptions = document.getElementById('growthRecurringOptions');
                recurringOptions.style.display = this.checked ? 'block' : 'none';
            });
            
            // 成長提醒保存按鈕
            document.getElementById('saveGrowthReminderBtn').addEventListener('click', saveGrowthReminder);
            
            // 醫療提醒保存按鈕
            document.getElementById('saveMedicalReminderBtn').addEventListener('click', saveMedicalReminder);
        }

        // 新增：更新藥物服用時間選項
        function updateMedicineTimeOptions(frequencyValue) {
            // 根據頻率設定預設的服藥時間
            const morningCheckbox = document.getElementById('medicineTimeMorning');
            const noonCheckbox = document.getElementById('medicineTimeNoon');
            const eveningCheckbox = document.getElementById('medicineTimeEvening');
            const nightCheckbox = document.getElementById('medicineTimeNight');
            
            // 重置所有選項
            morningCheckbox.checked = false;
            noonCheckbox.checked = false;
            eveningCheckbox.checked = false;
            nightCheckbox.checked = false;
            
            // 設定預設時間
            document.getElementById('medicineTimeMorningValue').value = '08:00';
            document.getElementById('medicineTimeNoonValue').value = '12:00';
            document.getElementById('medicineTimeEveningValue').value = '18:00';
            document.getElementById('medicineTimeNightValue').value = '21:00';
            
            // 根據頻率選擇預設選項
            switch (frequencyValue) {
                case 'once':
                    morningCheckbox.checked = true;
                    break;
                case 'twice':
                    morningCheckbox.checked = true;
                    eveningCheckbox.checked = true;
                    break;
                case 'thrice':
                    morningCheckbox.checked = true;
                    noonCheckbox.checked = true;
                    eveningCheckbox.checked = true;
                    break;
                case 'four':
                    morningCheckbox.checked = true;
                    noonCheckbox.checked = true;
                    eveningCheckbox.checked = true;
                    nightCheckbox.checked = true;
                    break;
                case 'needed':
                    // 按需服藥，不設定固定時間
                    break;
                case 'custom':
                    // 自訂頻率，不預設選項
                    break;
            }
        }

        // 新增：保存藥物資料
        function saveMedicine() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童');
                return;
            }
            
            // 收集表單數據
            const name = document.getElementById('medicineName').value.trim();
            const category = document.getElementById('medicineCategory').value;
            const dosage = document.getElementById('medicineDosage').value.trim();
            const dosageUnit = document.getElementById('medicineDosageUnit').value;
            const form = document.getElementById('medicineForm').value;
            const frequency = document.getElementById('medicineFrequency').value;
            const customFrequency = document.getElementById('medicineCustomFrequency').value.trim();
            const startDate = document.getElementById('medicineStartDate').value;
            const duration = document.getElementById('medicineDuration').value;
            const durationUnit = document.getElementById('medicineDurationUnit').value;
            const instructions = document.getElementById('medicineInstructions').value.trim();
            const prescriber = document.getElementById('medicinePrescriber').value.trim();
            const reason = document.getElementById('medicineReason').value.trim();
            const setReminder = document.getElementById('medicineSetReminder').checked;
            const notifyMissed = document.getElementById('medicineNotifyMissed').checked;
            
            // 驗證必填欄位
            if (!name) {
                showToast('請輸入藥物名稱');
                return;
            }
            
            if (!dosage) {
                showToast('請輸入藥物劑量');
                return;
            }
            
            if (!startDate) {
                showToast('請選擇開始日期');
                return;
            }
            
            // 收集服藥時間
            const times = [];
            const timeCheckboxes = ['medicineTimeMorning', 'medicineTimeNoon', 'medicineTimeEvening', 'medicineTimeNight'];
            const timeLabels = ['早上', '中午', '傍晚', '晚上'];
            const timeValues = ['medicineTimeMorningValue', 'medicineTimeNoonValue', 'medicineTimeEveningValue', 'medicineTimeNightValue'];
            
            timeCheckboxes.forEach((checkboxId, index) => {
                if (document.getElementById(checkboxId).checked) {
                    const timeValue = document.getElementById(timeValues[index]).value;
                    if (timeValue) {
                        times.push({
                            label: timeLabels[index],
                            time: timeValue
                        });
                    }
                }
            });
            
            // 計算結束日期
            let endDate = null;
            if (duration && duration !== '0') {
                const durationValue = parseInt(duration);
                const startDateTime = new Date(startDate);
                
                if (durationUnit === 'days') {
                    endDate = new Date(startDateTime.getTime() + durationValue * 24 * 60 * 60 * 1000);
                } else if (durationUnit === 'weeks') {
                    endDate = new Date(startDateTime.getTime() + durationValue * 7 * 24 * 60 * 60 * 1000);
                } else if (durationUnit === 'months') {
                    endDate = new Date(startDateTime);
                    endDate.setMonth(endDate.getMonth() + durationValue);
                }
                
                endDate = endDate.toISOString().split('T')[0];
            }
            
            // 創建藥物記錄
            const medicineId = 'medicine_' + Date.now();
            const medicine = {
                id: medicineId,
                name: name,
                category: category,
                dosage: dosage,
                dosageUnit: dosageUnit,
                form: form,
                frequency: frequency,
                customFrequency: customFrequency,
                times: times,
                startDate: startDate,
                endDate: endDate,
                duration: {
                    value: duration,
                    unit: durationUnit
                },
                instructions: instructions,
                prescriber: prescriber,
                reason: reason,
                dateAdded: new Date().toISOString(),
                status: 'active',
                doses: [],
                reminderSettings: {
                    enabled: setReminder,
                    notifyMissed: notifyMissed
                }
            };
            
            // 添加到藥物列表
            if (!appData.medicines[appData.selectedChild]) {
                appData.medicines[appData.selectedChild] = [];
            }
            
            appData.medicines[appData.selectedChild].push(medicine);
            saveMedicines();
            
            // 如果啟用提醒，創建藥物服用提醒
            if (setReminder) {
                createMedicineReminders(medicine, appData.selectedChild);
            }
            
            // 創建藥物開始記錄
            const record = {
                id: 'record_' + Date.now(),
                type: 'medicine',
                date: new Date().toISOString(),
                medicineId: medicineId,
                action: 'start',
                time: new Date().toISOString(),
                title: `開始服用 ${name}`,
                content: `開始服用 ${name} ${dosage}${dosageUnit}，${frequency === 'custom' ? customFrequency : getMedicineFrequencyText(frequency)}。${reason ? `原因：${reason}` : ''}`
            };
            
            if (!appData.records[appData.selectedChild]) {
                appData.records[appData.selectedChild] = [];
            }
            appData.records[appData.selectedChild].push(record);
            saveRecords(appData.selectedChild);
            
            // 切換回藥物列表標籤
            document.querySelectorAll('.tab').forEach(t => {
                if (t.getAttribute('data-tab-content') === 'medicineList') {
                    t.click();
                }
            });
            
            // 顯示成功消息
            showToast('藥物資料已保存');
        }

        // 新增：創建藥物服用提醒
        function createMedicineReminders(medicine, childId) {
            if (!medicine.reminderSettings.enabled || !medicine.times || medicine.times.length === 0) {
                return;
            }
            
            // 確定提醒結束日期
            const startDate = new Date(medicine.startDate);
            let endDate;
            
            if (medicine.endDate) {
                endDate = new Date(medicine.endDate);
            } else {
                // 如果沒有結束日期，預設為30天後
                endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 30);
            }
            
            // 標準頻率轉換為天數
            let repeatDays = [];
            
            if (medicine.frequency === 'once' || medicine.frequency === 'twice' || 
                medicine.frequency === 'thrice' || medicine.frequency === 'four') {
                // 每天都需要提醒
                repeatDays = [0, 1, 2, 3, 4, 5, 6]; // 週日到週六
            } else if (medicine.frequency === 'needed') {
                // 按需服用不創建定期提醒
                return;
            } else if (medicine.frequency === 'custom') {
                // 自訂頻率，可能需要更複雜的解析
                // 這裡简化為每天提醒
                repeatDays = [0, 1, 2, 3, 4, 5, 6];
            }
            
            // 為每個服藥時間創建提醒
            medicine.times.forEach(timeObj => {
                // 解析時間
                const [hours, minutes] = timeObj.time.split(':').map(Number);
                
                // 設置基準提醒時間
                const reminderDate = new Date(startDate);
                reminderDate.setHours(hours, minutes, 0, 0);
                
                // 如果基準時間已過，調整到明天
                if (reminderDate < new Date()) {
                    reminderDate.setDate(reminderDate.getDate() + 1);
                }
                
                // 創建提醒
                const reminderTitle = `服藥提醒 - ${medicine.name}`;
                const reminderMessage = `該服用 ${medicine.name} ${medicine.dosage}${medicine.dosageUnit} ${timeObj.label}藥`;
                
                addReminder(childId, {
                    type: 'medicine',
                    title: reminderTitle,
                    time: reminderDate.toISOString(),
                    message: reminderMessage,
                    completed: false,
                    repeat: {
                        type: 'weekly',
                        days: repeatDays
                    },
                    metadata: {
                        medicineId: medicine.id,
                        doseTime: timeObj.label,
                        endDate: endDate.toISOString()
                    }
                });
            });
        }

        // 新增：獲取藥物頻率描述文字
        function getMedicineFrequencyText(frequency) {
            switch (frequency) {
                case 'once': return '每天1次';
                case 'twice': return '每天2次';
                case 'thrice': return '每天3次';
                case 'four': return '每天4次';
                case 'needed': return '需要時服用';
                case 'custom': return '自訂頻率'; // 實際應展示使用者填寫的自訂頻率
                default: return frequency;
            }
        }

        // 新增：更新藥物列表
        function updateMedicineList(filter = 'all') {
            const medicineList = document.getElementById('activeMedicineList');
            medicineList.innerHTML = '';
            
            if (!appData.selectedChild || !appData.medicines[appData.selectedChild] || 
                appData.medicines[appData.selectedChild].length === 0) {
                medicineList.innerHTML = '<p>目前沒有藥物記錄</p>';
                return;
            }
            
            // 獲取藥物列表
            let medicines = appData.medicines[appData.selectedChild];
            
            // 應用篩選
            if (filter === 'active') {
                medicines = medicines.filter(m => m.status === 'active');
            } else if (filter === 'completed') {
                medicines = medicines.filter(m => m.status === 'completed');
            }
            
            if (medicines.length === 0) {
                medicineList.innerHTML = `<p>沒有${filter === 'active' ? '使用中' : '已完成'}的藥物記錄</p>`;
                return;
            }
            
            // 按開始日期降序排列
            medicines.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
            
            // 生成列表
            medicines.forEach(medicine => {
                const medicineItem = document.createElement('div');
                medicineItem.className = 'medicine-item';
                medicineItem.setAttribute('data-medicine-id', medicine.id);
                
                // 計算今日是否有需服用的藥物
                const hasTodayDoses = checkMedicineTodayDoses(medicine);
                const todayDosesStatus = getMedicineTodayDosesStatus(medicine);
                
                // 藥物狀態徽章
                const statusClass = medicine.status === 'active' ? 'medicine-status-active' : 'medicine-status-completed';
                const statusText = medicine.status === 'active' ? '使用中' : '已完成';
                
                medicineItem.innerHTML = `
                    <div class="medicine-header">
                        <div class="medicine-title">${medicine.name}</div>
                        <span class="medicine-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="medicine-detail">
                        <label>劑量：</label>
                        <span>${medicine.dosage} ${medicine.dosageUnit}</span>
                    </div>
                    <div class="medicine-detail">
                        <label>頻率：</label>
                        <span>${medicine.frequency === 'custom' ? medicine.customFrequency : getMedicineFrequencyText(medicine.frequency)}</span>
                    </div>
                    <div class="medicine-detail">
                        <label>使用期間：</label>
                        <span>${formatDate(medicine.startDate)} ${medicine.endDate ? '至 ' + formatDate(medicine.endDate) : '持續中'}</span>
                    </div>
                    ${medicine.reason ? `
                    <div class="medicine-detail">
                        <label>用藥原因：</label>
                        <span>${medicine.reason}</span>
                    </div>
                    ` : ''}
                    ${hasTodayDoses ? `
                    <div class="medicine-dose-history">
                        <div style="margin-bottom: 10px; font-weight: 500;">今日服藥狀態</div>
                        ${todayDosesStatus}
                    </div>
                    ` : ''}
                    <div class="medicine-actions">
                        <button class="btn btn-primary btn-record-dose" data-medicine-id="${medicine.id}">
                            <i class="fas fa-check"></i> 記錄服藥
                        </button>
                        <button class="btn btn-view-medicine" data-medicine-id="${medicine.id}">
                            <i class="fas fa-eye"></i> 查看詳情
                        </button>
                    </div>
                `;
                
                medicineList.appendChild(medicineItem);
            });
            
            // 添加按鈕事件監聽
            document.querySelectorAll('.btn-record-dose').forEach(btn => {
                btn.addEventListener('click', function() {
                    const medicineId = this.getAttribute('data-medicine-id');
                    showMedicineDoseModal(medicineId);
                });
            });
            
            document.querySelectorAll('.btn-view-medicine').forEach(btn => {
                btn.addEventListener('click', function() {
                    const medicineId = this.getAttribute('data-medicine-id');
                    showMedicineDetailModal(medicineId);
                });
            });
            
            // 更新藥物快捷服用選擇框
            updateQuickMedicineSelect();
        }

        // 新增：檢查藥物今日服用狀態
        function checkMedicineTodayDoses(medicine) {
            // 檢查是否是活躍藥物且開始日期不晚於今天
            if (medicine.status !== 'active') return false;
            
            const startDate = new Date(medicine.startDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (startDate > today) return false;
            
            // 如果有結束日期，檢查今天是否在結束日期之前
            if (medicine.endDate) {
                const endDate = new Date(medicine.endDate);
                endDate.setHours(23, 59, 59, 999);
                
                if (today > endDate) return false;
            }
            
            // 檢查藥物服用頻率
            if (medicine.frequency === 'needed') {
                return false; // 按需服用不顯示今日狀態
            }
            
            return true;
        }

        // 新增：獲取藥物今日服用狀態HTML
        function getMedicineTodayDosesStatus(medicine) {
            if (!checkMedicineTodayDoses(medicine)) {
                return '';
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // 獲取今日應服用的時間
            const scheduledDoses = [];
            
            if (medicine.times && medicine.times.length > 0) {
                medicine.times.forEach(timeObj => {
                    scheduledDoses.push({
                        label: timeObj.label,
                        time: timeObj.time,
                        status: 'scheduled'
                    });
                });
            }
            
            // 檢查今日已記錄的服用
            if (medicine.doses) {
                medicine.doses.forEach(dose => {
                    const doseTime = new Date(dose.time);
                    
                    if (doseTime >= today && doseTime < tomorrow) {
                        // 尋找對應的預定劑量
                        for (let i = 0; i < scheduledDoses.length; i++) {
                            if (scheduledDoses[i].label === dose.timeLabel) {
                                scheduledDoses[i].status = dose.status;
                                scheduledDoses[i].actualTime = doseTime;
                                break;
                            }
                        }
                    }
                });
            }
            
            // 生成HTML
            let html = `<div class="medicine-checklist-items">`;
            
            scheduledDoses.forEach(dose => {
                const statusClass = dose.status === 'taken' ? 'taken' : dose.status === 'missed' ? 'missed' : '';
                const statusText = dose.status === 'taken' ? '已服用' : dose.status === 'missed' ? '未服用' : dose.status === 'partial' ? '部分服用' : '待服用';
                const statusIcon = dose.status === 'taken' ? '<i class="fas fa-check"></i>' : dose.status === 'missed' ? '<i class="fas fa-times"></i>' : dose.status === 'partial' ? '<i class="fas fa-adjust"></i>' : '<i class="far fa-clock"></i>';
                
                html += `
                    <div class="medicine-checklist-item ${statusClass}">
                        <div class="medicine-checklist-time">${dose.label} ${dose.time}</div>
                        <div class="medicine-checklist-status">
                            ${statusIcon} ${statusText}
                        </div>
                        ${dose.actualTime ? `<div style="font-size: 0.8rem; margin-top: 5px;">${formatDateTime(dose.actualTime)}</div>` : ''}
                    </div>
                `;
            });
            
            html += `</div>`;
            
            return html;
        }

        // 新增：顯示藥物服用記錄模態框
        function showMedicineDoseModal(medicineId) {
            const medicine = findMedicineById(medicineId);
            if (!medicine) {
                showToast('找不到指定的藥物');
                return;
            }
            
            const modal = document.getElementById('medicineDoseModal');
            
            // 設置藥物資訊
            document.getElementById('medicineDoseName').textContent = medicine.name;
            document.getElementById('medicineDoseInfo').textContent = 
                `${medicine.dosage} ${medicine.dosageUnit} ${medicine.form} | ${getMedicineFrequencyText(medicine.frequency)}`;
            
            // 設置當前時間
            const now = new Date();
            const isoString = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('medicineDoseTime').value = isoString;
            
            // 設置默認狀態
            document.getElementById('medicineDoseStatus').value = 'taken';
            document.getElementById('medicineDoseNote').value = '';
            
            // 設置保存按鈕事件
            const saveBtn = document.getElementById('saveMedicineDoseBtn');
            saveBtn.onclick = function() {
                saveMedicineDose(medicineId);
            };
            
            // 顯示模態框
            modal.classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }

        // 新增：保存藥物服用記錄
        function saveMedicineDose(medicineId) {
            const medicine = findMedicineById(medicineId);
            if (!medicine) {
                showToast('找不到指定的藥物');
                closeModals();
                return;
            }
            
            const doseTime = document.getElementById('medicineDoseTime').value;
            const doseStatus = document.getElementById('medicineDoseStatus').value;
            const doseNote = document.getElementById('medicineDoseNote').value.trim();
            
            if (!doseTime) {
                showToast('請選擇服用時間');
                return;
            }
            
            // 確定是哪個時段的藥
            const doseDateTime = new Date(doseTime);
            const hours = doseDateTime.getHours();
            
            let timeLabel = '';
            if (hours >= 5 && hours < 11) {
                timeLabel = '早上';
            } else if (hours >= 11 && hours < 14) {
                timeLabel = '中午';
            } else if (hours >= 14 && hours < 19) {
                timeLabel = '傍晚';
            } else {
                timeLabel = '晚上';
            }
            
            // 創建服用記錄
            const doseRecord = {
                id: 'dose_' + Date.now(),
                medicineId: medicineId,
                time: doseDateTime.toISOString(),
                timeLabel: timeLabel,
                status: doseStatus,
                note: doseNote
            };
            
            // 添加到藥物服用歷史
            if (!medicine.doses) {
                medicine.doses = [];
            }
            
            medicine.doses.push(doseRecord);
            
            // 更新藥物狀態(如果這是最後一劑且有結束日期)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (medicine.endDate) {
                const endDate = new Date(medicine.endDate);
                endDate.setHours(23, 59, 59, 999);
                
                if (today >= endDate) {
                    // 檢查是否所有今日劑量都已服用
                    const allDosesTaken = allTodayDosesTaken(medicine);
                    
                    if (allDosesTaken) {
                        medicine.status = 'completed';
                        
                        // 創建結束記錄
                        const record = {
                            id: 'record_' + Date.now(),
                            type: 'medicine',
                            date: new Date().toISOString(),
                            medicineId: medicineId,
                            action: 'end',
                            time: new Date().toISOString(),
                            title: `完成服用 ${medicine.name}`,
                            content: `完成服用 ${medicine.name} ${medicine.dosage}${medicine.dosageUnit}，療程已結束。`
                        };
                        
                        if (!appData.records[appData.selectedChild]) {
                            appData.records[appData.selectedChild] = [];
                        }
                        appData.records[appData.selectedChild].push(record);
                        saveRecords(appData.selectedChild);
                    }
                }
            }
            
            // 保存更新後的藥物資料
            saveMedicines();
            
            // 創建服用記錄
            const record = {
                id: 'record_' + Date.now(),
                type: 'medicine',
                date: doseDateTime.toISOString(),
                medicineId: medicineId,
                action: 'dose',
                time: doseDateTime.toISOString(),
                title: `服用 ${medicine.name}`,
                content: `${timeLabel}服用 ${medicine.name} ${medicine.dosage}${medicine.dosageUnit}，狀態: ${doseStatus === 'taken' ? '已服用' : doseStatus === 'partial' ? '部分服用' : '未服用'}。${doseNote ? `備註: ${doseNote}` : ''}`
            };
            
            if (!appData.records[appData.selectedChild]) {
                appData.records[appData.selectedChild] = [];
            }
            appData.records[appData.selectedChild].push(record);
            saveRecords(appData.selectedChild);
            
            // 關閉模態框並更新藥物列表
            closeModals();
            updateMedicineList();
            
            // 顯示成功訊息
            showToast('服藥記錄已保存');
        }

        // 新增：快速服藥記錄
        function saveQuickMedicineRecord() {
            const medicineId = document.getElementById('quickMedicineSelect').value;
            if (!medicineId) {
                showToast('請選擇藥物');
                return;
            }
            
            const medicine = findMedicineById(medicineId);
            if (!medicine) {
                showToast('找不到指定的藥物');
                closeModals();
                return;
            }
            
            const doseTime = document.getElementById('quickMedicineTime').value;
            const doseStatus = document.getElementById('quickMedicineDoseStatus').value;
            const doseNote = document.getElementById('quickMedicineNote').value.trim();
            
            if (!doseTime) {
                showToast('請選擇服用時間');
                return;
            }
            
            // 確定是哪個時段的藥
            const doseDateTime = new Date(doseTime);
            const hours = doseDateTime.getHours();
            
            let timeLabel = '';
            if (hours >= 5 && hours < 11) {
                timeLabel = '早上';
            } else if (hours >= 11 && hours < 14) {
                timeLabel = '中午';
            } else if (hours >= 14 && hours < 19) {
                timeLabel = '傍晚';
            } else {
                timeLabel = '晚上';
            }
            
            // 創建服用記錄
            const doseRecord = {
                id: 'dose_' + Date.now(),
                medicineId: medicineId,
                time: doseDateTime.toISOString(),
                timeLabel: timeLabel,
                status: doseStatus,
                note: doseNote
            };
            
            // 添加到藥物服用歷史
            if (!medicine.doses) {
                medicine.doses = [];
            }
            
            medicine.doses.push(doseRecord);
            
            // 保存更新後的藥物資料
            saveMedicines();
            
            // 創建服用記錄
            const record = {
                id: 'record_' + Date.now(),
                type: 'medicine',
                date: doseDateTime.toISOString(),
                medicineId: medicineId,
                action: 'dose',
                time: doseDateTime.toISOString(),
                title: `服用 ${medicine.name}`,
                content: `${timeLabel}服用 ${medicine.name} ${medicine.dosage}${medicine.dosageUnit}，狀態: ${doseStatus === 'taken' ? '已服用' : doseStatus === 'partial' ? '部分服用' : '未服用'}。${doseNote ? `備註: ${doseNote}` : ''}`
            };
            
            if (!appData.records[appData.selectedChild]) {
                appData.records[appData.selectedChild] = [];
            }
            appData.records[appData.selectedChild].push(record);
            saveRecords(appData.selectedChild);
            
            // 關閉模態框
            closeModals();
            
            // 顯示成功訊息
            showToast('服藥記錄已保存');
        }

        // 新增：檢查所有今日劑量是否已記錄
        function allTodayDosesTaken(medicine) {
            if (!medicine.times || medicine.times.length === 0) {
                return true;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // 檢查每個時間段是否都有記錄
            for (const timeObj of medicine.times) {
                let found = false;
                
                if (medicine.doses) {
                    for (const dose of medicine.doses) {
                        const doseTime = new Date(dose.time);
                        
                        if (doseTime >= today && doseTime < tomorrow && dose.timeLabel === timeObj.label) {
                            found = true;
                            break;
                        }
                    }
                }
                
                if (!found) {
                    return false;
                }
            }
            
            return true;
        }

        // 新增：查找藥物通過ID
        function findMedicineById(medicineId) {
            if (!appData.selectedChild || !appData.medicines[appData.selectedChild]) {
                return null;
            }
            
            return appData.medicines[appData.selectedChild].find(m => m.id === medicineId);
        }

        // 新增：更新快速服藥選擇框
        function updateQuickMedicineSelect() {
            const select = document.getElementById('quickMedicineSelect');
            if (!select) return;
            
            // 清空現有選項
            select.innerHTML = '<option value="">-- 請選擇藥物 --</option>';
            
            if (!appData.selectedChild || !appData.medicines[appData.selectedChild]) {
                return;
            }
            
            // 只顯示活躍的藥物
            const activeMedicines = appData.medicines[appData.selectedChild].filter(m => m.status === 'active');
            
            activeMedicines.forEach(medicine => {
                const option = document.createElement('option');
                option.value = medicine.id;
                option.textContent = medicine.name;
                select.appendChild(option);
            });
        }

        // 新增：顯示藥物詳情模態框
        function showMedicineDetailModal(medicineId) {
            const medicine = findMedicineById(medicineId);
            if (!medicine) {
                showToast('找不到指定的藥物');
                return;
            }
            
            const modal = document.getElementById('medicineDetailModal');
            const contentDiv = document.getElementById('medicineDetailContent');
            
            // 計算服藥依從性
            const adherenceRate = calculateMedicineAdherence(medicine);
            
            // 設置藥物詳情內容
            contentDiv.innerHTML = `
                <div class="medicine-detail-header">
                    <h4>${medicine.name}</h4>
                    <span class="badge ${medicine.status === 'active' ? 'badge-success' : 'badge-primary'}">
                        ${medicine.status === 'active' ? '使用中' : '已完成'}
                    </span>
                </div>
                
                <div class="form-row" style="margin-top: 15px;">
                    <div class="form-col">
                        <div class="medicine-detail">
                            <label>劑量：</label>
                            <span>${medicine.dosage} ${medicine.dosageUnit}</span>
                        </div>
                        <div class="medicine-detail">
                            <label>藥物形式：</label>
                            <span>${medicine.form}</span>
                        </div>
                        <div class="medicine-detail">
                            <label>類別：</label>
                            <span>${medicine.category}</span>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="medicine-detail">
                            <label>頻率：</label>
                            <span>${medicine.frequency === 'custom' ? medicine.customFrequency : getMedicineFrequencyText(medicine.frequency)}</span>
                        </div>
                        <div class="medicine-detail">
                            <label>服藥時間：</label>
                            <span>${medicine.times.map(t => t.label + ' ' + t.time).join(', ')}</span>
                        </div>
                        <div class="medicine-detail">
                            <label>服藥依從性：</label>
                            <span>${adherenceRate}%</span>
                        </div>
                    </div>
                </div>
                
                <div class="medicine-detail">
                    <label>使用期間：</label>
                    <span>${formatDate(medicine.startDate)} ${medicine.endDate ? '至 ' + formatDate(medicine.endDate) : '持續中'}</span>
                </div>
                
                ${medicine.instructions ? `
                <div class="medicine-detail">
                    <label>服用說明：</label>
                    <span>${medicine.instructions}</span>
                </div>
                ` : ''}
                
                ${medicine.prescriber ? `
                <div class="medicine-detail">
                    <label>處方者：</label>
                    <span>${medicine.prescriber}</span>
                </div>
                ` : ''}
                
                ${medicine.reason ? `
                <div class="medicine-detail">
                    <label>用藥原因：</label>
                    <span>${medicine.reason}</span>
                </div>
                ` : ''}
                
                <div class="medicine-dose-history" style="margin-top: 20px;">
                    <h4>服藥記錄</h4>
                    ${medicine.doses && medicine.doses.length > 0 ? `
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${medicine.doses.sort((a, b) => new Date(b.time) - new Date(a.time)).map(dose => `
                                <div class="medicine-dose-item">
                                    <span class="medicine-dose-date">${formatDateTime(dose.time)} (${dose.timeLabel})</span>
                                    <span class="medicine-dose-status ${dose.status === 'taken' ? 'medicine-dose-taken' : dose.status === 'missed' ? 'medicine-dose-missed' : ''}">
                                        ${dose.status === 'taken' ? '已服用' : dose.status === 'partial' ? '部分服用' : '未服用'}
                                    </span>
                                </div>
                                ${dose.note ? `<div style="font-size: 0.9rem; margin-left: 20px; color: var(--light-text);">${dose.note}</div>` : ''}
                            `).join('')}
                        </div>
                    ` : '<p>尚無服藥記錄</p>'}
                </div>
            `;
            
            // 設置按鈕事件
            document.getElementById('deleteMedicineBtn').onclick = function() {
                if (confirm(`確定要刪除「${medicine.name}」的藥物記錄嗎？這將同時刪除所有相關的服藥記錄。`)) {
                    deleteMedicine(medicineId);
                    closeModals();
                }
            };
            
            document.getElementById('editMedicineBtn').onclick = function() {
                // 顯示編輯表單
                // 此功能將在未來版本實現
                showToast('藥物編輯功能將在未來版本提供');
            };
            
            // 顯示模態框
            modal.classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }

        // 新增：計算藥物服用依從性
        function calculateMedicineAdherence(medicine) {
            if (!medicine.doses || medicine.doses.length === 0) {
                return 0;
            }
            
            // 計算開始日期至結束日期（或今天）的總劑量數
            const startDate = new Date(medicine.startDate);
            startDate.setHours(0, 0, 0, 0);
            
            let endDate = new Date();
            if (medicine.endDate) {
                const medicineEndDate = new Date(medicine.endDate);
                if (medicineEndDate < endDate) {
                    endDate = medicineEndDate;
                }
            }
            endDate.setHours(23, 59, 59, 999);
            
            // 如果藥物今天才開始，默認依從性為100%
            if (startDate > new Date().setHours(0, 0, 0, 0)) {
                return 100;
            }
            
            // 計算總應服用次數
            const dayCount = Math.ceil((endDate - startDate) / (24 * 60 * 60 * 1000));
            
            let totalDoses = 0;
            if (medicine.frequency === 'once') totalDoses = dayCount;
            else if (medicine.frequency === 'twice') totalDoses = dayCount * 2;
            else if (medicine.frequency === 'thrice') totalDoses = dayCount * 3;
            else if (medicine.frequency === 'four') totalDoses = dayCount * 4;
            else if (medicine.frequency === 'needed') {
                // 按需服用，依從性計算為已記錄服用的比例
                return 100;
            } else if (medicine.frequency === 'custom') {
                // 自訂頻率，使用服藥時間數量
                if (medicine.times && medicine.times.length > 0) {
                    totalDoses = dayCount * medicine.times.length;
                } else {
                    totalDoses = dayCount; // 默認一天一次
                }
            }
            
            // 計算已服用次數
            const takenDoses = medicine.doses.filter(dose => dose.status === 'taken').length;
            const partialDoses = medicine.doses.filter(dose => dose.status === 'partial').length * 0.5; // 部分服用算一半
            
            const adherence = Math.min(Math.round(((takenDoses + partialDoses) / totalDoses) * 100), 100);
            
            return adherence;
        }

        // 新增：刪除藥物
        function deleteMedicine(medicineId) {
            if (!appData.selectedChild || !appData.medicines[appData.selectedChild]) {
                return;
            }
            
            // 獲取藥物名稱
            const medicine = findMedicineById(medicineId);
            if (!medicine) return;
            
            const medicineName = medicine.name;
            
            // 刪除藥物
            appData.medicines[appData.selectedChild] = appData.medicines[appData.selectedChild].filter(
                m => m.id !== medicineId
            );
            
            // 刪除相關提醒
            if (appData.reminders[appData.selectedChild]) {
                appData.reminders[appData.selectedChild] = appData.reminders[appData.selectedChild].filter(
                    r => !r.metadata || r.metadata.medicineId !== medicineId
                );
                saveReminders();
            }
            
            // 保存更新後的藥物資料
            saveMedicines();
            
            // 創建刪除記錄
            const record = {
                id: 'record_' + Date.now(),
                type: 'medicine',
                date: new Date().toISOString(),
                action: 'delete',
                time: new Date().toISOString(),
                title: `刪除藥物 ${medicineName}`,
                content: `刪除了藥物記錄: ${medicineName}`
            };
            
            if (!appData.records[appData.selectedChild]) {
                appData.records[appData.selectedChild] = [];
            }
            appData.records[appData.selectedChild].push(record);
            saveRecords(appData.selectedChild);
            
            // 更新藥物列表
            updateMedicineList();
            
            // 顯示成功訊息
            showToast('藥物記錄已刪除');
        }

        // 新增：保存成長記錄
        function saveGrowthRecord() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童');
                return;
            }
            
            // 收集表單數據
            const date = document.getElementById('growthDate').value;
            const location = document.getElementById('growthLocation').value.trim();
            const height = document.getElementById('growthHeight').value;
            const weight = document.getElementById('growthWeight').value;
            const headCircumference = document.getElementById('growthHeadCircumference').value;
            const note = document.getElementById('growthNote').value.trim();
            
            // 驗證
            if (!date) {
                showToast('請選擇記錄日期');
                return;
            }
            
            if (!height && !weight && !headCircumference) {
                showToast('請至少填寫一項測量值(身高/體重/頭圍)');
                return;
            }
            
            // 創建記錄
            const growthRecord = {
                id: 'growth_' + Date.now(),
                date: date,
                dateAdded: new Date().toISOString(),
                location: location,
                measurements: {}
            };
            
            // 添加測量值
            if (height) growthRecord.measurements.height = parseFloat(height);
            if (weight) growthRecord.measurements.weight = parseFloat(weight);
            if (headCircumference) growthRecord.measurements.headCircumference = parseFloat(headCircumference);
            
            // 計算BMI(如果有身高和體重)
            if (height && weight) {
                const heightInMeters = parseFloat(height) / 100;
                const bmi = parseFloat(weight) / (heightInMeters * heightInMeters);
                growthRecord.measurements.bmi = Math.round(bmi * 10) / 10; // 四捨五入到小數點後一位
            }
            
            // 添加備註
            if (note) growthRecord.note = note;
            
            // 添加成長記錄
            if (!appData.growthData[appData.selectedChild]) {
                appData.growthData[appData.selectedChild] = [];
            }
            
            appData.growthData[appData.selectedChild].push(growthRecord);
            saveGrowthData();
            
            // 添加到一般記錄
            const record = {
                id: 'record_' + Date.now(),
                type: 'growth',
                date: date + 'T00:00:00',
                time: date + 'T00:00:00',
                title: '成長測量記錄',
                content: `測量地點: ${location || '未指定'}\n` + 
                         `${height ? '身高: ' + height + ' 公分\n' : ''}` +
                         `${weight ? '體重: ' + weight + ' 公斤\n' : ''}` +
                         `${headCircumference ? '頭圍: ' + headCircumference + ' 公分\n' : ''}` +
                         `${growthRecord.measurements.bmi ? 'BMI: ' + growthRecord.measurements.bmi + '\n' : ''}` +
                         `${note ? '備註: ' + note : ''}`
            };
            
            if (!appData.records[appData.selectedChild]) {
                appData.records[appData.selectedChild] = [];
            }
            appData.records[appData.selectedChild].push(record);
            saveRecords(appData.selectedChild);
            
            // 重置表單並更新成長記錄顯示
            document.getElementById('growthHeight').value = '';
            document.getElementById('growthWeight').value = '';
            document.getElementById('growthHeadCircumference').value = '';
            document.getElementById('growthNote').value = '';
            
            updateGrowthRecords();
            updateGrowthChart('height'); // 預設顯示身高圖表
            
            // 顯示成功訊息
            showToast('成長記錄已儲存');
        }

        // 新增：保存快速成長記錄
        function saveQuickGrowthRecord() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童');
                closeModals();
                return;
            }
            
            // 收集表單數據
            const location = document.getElementById('quickGrowthLocation').value;
            const height = document.getElementById('quickGrowthHeight').value;
            const weight = document.getElementById('quickGrowthWeight').value;
            const headCircumference = document.getElementById('quickGrowthHeadCircumference').value;
            const note = document.getElementById('quickGrowthNote').value.trim();
            
            if (!height && !weight && !headCircumference) {
                showToast('請至少填寫一項測量值(身高/體重/頭圍)');
                return;
            }
            
            // 使用當前日期
            const date = new Date().toISOString().split('T')[0];
            
            // 創建記錄
            const growthRecord = {
                id: 'growth_' + Date.now(),
                date: date,
                dateAdded: new Date().toISOString(),
                location: location,
                measurements: {}
            };
            
            // 添加測量值
            if (height) growthRecord.measurements.height = parseFloat(height);
            if (weight) growthRecord.measurements.weight = parseFloat(weight);
            if (headCircumference) growthRecord.measurements.headCircumference = parseFloat(headCircumference);
            
            // 計算BMI(如果有身高和體重)
            if (height && weight) {
                const heightInMeters = parseFloat(height) / 100;
                const bmi = parseFloat(weight) / (heightInMeters * heightInMeters);
                growthRecord.measurements.bmi = Math.round(bmi * 10) / 10; // 四捨五入到小數點後一位
            }
            
            // 添加備註
            if (note) growthRecord.note = note;
            
            // 添加成長記錄
            if (!appData.growthData[appData.selectedChild]) {
                appData.growthData[appData.selectedChild] = [];
            }
            
            appData.growthData[appData.selectedChild].push(growthRecord);
            saveGrowthData();
            
            // 添加到一般記錄
            const record = {
                id: 'record_' + Date.now(),
                type: 'growth',
                date: date + 'T00:00:00',
                time: date + 'T00:00:00',
                title: '成長測量記錄',
                content: `測量地點: ${location || '未指定'}\n` + 
                         `${height ? '身高: ' + height + ' 公分\n' : ''}` +
                         `${weight ? '體重: ' + weight + ' 公斤\n' : ''}` +
                         `${headCircumference ? '頭圍: ' + headCircumference + ' 公分\n' : ''}` +
                         `${growthRecord.measurements.bmi ? 'BMI: ' + growthRecord.measurements.bmi + '\n' : ''}` +
                         `${note ? '備註: ' + note : ''}`
            };
            
            if (!appData.records[appData.selectedChild]) {
                appData.records[appData.selectedChild] = [];
            }
            appData.records[appData.selectedChild].push(record);
            saveRecords(appData.selectedChild);
            
            // 關閉模態框
            closeModals();
            
            // 顯示成功訊息
            showToast('成長記錄已儲存');
        }

        // 新增：更新成長記錄顯示
        function updateGrowthRecords() {
            const recordsContainer = document.getElementById('growthRecords');
            recordsContainer.innerHTML = '';
            
            if (!appData.selectedChild || !appData.growthData[appData.selectedChild] || 
                appData.growthData[appData.selectedChild].length === 0) {
                recordsContainer.innerHTML = '<p>尚無成長記錄</p>';
                return;
            }
            
            // 獲取兒童性別和出生日期（用於百分位計算）
            const child = appData.children.find(c => c.id === appData.selectedChild);
            if (!child) return;
            
            const gender = child.gender === '男' ? 'male' : 'female';
            const birthDate = new Date(child.birthday);
            
            // 排序記錄（最新的在前）
            const sortedRecords = [...appData.growthData[appData.selectedChild]].sort(
                (a, b) => new Date(b.date) - new Date(a.date)
            );
            
            // 生成記錄
            sortedRecords.forEach(record => {
                const recordDate = new Date(record.date);
                
                // 計算年齡（月）
                const ageInMonths = Math.floor((recordDate - birthDate) / (30.44 * 24 * 60 * 60 * 1000));
                
                // 創建記錄元素
                const recordElement = document.createElement('div');
                recordElement.className = 'growth-record-item';
                
                // 添加百分位資訊
                let heightPercentile = '';
                let weightPercentile = '';
                let headCircumferencePercentile = '';
                
                if (record.measurements.height && appData.growthStandards[gender].height[ageInMonths]) {
                    const percentileData = appData.growthStandards[gender].height[ageInMonths];
                    heightPercentile = getPercentileText(record.measurements.height, percentileData);
                }
                
                if (record.measurements.weight && appData.growthStandards[gender].weight[ageInMonths]) {
                    const percentileData = appData.growthStandards[gender].weight[ageInMonths];
                    weightPercentile = getPercentileText(record.measurements.weight, percentileData);
                }
                
                if (record.measurements.headCircumference && appData.growthStandards[gender].headCircumference[ageInMonths]) {
                    const percentileData = appData.growthStandards[gender].headCircumference[ageInMonths];
                    headCircumferencePercentile = getPercentileText(record.measurements.headCircumference, percentileData);
                }
                
                // 內容
                recordElement.innerHTML = `
                    <div class="record-date">
                        ${formatDate(record.date)} (${ageInMonths}個月) ${record.location ? `- ${record.location}` : ''}
                    </div>
                    <div class="growth-record-data">
                        ${record.measurements.height ? `
                            <div class="growth-data-item">
                                <h4>身高</h4>
                                <div class="growth-data-value">
                                    ${record.measurements.height} <span class="growth-data-unit">公分</span>
                                    ${heightPercentile ? `<span style="font-size: 0.8rem; color: var(--light-text);">(${heightPercentile})</span>` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${record.measurements.weight ? `
                            <div class="growth-data-item">
                                <h4>體重</h4>
                                <div class="growth-data-value">
                                    ${record.measurements.weight} <span class="growth-data-unit">公斤</span>
                                    ${weightPercentile ? `<span style="font-size: 0.8rem; color: var(--light-text);">(${weightPercentile})</span>` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${record.measurements.headCircumference ? `
                            <div class="growth-data-item">
                                <h4>頭圍</h4>
                                <div class="growth-data-value">
                                    ${record.measurements.headCircumference} <span class="growth-data-unit">公分</span>
                                    ${headCircumferencePercentile ? `<span style="font-size: 0.8rem; color: var(--light-text);">(${headCircumferencePercentile})</span>` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${record.measurements.bmi ? `
                            <div class="growth-data-item">
                                <h4>BMI</h4>
                                <div class="growth-data-value">
                                    ${record.measurements.bmi}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    ${record.note ? `<div class="growth-record-note">${record.note}</div>` : ''}
                    
                    <div style="text-align: right; margin-top: 10px;">
                        <button class="btn btn-danger btn-delete-growth" data-id="${record.id}">
                            <i class="fas fa-trash"></i> 刪除
                        </button>
                    </div>
                `;
                
                recordsContainer.appendChild(recordElement);
            });
            
            // 添加刪除按鈕事件
            document.querySelectorAll('.btn-delete-growth').forEach(btn => {
                btn.addEventListener('click', function() {
                    const recordId = this.getAttribute('data-id');
                    if (confirm('確定要刪除此成長記錄嗎？')) {
                        deleteGrowthRecord(recordId);
                    }
                });
            });
        }

        // 新增：獲取百分位文字
        function getPercentileText(value, percentileData) {
            if (!percentileData || percentileData.length < 5) return '';
            
            const [p3, p15, p50, p85, p97] = percentileData;
            
            if (value < p3) return '< 3rd';
            if (value < p15) return '3rd-15th';
            if (value < p50) return '15th-50th';
            if (value < p85) return '50th-85th';
            if (value < p97) return '85th-97th';
            return '> 97th';
        }

        // 新增：刪除成長記錄
        function deleteGrowthRecord(recordId) {
            if (!appData.selectedChild || !appData.growthData[appData.selectedChild]) {
                return;
            }
            
            // 尋找記錄索引
            const recordIndex = appData.growthData[appData.selectedChild].findIndex(r => r.id === recordId);
            if (recordIndex === -1) return;
            
            // 刪除記錄
            appData.growthData[appData.selectedChild].splice(recordIndex, 1);
            saveGrowthData();
            
            // 更新顯示
            updateGrowthRecords();
            updateGrowthChart('height'); // 更新圖表
            
            // 顯示成功消息
            showToast('成長記錄已刪除');
        }

        // 新增：更新成長圖表
        function updateGrowthChart(chartType) {
            const canvas = document.getElementById('growthChart');
            
            // 檢查是否選擇了兒童且有記錄
            if (!appData.selectedChild || !appData.growthData[appData.selectedChild] || 
                appData.growthData[appData.selectedChild].length === 0) {
                
                // 繪製空圖表
                if (window.growthChart) {
                    window.growthChart.destroy();
                }
                
                window.growthChart = new Chart(canvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['無數據'],
                        datasets: [{
                            label: '數據點',
                            data: [0],
                            borderColor: 'rgba(152, 212, 187, 1)',
                            backgroundColor: 'rgba(152, 212, 187, 0.2)'
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                
                return;
            }
            
            // 獲取兒童資訊
            const child = appData.children.find(c => c.id === appData.selectedChild);
            if (!child) return;
            
            const gender = child.gender === '男' ? 'male' : 'female';
            const birthDate = new Date(child.birthday);
            
            // 過濾有選定測量類型數據的記錄
            const validRecords = appData.growthData[appData.selectedChild].filter(
                r => r.measurements && r.measurements[chartType] !== undefined
            );
            
            // 排序記錄（按日期）
            validRecords.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // 準備數據
            const labels = [];
            const dataPoints = [];
            const ageData = [];
            
            validRecords.forEach(record => {
                const recordDate = new Date(record.date);
                labels.push(formatDate(record.date));
                dataPoints.push(record.measurements[chartType]);
                
                // 計算年齡（月）
                const ageInMonths = Math.floor((recordDate - birthDate) / (30.44 * 24 * 60 * 60 * 1000));
                ageData.push(ageInMonths);
            });
            
            // 準備標準線數據
            const standardsDatasets = [];
            
            // 標準線顏色和名稱
            const standardLines = [
                { percentile: 97, color: 'rgba(224, 231, 255, 0.6)', label: '97th' },
                { percentile: 85, color: 'rgba(219, 234, 254, 0.6)', label: '85th' },
                { percentile: 50, color: 'rgba(236, 252, 203, 0.6)', label: '50th' },
                { percentile: 15, color: 'rgba(254, 243, 199, 0.6)', label: '15th' },
                { percentile: 3, color: 'rgba(254, 226, 226, 0.6)', label: '3rd' }
            ];
            
            // 在存在標準資料的情況下添加標準線
            if (appData.growthStandards[gender][chartType]) {
                standardLines.forEach((line, index) => {
                    const standardData = [];
                    
                    // 對每個年齡填入相應的標準值
                    ageData.forEach(age => {
                        // 找到最接近的年齡
                        const closestAge = Object.keys(appData.growthStandards[gender][chartType])
                            .map(a => parseInt(a))
                            .reduce((prev, curr) => 
                                Math.abs(curr - age) < Math.abs(prev - age) ? curr : prev
                            );
                            
                        const percentileIndex = line.percentile === 3 ? 0 :
                                               line.percentile === 15 ? 1 :
                                               line.percentile === 50 ? 2 :
                                               line.percentile === 85 ? 3 : 4;
                                               
                        standardData.push(appData.growthStandards[gender][chartType][closestAge][percentileIndex]);
                    });
                    
                    standardsDatasets.push({
                        label: `${line.label} 百分位`,
                        data: standardData,
                        borderColor: line.color.replace('0.6', '1'),
                        backgroundColor: line.color,
                        fill: index === 0 ? false : '-1',
                        pointRadius: 0,
                        borderWidth: 1,
                        borderDash: line.percentile === 50 ? [] : [5, 5]
                    });
                });
            }
            
            // 添加實際數據線
            standardsDatasets.push({
                label: '實際記錄',
                data: dataPoints,
                borderColor: 'rgba(37, 99, 235, 1)',
                backgroundColor: 'rgba(37, 99, 235, 0.2)',
                pointRadius: 5,
                borderWidth: 2
            });
            
            // 設定Y軸標籤
            const yAxisLabel = chartType === 'height' ? '身高 (公分)' : 
                              chartType === 'weight' ? '體重 (公斤)' : 
                              chartType === 'headCircumference' ? '頭圍 (公分)' : 'BMI';
            
            // 繪製圖表
            if (window.growthChart) {
                window.growthChart.destroy();
            }
            
            window.growthChart = new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: standardsDatasets
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: yAxisLabel
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '日期'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    return `${tooltipItems[0].label} (${ageData[tooltipItems[0].dataIndex]}個月)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 新增：保存就醫記錄
        function saveMedicalRecord() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童');
                return;
            }
            
            // 收集表單數據
            const date = document.getElementById('medicalDate').value;
            const type = document.getElementById('medicalType').value;
            const provider = document.getElementById('medicalProvider').value.trim();
            const specialty = document.getElementById('medicalSpecialty').value;
            const reason = document.getElementById('medicalReason').value.trim();
            const diagnosis = document.getElementById('medicalDiagnosis').value.trim();
            const treatment = document.getElementById('medicalTreatment').value.trim();
            const followUpNeeded = document.getElementById('medicalFollowUpNeeded').value;
            const followUpDate = followUpNeeded === 'yes' ? document.getElementById('medicalFollowUpDate').value : '';
            const cost = document.getElementById('medicalCost').value.trim();
            const note = document.getElementById('medicalNote').value.trim();
            
            // 驗證
            if (!date) {
                showToast('請選擇就醫日期');
                return;
            }
            
            // 創建記錄
            const medicalRecord = {
                id: 'medical_' + Date.now(),
                type: 'medical',
                subType: type,
                date: date,
                dateAdded: new Date().toISOString(),
                provider: provider,
                specialty: specialty,
                reason: reason,
                diagnosis: diagnosis,
                treatment: treatment,
                followUp: {
                    needed: followUpNeeded,
                    date: followUpDate
                },
                cost: cost ? parseFloat(cost) : null,
                note: note
            };
            
            // 添加記錄
            if (!appData.records[appData.selectedChild]) {
                appData.records[appData.selectedChild] = [];
            }
            
            appData.records[appData.selectedChild].push(medicalRecord);
            saveRecords(appData.selectedChild);
            
            // 設置回診提醒
            const setReminder = document.getElementById('medicalSetFollowUpReminder').checked;
            if (setReminder && followUpNeeded === 'yes' && followUpDate) {
                const reminderDate = document.getElementById('medicalReminderDate').value || followUpDate;
                const reminderMessage = document.getElementById('medicalReminderMessage').value || `回診預約 (${provider || specialty || type})`;
                
                // 創建提醒
                addReminder(appData.selectedChild, {
                    type: 'medical',
                    title: '回診提醒',
                    time: new Date(reminderDate + 'T09:00:00').toISOString(), // 設定為上午9點
                    message: reminderMessage,
                    completed: false,
                    repeat: null
                });
                
                showToast('就醫記錄已儲存，並設定回診提醒');
            } else {
                showToast('就醫記錄已儲存');
            }
            
            // 重置表單並更新就醫記錄顯示
            document.getElementById('medicalReason').value = '';
            document.getElementById('medicalDiagnosis').value = '';
            document.getElementById('medicalTreatment').value = '';
            document.getElementById('medicalFollowUpNeeded').value = 'no';
            document.getElementById('medicalFollowUpDateCol').style.display = 'none';
            document.getElementById('medicalFollowUpDate').value = '';
            document.getElementById('medicalCost').value = '';
            document.getElementById('medicalNote').value = '';
            document.getElementById('medicalSetFollowUpReminder').checked = false;
            document.getElementById('medicalFollowUpReminderOptions').style.display = 'none';
            
            updateMedicalRecords();
        }

        // 新增：更新就醫記錄顯示
        function updateMedicalRecords() {
            const recordsContainer = document.getElementById('medicalRecords');
            if (!recordsContainer) return;
            
            recordsContainer.innerHTML = '';
            
            if (!appData.selectedChild || !appData.records[appData.selectedChild] || 
                appData.records[appData.selectedChild].length === 0) {
                recordsContainer.innerHTML = '<p>尚無就醫記錄</p>';
                return;
            }
            
            // 過濾就醫記錄
            const medicalRecords = appData.records[appData.selectedChild].filter(r => r.type === 'medical');
            
            if (medicalRecords.length === 0) {
                recordsContainer.innerHTML = '<p>尚無就醫記錄</p>';
                return;
            }
            
            // 排序記錄（最新的在前）
            medicalRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // 生成記錄
            medicalRecords.forEach(record => {
                const recordElement = document.createElement('div');
                recordElement.className = 'medical-record-item';
                recordElement.setAttribute('data-id', record.id);
                
                recordElement.innerHTML = `
                    <div class="medical-record-date">${formatDate(record.date)}</div>
                    <div class="medical-record-title">
                        ${record.subType || '就醫記錄'} ${record.provider ? `- ${record.provider}` : ''}
                        ${record.specialty ? `(${record.specialty})` : ''}
                    </div>
                    ${record.reason ? `
                        <div class="medical-record-detail">
                            <label>原因/症狀:</label>
                            <span>${record.reason}</span>
                        </div>
                    ` : ''}
                    ${record.diagnosis ? `
                        <div class="medical-record-detail">
                            <label>診斷/結果:</label>
                            <span>${record.diagnosis}</span>
                        </div>
                    ` : ''}
                    ${record.treatment ? `
                        <div class="medical-record-detail">
                            <label>治療/建議:</label>
                            <span>${record.treatment}</span>
                        </div>
                    ` : ''}
                    ${record.followUp && record.followUp.needed !== 'no' ? `
                        <div class="medical-record-detail">
                            <label>回診:</label>
                            <span>${record.followUp.needed === 'yes' ? '需要' : '視情況'} 
                            ${record.followUp.date ? '- ' + formatDate(record.followUp.date) : ''}</span>
                        </div>
                    ` : ''}
                    ${record.cost ? `
                        <div class="medical-record-detail">
                            <label>費用:</label>
                            <span>${record.cost}</span>
                        </div>
                    ` : ''}
                    ${record.note ? `
                        <div class="medical-record-note">
                            <label>備註:</label>
                            <div>${record.note}</div>
                        </div>
                    ` : ''}
                    
                    <div style="text-align: right; margin-top: 10px;">
                        <button class="btn btn-danger btn-delete-medical" data-id="${record.id}">
                            <i class="fas fa-trash"></i> 刪除
                        </button>
                        </div>
                `;
                
                recordsContainer.appendChild(recordElement);
            });
            
            // 添加刪除按鈕事件
            document.querySelectorAll('.btn-delete-medical').forEach(btn => {
                btn.addEventListener('click', function() {
                    const recordId = this.getAttribute('data-id');
                    if (confirm('確定要刪除此就醫記錄嗎？')) {
                        deleteMedicalRecord(recordId);
                    }
                });
            });
        }

        // 新增：刪除就醫記錄
        function deleteMedicalRecord(recordId) {
            if (!appData.selectedChild || !appData.records[appData.selectedChild]) {
                return;
            }
            
            // 尋找記錄索引
            const recordIndex = appData.records[appData.selectedChild].findIndex(r => r.id === recordId);
            if (recordIndex === -1) return;
            
            // 刪除記錄
            appData.records[appData.selectedChild].splice(recordIndex, 1);
            saveRecords(appData.selectedChild);
            
            // 更新顯示
            updateMedicalRecords();
            
            // 顯示成功消息
            showToast('就醫記錄已刪除');
        }

        // 新增：儲存醫療提醒
        function saveMedicalReminder() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童');
                closeModals();
                return;
            }
            
            // 收集表單數據
            const date = document.getElementById('medicalReminderDate').value;
            const provider = document.getElementById('medicalReminderProvider').value.trim();
            const type = document.getElementById('medicalReminderType').value;
            const reason = document.getElementById('medicalReminderReason').value.trim();
            const setPreReminder = document.getElementById('medicalSetPreReminder').checked;
            const preReminderDays = document.getElementById('medicalPreReminderDays').value;
            
            // 驗證
            if (!date) {
                showToast('請選擇回診日期');
                return;
            }
            
            // 創建主要回診提醒
            const appointmentDate = new Date(date + 'T09:00:00'); // 設定為上午9點
            
            const title = `回診提醒 - ${type}`;
            const message = `回診預約${provider ? ` - ${provider}` : ''}${reason ? `\n原因: ${reason}` : ''}`;
            
            addReminder(appData.selectedChild, {
                type: 'medical',
                title: title,
                time: appointmentDate.toISOString(),
                message: message,
                completed: false,
                repeat: null,
                metadata: {
                    appointmentType: type,
                    provider: provider
                }
            });
            
            // 如果設定了提前提醒，創建提前提醒
            if (setPreReminder) {
                const preReminderDate = new Date(appointmentDate);
                preReminderDate.setDate(preReminderDate.getDate() - parseInt(preReminderDays));
                
                addReminder(appData.selectedChild, {
                    type: 'medical',
                    title: `回診預告 - ${type}`,
                    time: preReminderDate.toISOString(),
                    message: `還有${preReminderDays}天就要回診${provider ? ` - ${provider}` : ''}`,
                    completed: false,
                    repeat: null,
                    metadata: {
                        appointmentType: type,
                        provider: provider,
                        isPreReminder: true,
                        mainAppointmentDate: appointmentDate.toISOString()
                    }
                });
            }
            
            // 創建記錄
            const record = {
                id: 'record_' + Date.now(),
                type: 'medical',
                subType: '回診安排',
                date: new Date().toISOString(),
                time: new Date().toISOString(),
                title: '安排回診',
                content: `安排${date}的${type}回診${provider ? ` - ${provider}` : ''}${reason ? `\n原因: ${reason}` : ''}`
            };
            
            if (!appData.records[appData.selectedChild]) {
                appData.records[appData.selectedChild] = [];
            }
            appData.records[appData.selectedChild].push(record);
            saveRecords(appData.selectedChild);
            
            // 關閉模態框
            closeModals();
            
            // 更新提醒列表
            updateReminderList();
            
            // 顯示成功訊息
            showToast('回診提醒已設定');
        }

        // 新增：儲存成長提醒
        function saveGrowthReminder() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童');
                closeModals();
                return;
            }
            
            // 收集表單數據
            const date = document.getElementById('growthReminderDate').value;
            const location = document.getElementById('growthReminderLocation').value;
            const note = document.getElementById('growthReminderNote').value.trim();
            const setPreReminder = document.getElementById('growthSetPreReminder').checked;
            const preReminderDays = document.getElementById('growthPreReminderDays').value;
            const setRecurring = document.getElementById('growthSetRecurring').checked;
            const recurringInterval = document.getElementById('growthRecurringInterval').value;
            const recurringCount = document.getElementById('growthRecurringCount').value;
            
            // 驗證
            if (!date) {
                showToast('請選擇測量日期');
                return;
            }
            
            // 創建主要成長測量提醒
            const measurementDate = new Date(date + 'T10:00:00'); // 設定為上午10點
            
            const title = `成長測量提醒`;
            const message = `安排在${location}進行成長測量${note ? `\n備註: ${note}` : ''}`;
            
            addReminder(appData.selectedChild, {
                type: 'growth',
                title: title,
                time: measurementDate.toISOString(),
                message: message,
                completed: false,
                repeat: setRecurring ? {
                    type: 'monthly',
                    interval: parseInt(recurringInterval),
                    count: parseInt(recurringCount)
                } : null,
                metadata: {
                    location: location
                }
            });
            
            // 如果設定了提前提醒，創建提前提醒
            if (setPreReminder) {
                const preReminderDate = new Date(measurementDate);
                preReminderDate.setDate(preReminderDate.getDate() - parseInt(preReminderDays));
                
                addReminder(appData.selectedChild, {
                    type: 'growth',
                    title: `成長測量預告`,
                    time: preReminderDate.toISOString(),
                    message: `還有${preReminderDays}天就要在${location}進行成長測量`,
                    completed: false,
                    repeat: setRecurring ? {
                        type: 'monthly',
                        interval: parseInt(recurringInterval),
                        count: parseInt(recurringCount)
                    } : null,
                    metadata: {
                        location: location,
                        isPreReminder: true,
                        mainMeasurementDate: measurementDate.toISOString()
                    }
                });
            }
            
            // 創建記錄
            const record = {
                id: 'record_' + Date.now(),
                type: 'growth',
                date: new Date().toISOString(),
                time: new Date().toISOString(),
                title: '安排成長測量',
                content: `安排${date}在${location}進行成長測量${note ? `\n備註: ${note}` : ''}`
            };
            
            if (!appData.records[appData.selectedChild]) {
                appData.records[appData.selectedChild] = [];
            }
            appData.records[appData.selectedChild].push(record);
            saveRecords(appData.selectedChild);
            
            // 關閉模態框
            closeModals();
            
            // 更新提醒列表
            updateReminderList();
            
            // 顯示成功訊息
            showToast('成長測量提醒已設定');
        }

        // 新增提醒
        function addReminder(childId, reminderData) {
            if (!appData.reminders[childId]) {
                appData.reminders[childId] = [];
            }
            
            const reminder = {
                id: 'reminder_' + Date.now(),
                ...reminderData
            };
            
            appData.reminders[childId].push(reminder);
            saveReminders();
            
            return reminder.id;
        }

        // 更新提醒列表
        function updateReminderList() {
            const reminderList = document.getElementById('reminderList');
            if (!reminderList) return;
            
            reminderList.innerHTML = '';
            
            if (!appData.selectedChild || !appData.reminders[appData.selectedChild] || 
                appData.reminders[appData.selectedChild].length === 0) {
                reminderList.innerHTML = '<p>目前沒有提醒項目。</p>';
                return;
            }
            
            // 獲取過濾器選項
            const filter = document.getElementById('reminderFilter').value;
            
            // 複製提醒列表並進行排序（按時間）
            let reminders = [...appData.reminders[appData.selectedChild]];
            
            // 應用過濾
            if (filter === 'active') {
                reminders = reminders.filter(r => !r.completed);
            } else if (filter === 'completed') {
                reminders = reminders.filter(r => r.completed);
            }
            
            // 如果沒有提醒
            if (reminders.length === 0) {
                reminderList.innerHTML = `<p>目前沒有${filter === 'active' ? '活躍' : '已完成'}的提醒項目。</p>`;
                return;
            }
            
            // 排序提醒 (未完成的和未來的優先)
            reminders.sort((a, b) => {
                // 先按照完成狀態排序
                if (a.completed !== b.completed) {
                    return a.completed ? 1 : -1;
                }
                
                // 然後按照時間排序
                const aTime = new Date(a.time);
                const bTime = new Date(b.time);
                
                // 對於未完成的提醒，未來的時間排在前面
                if (!a.completed) {
                    return aTime - bTime;
                }
                
                // 對於已完成的提醒，最近完成的排在前面
                return bTime - aTime;
            });
            
            const now = new Date();
            
            // 生成提醒列表
            reminders.forEach(reminder => {
                const reminderTime = new Date(reminder.time);
                
                // 判斷提醒狀態
                let statusClass = '';
                let isExpired = false;
                
                if (reminder.completed) {
                    statusClass = 'active';
                } else if (reminderTime < now) {
                    statusClass = 'expired';
                    isExpired = true;
                }
                
                // 創建提醒元素
                const reminderItem = document.createElement('div');
                reminderItem.className = `reminder-item ${statusClass}`;
                reminderItem.setAttribute('data-id', reminder.id);
                
                // 獲取提醒類型的圖標和顏色
                const typeIconClass = getReminderTypeIconClass(reminder.type);
                
                reminderItem.innerHTML = `
                    <div class="reminder-type-icon ${typeIconClass}">
                        <i class="${getReminderTypeIcon(reminder.type)}"></i>
                    </div>
                    <div class="reminder-info">
                        <div class="reminder-title">${reminder.title}</div>
                        <div class="reminder-time">${formatDateTime(reminderTime)} 
                        ${isExpired ? '<span class="badge badge-warning">已過期</span>' : ''}
                        ${reminder.repeat ? '<span class="badge badge-primary">重複</span>' : ''}
                        </div>
                        ${reminder.message ? `<div class="reminder-message">${reminder.message}</div>` : ''}
                    </div>
                    <div class="reminder-actions">
                        ${!reminder.completed ? `
                            <button class="btn btn-success btn-complete-reminder">
                                <i class="fas fa-check"></i>
                            </button>
                        ` : ''}
                        <button class="btn btn-danger btn-delete-reminder">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                reminderList.appendChild(reminderItem);
            });
            
            // 添加按鈕事件
            document.querySelectorAll('.btn-complete-reminder').forEach(btn => {
                btn.addEventListener('click', function() {
                    const reminderItem = this.closest('.reminder-item');
                    const reminderId = reminderItem.getAttribute('data-id');
                    completeReminder(reminderId);
                });
            });
            
            document.querySelectorAll('.btn-delete-reminder').forEach(btn => {
                btn.addEventListener('click', function() {
                    const reminderItem = this.closest('.reminder-item');
                    const reminderId = reminderItem.getAttribute('data-id');
                    if (confirm('確定要刪除此提醒嗎？')) {
                        deleteReminder(reminderId);
                    }
                });
            });
            
            // 更新底部導航提醒徽章
            updateReminderBadge();
        }

        // 獲取提醒類型圖標
        function getReminderTypeIcon(type) {
            switch (type) {
                case 'feeding': return 'fas fa-utensils';
                case 'sleep': return 'fas fa-bed';
                case 'diaper': return 'fas fa-baby';
                case 'medicine': return 'fas fa-pills';
                case 'vaccine': return 'fas fa-syringe';
                case 'medical': return 'fas fa-hospital';
                case 'growth': return 'fas fa-ruler';
                default: return 'fas fa-bell';
            }
        }

        // 獲取提醒類型圖標類別
        function getReminderTypeIconClass(type) {
            switch (type) {
                case 'feeding': return 'reminder-type-feeding';
                case 'sleep': return 'reminder-type-sleep';
                case 'diaper': return 'reminder-type-other';
                case 'medicine': return 'reminder-type-medicine';
                case 'vaccine': return 'reminder-type-vaccine';
                case 'medical': return 'reminder-type-other';
                case 'growth': return 'reminder-type-other';
                default: return 'reminder-type-other';
            }
        }

        // 完成提醒
        function completeReminder(reminderId) {
            if (!appData.selectedChild || !appData.reminders[appData.selectedChild]) {
                return;
            }
            
            // 尋找提醒
            const reminderIndex = appData.reminders[appData.selectedChild].findIndex(r => r.id === reminderId);
            if (reminderIndex === -1) return;
            
            const reminder = appData.reminders[appData.selectedChild][reminderIndex];
            
            // 標記為已完成
            reminder.completed = true;
            reminder.completedTime = new Date().toISOString();
            
            // 如果是重複提醒，創建下一次提醒
            if (reminder.repeat) {
                createNextRepeatReminder(reminder);
            }
            
            // 處理特定類型的提醒完成
            handleReminderCompletion(reminder);
            
            // 保存提醒
            saveReminders();
            
            // 更新列表
            updateReminderList();
            
            // 顯示成功消息
            showToast('提醒已標記為完成');
        }

        // 創建下一次重複提醒
        function createNextRepeatReminder(reminder) {
            if (!reminder.repeat) return;
            
            // 計算下一次重複時間
            const currentTime = new Date(reminder.time);
            let nextTime;
            
            if (reminder.repeat.type === 'daily') {
                nextTime = new Date(currentTime);
                nextTime.setDate(nextTime.getDate() + 1);
            } else if (reminder.repeat.type === 'weekly') {
                nextTime = new Date(currentTime);
                nextTime.setDate(nextTime.getDate() + 7);
                
                // 如果指定了特定的星期幾
                if (reminder.repeat.days && reminder.repeat.days.length > 0) {
                    // 尋找下一個符合的星期幾
                    const currentDay = nextTime.getDay(); // 0-6 (週日-週六)
                    
                    // 將days轉換為數字陣列
                    const repeatDays = reminder.repeat.days.map(d => parseInt(d));
                    
                    // 尋找下一個大於當前星期的日期
                    let nextDay = repeatDays.find(d => d > currentDay);
                    
                    if (nextDay === undefined) {
                        // 如果沒有大於當前的星期，則取第一個（下週）
                        nextDay = repeatDays[0];
                        nextTime.setDate(nextTime.getDate() + (7 - currentDay + nextDay));
                    } else {
                        // 設定到下一個符合的星期
                        nextTime.setDate(nextTime.getDate() + (nextDay - currentDay));
                    }
                }
            } else if (reminder.repeat.type === 'monthly') {
                nextTime = new Date(currentTime);
                
                // 如果有指定間隔
                const interval = reminder.repeat.interval || 1;
                nextTime.setMonth(nextTime.getMonth() + interval);
                
                // 如果指定了日期
                if (reminder.repeat.date) {
                    nextTime.setDate(parseInt(reminder.repeat.date));
                }
            } else {
                // 默認為每天
                nextTime = new Date(currentTime);
                nextTime.setDate(nextTime.getDate() + 1);
            }
            
            // 創建新的提醒
            const newReminder = {...reminder};
            delete newReminder.id; // 刪除舊ID，讓addReminder自動生成新ID
            delete newReminder.completed;
            delete newReminder.completedTime;
            
            // 設定新時間
            newReminder.time = nextTime.toISOString();
            
            // 減少計數
            if (reminder.repeat.count && reminder.repeat.count > 0) {
                newReminder.repeat.count = reminder.repeat.count - 1;
                
                // 如果計數已經到0，不再創建新提醒
                if (newReminder.repeat.count <= 0) {
                    delete newReminder.repeat;
                }
            }
            
            // 添加新提醒
            addReminder(appData.selectedChild, newReminder);
        }

        // 處理特定類型的提醒完成
        function handleReminderCompletion(reminder) {
            // 根據提醒類型執行特定動作
            if (reminder.type === 'feeding') {
                // 可以添加餵食記錄
            } else if (reminder.type === 'medicine' && reminder.metadata && reminder.metadata.medicineId) {
                // 可以添加藥物服用記錄
            }
        }

        // 刪除提醒
        function deleteReminder(reminderId) {
            if (!appData.selectedChild || !appData.reminders[appData.selectedChild]) {
                return;
            }
            
            // 從提醒列表中刪除
            appData.reminders[appData.selectedChild] = appData.reminders[appData.selectedChild].filter(
                r => r.id !== reminderId
            );
            
            // 保存提醒
            saveReminders();
            
            // 更新列表
            updateReminderList();
            
            // 顯示成功消息
            showToast('提醒已刪除');
        }

        // 清除已完成的提醒
        function clearCompletedReminders() {
            if (!appData.selectedChild || !appData.reminders[appData.selectedChild]) {
                return;
            }
            
            // 確認是否有已完成的提醒
            const completedCount = appData.reminders[appData.selectedChild].filter(r => r.completed).length;
            
            if (completedCount === 0) {
                showToast('沒有已完成的提醒可清除');
                return;
            }
            
            // 確認是否要清除
            if (!confirm(`確定要清除所有已完成的提醒嗎？(共${completedCount}個)`)) {
                return;
            }
            
            // 保留未完成的提醒
            appData.reminders[appData.selectedChild] = appData.reminders[appData.selectedChild].filter(
                r => !r.completed
            );
            
            // 保存提醒
            saveReminders();
            
            // 更新列表
            updateReminderList();
            
            // 顯示成功消息
            showToast('已清除所有已完成的提醒');
        }

        // 檢查和更新提醒
        function checkAndUpdateReminders() {
            // 檢查所有兒童的提醒
            for (const childId in appData.reminders) {
                if (!appData.reminders[childId] || appData.reminders[childId].length === 0) {
                    continue;
                }
                
                const now = new Date();
                
                // 檢查每個提醒
                appData.reminders[childId].forEach(reminder => {
                    const reminderTime = new Date(reminder.time);
                    
                    // 檢查藥物提醒是否過期
                    if (!reminder.completed && 
                        reminder.type === 'medicine' && 
                        reminderTime < now && 
                        now - reminderTime > 60 * 60 * 1000) { // 超過1小時未完成
                        
                        // 如果設置了漏服提醒，且提醒是今天的
                        if (reminder.metadata && reminder.metadata.medicineId && 
                            reminderTime.toDateString() === now.toDateString()) {
                            
                            // 尋找對應的藥物
                            const medicine = findMedicineById(reminder.metadata.medicineId);
                            
                            if (medicine && medicine.reminderSettings && medicine.reminderSettings.notifyMissed) {
                                // 創建漏服記錄
                                const doseRecord = {
                                    id: 'dose_' + Date.now(),
                                    medicineId: reminder.metadata.medicineId,
                                    time: reminderTime.toISOString(),
                                    timeLabel: reminder.metadata.doseTime || '',
                                    status: 'missed',
                                    note: '系統自動記錄為漏服'
                                };
                                
                                // 添加到藥物服用歷史
                                if (!medicine.doses) {
                                    medicine.doses = [];
                                }
                                
                                // 檢查是否已經有相同時間段的漏服記錄
                                const existingRecord = medicine.doses.find(d => 
                                    new Date(d.time).toDateString() === reminderTime.toDateString() && 
                                    d.timeLabel === reminder.metadata.doseTime && 
                                    d.status === 'missed'
                                );
                                
                                if (!existingRecord) {
                                    medicine.doses.push(doseRecord);
                                    
                                    // 保存藥物資料
                                    saveMedicines();
                                    
                                    // 標記提醒為已完成
                                    reminder.completed = true;
                                    reminder.completedTime = now.toISOString();
                                    reminder.autoCompleted = true;
                                }
                            }
                        }
                    }
                });
            }
            
            // 保存提醒
            saveReminders();
            
            // 更新提醒列表（如果當前在提醒頁面）
            if (document.getElementById('reminderTab').classList.contains('active')) {
                updateReminderList();
            }
            
            // 更新提醒徽章
            updateReminderBadge();
        }

        // 更新提醒徽章
        function updateReminderBadge() {
            if (!appData.selectedChild || !appData.reminders[appData.selectedChild]) {
                return;
            }
            
            // 計算未完成且已過期的提醒數量
            const now = new Date();
            const overdueCount = appData.reminders[appData.selectedChild].filter(r => 
                !r.completed && new Date(r.time) < now
            ).length;
            
            // 更新底部導航提醒徽章
            const reminderBadges = document.querySelectorAll('.reminder-count-badge');
            
            reminderBadges.forEach(badge => {
                if (overdueCount > 0) {
                    badge.setAttribute('data-count', overdueCount);
                    badge.classList.add('tab-badge');
                } else {
                    badge.classList.remove('tab-badge');
                }
            });
        }

        // 初始化事件監聽器
        function initEventListeners() {
            // 標籤頁切換
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(this.getAttribute('data-tab') + 'Tab').classList.add('active');
                    
                    // 更新相應標籤頁的內容
                    updateTabContent(this.getAttribute('data-tab'));
                });
            });
            
            // 底部導航切換
            document.querySelectorAll('.bottom-nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.bottom-nav-item').forEach(i => i.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId + 'Tab').classList.add('active');
                    
                    // 同步頂部標籤
                    document.querySelector(`.nav-tab[data-tab="${tabId}"]`).classList.add('active');
                    
                    // 更新相應標籤頁的內容
                    updateTabContent(tabId);
                });
            });
            
            // 兒童選擇器變更
            document.getElementById('childSelect').addEventListener('change', function() {
                if (this.value) {
                    appData.selectedChild = this.value;
                    localStorage.setItem('selectedChild', this.value);
                    loadChildData(this.value);
                    updateChildInfo();
                    updateAllTabs();
                } else {
                    appData.selectedChild = null;
                    localStorage.removeItem('selectedChild');
                    updateChildInfo();
                }
            });
            
            // 新增兒童按鈕
            document.getElementById('addChildBtn').addEventListener('click', function() {
                showAddChildModal();
            });
            
            // 保存兒童按鈕
            document.getElementById('saveChildBtn').addEventListener('click', saveChild);
            
            // 記錄類型選擇器
            document.querySelectorAll('.record-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.record-type-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.record-form').forEach(form => form.style.display = 'none');
                    
                    this.classList.add('active');
                    document.getElementById(this.getAttribute('data-record-type') + 'Form').style.display = 'block';
                });
            });
            
            // 評分星星點擊
            document.querySelectorAll('.rating-star').forEach(star => {
                star.addEventListener('click', function() {
                    const ratingStars = this.parentElement.querySelectorAll('.rating-star');
                    const ratingValue = parseInt(this.getAttribute('data-value'));
                    const ratingInput = document.getElementById(this.parentElement.id.replace('Rating', ''));
                    
                    // 設置星星樣式
                    ratingStars.forEach(s => {
                        if (parseInt(s.getAttribute('data-value')) <= ratingValue) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                    
                    // 設置隱藏輸入值
                    ratingInput.value = ratingValue;
                });
            });
            
            // 模態框關閉按鈕
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', closeModals);
            });
            
            // 模態框取消按鈕
            document.getElementById('cancelAddChildBtn').addEventListener('click', closeModals);
            
            // 保存各類型記錄的按鈕
            document.getElementById('saveFeedingBtn').addEventListener('click', saveFeeding);
            document.getElementById('saveSleepBtn').addEventListener('click', saveSleep);
            document.getElementById('saveDiaperBtn').addEventListener('click', saveDiaper);
            document.getElementById('saveEmotionBtn').addEventListener('click', saveEmotion);
            document.getElementById('saveActivityBtn').addEventListener('click', saveActivity);
            document.getElementById('saveOtherBtn').addEventListener('click', saveOther);
            
            // 提醒設置切換
            document.getElementById('feedingSetReminder').addEventListener('change', function() {
                document.getElementById('feedingReminderOptions').style.display = this.checked ? 'block' : 'none';
            });
            
            document.getElementById('sleepSetReminder').addEventListener('change', function() {
                document.getElementById('sleepReminderOptions').style.display = this.checked ? 'block' : 'none';
            });
            
            document.getElementById('diaperSetReminder').addEventListener('change', function() {
                document.getElementById('diaperReminderOptions').style.display = this.checked ? 'block' : 'none';
            });
            
            document.getElementById('activitySetReminder').addEventListener('change', function() {
                document.getElementById('activityReminderOptions').style.display = this.checked ? 'block' : 'none';
            });
            
            document.getElementById('otherSetReminder').addEventListener('change', function() {
                document.getElementById('otherReminderOptions').style.display = this.checked ? 'block' : 'none';
            });
            
            // 提醒間隔選擇
            document.getElementById('feedingReminderInterval').addEventListener('change', function() {
                document.getElementById('feedingCustomTimeCol').style.display = this.value === 'custom' ? 'block' : 'none';
            });
            
            document.getElementById('sleepReminderInterval').addEventListener('change', function() {
                document.getElementById('sleepCustomTimeCol').style.display = this.value === 'custom' ? 'block' : 'none';
            });
            
            document.getElementById('diaperReminderInterval').addEventListener('change', function() {
                document.getElementById('diaperCustomTimeCol').style.display = this.value === 'custom' ? 'block' : 'none';
            });
            
            document.getElementById('activityReminderInterval').addEventListener('change', function() {
                document.getElementById('activityCustomTimeCol').style.display = this.value === 'custom' ? 'block' : 'none';
            });
            
            // 歷史記錄日期選擇
            document.getElementById('historyDate').addEventListener('change', function() {
                updateHistoryContent();
            });
            
            // 歷史記錄類型過濾
            document.getElementById('historyFilter').addEventListener('change', function() {
                updateHistoryContent();
            });
            
            // 里程碑過濾
            document.getElementById('milestoneFilter').addEventListener('change', function() {
                updateMilestoneContent();
            });
            
            // 統計時段選擇
            document.querySelectorAll('.stats-period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.stats-period-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 顯示/隱藏自訂日期選擇
                    document.querySelector('.stats-custom-period').style.display = this.getAttribute('data-period') === 'custom' ? 'flex' : 'none';
                    
                    // 更新統計圖表
                    if (this.getAttribute('data-period') !== 'custom') {
                        updateStatsCharts(this.getAttribute('data-period'));
                    }
                });
            });
            
            // 應用自訂統計時段
            document.getElementById('statsApplyCustom').addEventListener('click', function() {
                const startDate = document.getElementById('statsStartDate').value;
                const endDate = document.getElementById('statsEndDate').value;
                
                if (!startDate || !endDate) {
                    showToast('請選擇開始日期和結束日期');
                    return;
                }
                
                updateStatsCharts('custom', startDate, endDate);
            });
            
            // 照顧提示類別過濾
            document.getElementById('caretipsCategory').addEventListener('change', function() {
                updateCareTipsContent();
            });
            
            // 匯出選項切換
            document.getElementById('exportAllTypes').addEventListener('change', function() {
                const typeOptions = document.getElementById('exportTypeOptions');
                const checkboxes = typeOptions.querySelectorAll('input[type="checkbox"]');
                
                checkboxes.forEach(cb => {
                    cb.checked = this.checked;
                    cb.disabled = this.checked;
                });
            });
            
            document.getElementById('exportAllDates').addEventListener('change', function() {
                document.getElementById('exportDateRange').style.display = this.checked ? 'none' : 'block';
            });
            
            // 匯出CSV按鈕
            document.getElementById('exportCSVBtn').addEventListener('click', exportToCSV);
            
            // 全部數據匯出按鈕
            document.getElementById('exportAllDataBtn').addEventListener('click', exportAllData);
            
            // 匯入檔案選擇按鈕
            document.getElementById('importFileBtn').addEventListener('click', function() {
                document.getElementById('importFileInput').click();
            });
            
            // 檔案選擇變更
            document.getElementById('importFileInput').addEventListener('change', function() {
                if (this.files.length > 0) {
                    document.getElementById('importFileName').textContent = this.files[0].name;
                    document.getElementById('importDataBtn').disabled = false;
                } else {
                    document.getElementById('importFileName').textContent = '未選擇檔案';
                    document.getElementById('importDataBtn').disabled = true;
                }
            });
            
            // 匯入數據按鈕
            document.getElementById('importDataBtn').addEventListener('click', previewImport);
            
            // 確認匯入按鈕
            document.getElementById('confirmImportBtn').addEventListener('click', importData);
            
            // 刪除兒童按鈕
            document.getElementById('deleteChildBtn').addEventListener('click', function() {
                if (!appData.selectedChild) {
                    showToast('請先選擇一位兒童');
                    return;
                }
                
                const child = appData.children.find(c => c.id === appData.selectedChild);
                if (!child) return;
                
                document.getElementById('deleteChildName').textContent = child.name;
                document.getElementById('deleteChildModal').classList.add('active');
                document.getElementById('overlay').classList.add('active');
            });
            
            // 確認刪除兒童按鈕
            document.getElementById('confirmDeleteChildBtn').addEventListener('click', deleteSelectedChild);
            
            // 取消刪除兒童按鈕
            document.getElementById('cancelDeleteChildBtn').addEventListener('click', closeModals);
            
            // 確認匯入取消按鈕
            document.getElementById('cancelImportBtn').addEventListener('click', closeModals);
            
            // 快捷動作按鈕
            document.getElementById('quickActionBtn').addEventListener('click', function() {
                document.getElementById('quickActionMenu').classList.add('active');
                document.getElementById('overlay').classList.add('active');
            });
            
            // 關閉快捷選單按鈕
            document.getElementById('quickActionMenuClose').addEventListener('click', function() {
                document.getElementById('quickActionMenu').classList.remove('active');
                document.getElementById('overlay').classList.remove('active');
            });
            
            // 快捷動作項目
            document.getElementById('quickActionFeeding').addEventListener('click', function() {
                closeModals();
                showQuickFeedingModal();
            });
            
            document.getElementById('quickActionSleep').addEventListener('click', function() {
                closeModals();
                toggleSleepTimer();
            });
            
            document.getElementById('quickActionDiaper').addEventListener('click', function() {
                closeModals();
                showQuickDiaperModal();
            });
            
            document.getElementById('quickActionGrowth').addEventListener('click', function() {
                closeModals();
                showQuickGrowthModal();
            });
            
            document.getElementById('quickActionMedicine').addEventListener('click', function() {
                closeModals();
                showQuickMedicineRecordModal();
            });
            
            document.getElementById('quickActionOther').addEventListener('click', function() {
                closeModals();
                showQuickOtherModal();
            });
            
            // 睡眠計時器徽章
            document.getElementById('sleepTimerBadge').addEventListener('click', function() {
                if (confirm('是否結束記錄睡眠？')) {
                    endSleepTimer();
                }
            });
            
            // 遮罩層點擊
            document.getElementById('overlay').addEventListener('click', function() {
                closeModals();
            });
            
            // 防止模態框內容點擊穿透
            document.querySelectorAll('.modal-content').forEach(content => {
                content.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });
            
            // 快速尿布選項
            document.querySelectorAll('.diaper-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.diaper-option').forEach(o => o.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // 儲存快速尿布記錄
            document.getElementById('saveQuickDiaperBtn').addEventListener('click', saveQuickDiaper);
            
            // 儲存快速餵食記錄
            document.getElementById('saveQuickFeedingBtn').addEventListener('click', saveQuickFeeding);
            
            // 儲存快速其他記錄
            document.getElementById('saveQuickOtherBtn').addEventListener('click', saveQuickOther);
            
            // 新增提醒按鈕
            document.getElementById('addReminderBtn').addEventListener('click', showAddReminderModal);
            
            // 儲存提醒按鈕
            document.getElementById('saveReminderBtn').addEventListener('click', saveReminder);
            
            // 取消新增提醒按鈕
            document.getElementById('cancelAddReminderBtn').addEventListener('click', closeModals);
            
            // 清除已完成提醒按鈕
            document.getElementById('clearCompletedRemindersBtn').addEventListener('click', clearCompletedReminders);
            
            // 提醒重複切換
            document.getElementById('reminderRepeat').addEventListener('change', function() {
                document.getElementById('reminderRepeatDetails').classList.toggle('active', this.checked);
            });
            
            // 提醒重複類型變更
            document.getElementById('reminderRepeatType').addEventListener('change', function() {
                // 根據重複類型顯示/隱藏相應選項
                const repeatDaysGroup = document.getElementById('reminderRepeatDaysGroup');
                const repeatDateGroup = document.getElementById('reminderRepeatDateGroup');
                
                if (this.value === 'weekly') {
                    repeatDaysGroup.style.display = 'block';
                    repeatDateGroup.style.display = 'none';
                } else if (this.value === 'monthly') {
                    repeatDaysGroup.style.display = 'none';
                    repeatDateGroup.style.display = 'block';
                } else {
                    repeatDaysGroup.style.display = 'none';
                    repeatDateGroup.style.display = 'none';
                }
            });
            
            // 動態生成每月重複日期選項
            const repeatDateSelect = document.getElementById('reminderRepeatDate');
            for (let i = 1; i <= 31; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i + '日';
                repeatDateSelect.appendChild(option);
            }
            
            // 快速提醒類型
            document.querySelectorAll('.reminder-quick-add-item').forEach(item => {
                item.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    
                    switch (type) {
                        case 'feeding':
                            showQuickFeedingModal();
                            break;
                        case 'sleep':
                            toggleSleepTimer();
                            break;
                        case 'medicine':
                            showQuickMedicineModal();
                            break;
                        case 'vaccine':
                            showQuickVaccineModal();
                            break;
                        case 'medical':
                            showQuickMedicalModal();
                            break;
                        case 'growth':
                            showQuickGrowthReminderModal();
                            break;
                    }
                });
            });
            
            // 疫苗名稱變更事件
            document.getElementById('vaccineName').addEventListener('change', function() {
                document.getElementById('vaccineOtherNameGroup').style.display = this.value === 'other' ? 'block' : 'none';
            });
            
            // 疫苗提醒切換事件
            document.getElementById('vaccineSetNextReminder').addEventListener('change', function() {
                document.getElementById('vaccineNextReminderOptions').style.display = this.checked ? 'block' : 'none';
            });
            
            // 保存疫苗提醒按鈕
            document.getElementById('saveVaccineReminderBtn').addEventListener('click', saveVaccineReminder);
            
            // 保存藥物提醒按鈕
            document.getElementById('saveMedicineReminderBtn').addEventListener('click', saveMedicineReminder);
        }

        // 初始化快捷動作按鈕
        function initQuickActionButtons() {
            // 設置浮動快捷按鈕位置
            const quickActionBtn = document.getElementById('quickActionBtn');
            
            // 設置底部導航高度
            const bottomNavHeight = document.querySelector('.bottom-nav').offsetHeight;
            
            // 調整按鈕位置
            quickActionBtn.style.bottom = (bottomNavHeight + 10) + 'px';
        }

        // 更新所有標籤頁內容
        function updateAllTabs() {
            updateRecordFormDefaults();
            updateHistoryContent();
            updateMilestoneContent();
            updateReminderList();
            updateStatsCharts('week');
            updateCareTipsContent();
            updateMedicineList();
            updateGrowthRecords();
            updateGrowthChart('height');
            updateMedicalRecords();
        }

        // 根據標籤ID更新標籤頁內容
        function updateTabContent(tabId) {
            switch (tabId) {
                case 'record':
                    updateRecordFormDefaults();
                    break;
                case 'history':
                    updateHistoryContent();
                    break;
                case 'milestone':
                    updateMilestoneContent();
                    break;
                case 'reminder':
                    updateReminderList();
                    break;
                case 'stats':
                    updateStatsCharts(document.querySelector('.stats-period-btn.active').getAttribute('data-period'));
                    break;
                case 'caretips':
                    updateCareTipsContent();
                    break;
                case 'medicine':
                    updateMedicineList();
                    break;
                case 'growth':
                    updateGrowthRecords();
                    updateGrowthChart('height');
                    break;
                case 'medical':
                    updateMedicalRecords();
                    break;
            }
        }

        // 設置當前日期時間
        function setCurrentDateTime() {
            const now = new Date();
            const isoString = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            
            document.getElementById('feedingTime').value = isoString;
            document.getElementById('sleepStart').value = isoString;
            document.getElementById('sleepEnd').value = isoString;
            document.getElementById('diaperTime').value = isoString;
            document.getElementById('emotionTime').value = isoString;
            document.getElementById('activityTime').value = isoString;
            document.getElementById('otherTime').value = isoString;
            
            // 設置歷史日期為今天
            document.getElementById('historyDate').value = now.toISOString().split('T')[0];
            
            // 設置成長記錄日期為今天
            document.getElementById('growthDate').value = now.toISOString().split('T')[0];
            
            // 設置就醫記錄日期為今天
            document.getElementById('medicalDate').value = now.toISOString().split('T')[0];
            
            // 設置藥物開始日期為今天
            document.getElementById('medicineStartDate').value = now.toISOString().split('T')[0];
        }

        // 格式化日期 (YYYY-MM-DD -> YYYY/MM/DD)
        function formatDate(dateString) {
            if (!dateString) return '';
            
            // 提取日期部分
            const datePart = dateString.split('T')[0];
            
            return datePart.replace(/-/g, '/');
        }

        // 格式化日期時間
        function formatDateTime(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}/${month}/${day} ${hours}:${minutes}`;
        }

        // 計算兩個日期時間之間的時間差（返回小時和分鐘）
        function calculateTimeDifference(startDate, endDate) {
            const diffMs = new Date(endDate) - new Date(startDate);
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            
            return {
                hours: diffHours,
                minutes: diffMinutes,
                totalMinutes: diffHours * 60 + diffMinutes
            };
        }

        // 更新兒童選擇器
        function updateChildSelector() {
            const childSelect = document.getElementById('childSelect');
            childSelect.innerHTML = '<option value="">選擇兒童</option>';
            
            appData.children.forEach(child => {
                const option = document.createElement('option');
                option.value = child.id;
                option.textContent = child.name;
                
                if (child.id === appData.selectedChild) {
                    option.selected = true;
                }
                
                childSelect.appendChild(option);
            });
        }

        // 檢查是否已選擇兒童
        function checkSelectedChild() {
            const childInfoElements = document.querySelectorAll('[id$="ChildInfo"]');
            const formElements = document.querySelectorAll('.record-form');
            const saveButtons = document.querySelectorAll('.record-form button[id^="save"]');
            
            if (!appData.selectedChild) {
                childInfoElements.forEach(el => {
                    el.textContent = '請先選擇或新增一位兒童';
                });
                
                formElements.forEach(form => {
                    const inputs = form.querySelectorAll('input, textarea, select');
                    inputs.forEach(input => input.disabled = true);
                });
                
                saveButtons.forEach(btn => btn.disabled = true);
                
                // 禁用里程碑過濾和提醒添加等
                document.getElementById('milestoneFilter').disabled = true;
                document.getElementById('addReminderBtn').disabled = true;
                document.getElementById('exportCSVBtn').disabled = true;
            } else {
                const selectedChild = appData.children.find(child => child.id === appData.selectedChild);
                
                childInfoElements.forEach(el => {
                    el.textContent = `選擇的兒童: ${selectedChild.name} (${calculateAge(selectedChild.birthday)})`;
                });
                
                formElements.forEach(form => {
                    const inputs = form.querySelectorAll('input, textarea, select');
                    inputs.forEach(input => input.disabled = false);
                });
                
                saveButtons.forEach(btn => btn.disabled = false);
                
                // 啓用里程碑過濾和提醒添加等
                document.getElementById('milestoneFilter').disabled = false;
                document.getElementById('addReminderBtn').disabled = false;
                document.getElementById('exportCSVBtn').disabled = false;
                
                // 更新兒童資訊
                updateChildInfo();
            }
        }

        // 計算年齡
        function calculateAge(birthday) {
            const birthDate = new Date(birthday);
            const now = new Date();
            
            let years = now.getFullYear() - birthDate.getFullYear();
            let months = now.getMonth() - birthDate.getMonth();
            let days = now.getDate() - birthDate.getDate();
            
            if (days < 0) {
                months--;
                days += new Date(now.getFullYear(), now.getMonth(), 0).getDate();
            }
            
            if (months < 0) {
                years--;
                months += 12;
            }
            
            if (years > 0) {
                return `${years}歲${months > 0 ? months + '個月' : ''}`;
            } else if (months > 0) {
                return `${months}個月${days > 0 ? days + '天' : ''}`;
            } else {
                return `${days}天`;
            }
        }

        // 更新兒童資訊
        function updateChildInfo() {
            checkSelectedChild();
            
            if (appData.selectedChild) {
                const child = appData.children.find(c => c.id === appData.selectedChild);
                
                if (child) {
                    const age = calculateAge(child.birthday);
                    
                    // 更新自訂提示 (根據年齡)
                    updateAgeDependentContent(child);
                }
            }
        }

        // 更新年齡相關的內容 (如照顧提示)
        function updateAgeDependentContent(child) {
            // 實現此功能
        }

        // 顯示新增兒童模態框
        function showAddChildModal() {
            const modal = document.getElementById('addChildModal');
            document.getElementById('childName').value = '';
            document.getElementById('childBirthday').value = '';
            document.getElementById('childGender').value = '男';
            document.getElementById('childNote').value = '';
            
            modal.classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }

        // 儲存兒童資料
        function saveChild() {
            const name = document.getElementById('childName').value.trim();
            const birthday = document.getElementById('childBirthday').value;
            const gender = document.getElementById('childGender').value;
            const note = document.getElementById('childNote').value.trim();
            
            if (!name) {
                showToast('請輸入兒童姓名');
                return;
            }
            
            if (!birthday) {
                showToast('請選擇出生日期');
                return;
            }
            
            const child = {
                id: 'child_' + Date.now(),
                name: name,
                birthday: birthday,
                gender: gender,
                note: note,
                dateAdded: new Date().toISOString()
            };
            
            appData.children.push(child);
            saveChildren();
            
            // 選擇新增的兒童
            appData.selectedChild = child.id;
            localStorage.setItem('selectedChild', child.id);
            
            // 初始化此兒童的數據結構
            initMilestones(child.id);
            loadChildData(child.id);
            
            updateChildSelector();
            updateChildInfo();
            updateAllTabs();
            
            closeModals();
            showToast('兒童資料已儲存');
        }

        // 刪除選擇的兒童
        function deleteSelectedChild() {
            if (!appData.selectedChild) return;
            
            // 從兒童列表中刪除
            appData.children = appData.children.filter(c => c.id !== appData.selectedChild);
            saveChildren();
            
            // 刪除與此兒童相關的所有資料
            localStorage.removeItem(`records_${appData.selectedChild}`);
            localStorage.removeItem(`milestones_${appData.selectedChild}`);
            
            // 從提醒中刪除
            delete appData.reminders[appData.selectedChild];
            saveReminders();
            
            // 從藥物中刪除
            delete appData.medicines[appData.selectedChild];
            saveMedicines();
            
            // 從成長數據中刪除
            delete appData.growthData[appData.selectedChild];
            saveGrowthData();
            
            // 重置選擇
            appData.selectedChild = null;
            localStorage.removeItem('selectedChild');
            
            // 如果還有其他兒童，選擇第一個
            if (appData.children.length > 0) {
                appData.selectedChild = appData.children[0].id;
                localStorage.setItem('selectedChild', appData.children[0].id);
                loadChildData(appData.children[0].id);
            }
            
            updateChildSelector();
            updateChildInfo();
            updateAllTabs();
            
            closeModals();
            showToast('兒童資料已刪除');
        }

        // 保存餵食記錄
        function saveFeeding() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童');
                return;
            }
            
            const type = document.getElementById('feedingType').value;
            const amount = document.getElementById('feedingAmount').value;
            const unit = document.getElementById('feedingUnit').value;
            const time = document.getElementById('feedingTime').value;
            const note = document.getElementById('feedingNote').value.trim();
            
            if (!amount) {
                showToast('請輸入餵食量');
                return;
            }
            
            if (!time) {
                showToast('請選擇時間');
                return;
            }
            
            const record = {
                id: 'record_' + Date.now(),
                type: 'feeding',
                feedingType: type,
                amount: amount,
                unit: unit,
                date: time,
                time: time,
                note: note
            };
            
            // 記錄最後一次餵食選項
            appData.quickOptions.lastFeeding = {
                type: type,
                amount: amount,
                unit: unit
            };
            saveQuickOptions();
            
            // 添加記錄
            if (!appData.records[appData.selectedChild]) {
                appData.records[appData.selectedChild] = [];
            }
            
            appData.records[appData.selectedChild].push(record);
            saveRecords(appData.selectedChild);
            
            // 設定下次餵食提醒
            const setReminder = document.getElementById('feedingSetReminder').checked;
            if (setReminder) {
                const reminderInterval = document.getElementById('feedingReminderInterval').value;
                let reminderTime;
                
                if (reminderInterval === 'custom') {
                    reminderTime = document.getElementById('feedingCustomTime').value;
                    if (!reminderTime) {
                        showToast('請選擇提醒時間');
                        return;
                    }
                } else {
                    // 計算提醒時間 (小時後)
                    const dateObj = new Date(time);
                    dateObj.setHours(dateObj.getHours() + parseInt(reminderInterval));
                    reminderTime = dateObj.toISOString().slice(0, 16);
                }
                
                // 添加提醒
                addReminder(appData.selectedChild, {
                    type: 'feeding',
                    title: '餵食提醒',
                    time: new Date(reminderTime).toISOString(),
                    message: `是時候進行下一次${type}餵食了`,
                    completed: false,
                    repeat: null
                });
                
                showToast('餵食記錄已儲存，並設定下次提醒');
            } else {
                showToast('餵食記錄已儲存');
            }
            
            // 重置表單
            document.getElementById('feedingAmount').value = '';
            document.getElementById('feedingNote').value = '';
            setCurrentDateTime();
            
            // 更新顯示
            updateHistoryContent();
        }

        // 保存睡眠記錄
        function saveSleep() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童');
                return;
            }
            
            const start = document.getElementById('sleepStart').value;
            const end = document.getElementById('sleepEnd').value;
            const quality = document.getElementById('sleepQuality').value;
            const note = document.getElementById('sleepNote').value.trim();
            
            if (!start) {
                showToast('請選擇開始時間');
                return;
            }
            
            if (!end) {
                showToast('請選擇結束時間');
                return;
            }
            
            // 驗證開始時間早於結束時間
            if (new Date(start) >= new Date(end)) {
                showToast('結束時間必須晚於開始時間');
                return;
            }
            
            // 計算睡眠時長
            const duration = calculateTimeDifference(start, end);
            
            const record = {
                id: 'record_' + Date.now(),
                type: 'sleep',
                start: start,
                end: end,
                duration: {
                    hours: duration.hours,
                    minutes: duration.minutes,
                    totalMinutes: duration.totalMinutes
                },
                quality: parseInt(quality),
                date: start,
                time: start,
                note: note
            };
            
            // 添加記錄
            if (!appData.records[appData.selectedChild]) {
                appData.records[appData.selectedChild] = [];
            }
            
            appData.records[appData.selectedChild].push(record);
            saveRecords(appData.selectedChild);
            
            // 設定下次睡眠/醒來提醒
            const setReminder = document.getElementById('sleepSetReminder').checked;
            if (setReminder) {
                const reminderType = document.getElementById('sleepReminderType').value;
                const reminderInterval = document.getElementById('sleepReminderInterval').value;
                let reminderTime;
                
                if (reminderInterval === 'custom') {
                    reminderTime = document.getElementById('sleepCustomTime').value;
                    if (!reminderTime) {
                        showToast('請選擇提醒時間');
                        return;
                    }
                } else {
                    // 計算提醒時間 (小時後)
                    const dateObj = new Date(end); // 從睡眠結束時間開始計算
                    dateObj.setHours(dateObj.getHours() + parseInt(reminderInterval));
                    reminderTime = dateObj.toISOString().slice(0, 16);
                }
                
                const reminderTitle = reminderType === 'nextSleep' ? '睡眠提醒' : '預計醒來提醒';
                const reminderMessage = reminderType === 'nextSleep' ? '是時候睡覺了' : '預計寶寶將在此時醒來';
                
                // 添加提醒
                addReminder(appData.selectedChild, {
                    type: 'sleep',
                    title: reminderTitle,
                    time: new Date(reminderTime).toISOString(),
                    message: reminderMessage,
                    completed: false,
                    repeat: null
                });
                
                showToast('睡眠記錄已儲存，並設定提醒');
            } else {
                showToast('睡眠記錄已儲存');
            }
            
            // 重置表單
            document.getElementById('sleepNote').value = '';
            document.querySelectorAll('#sleepQualityRating .rating-star').forEach((star, index) => {
                star.classList.toggle('active', index < 3);
            });
            document.getElementById('sleepQuality').value = '3';
            setCurrentDateTime();
            
            // 重置睡眠計時器
            appData.quickOptions.sleepStartTime = null;
            saveQuickOptions();
            document.getElementById('sleepTimerBadge').classList.remove('active');
            
            // 更新顯示
            updateHistoryContent();
        }

        // 保存尿布記錄
        function saveDiaper() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童');
                return;
            }
            
            const urine = document.getElementById('diaperUrine').checked;
            const stool = document.getElementById('diaperStool').checked;
            const condition = document.getElementById('diaperCondition').value;
            const time = document.getElementById('diaperTime').value;
            const note = document.getElementById('diaperNote').value.trim();
            
            if (!urine && !stool) {
                showToast('請至少選擇一種排泄類型');
                return;
            }
            
            if (!time) {
                showToast('請選擇時間');
                return;
            }
            
            const record = {
                id: 'record_' + Date.now(),
                type: 'diaper',
                urine: urine,
                stool: stool,
                condition: condition,
                date: time,
                time: time,
                note: note
            };
            
            // 添加記錄
            if (!appData.records[appData.selectedChild]) {
                appData.records[appData.selectedChild] = [];
            }
            
            appData.records[appData.selectedChild].push(record);
            saveRecords(appData.selectedChild);
            
            // 設定下次更換提醒
            const setReminder = document.getElementById('diaperSetReminder').checked;
            if (setReminder) {
                const reminderInterval = document.getElementById('diaperReminderInterval').value;
                let reminderTime;
                
                if (reminderInterval === 'custom') {
                    reminderTime = document.getElementById('diaperCustomTime').value;
                    if (!reminderTime) {
                        showToast('請選擇提醒時間');
                        return;
                    }
                } else {
                    // 計算提醒時間 (小時後)
                    const dateObj = new Date(time);
                    dateObj.setHours(dateObj.getHours() + parseInt(reminderInterval));
                    reminderTime = dateObj.toISOString().slice(0, 16);
                }
                
                // 添加提醒
                addReminder(appData.selectedChild, {
                    type: 'diaper',
                    title: '尿布更換提醒',
                    time: new Date(reminderTime).toISOString(),
                    message: '是時候檢查尿布了',
                    completed: false,
                    repeat: null
                });
                
                showToast('尿布記錄已儲存，並設定下次提醒');
            } else {
                showToast('尿布記錄已儲存');
            }
            
            // 重置表單
            document.getElementById('diaperNote').value = '';
            document.getElementById('diaperCondition').value = '正常';
            setCurrentDateTime();
            
            // 更新顯示
            updateHistoryContent();
        }

        // 保存情緒記錄
        function saveEmotion() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童');
                return;
            }
            
            const type = document.getElementById('emotionType').value;
            const intensity = document.getElementById('emotionIntensity').value;
            const time = document.getElementById('emotionTime').value;
            const note = document.getElementById('emotionNote').value.trim();
            
            if (!time) {
                showToast('請選擇時間');
                return;
            }
            
            const record = {
                id: 'record_' + Date.now(),
                type: 'emotion',
                emotionType: type,
                intensity: parseInt(intensity),
                date: time,
                time: time,
                note: note
            };
            
            // 添加記錄
            if (!appData.records[appData.selectedChild]) {
                appData.records[appData.selectedChild] = [];
            }
            
            appData.records[appData.selectedChild].push(record);
            saveRecords(appData.selectedChild);
            
            showToast('情緒記錄已儲存');
            
            // 重置表單
            document.getElementById('emotionNote').value = '';
            document.querySelectorAll('#emotionIntensityRating .rating-star').forEach((star, index) => {
                star.classList.toggle('active', index < 3);
            });
            document.getElementById('emotionIntensity').value = '3';
            setCurrentDateTime();
            
            // 更新顯示
            updateHistoryContent();
        }

        // 保存活動記錄
        function saveActivity() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童');
                return;
            }
            
            const type = document.getElementById('activityType').value;
            const duration = document.getElementById('activityDuration').value;
            const time = document.getElementById('activityTime').value;
            const note = document.getElementById('activityNote').value.trim();
            
            if (!duration) {
                showToast('請輸入活動持續時間');
                return;
            }
            
            if (!time) {
                showToast('請選擇時間');
                return;
            }
            
            const record = {
                id: 'record_' + Date.now(),
                type: 'activity',
                activityType: type,
                duration: parseInt(duration),
                date: time,
                time: time,
                note: note
            };
            
            // 添加記錄
            if (!appData.records[appData.selectedChild]) {
                appData.records[appData.selectedChild] = [];
            }
            
            appData.records[appData.selectedChild].push(record);
            saveRecords(appData.selectedChild);
            
            // 設定下次活動提醒
            const setReminder = document.getElementById('activitySetReminder').checked;
            if (setReminder) {
                const reminderInterval = document.getElementById('activityReminderInterval').value;
                let reminderTime;
                
                if (reminderInterval === 'custom') {
                    reminderTime = document.getElementById('activityCustomTime').value;
                    if (!reminderTime) {
                        showToast('請選擇提醒時間');
                        return;
                    }
                } else {
                    // 計算提醒時間 (小時後)
                    const dateObj = new Date(time);
                    dateObj.setHours(dateObj.getHours() + parseInt(reminderInterval));
                    reminderTime = dateObj.toISOString().slice(0, 16);
                }
                
                // 添加提醒
                addReminder(appData.selectedChild, {
                    type: 'activity',
                    title: '活動提醒',
                    time: new Date(reminderTime).toISOString(),
                    message: `安排${type}活動`,
                    completed: false,
                    repeat: null
                });
                
                showToast('活動記錄已儲存，並設定提醒');
            } else {
                showToast('活動記錄已儲存');
            }
            
            // 重置表單
            document.getElementById('activityDuration').value = '';
            document.getElementById('activityNote').value = '';
            setCurrentDateTime();
            
            // 更新顯示
            updateHistoryContent();
        }

        // 保存其他記錄
        function saveOther() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童');
                return;
            }
            
            const title = document.getElementById('otherTitle').value.trim();
            const time = document.getElementById('otherTime').value;
            const content = document.getElementById('otherContent').value.trim();
            
            if (!title) {
                showToast('請輸入標題');
                return;
            }
            
            if (!time) {
                showToast('請選擇時間');
                return;
            }
            
            if (!content) {
                showToast('請輸入內容');
                return;
            }
            
            const record = {
                id: 'record_' + Date.now(),
                type: 'other',
                title: title,
                content: content,
                date: time,
                time: time
            };
            
            // 添加記錄
            if (!appData.records[appData.selectedChild]) {
                appData.records[appData.selectedChild] = [];
            }
            
            appData.records[appData.selectedChild].push(record);
            saveRecords(appData.selectedChild);
            
            // 設定提醒
            const setReminder = document.getElementById('otherSetReminder').checked;
            if (setReminder) {
                const reminderTime = document.getElementById('otherReminderTime').value;
                const reminderMessage = document.getElementById('otherReminderMessage').value || title;
                
                if (!reminderTime) {
                    showToast('請選擇提醒時間');
                    return;
                }
                
                // 添加提醒
                addReminder(appData.selectedChild, {
                    type: 'other',
                    title: title,
                    time: new Date(reminderTime).toISOString(),
                    message: reminderMessage,
                    completed: false,
                    repeat: null
                });
                
                showToast('記錄已儲存，並設定提醒');
            } else {
                showToast('記錄已儲存');
            }
            
            // 重置表單
            document.getElementById('otherTitle').value = '';
            document.getElementById('otherContent').value = '';
            setCurrentDateTime();
            
            // 更新顯示
            updateHistoryContent();
        }

        // 保存快速餵食記錄
        function saveQuickFeeding() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童');
                closeModals();
                return;
            }
            
            const type = document.getElementById('quickFeedingType').value;
            const amount = document.getElementById('quickFeedingAmount').value;
            const unit = document.getElementById('quickFeedingUnit').value;
            const note = document.getElementById('quickFeedingNote').value.trim();
            
            if (!amount) {
                showToast('請輸入餵食量');
                return;
            }
            
            // 使用當前時間
            const now = new Date();
            const time = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            
            const record = {
                id: 'record_' + Date.now(),
                type: 'feeding',
                feedingType: type,
                amount: amount,
                unit: unit,
                date: time,
                time: time,
                note: note
            };
            
            // 記錄最後一次餵食選項
            appData.quickOptions.lastFeeding = {
                type: type,
                amount: amount,
                unit: unit
            };
            saveQuickOptions();
            
            // 添加記錄
            if (!appData.records[appData.selectedChild]) {
                appData.records[appData.selectedChild] = [];
            }
            
            appData.records[appData.selectedChild].push(record);
            saveRecords(appData.selectedChild);
            
            // 設定下次餵食提醒
            const setReminder = document.getElementById('quickFeedingSetReminder').checked;
            if (setReminder) {
                const reminderInterval = document.getElementById('quickFeedingReminderInterval').value;
                
                // 計算提醒時間 (小時後)
                const dateObj = new Date(time);
                dateObj.setHours(dateObj.getHours() + parseInt(reminderInterval));
                const reminderTime = dateObj.toISOString().slice(0, 16);
                
                // 添加提醒
                addReminder(appData.selectedChild, {
                    type: 'feeding',
                    title: '餵食提醒',
                    time: new Date(reminderTime).toISOString(),
                    message: `是時候進行下一次${type}餵食了`,
                    completed: false,
                    repeat: null
                });
                
                showToast('餵食記錄已儲存，並設定下次提醒');
            } else {
                showToast('餵食記錄已儲存');
            }
            
            closeModals();
            
            // 更新顯示
            updateHistoryContent();
        }

        // 保存快速尿布記錄
        function saveQuickDiaper() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童');
                closeModals();
                return;
            }
            
            const activeOption = document.querySelector('.diaper-option.active');
            const diaperType = activeOption.getAttribute('data-type');
            
            const urine = diaperType === 'urine' || diaperType === 'both';
            const stool = diaperType === 'stool' || diaperType === 'both';
            
            const condition = document.getElementById('quickDiaperCondition').value;
            const note = document.getElementById('quickDiaperNote').value.trim();
            
            // 使用當前時間
            const now = new Date();
            const time = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            
            const record = {
                id: 'record_' + Date.now(),
                type: 'diaper',
                urine: urine,
                stool: stool,
                condition: condition,
                date: time,
                time: time,
                note: note
            };
            
            // 添加記錄
            if (!appData.records[appData.selectedChild]) {
                appData.records[appData.selectedChild] = [];
            }
            
            appData.records[appData.selectedChild].push(record);
            saveRecords(appData.selectedChild);
            
            // 設定下次更換提醒
            const setReminder = document.getElementById('quickDiaperSetReminder').checked;
            if (setReminder) {
                const reminderInterval = document.getElementById('quickDiaperReminderInterval').value;
                
                // 計算提醒時間 (小時後)
                const dateObj = new Date(time);
                dateObj.setHours(dateObj.getHours() + parseInt(reminderInterval));
                const reminderTime = dateObj.toISOString().slice(0, 16);
                
                // 添加提醒
                addReminder(appData.selectedChild, {
                    type: 'diaper',
                    title: '尿布更換提醒',
                    time: new Date(reminderTime).toISOString(),
                    message: '是時候檢查尿布了',
                    completed: false,
                    repeat: null
                });
                
                showToast('尿布記錄已儲存，並設定下次提醒');
            } else {
                showToast('尿布記錄已儲存');
            }
            
            closeModals();
            
            // 更新顯示
            updateHistoryContent();
        }

        // 保存快速其他記錄
        function saveQuickOther() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童');
                closeModals();
                return;
            }
            
            const typeValue = document.getElementById('quickOtherType').value;
            const note = document.getElementById('quickOtherNote').value.trim();
            
            // 解析記錄類型 (emotion_happy, activity_bath 等)
            const [type, subType] = typeValue.split('_');
            
            // 使用當前時間
            const now = new Date();
            const time = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            
            let record;
            
            if (type === 'emotion') {
                record = {
                    id: 'record_' + Date.now(),
                    type: 'emotion',
                    emotionType: subType,
                    intensity: 3, // 預設強度
                    date: time,
                    time: time,
                    note: note
                };
            } else if (type === 'activity') {
                record = {
                    id: 'record_' + Date.now(),
                    type: 'activity',
                    activityType: subType,
                    duration: 15, // 預設15分鐘
                    date: time,
                    time: time,
                    note: note
                };
            }
            
            // 添加記錄
            if (!appData.records[appData.selectedChild]) {
                appData.records[appData.selectedChild] = [];
            }
            
            appData.records[appData.selectedChild].push(record);
            saveRecords(appData.selectedChild);
            
            showToast('記錄已儲存');
            closeModals();
            
            // 更新顯示
            updateHistoryContent();
        }

        // 保存提醒
        function saveReminder() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童');
                closeModals();
                return;
            }
            
            const type = document.getElementById('reminderType').value;
            const title = document.getElementById('reminderTitle').value.trim();
            const time = document.getElementById('reminderTime').value;
            const message = document.getElementById('reminderMessage').value.trim();
            const repeat = document.getElementById('reminderRepeat').checked;
            
            if (!title) {
                showToast('請輸入提醒標題');
                return;
            }
            
            if (!time) {
                showToast('請選擇提醒時間');
                return;
            }
            
            // 創建提醒數據
            const reminderData = {
                type: type,
                title: title,
                time: new Date(time).toISOString(),
                message: message,
                completed: false,
                repeat: null
            };
            
            // 如果設定了重複
            if (repeat) {
                const repeatType = document.getElementById('reminderRepeatType').value;
                
                if (repeatType === 'daily') {
                    reminderData.repeat = {
                        type: 'daily'
                    };
                } else if (repeatType === 'weekly') {
                    // 獲取選中的星期幾
                    const selectedDays = [];
                    document.querySelectorAll('input[name="reminderRepeatDay"]:checked').forEach(cb => {
                        selectedDays.push(cb.value);
                    });
                    
                    if (selectedDays.length === 0) {
                        showToast('請至少選擇一個重複的星期');
                        return;
                    }
                    
                    reminderData.repeat = {
                        type: 'weekly',
                        days: selectedDays
                    };
                } else if (repeatType === 'monthly') {
                    const repeatDate = document.getElementById('reminderRepeatDate').value;
                    
                    reminderData.repeat = {
                        type: 'monthly',
                        date: repeatDate
                    };
                }
            }
            
            // 添加提醒
            addReminder(appData.selectedChild, reminderData);
            
            closeModals();
            updateReminderList();
            
            showToast('提醒已儲存');
        }

        // 保存疫苗提醒
        function saveVaccineReminder() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童');
                closeModals();
                return;
            }
            
            let vaccineName = document.getElementById('vaccineName').value;
            if (vaccineName === 'other') {
                vaccineName = document.getElementById('vaccineOtherName').value.trim();
                if (!vaccineName) {
                    showToast('請輸入疫苗名稱');
                    return;
                }
            }
            
            const date = document.getElementById('vaccineDate').value;
            const location = document.getElementById('vaccineLocation').value.trim();
            const note = document.getElementById('vaccineNote').value.trim();
            
            if (!date) {
                showToast('請選擇接種日期');
                return;
            }
            
            // 創建提醒
            const reminderDate = new Date(date);
            reminderDate.setHours(9, 0, 0); // 設定為上午9點
            
            addReminder(appData.selectedChild, {
                type: 'vaccine',
                title: `疫苗接種 - ${vaccineName}`,
                time: reminderDate.toISOString(),
                message: `今天是${vaccineName}疫苗接種日${location ? `\n接種地點: ${location}` : ''}${note ? `\n備註: ${note}` : ''}`,
                completed: false,
                repeat: null,
                metadata: {
                    vaccineName: vaccineName,
                    location: location
                }
            });
            
            // 如果設定了下一劑提醒
            const setNextReminder = document.getElementById('vaccineSetNextReminder').checked;
            if (setNextReminder) {
                const nextDate = document.getElementById('vaccineNextDate').value;
                
                if (!nextDate) {
                    showToast('請選擇下一劑日期');
                    return;
                }
                
                const nextReminderDate = new Date(nextDate);
                nextReminderDate.setHours(9, 0, 0); // 設定為上午9點
                
                addReminder(appData.selectedChild, {
                    type: 'vaccine',
                    title: `下一劑疫苗 - ${vaccineName}`,
                    time: nextReminderDate.toISOString(),
                    message: `今天是${vaccineName}下一劑疫苗接種日${location ? `\n建議接種地點: ${location}` : ''}${note ? `\n備註: ${note}` : ''}`,
                    completed: false,
                    repeat: null,
                    metadata: {
                        vaccineName: vaccineName,
                        location: location,
                        isNext: true
                    }
                });
            }
            
            // 創建記錄
            const record = {
                id: 'record_' + Date.now(),
                type: 'medical',
                subType: '疫苗接種',
                date: date + 'T09:00:00',
                time: date + 'T09:00:00',
                title: `疫苗接種 - ${vaccineName}`,
                content: `安排${date}接種${vaccineName}疫苗${location ? `\n接種地點: ${location}` : ''}${note ? `\n備註: ${note}` : ''}`
            };
            
            if (!appData.records[appData.selectedChild]) {
                appData.records[appData.selectedChild] = [];
            }
            
            appData.records[appData.selectedChild].push(record);
            saveRecords(appData.selectedChild);
            
            closeModals();
            updateReminderList();
            
            showToast('疫苗提醒已設定');
        }

        // 保存藥物提醒
        function saveMedicineReminder() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童');
                closeModals();
                return;
            }
            
            const name = document.getElementById('medicineName').value.trim();
            const dosage = document.getElementById('medicineDosage').value.trim();
            const schedule = document.getElementById('medicineSchedule').value;
            const duration = document.getElementById('medicineDuration').value;
            const note = document.getElementById('medicineNote').value.trim();
            
            if (!name) {
                showToast('請輸入藥物名稱');
                return;
            }
            
            if (!dosage) {
                showToast('請輸入劑量');
                return;
            }
            
            // 計算服用時間
            let firstTime;
            if (schedule === 'custom') {
                firstTime = document.getElementById('medicineFirstTime').value;
                if (!firstTime) {
                    showToast('請選擇首次服用時間');
                    return;
                }
            } else {
            //使用當前時間作為首次服用時間
                const now = new Date();
                firstTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            }
            
            // 藥物服用次數
            const dosesPerDay = parseInt(schedule);
            
            // 計算服用間隔（小時）
            const interval = 24 / dosesPerDay;
            
            // 創建首次提醒
            const firstDoseDate = new Date(firstTime);
            
            // 創建藥物記錄
            const medicineRecord = {
                id: 'record_' + Date.now(),
                type: 'medicine',
                action: 'start',
                date: firstDoseDate.toISOString(),
                time: firstDoseDate.toISOString(),
                title: `開始服用 ${name}`,
                content: `開始服用 ${name} ${dosage}，每天${dosesPerDay}次${duration > 0 ? `，共${duration}天` : ''}。${note ? `\n備註: ${note}` : ''}`
            };
            
            if (!appData.records[appData.selectedChild]) {
                appData.records[appData.selectedChild] = [];
            }
            
            appData.records[appData.selectedChild].push(medicineRecord);
            saveRecords(appData.selectedChild);
            
            // 生成服用時間
            const doseTimes = [];
            for (let i = 0; i < dosesPerDay; i++) {
                const doseTime = new Date(firstDoseDate);
                doseTime.setHours(doseTime.getHours() + i * interval);
                
                // 時間標籤
                let timeLabel = '';
                const hours = doseTime.getHours();
                
                if (hours >= 5 && hours < 11) {
                    timeLabel = '早上';
                } else if (hours >= 11 && hours < 14) {
                    timeLabel = '中午';
                } else if (hours >= 14 && hours < 19) {
                    timeLabel = '傍晚';
                } else {
                    timeLabel = '晚上';
                }
                
                doseTimes.push({
                    time: doseTime,
                    label: timeLabel
                });
            }
            
            // 創建所有提醒
            const endDate = duration > 0 ? new Date(firstDoseDate) : null;
            if (endDate) {
                endDate.setDate(endDate.getDate() + parseInt(duration));
            }
            
            // 每天的服用提醒
            for (let day = 0; day < (duration > 0 ? parseInt(duration) : 30); day++) {
                for (let i = 0; i < doseTimes.length; i++) {
                    const doseTime = new Date(doseTimes[i].time);
                    doseTime.setDate(doseTime.getDate() + day);
                    
                    // 如果時間已過，跳過
                    if (doseTime < new Date()) {
                        continue;
                    }
                    
                    // 添加提醒
                    addReminder(appData.selectedChild, {
                        type: 'medicine',
                        title: `服藥提醒 - ${name}`,
                        time: doseTime.toISOString(),
                        message: `該服用 ${name} ${dosage} (${doseTimes[i].label})${note ? `\n備註: ${note}` : ''}`,
                        completed: false,
                        repeat: null,
                        metadata: {
                            medicineName: name,
                            dosage: dosage,
                            doseTime: doseTimes[i].label,
                            endDate: endDate ? endDate.toISOString() : null
                        }
                    });
                }
            }
            
            closeModals();
            updateReminderList();
            
            showToast('藥物提醒已設定');
        }

        // 顯示提醒模態框
        function showAddReminderModal() {
            document.getElementById('reminderTitle').value = '';
            document.getElementById('reminderTime').value = '';
            document.getElementById('reminderMessage').value = '';
            document.getElementById('reminderRepeat').checked = false;
            document.getElementById('reminderRepeatDetails').classList.remove('active');
            
            document.getElementById('addReminderModal').classList.add('active');
            document.getElementById('overlay').classList.add('active');
            
            // 設置當前時間
            const now = new Date();
            document.getElementById('reminderTime').value = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        }

        // 顯示快速餵食模態框
        function showQuickFeedingModal() {
            // 設置默認值
            if (appData.quickOptions.lastFeeding) {
                document.getElementById('quickFeedingType').value = appData.quickOptions.lastFeeding.type;
                document.getElementById('quickFeedingAmount').value = appData.quickOptions.lastFeeding.amount;
                document.getElementById('quickFeedingUnit').value = appData.quickOptions.lastFeeding.unit;
            }
            
            document.getElementById('quickFeedingNote').value = '';
            document.getElementById('quickFeedingSetReminder').checked = false;
            document.getElementById('quickFeedingReminderOptions').style.display = 'none';
            
            document.getElementById('quickFeedingModal').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }

        // 顯示快速尿布模態框
        function showQuickDiaperModal() {
            // 重置選項
            document.querySelectorAll('.diaper-option').forEach(o => o.classList.remove('active'));
            document.querySelector('.diaper-option[data-type="urine"]').classList.add('active');
            
            document.getElementById('quickDiaperCondition').value = '正常';
            document.getElementById('quickDiaperNote').value = '';
            document.getElementById('quickDiaperSetReminder').checked = false;
            document.getElementById('quickDiaperReminderOptions').style.display = 'none';
            
            document.getElementById('quickDiaperModal').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }

        // 顯示快速其他模態框
        function showQuickOtherModal() {
            document.getElementById('quickOtherType').value = 'emotion_happy';
            document.getElementById('quickOtherNote').value = '';
            
            document.getElementById('quickOtherModal').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }

        // 顯示快速成長記錄模態框
        function showQuickGrowthModal() {
            document.getElementById('quickGrowthLocation').value = '家中';
            document.getElementById('quickGrowthHeight').value = '';
            document.getElementById('quickGrowthWeight').value = '';
            document.getElementById('quickGrowthHeadCircumference').value = '';
            document.getElementById('quickGrowthNote').value = '';
            
            document.getElementById('quickGrowthModal').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }

        // 顯示快速服藥記錄模態框
        function showQuickMedicineRecordModal() {
            // 更新藥物選擇
            updateQuickMedicineSelect();
            
            // 重置狀態
            document.getElementById('quickMedicineSelect').value = '';
            document.getElementById('quickMedicineDetails').style.display = 'none';
            document.getElementById('saveQuickMedicineBtn').disabled = true;
            
            // 設置當前時間
            const now = new Date();
            document.getElementById('quickMedicineTime').value = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            
            document.getElementById('quickMedicineRecordModal').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }

        // 顯示快速藥物提醒模態框
        function showQuickMedicineModal() {
            document.getElementById('medicineName').value = '';
            document.getElementById('medicineDosage').value = '';
            document.getElementById('medicineSchedule').value = '2';
            document.getElementById('medicineCustomTimeGroup').style.display = 'none';
            document.getElementById('medicineDuration').value = '7';
            document.getElementById('medicineNote').value = '';
            
            document.getElementById('quickMedicineModal').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }

        // 顯示快速疫苗提醒模態框
        function showQuickVaccineModal() {
            document.getElementById('vaccineName').value = 'BCG';
            document.getElementById('vaccineOtherNameGroup').style.display = 'none';
            
            // 設置日期為一週後
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('vaccineDate').value = nextWeek.toISOString().split('T')[0];
            
            document.getElementById('vaccineLocation').value = '';
            document.getElementById('vaccineNote').value = '';
            document.getElementById('vaccineSetNextReminder').checked = false;
            document.getElementById('vaccineNextReminderOptions').style.display = 'none';
            
            document.getElementById('quickVaccineModal').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }

        // 顯示快速回診提醒模態框
        function showQuickMedicalModal() {
            // 設置日期為一週後
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('medicalReminderDate').value = nextWeek.toISOString().split('T')[0];
            
            document.getElementById('medicalReminderProvider').value = '';
            document.getElementById('medicalReminderType').value = '例行檢查';
            document.getElementById('medicalReminderReason').value = '';
            document.getElementById('medicalSetPreReminder').checked = true;
            document.getElementById('medicalPreReminderOptions').style.display = 'block';
            document.getElementById('medicalPreReminderDays').value = '2';
            
            document.getElementById('quickMedicalModal').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }

        // 顯示快速成長檢測提醒模態框
        function showQuickGrowthReminderModal() {
            // 設置日期為一個月後
            const nextMonth = new Date();
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            document.getElementById('growthReminderDate').value = nextMonth.toISOString().split('T')[0];
            
            document.getElementById('growthReminderLocation').value = '健康中心';
            document.getElementById('growthReminderNote').value = '';
            document.getElementById('growthSetPreReminder').checked = true;
            document.getElementById('growthPreReminderOptions').style.display = 'block';
            document.getElementById('growthPreReminderDays').value = '2';
            document.getElementById('growthSetRecurring').checked = false;
            document.getElementById('growthRecurringOptions').style.display = 'none';
            
            document.getElementById('quickGrowthReminderModal').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }

        // 更新記錄表單預設值
        function updateRecordFormDefaults() {
            // 設置當前日期時間
            setCurrentDateTime();
            
            // 設置餵食預設值
            if (appData.quickOptions.lastFeeding) {
                document.getElementById('feedingType').value = appData.quickOptions.lastFeeding.type;
                document.getElementById('feedingAmount').value = appData.quickOptions.lastFeeding.amount;
                document.getElementById('feedingUnit').value = appData.quickOptions.lastFeeding.unit;
            }
        }

        // 更新歷史記錄內容
        function updateHistoryContent() {
            const historyContent = document.getElementById('historyContent');
            historyContent.innerHTML = '';
            
            if (!appData.selectedChild || !appData.records[appData.selectedChild] || 
                appData.records[appData.selectedChild].length === 0) {
                historyContent.innerHTML = '<p>沒有歷史記錄</p>';
                return;
            }
            
            // 獲取日期和過濾類型
            const selectedDate = document.getElementById('historyDate').value;
            const filterType = document.getElementById('historyFilter').value;
            
            // 過濾記錄
            let filteredRecords = [...appData.records[appData.selectedChild]];
            
            // 如果選擇了日期
            if (selectedDate) {
                filteredRecords = filteredRecords.filter(record => 
                    record.date && record.date.startsWith(selectedDate)
                );
            }
            
            // 如果選擇了類型
            if (filterType !== 'all') {
                filteredRecords = filteredRecords.filter(record => 
                    record.type === filterType
                );
            }
            
            // 如果沒有匹配的記錄
            if (filteredRecords.length === 0) {
                historyContent.innerHTML = '<p>沒有符合條件的記錄</p>';
                return;
            }
            
            // 按日期和時間分組記錄
            const recordsByDate = {};
            
            filteredRecords.forEach(record => {
                const dateStr = record.date ? record.date.split('T')[0] : 'unknown';
                
                if (!recordsByDate[dateStr]) {
                    recordsByDate[dateStr] = [];
                }
                
                recordsByDate[dateStr].push(record);
            });
            
            // 按日期遞減排序
            const sortedDates = Object.keys(recordsByDate).sort((a, b) => {
                return new Date(b) - new Date(a);
            });
            
            // 生成日期分組的記錄
            sortedDates.forEach(date => {
                const records = recordsByDate[date];
                
                // 排序記錄 (按時間遞減)
                records.sort((a, b) => {
                    return new Date(b.time || b.date) - new Date(a.time || a.date);
                });
                
                // 創建日期分組
                const dayContainer = document.createElement('div');
                dayContainer.className = 'history-day';
                
                // 創建日期標頭
                const dayHeader = document.createElement('div');
                dayHeader.className = 'history-day-header';
                dayHeader.textContent = formatDate(date);
                
                // 創建記錄容器
                const recordsContainer = document.createElement('div');
                recordsContainer.className = 'history-records';
                
                // 添加記錄
                records.forEach(record => {
                    const recordElement = createRecordElement(record);
                    recordsContainer.appendChild(recordElement);
                });
                
                dayContainer.appendChild(dayHeader);
                dayContainer.appendChild(recordsContainer);
                historyContent.appendChild(dayContainer);
            });
        }

        // 創建記錄元素
        function createRecordElement(record) {
            const recordElement = document.createElement('div');
            recordElement.className = 'history-record';
            recordElement.setAttribute('data-id', record.id);
            recordElement.setAttribute('data-type', record.type);
            
            // 獲取時間部分
            const timeStr = record.time ? new Date(record.time).toTimeString().slice(0, 5) : '';
            
            // 標題和內容
            let title = '';
            let content = '';
            
            switch (record.type) {
                case 'feeding':
                    title = '餵食';
                    content = `${record.feedingType} ${record.amount} ${record.unit}${record.note ? ` - ${record.note}` : ''}`;
                    break;
                case 'sleep':
                    title = '睡眠';
                    const duration = record.duration ? `${record.duration.hours}小時${record.duration.minutes}分鐘` : '';
                    content = `${formatTime(record.start)} - ${formatTime(record.end)} (${duration})${record.note ? ` - ${record.note}` : ''}`;
                    break;
                case 'diaper':
                    title = '尿布';
                    const typeStr = (record.urine ? '小便' : '') + (record.urine && record.stool ? ' + ' : '') + (record.stool ? '大便' : '');
                    content = `${typeStr} - ${record.condition}${record.note ? ` - ${record.note}` : ''}`;
                    break;
                case 'emotion':
                    title = '情緒';
                    content = `${record.emotionType} (強度: ${record.intensity})${record.note ? ` - ${record.note}` : ''}`;
                    break;
                case 'activity':
                    title = '活動';
                    content = `${record.activityType} (${record.duration}分鐘)${record.note ? ` - ${record.note}` : ''}`;
                    break;
                case 'growth':
                    title = '成長測量';
                    // 直接使用content字段，因為是從記錄中創建的
                    content = record.content || '';
                    break;
                case 'medical':
                    title = record.subType || '就醫';
                    // 直接使用content字段
                    content = record.content || '';
                    break;
                case 'medicine':
                    title = record.title || '用藥記錄';
                    // 直接使用content字段
                    content = record.content || '';
                    break;
                case 'other':
                    title = record.title || '其他';
                    content = record.content || '';
                    break;
            }
            
            // 添加記錄類型的顏色樣式
            recordElement.classList.add(`record-color-${record.type}`);
            
            // 創建記錄HTML
            recordElement.innerHTML = `
                <div class="history-record-time">${timeStr}</div>
                <div class="history-record-type">${title}</div>
                <div class="history-record-info">${content}</div>
                <div class="history-record-actions">
                    <button class="btn btn-danger btn-delete-record" data-id="${record.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            // 添加刪除按鈕事件
            recordElement.querySelector('.btn-delete-record').addEventListener('click', function(e) {
                e.stopPropagation();
                const recordId = this.getAttribute('data-id');
                if (confirm('確定要刪除此記錄嗎？')) {
                    deleteRecord(recordId);
                }
            });
            
            // 添加點擊事件（編輯記錄）
            recordElement.addEventListener('click', function() {
                const recordId = this.getAttribute('data-id');
                editRecord(recordId);
            });
            
            return recordElement;
        }

        // 格式化時間
        function formatTime(dateTimeStr) {
            if (!dateTimeStr) return '';
            
            const date = new Date(dateTimeStr);
            return date.toTimeString().slice(0, 5); // 格式為 "HH:MM"
        }

        // 刪除記錄
        function deleteRecord(recordId) {
            if (!appData.selectedChild || !appData.records[appData.selectedChild]) {
                return;
            }
            
            // 找到記錄
            const recordIndex = appData.records[appData.selectedChild].findIndex(r => r.id === recordId);
            if (recordIndex === -1) return;
            
            // 刪除記錄
            appData.records[appData.selectedChild].splice(recordIndex, 1);
            saveRecords(appData.selectedChild);
            
            // 更新顯示
            updateHistoryContent();
            
            showToast('記錄已刪除');
        }

        // 編輯記錄
        function editRecord(recordId) {
            // 尋找記錄
            const record = appData.records[appData.selectedChild].find(r => r.id === recordId);
            if (!record) return;
            
            // 設置標題
            document.getElementById('editRecordTitle').textContent = `編輯${getRecordTypeText(record.type)}記錄`;
            
            // 清空編輯表單
            document.getElementById('editRecordBody').innerHTML = '';
            
            // 生成編輯表單
            const formHTML = createEditForm(record);
            document.getElementById('editRecordBody').innerHTML = formHTML;
            
            // 設置按鈕事件
            document.getElementById('updateRecordBtn').onclick = function() {
                updateRecord(recordId);
            };
            
            document.getElementById('deleteRecordBtn').onclick = function() {
                if (confirm('確定要刪除此記錄嗎？')) {
                    deleteRecord(recordId);
                    closeModals();
                }
            };
            
            document.getElementById('cancelEditRecordBtn').onclick = closeModals;
            
            // 顯示模態框
            document.getElementById('editRecordModal').classList.add('active');
            document.getElementById('overlay').classList.add('active');
            
            // 初始化表單事件
            initEditFormEvents(record.type);
        }

        // 獲取記錄類型文字
        function getRecordTypeText(type) {
            switch (type) {
                case 'feeding': return '餵食';
                case 'sleep': return '睡眠';
                case 'diaper': return '尿布';
                case 'emotion': return '情緒';
                case 'activity': return '活動';
                case 'growth': return '成長';
                case 'medical': return '就醫';
                case 'medicine': return '用藥';
                case 'other': return '';
                default: return '';
            }
        }

        // 創建編輯表單
        function createEditForm(record) {
            switch (record.type) {
                case 'feeding':
                    return `
                        <div class="form-group">
                            <label for="editFeedingType">餵食類型</label>
                            <select id="editFeedingType" class="form-control">
                                <option value="母乳" ${record.feedingType === '母乳' ? 'selected' : ''}>母乳</option>
                                <option value="配方奶" ${record.feedingType === '配方奶' ? 'selected' : ''}>配方奶</option>
                                <option value="副食品" ${record.feedingType === '副食品' ? 'selected' : ''}>副食品</option>
                                <option value="水果" ${record.feedingType === '水果' ? 'selected' : ''}>水果</option>
                                <option value="水/飲料" ${record.feedingType === '水/飲料' ? 'selected' : ''}>水/飲料</option>
                                <option value="其他" ${record.feedingType === '其他' ? 'selected' : ''}>其他</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editFeedingAmount">數量/時間</label>
                            <div style="display: flex; align-items: center;">
                                <input type="number" id="editFeedingAmount" class="form-control" style="flex: 1; margin-right: 10px;" value="${record.amount}">
                                <select id="editFeedingUnit" class="form-control" style="width: 80px;">
                                    <option value="ml" ${record.unit === 'ml' ? 'selected' : ''}>毫升</option>
                                    <option value="min" ${record.unit === 'min' ? 'selected' : ''}>分鐘</option>
                                    <option value="份" ${record.unit === '份' ? 'selected' : ''}>份</option>
                                    <option value="湯匙" ${record.unit === '湯匙' ? 'selected' : ''}>湯匙</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editFeedingTime">時間</label>
                            <input type="datetime-local" id="editFeedingTime" class="form-control" value="${record.time ? record.time.slice(0, 16) : ''}">
                        </div>
                        <div class="form-group">
                            <label for="editFeedingNote">備註</label>
                            <textarea id="editFeedingNote" class="form-control" rows="3">${record.note || ''}</textarea>
                        </div>
                    `;
                case 'sleep':
                    return `
                        <div class="form-group">
                            <label for="editSleepStart">開始時間</label>
                            <input type="datetime-local" id="editSleepStart" class="form-control" value="${record.start ? record.start.slice(0, 16) : ''}">
                        </div>
                        <div class="form-group">
                            <label for="editSleepEnd">結束時間</label>
                            <input type="datetime-local" id="editSleepEnd" class="form-control" value="${record.end ? record.end.slice(0, 16) : ''}">
                        </div>
                        <div class="form-group">
                            <label for="editSleepQuality">睡眠品質 (1-5分)</label>
                            <div class="rating" id="editSleepQualityRating">
                                <span class="rating-star ${record.quality >= 1 ? 'active' : ''}" data-value="1"><i class="fas fa-star"></i></span>
                                <span class="rating-star ${record.quality >= 2 ? 'active' : ''}" data-value="2"><i class="fas fa-star"></i></span>
                                <span class="rating-star ${record.quality >= 3 ? 'active' : ''}" data-value="3"><i class="fas fa-star"></i></span>
                                <span class="rating-star ${record.quality >= 4 ? 'active' : ''}" data-value="4"><i class="fas fa-star"></i></span>
                                <span class="rating-star ${record.quality >= 5 ? 'active' : ''}" data-value="5"><i class="fas fa-star"></i></span>
                            </div>
                            <input type="hidden" id="editSleepQuality" value="${record.quality || 3}">
                        </div>
                        <div class="form-group">
                            <label for="editSleepNote">備註</label>
                            <textarea id="editSleepNote" class="form-control" rows="3">${record.note || ''}</textarea>
                        </div>
                    `;
                case 'diaper':
                    return `
                        <div class="form-group">
                            <label>排泄類型</label>
                            <div style="display: flex; gap: 10px;">
                                <label style="display: flex; align-items: center;">
                                    <input type="checkbox" id="editDiaperUrine" ${record.urine ? 'checked' : ''} style="margin-right: 5px;"> 小便
                                </label>
                                <label style="display: flex; align-items: center;">
                                    <input type="checkbox" id="editDiaperStool" ${record.stool ? 'checked' : ''} style="margin-right: 5px;"> 大便
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editDiaperCondition">狀況</label>
                            <select id="editDiaperCondition" class="form-control">
                                <option value="正常" ${record.condition === '正常' ? 'selected' : ''}>正常</option>
                                <option value="異常" ${record.condition === '異常' ? 'selected' : ''}>異常</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editDiaperTime">時間</label>
                            <input type="datetime-local" id="editDiaperTime" class="form-control" value="${record.time ? record.time.slice(0, 16) : ''}">
                        </div>
                        <div class="form-group">
                            <label for="editDiaperNote">備註</label>
                            <textarea id="editDiaperNote" class="form-control" rows="3" placeholder="若狀況異常，請說明異常情況">${record.note || ''}</textarea>
                        </div>
                    `;
                case 'emotion':
                    return `
                        <div class="form-group">
                            <label for="editEmotionType">情緒類別</label>
                            <select id="editEmotionType" class="form-control">
                                <option value="開心" ${record.emotionType === '開心' ? 'selected' : ''}>開心</option>
                                <option value="難過" ${record.emotionType === '難過' ? 'selected' : ''}>難過</option>
                                <option value="生氣" ${record.emotionType === '生氣' ? 'selected' : ''}>生氣</option>
                                <option value="害怕" ${record.emotionType === '害怕' ? 'selected' : ''}>害怕</option>
                                <option value="驚訝" ${record.emotionType === '驚訝' ? 'selected' : ''}>驚訝</option>
                                <option value="平靜" ${record.emotionType === '平靜' ? 'selected' : ''}>平靜</option>
                                <option value="其他" ${record.emotionType === '其他' ? 'selected' : ''}>其他</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editEmotionIntensity">強度 (1-5分)</label>
                            <div class="rating" id="editEmotionIntensityRating">
                                <span class="rating-star ${record.intensity >= 1 ? 'active' : ''}" data-value="1"><i class="fas fa-star"></i></span>
                                <span class="rating-star ${record.intensity >= 2 ? 'active' : ''}" data-value="2"><i class="fas fa-star"></i></span>
                                <span class="rating-star ${record.intensity >= 3 ? 'active' : ''}" data-value="3"><i class="fas fa-star"></i></span>
                                <span class="rating-star ${record.intensity >= 4 ? 'active' : ''}" data-value="4"><i class="fas fa-star"></i></span>
                                <span class="rating-star ${record.intensity >= 5 ? 'active' : ''}" data-value="5"><i class="fas fa-star"></i></span>
                            </div>
                            <input type="hidden" id="editEmotionIntensity" value="${record.intensity || 3}">
                        </div>
                        <div class="form-group">
                            <label for="editEmotionTime">時間</label>
                            <input type="datetime-local" id="editEmotionTime" class="form-control" value="${record.time ? record.time.slice(0, 16) : ''}">
                        </div>
                        <div class="form-group">
                            <label for="editEmotionNote">備註</label>
                            <textarea id="editEmotionNote" class="form-control" rows="3" placeholder="描述情緒發生的情境和可能的原因">${record.note || ''}</textarea>
                        </div>
                    `;
                case 'activity':
                    return `
                        <div class="form-group">
                            <label for="editActivityType">活動類型</label>
                            <select id="editActivityType" class="form-control">
                                <option value="遊戲" ${record.activityType === '遊戲' ? 'selected' : ''}>遊戲</option>
                                <option value="洗澡" ${record.activityType === '洗澡' ? 'selected' : ''}>洗澡</option>
                                <option value="戶外" ${record.activityType === '戶外' ? 'selected' : ''}>戶外</option>
                                <option value="學習" ${record.activityType === '學習' ? 'selected' : ''}>學習</option>
                                <option value="社交" ${record.activityType === '社交' ? 'selected' : ''}>社交</option>
                                <option value="運動" ${record.activityType === '運動' ? 'selected' : ''}>運動</option>
                                <option value="其他" ${record.activityType === '其他' ? 'selected' : ''}>其他</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editActivityDuration">持續時間 (分鐘)</label>
                            <input type="number" id="editActivityDuration" class="form-control" value="${record.duration || ''}">
                        </div>
                        <div class="form-group">
                            <label for="editActivityTime">開始時間</label>
                            <input type="datetime-local" id="editActivityTime" class="form-control" value="${record.time ? record.time.slice(0, 16) : ''}">
                        </div>
                        <div class="form-group">
                            <label for="editActivityNote">備註</label>
                            <textarea id="editActivityNote" class="form-control" rows="3" placeholder="描述活動內容和兒童反應">${record.note || ''}</textarea>
                        </div>
                    `;
                case 'other':
                    return `
                        <div class="form-group">
                            <label for="editOtherTitle">標題</label>
                            <input type="text" id="editOtherTitle" class="form-control" value="${record.title || ''}">
                        </div>
                        <div class="form-group">
                            <label for="editOtherTime">時間</label>
                            <input type="datetime-local" id="editOtherTime" class="form-control" value="${record.time ? record.time.slice(0, 16) : ''}">
                        </div>
                        <div class="form-group">
                            <label for="editOtherContent">內容</label>
                            <textarea id="editOtherContent" class="form-control" rows="5">${record.content || ''}</textarea>
                        </div>
                    `;
                default:
                    // 僅支持顯示但不編輯的記錄類型
                    return `
                        <p>此類型記錄不支持編輯。</p>
                        <div class="form-group">
                            <label>記錄內容：</label>
                            <div style="margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                                ${record.content || ''}
                            </div>
                        </div>
                    `;
            }
        }

        // 初始化編輯表單事件
        function initEditFormEvents(recordType) {
            if (recordType === 'sleep' || recordType === 'emotion') {
                // 評分星星點擊
                document.querySelectorAll(`#edit${toTitleCase(recordType)}QualityRating .rating-star`).forEach(star => {
                    star.addEventListener('click', function() {
                        const ratingStars = this.parentElement.querySelectorAll('.rating-star');
                        const ratingValue = parseInt(this.getAttribute('data-value'));
                        const ratingInput = document.getElementById(`edit${toTitleCase(recordType)}Quality`);
                        
                        // 設置星星樣式
                        ratingStars.forEach(s => {
                            if (parseInt(s.getAttribute('data-value')) <= ratingValue) {
                                s.classList.add('active');
                            } else {
                                s.classList.remove('active');
                            }
                        });
                        
                        // 設置隱藏輸入值
                        ratingInput.value = ratingValue;
                    });
                });
            }
        }

        // 首字母大寫
        function toTitleCase(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // 更新記錄
        function updateRecord(recordId) {
            const record = appData.records[appData.selectedChild].find(r => r.id === recordId);
            if (!record) return;
            
            switch (record.type) {
                case 'feeding':
                    record.feedingType = document.getElementById('editFeedingType').value;
                    record.amount = document.getElementById('editFeedingAmount').value;
                    record.unit = document.getElementById('editFeedingUnit').value;
                    record.time = document.getElementById('editFeedingTime').value;
                    record.date = document.getElementById('editFeedingTime').value;
                    record.note = document.getElementById('editFeedingNote').value.trim();
                    break;
                case 'sleep':
                    const start = document.getElementById('editSleepStart').value;
                    const end = document.getElementById('editSleepEnd').value;
                    
                    if (new Date(start) >= new Date(end)) {
                        showToast('結束時間必須晚於開始時間');
                        return;
                    }
                    
                    const duration = calculateTimeDifference(start, end);
                    
                    record.start = start;
                    record.end = end;
                    record.duration = {
                        hours: duration.hours,
                        minutes: duration.minutes,
                        totalMinutes: duration.totalMinutes
                    };
                    record.quality = parseInt(document.getElementById('editSleepQuality').value);
                    record.time = start;
                    record.date = start;
                    record.note = document.getElementById('editSleepNote').value.trim();
                    break;
                case 'diaper':
                    record.urine = document.getElementById('editDiaperUrine').checked;
                    record.stool = document.getElementById('editDiaperStool').checked;
                    record.condition = document.getElementById('editDiaperCondition').value;
                    record.time = document.getElementById('editDiaperTime').value;
                    record.date = document.getElementById('editDiaperTime').value;
                    record.note = document.getElementById('editDiaperNote').value.trim();
                    break;
                case 'emotion':
                    record.emotionType = document.getElementById('editEmotionType').value;
                    record.intensity = parseInt(document.getElementById('editEmotionIntensity').value);
                    record.time = document.getElementById('editEmotionTime').value;
                    record.date = document.getElementById('editEmotionTime').value;
                    record.note = document.getElementById('editEmotionNote').value.trim();
                    break;
                case 'activity':
                    record.activityType = document.getElementById('editActivityType').value;
                    record.duration = parseInt(document.getElementById('editActivityDuration').value);
                    record.time = document.getElementById('editActivityTime').value;
                    record.date = document.getElementById('editActivityTime').value;
                    record.note = document.getElementById('editActivityNote').value.trim();
                    break;
                case 'other':
                    record.title = document.getElementById('editOtherTitle').value.trim();
                    record.time = document.getElementById('editOtherTime').value;
                    record.date = document.getElementById('editOtherTime').value;
                    record.content = document.getElementById('editOtherContent').value.trim();
                    break;
                default:
                    // 不支持編輯的記錄類型
                    break;
            }
            
            saveRecords(appData.selectedChild);
            updateHistoryContent();
            
            closeModals();
            showToast('記錄已更新');
        }

        // 更新里程碑內容
        function updateMilestoneContent() {
            const milestoneContent = document.getElementById('milestoneContent');
            milestoneContent.innerHTML = '';
            
            if (!appData.selectedChild) {
                milestoneContent.innerHTML = '<p>請先選擇一位兒童</p>';
                return;
            }
            
            // 獲取過濾選項
            const filter = document.getElementById('milestoneFilter').value;
            
            // 獲取兒童年齡
            const child = appData.children.find(c => c.id === appData.selectedChild);
            if (!child) return;
            
            const birthDate = new Date(child.birthday);
            const now = new Date();
            const ageInMonths = Math.floor((now - birthDate) / (1000 * 60 * 60 * 24 * 30.44));
            
            // 遍歷里程碑定義
            for (const ageGroup in milestonesDefinition) {
                // 如果設置了過濾，只顯示相應的年齡段
                if (filter !== 'all' && ageGroup !== filter) {
                    continue;
                }
                
                // 解析年齡範圍
                const [minAge, maxAge] = ageGroup.split('-').map(a => parseInt(a));
                
                // 檢查是否要顯示此年齡段
                const showGroup = filter === 'all' || (ageInMonths >= minAge && ageInMonths <= maxAge);
                
                if (showGroup) {
                    // 創建年齡段容器
                    const ageGroupContainer = document.createElement('div');
                    ageGroupContainer.className = 'milestone-category';
                    
                    // 創建年齡段標題
                    const ageGroupTitle = document.createElement('h3');
                    ageGroupTitle.textContent = `${minAge}-${maxAge}個月`;
                    
                    // 添加當前年齡指示
                    if (ageInMonths >= minAge && ageInMonths <= maxAge) {
                        ageGroupTitle.innerHTML += ` <span class="badge badge-primary">當前年齡段</span>`;
                    }
                    
                    ageGroupContainer.appendChild(ageGroupTitle);
                    
                    // 遍歷類別
                    for (const category in milestonesDefinition[ageGroup]) {
                        // 創建類別容器
                        const categoryContainer = document.createElement('div');
                        categoryContainer.className = 'card';
                        categoryContainer.style.marginBottom = '15px';
                        
                        // 創建類別標題
                        const categoryTitle = document.createElement('h4');
                        categoryTitle.textContent = category;
                        categoryTitle.style.padding = '10px';
                        categoryTitle.style.backgroundColor = '#f0f5f9';
                        categoryTitle.style.marginBottom = '0';
                        categoryTitle.style.borderTopLeftRadius = '10px';
                        categoryTitle.style.borderTopRightRadius = '10px';
                        
                        categoryContainer.appendChild(categoryTitle);
                        
                        // 創建里程碑列表
                        const milestoneList = document.createElement('ul');
                        milestoneList.className = 'milestone-list';
                        milestoneList.style.padding = '10px';
                        milestoneList.style.margin = '0';
                        
                        // 遍歷里程碑
                        milestonesDefinition[ageGroup][category].forEach(milestone => {
                            const milestoneId = `${ageGroup}_${category}_${milestone.name}`;
                            
                            // 檢查里程碑狀態
                            let achieved = false;
                            let achievedDate = '';
                            
                            if (appData.milestones[appData.selectedChild] && 
                                appData.milestones[appData.selectedChild][milestoneId]) {
                                achieved = appData.milestones[appData.selectedChild][milestoneId].achieved;
                                achievedDate = appData.milestones[appData.selectedChild][milestoneId].date;
                            }
                            
                            // 創建里程碑項目
                            const milestoneItem = document.createElement('li');
                            milestoneItem.className = 'milestone-item';
                            
                            milestoneItem.innerHTML = `
                                <div class="milestone-info">
                                    <div class="milestone-name">${milestone.name}</div>
                                    <div class="milestone-age">通常在: ${milestone.typicalAge}</div>
                                </div>
                                <div class="milestone-status">
                                    <input type="checkbox" class="milestone-checkbox" data-id="${milestoneId}" ${achieved ? 'checked' : ''}>
                                    <div class="milestone-date">
                                        ${achieved ? 
                                            `<input type="date" class="form-control milestone-date-input" data-id="${milestoneId}" value="${achievedDate}" style="width: 100%;">` : 
                                            '未達成'}
                                    </div>
                                </div>
                            `;
                            
                            milestoneList.appendChild(milestoneItem);
                        });
                        
                        categoryContainer.appendChild(milestoneList);
                        ageGroupContainer.appendChild(categoryContainer);
                    }
                    
                    milestoneContent.appendChild(ageGroupContainer);
                }
            }
            
            // 添加里程碑復選框事件
            document.querySelectorAll('.milestone-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const milestoneId = this.getAttribute('data-id');
                    const achieved = this.checked;
                    
                    // 初始化里程碑物件（如果不存在）
                    if (!appData.milestones[appData.selectedChild]) {
                        appData.milestones[appData.selectedChild] = {};
                    }
                    
                    if (!appData.milestones[appData.selectedChild][milestoneId]) {
                        appData.milestones[appData.selectedChild][milestoneId] = {};
                    }
                    
                    // 更新里程碑狀態
                    appData.milestones[appData.selectedChild][milestoneId].achieved = achieved;
                    
                    // 如果已達成，添加日期輸入框
                    const parent = this.closest('.milestone-item');
                    const dateContainer = parent.querySelector('.milestone-date');
                    
                    if (achieved) {
                        const today = new Date().toISOString().split('T')[0];
                        dateContainer.innerHTML = `<input type="date" class="form-control milestone-date-input" data-id="${milestoneId}" value="${today}" style="width: 100%;">`;
                        
                        appData.milestones[appData.selectedChild][milestoneId].date = today;
                        
                        // 添加日期變更事件
                        dateContainer.querySelector('.milestone-date-input').addEventListener('change', function() {
                            const milestoneId = this.getAttribute('data-id');
                            const date = this.value;
                            
                            appData.milestones[appData.selectedChild][milestoneId].date = date;
                            saveMilestones(appData.selectedChild);
                        });
                    } else {
                        dateContainer.innerHTML = '未達成';
                        appData.milestones[appData.selectedChild][milestoneId].date = '';
                    }
                    
                    saveMilestones(appData.selectedChild);
                });
            });
            
            // 添加里程碑日期輸入框事件
            document.querySelectorAll('.milestone-date-input').forEach(input => {
                input.addEventListener('change', function() {
                    const milestoneId = this.getAttribute('data-id');
                    const date = this.value;
                    
                    appData.milestones[appData.selectedChild][milestoneId].date = date;
                    saveMilestones(appData.selectedChild);
                });
            });
        }

        // 更新統計圖表
        function updateStatsCharts(period, customStartDate, customEndDate) {
            if (!appData.selectedChild || !appData.records[appData.selectedChild] || 
                appData.records[appData.selectedChild].length === 0) {
                // 清空圖表
                clearCharts();
                return;
            }
            
            // 計算日期範圍
            const now = new Date();
            let startDate, endDate;
            
            if (period === 'custom') {
                startDate = new Date(customStartDate);
                endDate = new Date(customEndDate);
                endDate.setHours(23, 59, 59);
            } else if (period === 'week') {
                // 過去7天
                startDate = new Date(now);
                startDate.setDate(now.getDate() - 7);
                endDate = now;
            } else if (period === 'month') {
                // 過去30天
                startDate = new Date(now);
                startDate.setDate(now.getDate() - 30);
                endDate = now;
            } else if (period === '3months') {
                // 過去90天
                startDate = new Date(now);
                startDate.setDate(now.getDate() - 90);
                endDate = now;
            }
            
            // 過濾記錄
            const records = appData.records[appData.selectedChild].filter(record => {
                const recordDate = new Date(record.date);
                return recordDate >= startDate && recordDate <= endDate;
            });
            
            if (records.length === 0) {
                // 清空圖表
                clearCharts();
                return;
            }
            
            // 更新各類型圖表
            updateSleepChart(records, startDate, endDate);
            updateFeedingChart(records, startDate, endDate);
            updateDiaperChart(records, startDate, endDate);
            updateEmotionChart(records, startDate, endDate);
            updateMedicineAdherenceChart(records, startDate, endDate); // 新增：藥物依從性圖表
        }

        // 清空圖表
        function clearCharts() {
            const emptyData = {
                labels: ['無數據'],
                datasets: [{
                    label: '數據點',
                    data: [0],
                    backgroundColor: 'rgba(142, 202, 230, 0.2)',
                    borderColor: 'rgba(142, 202, 230, 1)',
                    borderWidth: 1
                }]
            };
            
            const emptyOptions = {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            };
            
            if (window.sleepChart) window.sleepChart.destroy();
            window.sleepChart = new Chart(document.getElementById('sleepChart').getContext('2d'), {
                type: 'bar',
                data: emptyData,
                options: emptyOptions
            });
            
            if (window.feedingChart) window.feedingChart.destroy();
            window.feedingChart = new Chart(document.getElementById('feedingChart').getContext('2d'), {
                type: 'bar',
                data: emptyData,
                options: emptyOptions
            });
            
            if (window.diaperChart) window.diaperChart.destroy();
            window.diaperChart = new Chart(document.getElementById('diaperChart').getContext('2d'), {
                type: 'bar',
                data: emptyData,
                options: emptyOptions
            });
            
            if (window.emotionChart) window.emotionChart.destroy();
            window.emotionChart = new Chart(document.getElementById('emotionChart').getContext('2d'), {
                type: 'line',
                data: emptyData,
                options: emptyOptions
            });
            
            if (window.medicineAdherenceChart) window.medicineAdherenceChart.destroy();
            window.medicineAdherenceChart = new Chart(document.getElementById('medicineAdherenceChart').getContext('2d'), {
                type: 'bar',
                data: emptyData,
                options: emptyOptions
            });
        }

        // 更新睡眠圖表
        function updateSleepChart(records, startDate, endDate) {
            // 過濾睡眠記錄
            const sleepRecords = records.filter(record => record.type === 'sleep');
            
            if (sleepRecords.length === 0) {
                if (window.sleepChart) window.sleepChart.destroy();
                window.sleepChart = new Chart(document.getElementById('sleepChart').getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['無睡眠數據'],
                        datasets: [{
                            label: '睡眠時間',
                            data: [0],
                            backgroundColor: 'rgba(147, 129, 255, 0.2)',
                            borderColor: 'rgba(147, 129, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                return;
            }
            
            // 按日期分組
            const sleepByDate = {};
            const qualityByDate = {};
            
            sleepRecords.forEach(record => {
                const dateStr = record.date.split('T')[0];
                
                if (!sleepByDate[dateStr]) {
                    sleepByDate[dateStr] = 0;
                    qualityByDate[dateStr] = [];
                }
                
                // 累加睡眠時間
                if (record.duration && record.duration.totalMinutes) {
                    sleepByDate[dateStr] += record.duration.totalMinutes;
                }
                
                // 累加睡眠品質
                if (record.quality) {
                    qualityByDate[dateStr].push(record.quality);
                }
            });
            
            // 處理日期
            const dates = getDatesInRange(startDate, endDate);
            
            // 準備圖表數據
            const labels = [];
            const sleepData = [];
            const qualityData = [];
            
            dates.forEach(date => {
                const dateStr = date.toISOString().split('T')[0];
                labels.push(formatDate(dateStr));
                
                // 睡眠時間（小時）
                sleepData.push(sleepByDate[dateStr] ? sleepByDate[dateStr] / 60 : 0);
                
                // 睡眠品質（平均）
                if (qualityByDate[dateStr] && qualityByDate[dateStr].length > 0) {
                    const sum = qualityByDate[dateStr].reduce((a, b) => a + b, 0);
                    qualityData.push(sum / qualityByDate[dateStr].length);
                } else {
                    qualityData.push(null);
                }
            });
            
            // 創建圖表
            if (window.sleepChart) window.sleepChart.destroy();
            window.sleepChart = new Chart(document.getElementById('sleepChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '睡眠時間 (小時)',
                            data: sleepData,
                            backgroundColor: 'rgba(147, 129, 255, 0.2)',
                            borderColor: 'rgba(147, 129, 255, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: '睡眠品質 (1-5分)',
                            data: qualityData,
                            type: 'line',
                            fill: false,
                            borderColor: 'rgba(255, 183, 3, 1)',
                            pointBackgroundColor: 'rgba(255, 183, 3, 1)',
                            pointBorderColor: 'rgba(255, 183, 3, 1)',
                            pointRadius: 4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '睡眠時間 (小時)'
                            }
                        },
                        y1: {
                            beginAtZero: true,
                            max: 5,
                            position: 'right',
                            title: {
                                display: true,
                                text: '睡眠品質 (1-5分)'
                            }
                        }
                    }
                }
            });
        }

        // 更新餵食圖表
        function updateFeedingChart(records, startDate, endDate) {
            // 過濾餵食記錄
            const feedingRecords = records.filter(record => record.type === 'feeding');
            
            if (feedingRecords.length === 0) {
                if (window.feedingChart) window.feedingChart.destroy();
                window.feedingChart = new Chart(document.getElementById('feedingChart').getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['無餵食數據'],
                        datasets: [{
                            label: '餵食量',
                            data: [0],
                            backgroundColor: 'rgba(142, 202, 230, 0.2)',
                            borderColor: 'rgba(142, 202, 230, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                return;
            }
            
            // 按日期和類型分組
            const feedingByDate = {};
            
            // 識別餵食類型
            const feedingTypes = [...new Set(feedingRecords.map(record => record.feedingType))];
            
            feedingRecords.forEach(record => {
                const dateStr = record.date.split('T')[0];
                
                if (!feedingByDate[dateStr]) {
                    feedingByDate[dateStr] = {};
                    
                    // 初始化每種類型
                    feedingTypes.forEach(type => {
                        feedingByDate[dateStr][type] = {
                            ml: 0,
                            min: 0,
                            份: 0,
                            湯匙: 0
                        };
                    });
                }
                
                // 確保類型存在
                if (!feedingByDate[dateStr][record.feedingType]) {
                    feedingByDate[dateStr][record.feedingType] = {
                        ml: 0,
                        min: 0,
                        份: 0,
                        湯匙: 0
                    };
                }
                
                // 累加數量
                if (record.amount && record.unit) {
                    feedingByDate[dateStr][record.feedingType][record.unit] += parseFloat(record.amount);
                }
            });
            
            // 處理日期
            const dates = getDatesInRange(startDate, endDate);
            
            // 準備圖表數據
            const labels = [];
            
            // 創建每種類型的數據集
            const datasets = [];
            
            // 設定主要單位 (ml 或 min)
            const primaryUnit = feedingRecords.some(r => r.unit === 'ml') ? 'ml' : 'min';
            
            // 顏色映射
            const colorMap = {
                '母乳': {
                    backgroundColor: 'rgba(142, 202, 230, 0.2)',
                    borderColor: 'rgba(142, 202, 230, 1)'
                },
                '配方奶': {
                    backgroundColor: 'rgba(33, 158, 188, 0.2)',
                    borderColor: 'rgba(33, 158, 188, 1)'
                },
                '副食品': {
                    backgroundColor: 'rgba(255, 183, 3, 0.2)',
                    borderColor: 'rgba(255, 183, 3, 1)'
                },
                '水果': {
                    backgroundColor: 'rgba(82, 183, 136, 0.2)',
                    borderColor: 'rgba(82, 183, 136, 1)'
                },
                '水/飲料': {
                    backgroundColor: 'rgba(147, 129, 255, 0.2)',
                    borderColor: 'rgba(147, 129, 255, 1)'
                },
                '其他': {
                    backgroundColor: 'rgba(231, 111, 81, 0.2)',
                    borderColor: 'rgba(231, 111, 81, 1)'
                }
            };
            
            // 為每個日期創建標籤
            dates.forEach(date => {
                const dateStr = date.toISOString().split('T')[0];
                labels.push(formatDate(dateStr));
            });
            
            // 為每種類型創建數據集
            feedingTypes.forEach(type => {
                const data = [];
                
                dates.forEach(date => {
                    const dateStr = date.toISOString().split('T')[0];
                    
                    if (feedingByDate[dateStr] && feedingByDate[dateStr][type]) {
                        data.push(feedingByDate[dateStr][type][primaryUnit]);
                    } else {
                        data.push(0);
                    }
                });
                
                const color = colorMap[type] || {
                    backgroundColor: 'rgba(108, 117, 125, 0.2)',
                    borderColor: 'rgba(108, 117, 125, 1)'
                };
                
                datasets.push({
                    label: `${type} (${primaryUnit})`,
                    data: data,
                    backgroundColor: color.backgroundColor,
                    borderColor: color.borderColor,
                    borderWidth: 1
                });
            });
            
            // 創建堆疊柱狀圖
            if (window.feedingChart) window.feedingChart.destroy();
            window.feedingChart = new Chart(document.getElementById('feedingChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: `餵食量 (${primaryUnit})`
                            }
                        }
                    }
                }
            });
        }

        // 更新尿布圖表
        function updateDiaperChart(records, startDate, endDate) {
            // 過濾尿布記錄
            const diaperRecords = records.filter(record => record.type === 'diaper');
            
            if (diaperRecords.length === 0) {
                if (window.diaperChart) window.diaperChart.destroy();
                window.diaperChart = new Chart(document.getElementById('diaperChart').getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['無尿布數據'],
                        datasets: [{
                            label: '尿布更換次數',
                            data: [0],
                            backgroundColor: 'rgba(255, 183, 3, 0.2)',
                            borderColor: 'rgba(255, 183, 3, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                return;
            }
            
            // 按日期和類型分組
            const diaperByDate = {};
            
            diaperRecords.forEach(record => {
                const dateStr = record.date.split('T')[0];
                
                if (!diaperByDate[dateStr]) {
                    diaperByDate[dateStr] = {
                        urine: 0,
                        stool: 0,
                        both: 0
                    };
                }
                
                // 根據記錄類型計數
                if (record.urine && record.stool) {
                    diaperByDate[dateStr].both++;
                } else if (record.urine) {
                    diaperByDate[dateStr].urine++;
                } else if (record.stool) {
                    diaperByDate[dateStr].stool++;
                }
            });
            
            // 處理日期
            const dates = getDatesInRange(startDate, endDate);
            
            // 準備圖表數據
            const labels = [];
            const urineData = [];
            const stoolData = [];
            const bothData = [];
            
            dates.forEach(date => {
                const dateStr = date.toISOString().split('T')[0];
                labels.push(formatDate(dateStr));
                
                if (diaperByDate[dateStr]) {
                    urineData.push(diaperByDate[dateStr].urine);
                    stoolData.push(diaperByDate[dateStr].stool);
                    bothData.push(diaperByDate[dateStr].both);
                } else {
                    urineData.push(0);
                    stoolData.push(0);
                    bothData.push(0);
                }
            });
            
            // 創建堆疊柱狀圖
            if (window.diaperChart) window.diaperChart.destroy();
            window.diaperChart = new Chart(document.getElementById('diaperChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '小便',
                            data: urineData,
                            backgroundColor: 'rgba(142, 202, 230, 0.2)',
                            borderColor: 'rgba(142, 202, 230, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '大便',
                            data: stoolData,
                            backgroundColor: 'rgba(231, 111, 81, 0.2)',
                            borderColor: 'rgba(231, 111, 81, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '兩者',
                            data: bothData,
                            backgroundColor: 'rgba(255, 183, 3, 0.2)',
                            borderColor: 'rgba(255, 183, 3, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '尿布更換次數'
                            }
                        }
                    }
                }
            });
        }

        // 更新情緒圖表
        function updateEmotionChart(records, startDate, endDate) {
            // 過濾情緒記錄
            const emotionRecords = records.filter(record => record.type === 'emotion');
            
            if (emotionRecords.length === 0) {
                if (window.emotionChart) window.emotionChart.destroy();
                window.emotionChart = new Chart(document.getElementById('emotionChart').getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['無情緒數據'],
                        datasets: [{
                            label: '情緒強度',
                            data: [0],
                            backgroundColor: 'rgba(231, 111, 81, 0.2)',
                            borderColor: 'rgba(231, 111, 81, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                return;
            }
            
            // 按情緒類型分組
            const emotionTypes = [...new Set(emotionRecords.map(record => record.emotionType))];
            
            // 準備圖表數據
            const datasets = [];
            
            // 顏色映射
            const colorMap = {
                '開心': {
                    backgroundColor: 'rgba(82, 183, 136, 0.2)',
                    borderColor: 'rgba(82, 183, 136, 1)'
                },
                '難過': {
                    backgroundColor: 'rgba(147, 129, 255, 0.2)',
                    borderColor: 'rgba(147, 129, 255, 1)'
                },
                '生氣': {
                    backgroundColor: 'rgba(231, 111, 81, 0.2)',
                    borderColor: 'rgba(231, 111, 81, 1)'
                },
                '害怕': {
                    backgroundColor: 'rgba(33, 158, 188, 0.2)',
                    borderColor: 'rgba(33, 158, 188, 1)'
                },
                '驚訝': {
                    backgroundColor: 'rgba(255, 183, 3, 0.2)',
                    borderColor: 'rgba(255, 183, 3, 1)'
                },
                '平靜': {
                    backgroundColor: 'rgba(142, 202, 230, 0.2)',
                    borderColor: 'rgba(142, 202, 230, 1)'
                },
                '其他': {
                    backgroundColor: 'rgba(108, 117, 125, 0.2)',
                    borderColor: 'rgba(108, 117, 125, 1)'
                }
            };
            
            // 為每種情緒類型創建數據集
            emotionTypes.forEach(type => {
                const typeRecords = emotionRecords.filter(record => record.emotionType === type);
                
                // 排序記錄 (按時間)
                typeRecords.sort((a, b) => new Date(a.time) - new Date(b.time));
                
                const labels = [];
                const intensityData = [];
                
                // 生成數據點
                typeRecords.forEach(record => {
                    const dateTime = formatDateTime(record.time);
                    labels.push(dateTime);
                    intensityData.push(record.intensity);
                });
                
                const color = colorMap[type] || {
                    backgroundColor: 'rgba(108, 117, 125, 0.2)',
                    borderColor: 'rgba(108, 117, 125, 1)'
                };
                
                datasets.push({
                    label: type,
                    data: intensityData,
                    backgroundColor: color.backgroundColor,
                    borderColor: color.borderColor,
                    borderWidth: 2,
                    fill: false,
                    pointRadius: 4,
                    pointBackgroundColor: color.borderColor,
                    tension: 0.1
                });
            });
            
            // 創建折線圖
            if (window.emotionChart) window.emotionChart.destroy();
            window.emotionChart = new Chart(document.getElementById('emotionChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: datasets.length > 0 ? datasets[0].data.map((_, i) => datasets[0].label + ' ' + (i + 1)) : ['無數據'],
                    datasets: datasets
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 5,
                            title: {
                                display: true,
                                text: '情緒強度 (1-5分)'
                            }
                        }
                    }
                }
            });
        }

        // 新增：更新藥物依從性圖表
        function updateMedicineAdherenceChart(records, startDate, endDate) {
            // 檢查是否有藥物數據
            if (!appData.selectedChild || !appData.medicines[appData.selectedChild] || 
                appData.medicines[appData.selectedChild].length === 0) {
                if (window.medicineAdherenceChart) window.medicineAdherenceChart.destroy();
                window.medicineAdherenceChart = new Chart(document.getElementById('medicineAdherenceChart').getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['無藥物數據'],
                        datasets: [{
                            label: '藥物依從性',
                            data: [0],
                            backgroundColor: 'rgba(147, 129, 255, 0.2)',
                            borderColor: 'rgba(147, 129, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                return;
            }
            
            // 獲取所有藥物
            const medicines = appData.medicines[appData.selectedChild].filter(medicine => {
                // 檢查藥物的時間範圍是否與圖表範圍重疊
                const medicineStartDate = new Date(medicine.startDate);
                const medicineEndDate = medicine.endDate ? new Date(medicine.endDate) : new Date();
                
                return medicineStartDate <= endDate && medicineEndDate >= startDate;
            });
            
            if (medicines.length === 0) {
                if (window.medicineAdherenceChart) window.medicineAdherenceChart.destroy();
                window.medicineAdherenceChart = new Chart(document.getElementById('medicineAdherenceChart').getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['無藥物數據'],
                        datasets: [{
                            label: '藥物依從性',
                            data: [0],
                            backgroundColor: 'rgba(147, 129, 255, 0.2)',
                            borderColor: 'rgba(147, 129, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                return;
            }
            
            // 計算每個藥物的依從性
            const labels = [];
            const adherenceData = [];
            const missedData = [];
            
            medicines.forEach(medicine => {
                labels.push(medicine.name);
                
                // 計算依從性
                const adherenceRate = calculateMedicineAdherence(medicine);
                adherenceData.push(adherenceRate);
                missedData.push(100 - adherenceRate);
            });
            
            // 創建堆疊柱狀圖
            if (window.medicineAdherenceChart) window.medicineAdherenceChart.destroy();
            window.medicineAdherenceChart = new Chart(document.getElementById('medicineAdherenceChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '已服用',
                            data: adherenceData,
                            backgroundColor: 'rgba(82, 183, 136, 0.2)',
                            borderColor: 'rgba(82, 183, 136, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '漏服或未服用',
                            data: missedData,
                            backgroundColor: 'rgba(231, 111, 81, 0.2)',
                            borderColor: 'rgba(231, 111, 81, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: '百分比 (%)'
                            }
                        }
                    }
                }
            });
        }

        // 獲取日期範圍內的所有日期
        function getDatesInRange(startDate, endDate) {
            const dates = [];
            let currentDate = new Date(startDate);
            
            // 設定為當天的開始時間
            currentDate.setHours(0, 0, 0, 0);
            
            const lastDate = new Date(endDate);
            lastDate.setHours(0, 0, 0, 0);
            
            while (currentDate <= lastDate) {
                dates.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return dates;
        }

        // 更新照顧提示內容
        function updateCareTipsContent() {
            const caretipsContent = document.getElementById('caretipsContent');
            caretipsContent.innerHTML = '';
            
            if (!appData.selectedChild) {
                caretipsContent.innerHTML = '<p>請先選擇一位兒童</p>';
                return;
            }
            
            // 獲取過濾選項
            const filter = document.getElementById('caretipsCategory').value;
            
            // 獲取兒童年齡
            const child = appData.children.find(c => c.id === appData.selectedChild);
            if (!child) return;
            
            const birthDate = new Date(child.birthday);
            const now = new Date();
            const ageInMonths = Math.floor((now - birthDate) / (1000 * 60 * 60 * 24 * 30.44));
            
            // 這裡需要根據照顧提示數據完善此功能
            // 簡單示例
            const ageCategoryMap = {
                '0-3': '新生兒期 (0-3個月)',
                '4-6': '嬰兒早期 (4-6個月)',
                '7-9': '嬰兒中期 (7-9個月)',
                '10-12': '嬰兒晚期 (10-12個月)',
                '13-18': '學步兒早期 (13-18個月)',
                '19-24': '學步兒中期 (19-24個月)',
                '25-36': '學步兒晚期 (25-36個月)',
                '37+': '幼兒期 (3歲以上)'
            };
            
            let currentAgeCategory = '';
            if (ageInMonths <= 3) currentAgeCategory = '0-3';
            else if (ageInMonths <= 6) currentAgeCategory = '4-6';
            else if (ageInMonths <= 9) currentAgeCategory = '7-9';
            else if (ageInMonths <= 12) currentAgeCategory = '10-12';
            else if (ageInMonths <= 18) currentAgeCategory = '13-18';
            else if (ageInMonths <= 24) currentAgeCategory = '19-24';
            else if (ageInMonths <= 36) currentAgeCategory = '25-36';
            else currentAgeCategory = '37+';
            
            // 創建年齡段容器
            const ageGroupContainer = document.createElement('div');
            ageGroupContainer.className = 'caretips-age-group';
            
            // 創建年齡段標題
            const ageGroupHeader = document.createElement('div');
            ageGroupHeader.className = 'caretips-age-header';
            ageGroupHeader.textContent = `${ageCategoryMap[currentAgeCategory]} - ${ageInMonths}個月`;
            ageGroupContainer.appendChild(ageGroupHeader);
            
            // 示例類別
            const categories = {
                'feeding': {
                    name: '餵食',
                    icon: 'fas fa-utensils',
                    className: 'category-icon-feeding'
                },
                'sleep': {
                    name: '睡眠',
                    icon: 'fas fa-bed',
                    className: 'category-icon-sleep'
                },
                'activity': {
                    name: '活動與遊戲',
                    icon: 'fas fa-walking',
                    className: 'category-icon-activity'
                },
                'safety': {
                    name: '安全',
                    icon: 'fas fa-shield-alt',
                    className: 'category-icon-safety'
                },
                'health': {
                    name: '健康與衛生',
                    icon: 'fas fa-heart',
                    className: 'category-icon-health'
                },
                'development': {
                    name: '發展與學習',
                    icon: 'fas fa-brain',
                    className: 'category-icon-development'
                }
            };
            
            // 示例提示
            const tips = [
                {
                    category: 'feeding',
                    title: '開始添加副食品',
                    description: '從單一食材的泥開始，如米糊、南瓜泥或蘋果泥，每次引入新食材要間隔3-5天，留意過敏反應。',
                    tags: ['副食品', '過敏', '營養'],
                    important: false
                },
                {
                    category: 'sleep',
                    title: '建立睡眠常規',
                    description: '固定的睡前例行活動有助於寶寶理解該睡覺了，例如洗澡、換睡衣、聽故事、輕哼等放鬆活動。',
                    tags: ['常規', '習慣', '安撫'],
                    important: false
                },
                {
                    category: 'safety',
                    title: '避免窒息危險',
                    description: '小於3.5公分的物品都可能造成窒息風險，隨著寶寶的活動範圍增加，請確保地面和低處櫃子中沒有小物品。',
                    tags: ['窒息', '預防'],
                    important: true
                },
                {
                    category: 'health',
                    title: '預防脹氣',
                    description: '餵食後適度拍嗝、使用防脹氣奶瓶、避免寶寶吞入過多空氣，都能有效預防脹氣和不適。',
                    tags: ['脹氣', '消化'],
                    important: false
                },
                {
                    category: 'activity',
                    title: '促進感官發展的遊戲',
                    description: '使用對比明顯的玩具、不同材質的觸摸書或布料、各種聲音的玩具，都能刺激寶寶的感官發展。',
                    tags: ['感官', '遊戲', '發展'],
                    important: false
                },
                {
                    category: 'development',
                    title: '語言發展：多說話',
                    description: '即使寶寶還不會說話，也要多與他交談，描述你的行為、命名物品、讀故事書，這些都有助於語言發展。',
                    tags: ['語言', '互動', '認知'],
                    important: false
                }
            ];
            
            // 如果選擇了特定類別
            if (filter !== 'all') {
                // 過濾提示
                const filteredTips = tips.filter(tip => tip.category === filter);
                
                if (filteredTips.length === 0) {
                    const noTipsMsg = document.createElement('p');
                    noTipsMsg.textContent = `沒有${categories[filter].name}類別的提示`;
                    ageGroupContainer.appendChild(noTipsMsg);
                } else {
                    // 創建類別容器
                    const categoryContainer = document.createElement('div');
                    categoryContainer.className = 'caretips-category';
                    
                    // 創建類別標題
                    const categoryHeader = document.createElement('div');
                    categoryHeader.className = 'caretips-category-header';
                    categoryHeader.innerHTML = `
                        <i class="${categories[filter].icon} ${categories[filter].className}"></i>
                        <span>${categories[filter].name}</span>
                    `;
                    categoryContainer.appendChild(categoryHeader);
                    
                    // 創建提示項目容器
                    const tipsContainer = document.createElement('div');
                    tipsContainer.className = 'caretips-category-items';
                    
                    // 添加提示
                    filteredTips.forEach(tip => {
                        const tipItem = document.createElement('div');
                        tipItem.className = `caretip-item${tip.important ? ' important' : ''}`;
                        
                        let tagsHTML = '';
                        if (tip.tags && tip.tags.length > 0) {
                            tagsHTML = tip.tags.map(tag => `<span class="caretip-tag caretip-tag-${tip.category}">${tag}</span>`).join('');
                        }
                        
                        tipItem.innerHTML = `
                            <div class="caretip-title">${tip.important ? '<i class="fas fa-exclamation-circle"></i> ' : ''}${tip.title}</div>
                            <div class="caretip-description">${tip.description}</div>
                            <div class="caretip-tags">${tagsHTML}</div>
                        `;
                        
                        tipsContainer.appendChild(tipItem);
                    });
                    
                    categoryContainer.appendChild(tipsContainer);
                    ageGroupContainer.appendChild(categoryContainer);
                }
            } else {
                // 按類別分組提示
                const tipsByCategory = {};
                tips.forEach(tip => {
                    if (!tipsByCategory[tip.category]) {
                        tipsByCategory[tip.category] = [];
                    }
                    tipsByCategory[tip.category].push(tip);
                });
                
                // 創建每個類別的容器
                for (const category in categories) {
                    if (tipsByCategory[category] && tipsByCategory[category].length > 0) {
                        // 創建類別容器
                        const categoryContainer = document.createElement('div');
                        categoryContainer.className = 'caretips-category';
                        
                        // 創建類別標題
                        const categoryHeader = document.createElement('div');
                        categoryHeader.className = 'caretips-category-header';
                        categoryHeader.innerHTML = `
                            <i class="${categories[category].icon} ${categories[category].className}"></i>
                            <span>${categories[category].name}</span>
                        `;
                        categoryContainer.appendChild(categoryHeader);
                        
                        // 創建提示項目容器
                        const tipsContainer = document.createElement('div');
                        tipsContainer.className = 'caretips-category-items';
                        
                        // 添加提示
                        tipsByCategory[category].forEach(tip => {
                            const tipItem = document.createElement('div');
                            tipItem.className = `caretip-item${tip.important ? ' important' : ''}`;
                            
                            let tagsHTML = '';
                            if (tip.tags && tip.tags.length > 0) {
                                tagsHTML = tip.tags.map(tag => `<span class="caretip-tag caretip-tag-${tip.category}">${tag}</span>`).join('');
                            }
                            
                            tipItem.innerHTML = `
                                <div class="caretip-title">${tip.important ? '<i class="fas fa-exclamation-circle"></i> ' : ''}${tip.title}</div>
                                <div class="caretip-description">${tip.description}</div>
                                <div class="caretip-tags">${tagsHTML}</div>
                            `;
                            
                            tipsContainer.appendChild(tipItem);
                        });
                        
                        categoryContainer.appendChild(tipsContainer);
                        ageGroupContainer.appendChild(categoryContainer);
                    }
                }
            }
            
            caretipsContent.appendChild(ageGroupContainer);
        }

        // 匯出為CSV
        function exportToCSV() {
            if (!appData.selectedChild || !appData.records[appData.selectedChild] || 
                appData.records[appData.selectedChild].length === 0) {
                showToast('沒有可匯出的記錄');
                return;
            }
            
            // 獲取匯出選項
            const exportAllTypes = document.getElementById('exportAllTypes').checked;
            const exportAllDates = document.getElementById('exportAllDates').checked;
            
            // 過濾記錄
            let records = [...appData.records[appData.selectedChild]];
            
            // 如果不是匯出所有類型
            if (!exportAllTypes) {
                const selectedTypes = [];
                document.querySelectorAll('input[name="exportType"]:checked').forEach(cb => {
                    selectedTypes.push(cb.value);
                });
                
                if (selectedTypes.length === 0) {
                    showToast('請至少選擇一種記錄類型');
                    return;
                }
                
                records = records.filter(r => selectedTypes.includes(r.type));
            }
            
            // 如果不是匯出所有日期
            if (!exportAllDates) {
                const startDate = document.getElementById('exportStartDate').value;
                const endDate = document.getElementById('exportEndDate').value;
                
                if (!startDate || !endDate) {
                    showToast('請選擇開始日期和結束日期');
                    return;
                }
                
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59);
                
                records = records.filter(r => {
                    const recordDate = new Date(r.date);
                    return recordDate >= start && recordDate <= end;
                });
            }
            
            if (records.length === 0) {
                showToast('沒有符合條件的記錄可匯出');
                return;
            }
            
            // 按日期排序 (從舊到新)
            records.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // 生成CSV內容
            const csvHeaders = ['Date', 'Time', 'Type', 'Content', 'Notes'];
            let csvContent = csvHeaders.join(',') + '\n';
            
            // 添加記錄
            records.forEach(record => {
                const date = record.date ? formatDate(record.date.split('T')[0]) : '';
                const time = record.time ? new Date(record.time).toTimeString().slice(0, 5) : '';
                
                let type = '';
                let content = '';
                let notes = '';
                
                switch (record.type) {
                    case 'feeding':
                        type = '餵食';
                        content = `${record.feedingType} ${record.amount} ${record.unit}`;
                        notes = record.note || '';
                        break;
                    case 'sleep':
                        type = '睡眠';
                        const duration = record.duration ? `${record.duration.hours}小時${record.duration.minutes}分鐘` : '';
                        content = `${formatTime(record.start)} - ${formatTime(record.end)} (${duration})`;
                        notes = `品質: ${record.quality}/5 ${record.note || ''}`;
                        break;
                    case 'diaper':
                        type = '尿布';
                        const typeStr = (record.urine ? '小便' : '') + (record.urine && record.stool ? ' + ' : '') + (record.stool ? '大便' : '');
                        content = `${typeStr} - ${record.condition}`;
                        notes = record.note || '';
                        break;
                    case 'emotion':
                        type = '情緒';
                        content = `${record.emotionType} (強度: ${record.intensity})`;
                        notes = record.note || '';
                        break;
                    case 'activity':
                        type = '活動';
                        content = `${record.activityType} (${record.duration}分鐘)`;
                        notes = record.note || '';
                        break;
                    case 'growth':
                        type = '成長測量';
                        content = record.content || '';
                        notes = '';
                        break;
                    case 'medical':
                        type = record.subType || '就醫';
                        content = record.content || '';
                        notes = '';
                        break;
                    case 'medicine':
                        type = '用藥記錄';
                        content = record.content || '';
                        notes = '';
                        break;
                    case 'other':
                        type = record.title || '其他';
                        content = record.content || '';
                        notes = '';
                        break;
                }
                
                // 處理CSV格式中的特殊字符
                const escapeCsv = (str) => {
                    if (!str) return '';
                    return `"${str.replace(/"/g, '""')}"`;
                };
                
                const row = [
                    date,
                    time,
                    escapeCsv(type),
                    escapeCsv(content),
                    escapeCsv(notes)
                ];
                
                csvContent += row.join(',') + '\n';
            });
            
            // 建立下載
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const child = appData.children.find(c => c.id === appData.selectedChild);
            const childName = child ? child.name : 'child';
            const now = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `${childName}_records_${now}.csv`);
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('記錄已成功匯出為CSV檔案');
        }

        // 匯出所有數據
        function exportAllData() {
            // 創建一個完整的數據副本
            const exportData = {
                version: 1,
                exportDate: new Date().toISOString(),
                children: appData.children,
                records: appData.records,
                milestones: appData.milestones,
                reminders: appData.reminders,
                medicines: appData.medicines,
                growthData: appData.growthData
            };
            
            // 建立下載
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const now = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `baby_care_data_backup_${now}.json`);
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('所有數據已成功匯出');
        }

        // 預覽匯入數據
        function previewImport() {
            const fileInput = document.getElementById('importFileInput');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showToast('請選擇要匯入的檔案');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // 檢查檔案格式
                    if (!data.version || !data.children) {
                        showToast('不支援的檔案格式');
                        return;
                    }
                    
                    // 預存匯入數據
                    importedData = data;
                    
                    // 生成摘要
                    const summary = document.getElementById('importSummary');
                    summary.innerHTML = `
                        <p><strong>匯出日期:</strong> ${formatDateTime(data.exportDate)}</p>
                        <p><strong>兒童數量:</strong> ${data.children.length} 位</p>
                        <p><strong>記錄數量:</strong> ${Object.values(data.records || {}).reduce((total, records) => total + records.length, 0)} 筆</p>
                        <p><strong>提醒數量:</strong> ${Object.values(data.reminders || {}).reduce((total, reminders) => total + reminders.length, 0)} 筆</p>
                        <p><strong>藥物數量:</strong> ${Object.values(data.medicines || {}).reduce((total, medicines) => total + medicines.length, 0)} 筆</p>
                        <p><strong>成長記錄數量:</strong> ${Object.values(data.growthData || {}).reduce((total, records) => total + records.length, 0)} 筆</p>
                    `;
                    
                    // 設置警告訊息
                    const warning = document.getElementById('importWarning');
                    const importOption = document.querySelector('input[name="importOption"]:checked').value;
                    
                    if (importOption === 'merge') {
                        // 檢查重複的兒童名稱
                        const importChildNames = data.children.map(c => c.name);
                        const existingChildNames = appData.children.map(c => c.name);
                        const duplicates = importChildNames.filter(name => existingChildNames.includes(name));
                        
                        if (duplicates.length > 0) {
                            warning.textContent = `警告: 有${duplicates.length}位兒童名稱重複，可能會合併或產生重複記錄: ${duplicates.join(', ')}`;
                        } else {
                            warning.textContent = '資料將與現有資料合併。所有記錄將保留。';
                        }
                    } else {
                        warning.textContent = '警告: 這將刪除所有現有的資料! 此操作無法復原!';
                    }
                    
                    // 顯示確認模態框
                    document.getElementById('importConfirmModal').classList.add('active');
                    document.getElementById('overlay').classList.add('active');
                    
                } catch (error) {
                    console.error('匯入錯誤:', error);
                    showToast('無法解析檔案，請確認是否為有效的備份檔案');
                }
            };
            
            reader.readAsText(file);
        }

        // 匯入數據
        function importData() {
            if (!importedData) {
                showToast('沒有可匯入的數據');
                closeModals();
                return;
            }
            
            const importOption = document.querySelector('input[name="importOption"]:checked').value;
            
            if (importOption === 'replace') {
                // 完全替換所有數據
                appData.children = importedData.children;
                appData.records = importedData.records || {};
                appData.milestones = importedData.milestones || {};
                appData.reminders = importedData.reminders || {};
                appData.medicines = importedData.medicines || {};
                appData.growthData = importedData.growthData || {};
                
                // 清除選擇的兒童
                appData.selectedChild = null;
                localStorage.removeItem('selectedChild');
                
                // 如果有兒童，選擇第一個
                if (appData.children.length > 0) {
                    appData.selectedChild = appData.children[0].id;
                    localStorage.setItem('selectedChild', appData.children[0].id);
                    loadChildData(appData.children[0].id);
                }
            } else {
                // 合併數據
                
                // 合併兒童，檢查重複名稱
                const existingChildMap = {};
                appData.children.forEach(child => {
                    existingChildMap[child.name] = child;
                });
                
                importedData.children.forEach(importChild => {
                    if (existingChildMap[importChild.name]) {
                        // 重複的名稱，略過
                        console.log(`兒童名稱重複: ${importChild.name}，略過匯入此兒童`);
                    } else {
                        // 添加新兒童
                        appData.children.push(importChild);
                        
                        // 導入相關數據
                        if (importedData.records && importedData.records[importChild.id]) {
                            appData.records[importChild.id] = importedData.records[importChild.id];
                        }
                        
                        if (importedData.milestones && importedData.milestones[importChild.id]) {
                            appData.milestones[importChild.id] = importedData.milestones[importChild.id];
                        }
                        
                        if (importedData.reminders && importedData.reminders[importChild.id]) {
                            appData.reminders[importChild.id] = importedData.reminders[importChild.id];
                        }
                        
                        if (importedData.medicines && importedData.medicines[importChild.id]) {
                            appData.medicines[importChild.id] = importedData.medicines[importChild.id];
                        }
                        
                        if (importedData.growthData && importedData.growthData[importChild.id]) {
                            appData.growthData[importChild.id] = importedData.growthData[importChild.id];
                        }
                    }
                });
            }
            
            // 儲存所有數據
            saveChildren();
            
            for (const childId in appData.records) {
                saveRecords(childId);
            }
            
            for (const childId in appData.milestones) {
                saveMilestones(childId);
            }
            
            saveReminders();
            saveMedicines();
            saveGrowthData();
            
            // 更新顯示
            updateChildSelector();
            updateChildInfo();
            updateAllTabs();
            
            // 重置匯入狀態
            importedData = null;
            document.getElementById('importFileInput').value = '';
            document.getElementById('importFileName').textContent = '未選擇檔案';
            document.getElementById('importDataBtn').disabled = true;
            
            closeModals();
            showToast('數據匯入成功');
        }

        // 睡眠計時器
        function toggleSleepTimer() {
            if (!appData.selectedChild) {
                showToast('請先選擇一位兒童');
                return;
            }
            
            const sleepTimerBadge = document.getElementById('sleepTimerBadge');
            
            // 如果已經有進行中的睡眠記錄
            if (appData.quickOptions.sleepStartTime) {
                if (confirm('結束睡眠計時並儲存記錄？')) {
                    endSleepTimer();
                }
            } else {
                // 開始新的睡眠計時
                appData.quickOptions.sleepStartTime = new Date().toISOString();
                saveQuickOptions();
                
                // 顯示計時器
                updateSleepTimerDisplay(new Date(appData.quickOptions.sleepStartTime));
                sleepTimerBadge.classList.add('active');
                
                showToast('睡眠計時開始');
            }
        }

        // 結束睡眠計時
        function endSleepTimer() {
            if (!appData.quickOptions.sleepStartTime) {
                return;
            }
            
            const startTime = new Date(appData.quickOptions.sleepStartTime);
            const endTime = new Date();
            
            // 計算睡眠時間
            const duration = calculateTimeDifference(startTime, endTime);
            
            // 創建睡眠記錄
            const record = {
                id: 'record_' + Date.now(),
                type: 'sleep',
                start: appData.quickOptions.sleepStartTime,
                end: endTime.toISOString(),
                duration: {
                    hours: duration.hours,
                    minutes: duration.minutes,
                    totalMinutes: duration.totalMinutes
                },
                quality: 3, // 預設品質
                date: appData.quickOptions.sleepStartTime,
                time: appData.quickOptions.sleepStartTime,
                note: '使用睡眠計時器記錄'
            };
            
            // 添加記錄
            if (!appData.records[appData.selectedChild]) {
                appData.records[appData.selectedChild] = [];
            }
            
            appData.records[appData.selectedChild].push(record);
            saveRecords(appData.selectedChild);
            
            // 重置計時器
            appData.quickOptions.sleepStartTime = null;
            saveQuickOptions();
            
            // 隱藏計時器徽章
            document.getElementById('sleepTimerBadge').classList.remove('active');
            
            // 更新歷史記錄
            updateHistoryContent();
            
            showToast('睡眠記錄已儲存');
        }

        // 更新睡眠計時器顯示
        function updateSleepTimerDisplay(startTime) {
            const updateTimer = () => {
                if (!appData.quickOptions.sleepStartTime) {
                    return;
                }
                
                const now = new Date();
                const duration = calculateTimeDifference(startTime, now);
                
                const hours = String(duration.hours).padStart(2, '0');
                const minutes = String(duration.minutes).padStart(2, '0');
                const seconds = String(Math.floor((now - startTime) / 1000) % 60).padStart(2, '0');
                
                document.querySelector('.sleep-timer-text').textContent = `正在睡眠中: ${hours}:${minutes}:${seconds}`;
                
                // 每秒更新
                setTimeout(updateTimer, 1000);
            };
            
            updateTimer();
        }

        // 顯示通知
        function showToast(message) {
            const toast = document.getElementById('toastNotification');
            document.getElementById('toastMessage').textContent = message;
            
            toast.classList.add('active');
            
            // 自動隱藏
            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }

        // 關閉模態框
        function closeModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
            
            document.getElementById('quickActionMenu').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }

        // 檢查通知權限
        function checkPermission() {
            if ("Notification" in window) {
                if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                    // 可以請求權限
                    document.getElementById('requestPermissionBtn').style.display = 'block';
                }
            }
        }

        // 初始化應用程序
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            
            // 設置定時檢查提醒
            setInterval(checkAndUpdateReminders, 60000); // 每分鐘檢查一次
        });
    </script>
</body>
</html>
