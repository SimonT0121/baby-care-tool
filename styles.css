// å…¨å±€è®Šæ•¸
let db;
let currentChild = null;
let currentPage = 'dashboard';
let editingRecordId = null;

// é è¨­é‡Œç¨‹ç¢‘æ•¸æ“š
const defaultMilestones = {
    motor: [
        { title: 'æŠ¬é ­', description: 'ä¿¯è‡¥æ™‚èƒ½æŠ¬èµ·é ­éƒ¨', ageMonths: 1 },
        { title: 'ç¿»èº«', description: 'èƒ½å¾ä»°è‡¥ç¿»åˆ°ä¿¯è‡¥', ageMonths: 4 },
        { title: 'åç«‹', description: 'èƒ½ç¨ç«‹åè‘—ä¸å€’', ageMonths: 6 },
        { title: 'çˆ¬è¡Œ', description: 'èƒ½ç”¨æ‰‹è†çˆ¬è¡Œ', ageMonths: 8 },
        { title: 'æ‰¶ç«™', description: 'æ‰¶è‘—æ±è¥¿ç«™ç«‹', ageMonths: 9 },
        { title: 'ç¨ç«‹è¡Œèµ°', description: 'èƒ½ç¨ç«‹èµ°å¹¾æ­¥', ageMonths: 12 }
    ],
    language: [
        { title: 'ç™¼å‡ºè²éŸ³', description: 'é–‹å§‹ç™¼å‡ºå’¯å’¯è²', ageMonths: 2 },
        { title: 'èªè­˜è²éŸ³', description: 'è½åˆ°è²éŸ³æœƒè½‰é ­', ageMonths: 4 },
        { title: 'å’¿å‘€å­¸èª', description: 'ç™¼å‡ºBaã€Daç­‰éŸ³', ageMonths: 6 },
        { title: 'èªªç¬¬ä¸€å€‹å­—', description: 'æœƒèªªåª½åª½æˆ–çˆ¸çˆ¸', ageMonths: 10 },
        { title: 'ç°¡å–®è©å½™', description: 'æœƒèªª2-3å€‹å–®è©', ageMonths: 12 }
    ],
    social: [
        { title: 'ç¤¾äº¤å¾®ç¬‘', description: 'çœ‹åˆ°äººæœƒç¬‘', ageMonths: 2 },
        { title: 'èªè­˜ç…§é¡§è€…', description: 'èªå¾—ä¸»è¦ç…§é¡§è€…', ageMonths: 4 },
        { title: 'èªç”Ÿ', description: 'é–‹å§‹æ€•ç”Ÿ', ageMonths: 6 },
        { title: 'æ¨¡ä»¿å‹•ä½œ', description: 'æœƒæ¨¡ä»¿æ‹æ‰‹ç­‰å‹•ä½œ', ageMonths: 9 },
        { title: 'åˆ†é›¢ç„¦æ…®', description: 'é›¢é–‹çˆ¶æ¯æœƒå“­é¬§', ageMonths: 10 }
    ],
    cognitive: [
        { title: 'è¿½è¦–ç‰©å“', description: 'çœ¼ç›æœƒè·Ÿéš¨ç‰©å“ç§»å‹•', ageMonths: 2 },
        { title: 'èªè­˜ç‰©å“', description: 'èªè­˜ç†Ÿæ‚‰çš„ç‰©å“', ageMonths: 6 },
        { title: 'ç‰©å“æ†å­˜', description: 'çŸ¥é“è¢«é®ä½çš„ç‰©å“é‚„å­˜åœ¨', ageMonths: 8 },
        { title: 'å› æœé—œä¿‚', description: 'ç†è§£å‹•ä½œå’Œçµæœçš„é—œä¿‚', ageMonths: 10 },
        { title: 'è§£æ±ºå•é¡Œ', description: 'èƒ½è§£æ±ºç°¡å–®å•é¡Œ', ageMonths: 12 }
    ],
    selfcare: [
        { title: 'å¸å®åå°„', description: 'èƒ½æ­£å¸¸å¸å®', ageMonths: 0 },
        { title: 'ç”¨æ‰‹æŠ“å–', description: 'èƒ½ç”¨æ‰‹æŠ“ä½ç‰©å“', ageMonths: 4 },
        { title: 'ç”¨æ¯å­å–æ°´', description: 'èƒ½ç”¨æ¯å­å–æ°´', ageMonths: 8 },
        { title: 'è‡ªå·±ç”¨é¤å…·', description: 'é–‹å§‹ç”¨æ¹¯åŒ™åƒé£¯', ageMonths: 12 },
        { title: 'ä¾¿ç›†è¨“ç·´', description: 'é–‹å§‹ä¾¿ç›†è¨“ç·´', ageMonths: 18 }
    ]
};

// æ´»å‹•é¡å‹å°æ‡‰åœ–æ¨™å’Œåç¨±
const activityTypes = {
    bath: { name: 'æ´—æ¾¡', icon: 'fas fa-shower' },
    massage: { name: 'æŒ‰æ‘©', icon: 'fas fa-hands' },
    change: { name: 'æ›è¡£æœ/è­·ç†', icon: 'fas fa-tshirt' },
    tummy: { name: 'ä¿¯è‡¥æ™‚é–“', icon: 'fas fa-baby' },
    sensory: { name: 'æ„Ÿå®˜éŠæˆ²', icon: 'fas fa-hand-paper' },
    reading: { name: 'è¦ªå­å…±è®€', icon: 'fas fa-book' },
    music: { name: 'éŸ³æ¨‚äº’å‹•', icon: 'fas fa-music' },
    walk: { name: 'æ•£æ­¥/æ¨è»Š', icon: 'fas fa-walking' },
    sunlight: { name: 'æ›¬å¤ªé™½', icon: 'fas fa-sun' },
    social: { name: 'ç¤¾äº¤äº’å‹•', icon: 'fas fa-users' },
    custom: { name: 'è‡ªå®šç¾©æ´»å‹•', icon: 'fas fa-star' }
};

// IndexedDB åˆå§‹åŒ–
async function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('BabyTrackerDB', 1);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
        
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            
            // å­©å­æª”æ¡ˆ
            if (!db.objectStoreNames.contains('children')) {
                const childStore = db.createObjectStore('children', { keyPath: 'id' });
                childStore.createIndex('name', 'name', { unique: false });
            }
            
            // é¤µé£Ÿè¨˜éŒ„
            if (!db.objectStoreNames.contains('feeding')) {
                const feedingStore = db.createObjectStore('feeding', { keyPath: 'id' });
                feedingStore.createIndex('childId', 'childId', { unique: false });
                feedingStore.createIndex('timestamp', 'timestamp', { unique: false });
            }
            
            // ç¡çœ è¨˜éŒ„
            if (!db.objectStoreNames.contains('sleep')) {
                const sleepStore = db.createObjectStore('sleep', { keyPath: 'id' });
                sleepStore.createIndex('childId', 'childId', { unique: false });
                sleepStore.createIndex('startTime', 'startTime', { unique: false });
            }
            
            // å°¿å¸ƒè¨˜éŒ„
            if (!db.objectStoreNames.contains('diaper')) {
                const diaperStore = db.createObjectStore('diaper', { keyPath: 'id' });
                diaperStore.createIndex('childId', 'childId', { unique: false });
                diaperStore.createIndex('timestamp', 'timestamp', { unique: false });
            }
            
            // å¥åº·è¨˜éŒ„
            if (!db.objectStoreNames.contains('health')) {
                const healthStore = db.createObjectStore('health', { keyPath: 'id' });
                healthStore.createIndex('childId', 'childId', { unique: false });
                healthStore.createIndex('category', 'category', { unique: false });
                healthStore.createIndex('date', 'date', { unique: false });
            }
            
            // é‡Œç¨‹ç¢‘
            if (!db.objectStoreNames.contains('milestones')) {
                const milestoneStore = db.createObjectStore('milestones', { keyPath: 'id' });
                milestoneStore.createIndex('childId', 'childId', { unique: false });
                milestoneStore.createIndex('category', 'category', { unique: false });
            }
            
            // æ´»å‹•è¨˜éŒ„
            if (!db.objectStoreNames.contains('activities')) {
                const activityStore = db.createObjectStore('activities', { keyPath: 'id' });
                activityStore.createIndex('childId', 'childId', { unique: false });
                activityStore.createIndex('type', 'type', { unique: false });
                activityStore.createIndex('timestamp', 'timestamp', { unique: false });
            }
            
            // äº’å‹•è¨˜éŒ„
            if (!db.objectStoreNames.contains('interactions')) {
                const interactionStore = db.createObjectStore('interactions', { keyPath: 'id' });
                interactionStore.createIndex('childId', 'childId', { unique: false });
                interactionStore.createIndex('timestamp', 'timestamp', { unique: false });
            }
        };
    });
}

// é€šç”¨æ•¸æ“šåº«æ“ä½œ
async function dbOperation(storeName, operation, data = null) {
    const transaction = db.transaction([storeName], operation === 'get' || operation === 'getAll' ? 'readonly' : 'readwrite');
    const store = transaction.objectStore(storeName);
    
    let request;
    switch (operation) {
        case 'add':
            request = store.add(data);
            break;
        case 'put':
            request = store.put(data);
            break;
        case 'delete':
            request = store.delete(data);
            break;
        case 'get':
            request = store.get(data);
            break;
        case 'getAll':
            request = store.getAll();
            break;
        case 'getByIndex':
            const index = store.index(data.indexName);
            request = index.getAll(data.value);
            break;
    }
    
    return new Promise((resolve, reject) => {
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

// ç”Ÿæˆå”¯ä¸€ID
function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

// æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
function formatDateTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(date) {
    return new Date(date).toLocaleDateString('zh-TW');
}

// è¨ˆç®—å¹´é½¡
function calculateAge(birthDate) {
    const now = new Date();
    const birth = new Date(birthDate);
    const diffTime = Math.abs(now - birth);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays < 30) {
        return `${diffDays} å¤©`;
    } else if (diffDays < 365) {
        const months = Math.floor(diffDays / 30);
        return `${months} å€‹æœˆ`;
    } else {
        const years = Math.floor(diffDays / 365);
        const months = Math.floor((diffDays % 365) / 30);
        return months > 0 ? `${years} æ­² ${months} å€‹æœˆ` : `${years} æ­²`;
    }
}

// è¨ˆç®—æŒçºŒæ™‚é–“
function calculateDuration(startTime, endTime) {
    if (!endTime) return '';
    const duration = Math.abs(new Date(endTime) - new Date(startTime));
    const hours = Math.floor(duration / (1000 * 60 * 60));
    const minutes = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));
    return hours > 0 ? `${hours}å°æ™‚${minutes}åˆ†é˜` : `${minutes}åˆ†é˜`;
}

// åœ–ç‰‡è½‰æ›ç‚ºBase64
function convertToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// åˆå§‹åŒ–æ‡‰ç”¨
async function initApp() {
    try {
        // é¡¯ç¤ºè¼‰å…¥ç•«é¢
        document.getElementById('loading').style.display = 'flex';
        
        // åˆå§‹åŒ–æ•¸æ“šåº«
        db = await initDB();
        
        // è¼‰å…¥å­©å­åˆ—è¡¨
        await loadChildren();
        
        // åˆå§‹åŒ–é è¨­é‡Œç¨‹ç¢‘
        await initDefaultMilestones();
        
        // è¨­ç½®äº‹ä»¶ç›£è½å™¨
        setupEventListeners();
        
        // è¼‰å…¥å„²å­˜çš„ä¸»é¡Œ
        loadTheme();
        
        // è¨­ç½®ç•¶å‰æ—¥æœŸ
        document.getElementById('currentDate').textContent = 
            new Date().toLocaleDateString('zh-TW', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            });
        
        // è¼‰å…¥ç¸½è¦½é é¢
        showPage('dashboard');
        
        // éš±è—è¼‰å…¥ç•«é¢ï¼Œé¡¯ç¤ºæ‡‰ç”¨
        setTimeout(() => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('app').style.display = 'block';
        }, 1000);
        
    } catch (error) {
        console.error('åˆå§‹åŒ–å¤±æ•—:', error);
        alert('æ‡‰ç”¨åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚');
    }
}

// è¨­ç½®äº‹ä»¶ç›£è½å™¨
function setupEventListeners() {
    // å°èˆªé»æ“Š
    document.querySelectorAll('.nav-item, .bottom-nav-item').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const page = item.dataset.page;
            if (page) {
                showPage(page);
            }
        });
    });
    
    // å­©å­é¸æ“‡å™¨
    document.getElementById('childSelector').addEventListener('change', (e) => {
        const childId = e.target.value;
        if (childId) {
            selectChild(childId);
        }
    });
    
    // ä¸»é¡Œåˆ‡æ›
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    
    // è¨­å®šæŒ‰éˆ•
    document.getElementById('settingsBtn').addEventListener('click', () => {
        showModal('settingsModal');
    });
    
    // è¡¨å–®æäº¤
    document.getElementById('childForm').addEventListener('submit', handleChildSubmit);
    document.getElementById('feedingForm').addEventListener('submit', handleFeedingSubmit);
    document.getElementById('sleepForm').addEventListener('submit', handleSleepSubmit);
    document.getElementById('diaperForm').addEventListener('submit', handleDiaperSubmit);
    document.getElementById('healthForm').addEventListener('submit', handleHealthSubmit);
    document.getElementById('milestoneForm').addEventListener('submit', handleMilestoneSubmit);
    document.getElementById('activityForm').addEventListener('submit', handleActivitySubmit);
    document.getElementById('interactionForm').addEventListener('submit', handleInteractionSubmit);
    
    // ç…§ç‰‡é è¦½
    document.getElementById('childPhoto').addEventListener('change', (e) => previewPhoto(e, 'childPhotoPreview'));
    document.getElementById('activityPhoto').addEventListener('change', (e) => previewPhoto(e, 'activityPhotoPreview'));
    document.getElementById('interactionPhoto').addEventListener('change', (e) => previewPhoto(e, 'interactionPhotoPreview'));
    
    // é¤µé£Ÿé¡å‹è®Šæ›´
    document.getElementById('feedingType').addEventListener('change', toggleFeedingFields);
    
    // å¥åº·é¡åˆ¥è®Šæ›´
    document.getElementById('healthCategory').addEventListener('change', toggleHealthFields);
    
    // æ´»å‹•é¡å‹è®Šæ›´
    document.getElementById('activityType').addEventListener('change', toggleActivityFields);
    
    // éæ¿¾æ¨™ç±¤
    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            e.target.classList.add('active');
            loadFeedingRecords();
        });
    });
    
    document.querySelectorAll('.health-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
            document.querySelectorAll('.health-tab').forEach(t => t.classList.remove('active'));
            e.target.classList.add('active');
            loadHealthRecords();
        });
    });
    
    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
            document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
            e.target.classList.add('active');
            loadMilestones();
        });
    });
    
    // çµ±è¨ˆæ—¥æœŸç¯„åœè®Šæ›´
    document.getElementById('statsDateRange').addEventListener('change', loadStatistics);
    
    // æ¨¡æ…‹æ¡†å¤–é»æ“Šé—œé–‰
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal(modal.id);
            }
        });
    });
    
    // å´é‚Šæ¬„åˆ‡æ›ï¼ˆç§»å‹•ç«¯ï¼‰
    window.addEventListener('resize', handleResize);
    handleResize();
}

// è™•ç†è¢å¹•å¤§å°è®ŠåŒ–
function handleResize() {
    const sidebar = document.getElementById('sidebar');
    if (window.innerWidth >= 768) {
        sidebar.classList.add('open');
    } else {
        sidebar.classList.remove('open');
    }
}

// åˆ‡æ›å´é‚Šæ¬„
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('open');
}

// è¼‰å…¥ä¸»é¡Œ
function loadTheme() {
    const theme = localStorage.getItem('babyTrackerTheme') || 'light';
    document.documentElement.setAttribute('data-theme', theme);
    updateThemeIcon(theme);
}

// åˆ‡æ›ä¸»é¡Œ
function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('babyTrackerTheme', newTheme);
    updateThemeIcon(newTheme);
}

// æ›´æ–°ä¸»é¡Œåœ–æ¨™
function updateThemeIcon(theme) {
    const icon = document.querySelector('#themeToggle i');
    icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
}

// é¡¯ç¤ºé é¢
function showPage(pageId) {
    // æ›´æ–°å°èˆªç‹€æ…‹
    document.querySelectorAll('.nav-item, .bottom-nav-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelectorAll(`[data-page="${pageId}"]`).forEach(item => {
        item.classList.add('active');
    });
    
    // é¡¯ç¤ºå°æ‡‰é é¢
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    document.getElementById(pageId).classList.add('active');
    
    currentPage = pageId;
    
    // é—œé–‰å´é‚Šæ¬„ï¼ˆç§»å‹•ç«¯ï¼‰
    if (window.innerWidth < 768) {
        document.getElementById('sidebar').classList.remove('open');
    }
    
    // è¼‰å…¥é é¢æ•¸æ“š
    loadPageData(pageId);
}

// è¼‰å…¥é é¢æ•¸æ“š
async function loadPageData(pageId) {
    if (!currentChild) return;
    
    switch (pageId) {
        case 'dashboard':
            await loadDashboard();
            break;
        case 'children':
            await loadChildren();
            break;
        case 'feeding':
            await loadFeedingRecords();
            break;
        case 'sleep':
            await loadSleepRecords();
            break;
        case 'diaper':
            await loadDiaperRecords();
            break;
        case 'health':
            await loadHealthRecords();
            break;
        case 'milestones':
            await loadMilestones();
            break;
        case 'activities':
            await loadActivityRecords();
            break;
        case 'interaction':
            await loadInteractionRecords();
            break;
        case 'statistics':
            await loadStatistics();
            break;
    }
}

// é¡¯ç¤ºæ¨¡æ…‹æ¡†
function showModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.add('show');
    modal.style.display = 'flex';
    
    // é‡ç½®è¡¨å–®
    const form = modal.querySelector('form');
    if (form) {
        form.reset();
        // æ¸…é™¤ç…§ç‰‡é è¦½
        modal.querySelectorAll('.photo-preview').forEach(preview => {
            preview.innerHTML = '';
        });
    }
}

// é—œé–‰æ¨¡æ…‹æ¡†
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('show');
    modal.style.display = 'none';
    editingRecordId = null;
}

// ç…§ç‰‡é è¦½
async function previewPhoto(event, previewId) {
    const file = event.target.files[0];
    const preview = document.getElementById(previewId);
    
    if (file) {
        try {
            const base64 = await convertToBase64(file);
            preview.innerHTML = `<img src="${base64}" alt="ç…§ç‰‡é è¦½">`;
        } catch (error) {
            console.error('åœ–ç‰‡è™•ç†å¤±æ•—:', error);
            alert('åœ–ç‰‡è™•ç†å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
        }
    } else {
        preview.innerHTML = '';
    }
}

// åˆ‡æ›é¤µé£Ÿæ¬„ä½
function toggleFeedingFields() {
    const type = document.getElementById('feedingType').value;
    const breastGroup = document.getElementById('breastGroup');
    const amountGroup = document.getElementById('amountGroup');
    
    if (type === 'breast') {
        breastGroup.style.display = 'block';
        amountGroup.style.display = 'none';
        // è¨­ç½®ç•¶å‰æ™‚é–“ç‚ºé–‹å§‹æ™‚é–“
        document.getElementById('feedingStartTime').value = new Date().toISOString().slice(0, 16);
    } else if (type === 'formula' || type === 'solid') {
        breastGroup.style.display = 'none';
        amountGroup.style.display = 'block';
        document.getElementById('feedingUnit').value = type === 'formula' ? 'ml' : 'g';
    } else {
        breastGroup.style.display = 'none';
        amountGroup.style.display = 'none';
    }
    
    // è¨­ç½®è¨˜éŒ„æ™‚é–“ç‚ºç•¶å‰æ™‚é–“
    if (!document.getElementById('feedingTime').value) {
        document.getElementById('feedingTime').value = new Date().toISOString().slice(0, 16);
    }
}

// åˆ‡æ›å¥åº·æ¬„ä½
function toggleHealthFields() {
    const category = document.getElementById('healthCategory').value;
    const temperatureGroup = document.getElementById('temperatureGroup');
    
    if (category === 'temperature') {
        temperatureGroup.style.display = 'block';
    } else {
        temperatureGroup.style.display = 'none';
    }
    
    // è¨­ç½®ç•¶å‰æ—¥æœŸ
    if (!document.getElementById('healthDate').value) {
        document.getElementById('healthDate').value = new Date().toISOString().split('T')[0];
    }
}

// åˆ‡æ›æ´»å‹•æ¬„ä½
function toggleActivityFields() {
    const type = document.getElementById('activityType').value;
    const customGroup = document.getElementById('customActivityGroup');
    
    if (type === 'custom') {
        customGroup.style.display = 'block';
    } else {
        customGroup.style.display = 'none';
    }
    
    // è¨­ç½®ç•¶å‰æ™‚é–“
    if (!document.getElementById('activityTime').value) {
        document.getElementById('activityTime').value = new Date().toISOString().slice(0, 16);
    }
}

// è¼‰å…¥å­©å­åˆ—è¡¨
async function loadChildren() {
    try {
        const children = await dbOperation('children', 'getAll');
        const childrenGrid = document.getElementById('childrenGrid');
        const childSelector = document.getElementById('childSelector');
        
        // æ¸…ç©ºç¾æœ‰å…§å®¹
        childrenGrid.innerHTML = '';
        childSelector.innerHTML = '<option value="">è«‹é¸æ“‡å¯¶å¯¶</option>';
        
        if (children.length === 0) {
            childrenGrid.innerHTML = '<p class="no-data">å°šæœªæ–°å¢å­©å­è³‡è¨Š</p>';
            return;
        }
        
        // ç”¢ç”Ÿå­©å­å¡ç‰‡å’Œé¸é …
        children.forEach(child => {
            // å­©å­å¡ç‰‡
            const age = calculateAge(child.birthDate);
            const photoSrc = child.photo || '/api/placeholder/120/120';
            
            const cardHtml = `
                <div class="child-card">
                    <img src="${photoSrc}" alt="${child.name}" class="child-photo">
                    <div class="child-info">
                        <h3>${child.name}</h3>
                        <div class="child-details">
                            <span class="child-age">${age}</span>
                            ${child.gender ? `<span> â€¢ ${child.gender === 'male' ? 'ç”·' : 'å¥³'}</span>` : ''}
                            <div style="margin-top: 8px;">
                                <small>å‡ºç”Ÿæ—¥æœŸ: ${formatDate(child.birthDate)}</small>
                            </div>
                            ${child.notes ? `<div style="margin-top: 8px;"><small>${child.notes}</small></div>` : ''}
                        </div>
                    </div>
                    <div class="child-actions">
                        <button class="btn-small btn-primary-small" onclick="selectChild('${child.id}')">
                            <i class="fas fa-check"></i> é¸æ“‡
                        </button>
                        <button class="btn-small btn-secondary-small" onclick="editChild('${child.id}')">
                            <i class="fas fa-edit"></i> ç·¨è¼¯
                        </button>
                        <button class="btn-small btn-secondary-small" onclick="deleteChild('${child.id}')">
                            <i class="fas fa-trash"></i> åˆªé™¤
                        </button>
                    </div>
                </div>
            `;
            childrenGrid.insertAdjacentHTML('beforeend', cardHtml);
            
            // é¸é …
            const option = document.createElement('option');
            option.value = child.id;
            option.textContent = child.name;
            childSelector.appendChild(option);
        });
        
        // å¦‚æœæœ‰å„²å­˜çš„ç•¶å‰å­©å­ï¼Œé¸æ“‡å®ƒ
        const savedChildId = localStorage.getItem('currentChildId');
        if (savedChildId && children.find(c => c.id === savedChildId)) {
            selectChild(savedChildId);
        }
        
    } catch (error) {
        console.error('è¼‰å…¥å­©å­åˆ—è¡¨å¤±æ•—:', error);
        document.getElementById('childrenGrid').innerHTML = '<p class="no-data">è¼‰å…¥å¤±æ•—</p>';
    }
}

// é¸æ“‡å­©å­
async function selectChild(childId) {
    try {
        const child = await dbOperation('children', 'get', childId);
        if (child) {
            currentChild = child;
            document.getElementById('childSelector').value = childId;
            localStorage.setItem('currentChildId', childId);
            
            // é‡æ–°è¼‰å…¥ç•¶å‰é é¢æ•¸æ“š
            await loadPageData(currentPage);
            
            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            showToast(`å·²é¸æ“‡ ${child.name}`);
        }
    } catch (error) {
        console.error('é¸æ“‡å­©å­å¤±æ•—:', error);
        alert('é¸æ“‡å­©å­å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
    }
}

// é¡¯ç¤ºå­©å­è¡¨å–®
function showChildForm(editId = null) {
    const modal = document.getElementById('childModal');
    const title = document.getElementById('childModalTitle');
    
    if (editId) {
        title.textContent = 'ç·¨è¼¯å­©å­è³‡è¨Š';
        editingRecordId = editId;
        loadChildForEdit(editId);
    } else {
        title.textContent = 'æ–°å¢å­©å­';
        editingRecordId = null;
    }
    
    showModal('childModal');
}

// è¼‰å…¥ç·¨è¼¯çš„å­©å­è³‡è¨Š
async function loadChildForEdit(childId) {
    try {
        const child = await dbOperation('children', 'get', childId);
        if (child) {
            document.getElementById('childName').value = child.name;
            document.getElementById('childBirthDate').value = child.birthDate;
            document.getElementById('childGender').value = child.gender || '';
            document.getElementById('childNotes').value = child.notes || '';
            
            if (child.photo) {
                document.getElementById('childPhotoPreview').innerHTML = 
                    `<img src="${child.photo}" alt="ç…§ç‰‡é è¦½">`;
            }
        }
    } catch (error) {
        console.error('è¼‰å…¥å­©å­è³‡è¨Šå¤±æ•—:', error);
        alert('è¼‰å…¥å­©å­è³‡è¨Šå¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
    }
}

// ç·¨è¼¯å­©å­
function editChild(childId) {
    showChildForm(childId);
}

// åˆªé™¤å­©å­
function deleteChild(childId) {
    document.getElementById('confirmMessage').textContent = 'ç¢ºå®šè¦åˆªé™¤é€™å€‹å­©å­çš„æ‰€æœ‰è³‡è¨Šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚';
    document.getElementById('confirmDeleteBtn').onclick = async () => {
        try {
            await dbOperation('children', 'delete', childId);
            
            // å¦‚æœåˆªé™¤çš„æ˜¯ç•¶å‰é¸ä¸­çš„å­©å­ï¼Œæ¸…é™¤é¸æ“‡
            if (currentChild && currentChild.id === childId) {
                currentChild = null;
                localStorage.removeItem('currentChildId');
                document.getElementById('childSelector').value = '';
            }
            
            await loadChildren();
            closeModal('confirmModal');
            showToast('å­©å­è³‡è¨Šå·²åˆªé™¤');
        } catch (error) {
            console.error('åˆªé™¤å­©å­å¤±æ•—:', error);
            alert('åˆªé™¤å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
        }
    };
    showModal('confirmModal');
}

// è™•ç†å­©å­è¡¨å–®æäº¤
async function handleChildSubmit(e) {
    e.preventDefault();
    
    try {
        const formData = {
            id: editingRecordId || generateId(),
            name: document.getElementById('childName').value,
            birthDate: document.getElementById('childBirthDate').value,
            gender: document.getElementById('childGender').value || null,
            notes: document.getElementById('childNotes').value || null,
            photo: null,
            createdAt: editingRecordId ? undefined : Date.now(),
            updatedAt: Date.now()
        };
        
        // è™•ç†ç…§ç‰‡
        const photoFile = document.getElementById('childPhoto').files[0];
        if (photoFile) {
            formData.photo = await convertToBase64(photoFile);
        } else if (editingRecordId) {
            // ç·¨è¼¯æ™‚ä¿ç•™åŸæœ‰ç…§ç‰‡
            const existingChild = await dbOperation('children', 'get', editingRecordId);
            formData.photo = existingChild.photo;
        }
        
        await dbOperation('children', 'put', formData);
        
        closeModal('childModal');
        await loadChildren();
        showToast(editingRecordId ? 'å­©å­è³‡è¨Šå·²æ›´æ–°' : 'å­©å­è³‡è¨Šå·²æ–°å¢');
        
    } catch (error) {
        console.error('å„²å­˜å­©å­è³‡è¨Šå¤±æ•—:', error);
        alert('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
    }
}

// è¼‰å…¥ç¸½è¦½æ•¸æ“š
async function loadDashboard() {
    if (!currentChild) {
        document.getElementById('todayFeedings').textContent = '0';
        document.getElementById('todaySleep').textContent = '0';
        document.getElementById('todayDiapers').textContent = '0';
        document.getElementById('recentActivities').innerHTML = '<p class="no-data">è«‹å…ˆé¸æ“‡å­©å­</p>';
        return;
    }
    
    try {
        const today = new Date();
        const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
        const endOfDay = startOfDay + 24 * 60 * 60 * 1000;
        
        // è¼‰å…¥ä»Šæ—¥é¤µé£Ÿæ¬¡æ•¸
        const feedings = await dbOperation('feeding', 'getByIndex', {
            indexName: 'childId',
            value: currentChild.id
        });
        const todayFeedings = feedings.filter(f => f.timestamp >= startOfDay && f.timestamp < endOfDay);
        document.getElementById('todayFeedings').textContent = todayFeedings.length;
        
        // è¼‰å…¥ä»Šæ—¥ç¡çœ æ™‚é–“
        const sleeps = await dbOperation('sleep', 'getByIndex', {
            indexName: 'childId',
            value: currentChild.id
        });
        const todaySleeps = sleeps.filter(s => s.startTime >= startOfDay && s.startTime < endOfDay);
        let totalSleepMinutes = 0;
        todaySleeps.forEach(sleep => {
            if (sleep.endTime) {
                totalSleepMinutes += (sleep.endTime - sleep.startTime) / (1000 * 60);
            }
        });
        const sleepHours = (totalSleepMinutes / 60).toFixed(1);
        document.getElementById('todaySleep').textContent = sleepHours;
        
        // è¼‰å…¥ä»Šæ—¥å°¿å¸ƒæ¬¡æ•¸
        const diapers = await dbOperation('diaper', 'getByIndex', {
            indexName: 'childId',
            value: currentChild.id
        });
        const todayDiapers = diapers.filter(d => d.timestamp >= startOfDay && d.timestamp < endOfDay);
        document.getElementById('todayDiapers').textContent = todayDiapers.length;
        
        // è¼‰å…¥æœ€è¿‘äº’å‹•
        const interactions = await dbOperation('interactions', 'getByIndex', {
            indexName: 'childId',
            value: currentChild.id
        });
        const recentInteractions = interactions
            .sort((a, b) => b.timestamp - a.timestamp)
            .slice(0, 3);
        
        const recentActivitiesEl = document.getElementById('recentActivities');
        if (recentInteractions.length === 0) {
            recentActivitiesEl.innerHTML = '<p class="no-data">æš«ç„¡äº’å‹•è¨˜éŒ„</p>';
        } else {
            recentActivitiesEl.innerHTML = recentInteractions.map(interaction => `
                <div style="padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                    <div style="font-weight: 600; color: var(--primary-color);">
                        ${interaction.mood === 'happy' ? 'ğŸ˜Š' : 
                          interaction.mood === 'calm' ? 'ğŸ˜Œ' : 
                          interaction.mood === 'fussy' ? 'ğŸ˜£' : 'ğŸ˜´'} 
                        ${interaction.event || 'äº’å‹•è¨˜éŒ„'}
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">
                        ${formatDateTime(interaction.timestamp)}
                    </div>
                    ${interaction.notes ? `<div style="font-size: 0.8rem; color: var(--text-light); margin-top: 4px;">${interaction.notes}</div>` : ''}
                </div>
            `).join('');
        }
        
    } catch (error) {
        console.error('è¼‰å…¥ç¸½è¦½æ•¸æ“šå¤±æ•—:', error);
    }
}

// å¿«é€Ÿè¨˜éŒ„åŠŸèƒ½
function quickAddFeeding() {
    if (!currentChild) {
        alert('è«‹å…ˆé¸æ“‡å­©å­');
        return;
    }
    showFeedingForm();
}

function quickAddSleep() {
    if (!currentChild) {
        alert('è«‹å…ˆé¸æ“‡å­©å­');
        return;
    }
    showSleepForm();
}

function quickAddDiaper() {
    if (!currentChild) {
        alert('è«‹å…ˆé¸æ“‡å­©å­');
        return;
    }
    showDiaperForm();
}

function quickAddInteraction() {
    if (!currentChild) {
        alert('è«‹å…ˆé¸æ“‡å­©å­');
        return;
    }
    showInteractionForm();
}

// é¡¯ç¤ºé¤µé£Ÿè¡¨å–®
function showFeedingForm(editId = null) {
    if (!currentChild) {
        alert('è«‹å…ˆé¸æ“‡å­©å­');
        return;
    }
    
    editingRecordId = editId;
    if (editId) {
        loadFeedingForEdit(editId);
    } else {
        // è¨­ç½®é»˜èªæ™‚é–“
        document.getElementById('feedingTime').value = new Date().toISOString().slice(0, 16);
    }
    showModal('feedingModal');
}

// è¼‰å…¥ç·¨è¼¯çš„é¤µé£Ÿè¨˜éŒ„
async function loadFeedingForEdit(feedingId) {
    try {
        const feeding = await dbOperation('feeding', 'get', feedingId);
        if (feeding) {
            document.getElementById('feedingType').value = feeding.type;
            toggleFeedingFields();
            
            if (feeding.type === 'breast') {
                document.getElementById('feedingStartTime').value = 
                    new Date(feeding.startTime).toISOString().slice(0, 16);
                if (feeding.endTime) {
                    document.getElementById('feedingEndTime').value = 
                        new Date(feeding.endTime).toISOString().slice(0, 16);
                }
                document.getElementById('feedingSide').value = feeding.side || '';
            } else {
                document.getElementById('feedingAmount').value = feeding.amount || '';
                document.getElementById('feedingUnit').value = feeding.unit || '';
            }
            
            document.getElementById('feedingTime').value = 
                new Date(feeding.timestamp).toISOString().slice(0, 16);
            document.getElementById('feedingNotes').value = feeding.notes || '';
        }
    } catch (error) {
        console.error('è¼‰å…¥é¤µé£Ÿè¨˜éŒ„å¤±æ•—:', error);
        alert('è¼‰å…¥è¨˜éŒ„å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
    }
}

// è™•ç†é¤µé£Ÿè¡¨å–®æäº¤
async function handleFeedingSubmit(e) {
    e.preventDefault();
    
    if (!currentChild) {
        alert('è«‹å…ˆé¸æ“‡å­©å­');
        return;
    }
    
    try {
        const type = document.getElementById('feedingType').value;
        const formData = {
            id: editingRecordId || generateId(),
            childId: currentChild.id,
            type: type,
            timestamp: new Date(document.getElementById('feedingTime').value).getTime(),
            notes: document.getElementById('feedingNotes').value || null,
            createdAt: editingRecordId ? undefined : Date.now(),
            updatedAt: Date.now()
        };
        
        if (type === 'breast') {
            formData.startTime = new Date(document.getElementById('feedingStartTime').value).getTime();
            const endTime = document.getElementById('feedingEndTime').value;
            formData.endTime = endTime ? new Date(endTime).getTime() : null;
            formData.side = document.getElementById('feedingSide').value || null;
        } else {
            formData.amount = parseFloat(document.getElementById('feedingAmount').value) || null;
            formData.unit = document.getElementById('feedingUnit').value;
        }
        
        await dbOperation('feeding', 'put', formData);
        
        closeModal('feedingModal');
        await loadFeedingRecords();
        showToast(editingRecordId ? 'é¤µé£Ÿè¨˜éŒ„å·²æ›´æ–°' : 'é¤µé£Ÿè¨˜éŒ„å·²æ–°å¢');
        
    } catch (error) {
        console.error('å„²å­˜é¤µé£Ÿè¨˜éŒ„å¤±æ•—:', error);
        alert('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
    }
}

// è¼‰å…¥é¤µé£Ÿè¨˜éŒ„
async function loadFeedingRecords() {
    if (!currentChild) {
        document.getElementById('feedingList').innerHTML = '<p class="no-data">è«‹å…ˆé¸æ“‡å­©å­</p>';
        return;
    }
    
    try {
        const records = await dbOperation('feeding', 'getByIndex', {
            indexName: 'childId',
            value: currentChild.id
        });
        
        const activeFilter = document.querySelector('.filter-tab.active').dataset.filter;
        const filteredRecords = activeFilter === 'all' ? 
            records : records.filter(r => r.type === activeFilter);
        
        const sortedRecords = filteredRecords.sort((a, b) => b.timestamp - a.timestamp);
        
        const feedingList = document.getElementById('feedingList');
        
        if (sortedRecords.length === 0) {
            feedingList.innerHTML = '<p class="no-data">æš«ç„¡é¤µé£Ÿè¨˜éŒ„</p>';
            return;
        }
        
        feedingList.innerHTML = sortedRecords.map(record => {
            let details = '';
            let icon = 'fas fa-baby-bottle';
            
            if (record.type === 'breast') {
                icon = 'fas fa-heart';
                const duration = record.endTime ? 
                    calculateDuration(record.startTime, record.endTime) : 'é€²è¡Œä¸­';
                details = `
                    <div class="record-detail">æŒçºŒæ™‚é–“: ${duration}</div>
                    ${record.side ? `<div class="record-detail">é¤µé£Ÿå´: ${record.side === 'left' ? 'å·¦å´' : record.side === 'right' ? 'å³å´' : 'é›™å´'}</div>` : ''}
                `;
            } else {
                const typeName = record.type === 'formula' ? 'é…æ–¹å¥¶' : 'å‰¯é£Ÿå“';
                details = `
                    <div class="record-detail">é¡å‹: ${typeName}</div>
                    ${record.amount ? `<div class="record-detail">ä»½é‡: ${record.amount}${record.unit}</div>` : ''}
                `;
            }
            
            return `
                <div class="record-item">
                    <div class="record-header">
                        <div class="record-type">
                            <i class="${icon}"></i>
                            ${record.type === 'breast' ? 'æ¯ä¹³é¤µé£Ÿ' : 
                              record.type === 'formula' ? 'é…æ–¹å¥¶' : 'å‰¯é£Ÿå“'}
                        </div>
                        <div class="record-time">${formatDateTime(record.timestamp)}</div>
                    </div>
                    <div class="record-details">
                        ${details}
                    </div>
                    ${record.notes ? `<div class="record-notes">${record.notes}</div>` : ''}
                    <div class="record-actions">
                        <button class="btn-icon" onclick="showFeedingForm('${record.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon delete" onclick="deleteFeedingRecord('${record.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('è¼‰å…¥é¤µé£Ÿè¨˜éŒ„å¤±æ•—:', error);
        document.getElementById('feedingList').innerHTML = '<p class="no-data">è¼‰å…¥å¤±æ•—</p>';
    }
}

// åˆªé™¤é¤µé£Ÿè¨˜éŒ„
function deleteFeedingRecord(recordId) {
    document.getElementById('confirmMessage').textContent = 'ç¢ºå®šè¦åˆªé™¤é€™ç­†é¤µé£Ÿè¨˜éŒ„å—ï¼Ÿ';
    document.getElementById('confirmDeleteBtn').onclick = async () => {
        try {
            await dbOperation('feeding', 'delete', recordId);
            await loadFeedingRecords();
            closeModal('confirmModal');
            showToast('é¤µé£Ÿè¨˜éŒ„å·²åˆªé™¤');
        } catch (error) {
            console.error('åˆªé™¤é¤µé£Ÿè¨˜éŒ„å¤±æ•—:', error);
            alert('åˆªé™¤å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
        }
    };
    showModal('confirmModal');
}

// ç¡çœ è¨˜éŒ„ç›¸é—œå‡½æ•¸
function showSleepForm(editId = null) {
    if (!currentChild) {
        alert('è«‹å…ˆé¸æ“‡å­©å­');
        return;
    }
    
    editingRecordId = editId;
    if (editId) {
        loadSleepForEdit(editId);
    } else {
        // è¨­ç½®é»˜èªé–‹å§‹æ™‚é–“
        document.getElementById('sleepStartTime').value = new Date().toISOString().slice(0, 16);
    }
    showModal('sleepModal');
}

async function loadSleepForEdit(sleepId) {
    try {
        const sleep = await dbOperation('sleep', 'get', sleepId);
        if (sleep) {
            document.getElementById('sleepStartTime').value = 
                new Date(sleep.startTime).toISOString().slice(0, 16);
            if (sleep.endTime) {
                document.getElementById('sleepEndTime').value = 
                    new Date(sleep.endTime).toISOString().slice(0, 16);
            }
            document.getElementById('sleepQuality').value = sleep.quality || '';
            document.getElementById('sleepNotes').value = sleep.notes || '';
        }
    } catch (error) {
        console.error('è¼‰å…¥ç¡çœ è¨˜éŒ„å¤±æ•—:', error);
        alert('è¼‰å…¥è¨˜éŒ„å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
    }
}

async function handleSleepSubmit(e) {
    e.preventDefault();
    
    if (!currentChild) {
        alert('è«‹å…ˆé¸æ“‡å­©å­');
        return;
    }
    
    try {
        const startTime = new Date(document.getElementById('sleepStartTime').value).getTime();
        const endTimeValue = document.getElementById('sleepEndTime').value;
        const endTime = endTimeValue ? new Date(endTimeValue).getTime() : null;
        
        const formData = {
            id: editingRecordId || generateId(),
            childId: currentChild.id,
            startTime: startTime,
            endTime: endTime,
            quality: document.getElementById('sleepQuality').value || null,
            notes: document.getElementById('sleepNotes').value || null,
            createdAt: editingRecordId ? undefined : Date.now(),
            updatedAt: Date.now()
        };
        
        await dbOperation('sleep', 'put', formData);
        
        closeModal('sleepModal');
        await loadSleepRecords();
        showToast(editingRecordId ? 'ç¡çœ è¨˜éŒ„å·²æ›´æ–°' : 'ç¡çœ è¨˜éŒ„å·²æ–°å¢');
        
    } catch (error) {
        console.error('å„²å­˜ç¡çœ è¨˜éŒ„å¤±æ•—:', error);
        alert('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
    }
}

async function loadSleepRecords() {
    if (!currentChild) {
        document.getElementById('sleepList').innerHTML = '<p class="no-data">è«‹å…ˆé¸æ“‡å­©å­</p>';
        return;
    }
    
    try {
        const records = await dbOperation('sleep', 'getByIndex', {
            indexName: 'childId',
            value: currentChild.id
        });
        
        const sortedRecords = records.sort((a, b) => b.startTime - a.startTime);
        
        const sleepList = document.getElementById('sleepList');
        
        if (sortedRecords.length === 0) {
            sleepList.innerHTML = '<p class="no-data">æš«ç„¡ç¡çœ è¨˜éŒ„</p>';
            return;
        }
        
        sleepList.innerHTML = sortedRecords.map(record => {
            const duration = record.endTime ? 
                calculateDuration(record.startTime, record.endTime) : 'é€²è¡Œä¸­';
            const qualityText = record.quality ? 
                { excellent: 'éå¸¸å¥½', good: 'è‰¯å¥½', fair: 'æ™®é€š', poor: 'ä¸ä½³' }[record.quality] : '';
            
            return `
                <div class="record-item">
                    <div class="record-header">
                        <div class="record-type">
                            <i class="fas fa-bed"></i>
                            ç¡çœ è¨˜éŒ„
                        </div>
                        <div class="record-time">${formatDateTime(record.startTime)}</div>
                    </div>
                    <div class="record-details">
                        <div class="record-detail">é–‹å§‹: ${formatDateTime(record.startTime)}</div>
                        ${record.endTime ? `<div class="record-detail">çµæŸ: ${formatDateTime(record.endTime)}</div>` : ''}
                        <div class="record-detail">æŒçºŒæ™‚é–“: ${duration}</div>
                        ${qualityText ? `<div class="record-detail">ç¡çœ å“è³ª: ${qualityText}</div>` : ''}
                    </div>
                    ${record.notes ? `<div class="record-notes">${record.notes}</div>` : ''}
                    <div class="record-actions">
                        <button class="btn-icon" onclick="showSleepForm('${record.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon delete" onclick="deleteSleepRecord('${record.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('è¼‰å…¥ç¡çœ è¨˜éŒ„å¤±æ•—:', error);
        document.getElementById('sleepList').innerHTML = '<p class="no-data">è¼‰å…¥å¤±æ•—</p>';
    }
}

function deleteSleepRecord(recordId) {
    document.getElementById('confirmMessage').textContent = 'ç¢ºå®šè¦åˆªé™¤é€™ç­†ç¡çœ è¨˜éŒ„å—ï¼Ÿ';
    document.getElementById('confirmDeleteBtn').onclick = async () => {
        try {
            await dbOperation('sleep', 'delete', recordId);
            await loadSleepRecords();
            closeModal('confirmModal');
            showToast('ç¡çœ è¨˜éŒ„å·²åˆªé™¤');
        } catch (error) {
            console.error('åˆªé™¤ç¡çœ è¨˜éŒ„å¤±æ•—:', error);
            alert('åˆªé™¤å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
        }
    };
    showModal('confirmModal');
}

// å°¿å¸ƒè¨˜éŒ„ç›¸é—œå‡½æ•¸
function showDiaperForm(editId = null) {
    if (!currentChild) {
        alert('è«‹å…ˆé¸æ“‡å­©å­');
        return;
    }
    
    editingRecordId = editId;
    if (editId) {
        loadDiaperForEdit(editId);
    } else {
        // è¨­ç½®é»˜èªæ™‚é–“
        document.getElementById('diaperTime').value = new Date().toISOString().slice(0, 16);
    }
    showModal('diaperModal');
}

async function loadDiaperForEdit(diaperId) {
    try {
        const diaper = await dbOperation('diaper', 'get', diaperId);
        if (diaper) {
            document.getElementById('diaperType').value = diaper.type;
            document.getElementById('diaperTime').value = 
                new Date(diaper.timestamp).toISOString().slice(0, 16);
            document.getElementById('diaperNotes').value = diaper.notes || '';
        }
    } catch (error) {
        console.error('è¼‰å…¥å°¿å¸ƒè¨˜éŒ„å¤±æ•—:', error);
        alert('è¼‰å…¥è¨˜éŒ„å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
    }
}

async function handleDiaperSubmit(e) {
    e.preventDefault();
    
    if (!currentChild) {
        alert('è«‹å…ˆé¸æ“‡å­©å­');
        return;
    }
    
    try {
        const formData = {
            id: editingRecordId || generateId(),
            childId: currentChild.id,
            type: document.getElementById('diaperType').value,
            timestamp: new Date(document.getElementById('diaperTime').value).getTime(),
            notes: document.getElementById('diaperNotes').value || null,
            createdAt: editingRecordId ? undefined : Date.now(),
            updatedAt: Date.now()
        };
        
        await dbOperation('diaper', 'put', formData);
        
        closeModal('diaperModal');
        await loadDiaperRecords();
        showToast(editingRecordId ? 'å°¿å¸ƒè¨˜éŒ„å·²æ›´æ–°' : 'å°¿å¸ƒè¨˜éŒ„å·²æ–°å¢');
        
    } catch (error) {
        console.error('å„²å­˜å°¿å¸ƒè¨˜éŒ„å¤±æ•—:', error);
        alert('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
    }
}

async function loadDiaperRecords() {
    if (!currentChild) {
        document.getElementById('diaperList').innerHTML = '<p class="no-data">è«‹å…ˆé¸æ“‡å­©å­</p>';
        return;
    }
    
    try {
        const records = await dbOperation('diaper', 'getByIndex', {
            indexName: 'childId',
            value: currentChild.id
        });
        
        const sortedRecords = records.sort((a, b) => b.timestamp - a.timestamp);
        
        const diaperList = document.getElementById('diaperList');
        
        if (sortedRecords.length === 0) {
            diaperList.innerHTML = '<p class="no-data">æš«ç„¡å°¿å¸ƒè¨˜éŒ„</p>';
            return;
        }
        
        diaperList.innerHTML = sortedRecords.map(record => {
            const typeNames = {
                wet: 'å°¿æ¿•',
                soiled: 'æ’ä¾¿',
                both: 'å°¿æ¿•+æ’ä¾¿'
            };
            const icons = {
                wet: 'fas fa-tint',
                soiled: 'fas fa-poop',
                both: 'fas fa-baby-carriage'
            };
            
            return `
                <div class="record-item">
                    <div class="record-header">
                        <div class="record-type">
                            <i class="${icons[record.type] || 'fas fa-baby-carriage'}"></i>
                            å°¿å¸ƒæ›´æ› - ${typeNames[record.type] || record.type}
                        </div>
                        <div class="record-time">${formatDateTime(record.timestamp)}</div>
                    </div>
                    ${record.notes ? `<div class="record-notes">${record.notes}</div>` : ''}
                    <div class="record-actions">
                        <button class="btn-icon" onclick="showDiaperForm('${record.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon delete" onclick="deleteDiaperRecord('${record.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('è¼‰å…¥å°¿å¸ƒè¨˜éŒ„å¤±æ•—:', error);
        document.getElementById('diaperList').innerHTML = '<p class="no-data">è¼‰å…¥å¤±æ•—</p>';
    }
}

function deleteDiaperRecord(recordId) {
    document.getElementById('confirmMessage').textContent = 'ç¢ºå®šè¦åˆªé™¤é€™ç­†å°¿å¸ƒè¨˜éŒ„å—ï¼Ÿ';
    document.getElementById('confirmDeleteBtn').onclick = async () => {
        try {
            await dbOperation('diaper', 'delete', recordId);
            await loadDiaperRecords();
            closeModal('confirmModal');
            showToast('å°¿å¸ƒè¨˜éŒ„å·²åˆªé™¤');
        } catch (error) {
            console.error('åˆªé™¤å°¿å¸ƒè¨˜éŒ„å¤±æ•—:', error);
            alert('åˆªé™¤å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
        }
    };
    showModal('confirmModal');
}

// å¥åº·è¨˜éŒ„ç›¸é—œå‡½æ•¸
function showHealthForm(editId = null) {
    if (!currentChild) {
        alert('è«‹å…ˆé¸æ“‡å­©å­');
        return;
    }
    
    editingRecordId = editId;
    if (editId) {
        loadHealthForEdit(editId);
    } else {
        // è¨­ç½®é»˜èªæ—¥æœŸ
        document.getElementById('healthDate').value = new Date().toISOString().split('T')[0];
    }
    showModal('healthModal');
}

async function loadHealthForEdit(healthId) {
    try {
        const health = await dbOperation('health', 'get', healthId);
        if (health) {
            document.getElementById('healthCategory').value = health.category;
            toggleHealthFields();
            document.getElementById('healthDate').value = health.date;
            document.getElementById('healthTitle').value = health.title;
            document.getElementById('healthDescription').value = health.description || '';
            document.getElementById('healthNotes').value = health.notes || '';
            
            if (health.category === 'temperature') {
                document.getElementById('temperature').value = health.temperature || '';
                document.getElementById('temperatureMethod').value = health.temperatureMethod || 'oral';
            }
        }
    } catch (error) {
        console.error('è¼‰å…¥å¥åº·è¨˜éŒ„å¤±æ•—:', error);
        alert('è¼‰å…¥è¨˜éŒ„å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
    }
}

async function handleHealthSubmit(e) {
    e.preventDefault();
    
    if (!currentChild) {
        alert('è«‹å…ˆé¸æ“‡å­©å­');
        return;
    }
    
    try {
        const category = document.getElementById('healthCategory').value;
        const formData = {
            id: editingRecordId || generateId(),
            childId: currentChild.id,
            category: category,
            date: document.getElementById('healthDate').value,
            title: document.getElementById('healthTitle').value,
            description: document.getElementById('healthDescription').value || null,
            notes: document.getElementById('healthNotes').value || null,
            createdAt: editingRecordId ? undefined : Date.now(),
            updatedAt: Date.now()
        };
        
        if (category === 'temperature') {
            formData.temperature = parseFloat(document.getElementById('temperature').value) || null;
            formData.temperatureMethod = document.getElementById('temperatureMethod').value;
        }
        
        await dbOperation('health', 'put', formData);
        
        closeModal('healthModal');
        await loadHealthRecords();
        showToast(editingRecordId ? 'å¥åº·è¨˜éŒ„å·²æ›´æ–°' : 'å¥åº·è¨˜éŒ„å·²æ–°å¢');
        
    } catch (error) {
        console.error('å„²å­˜å¥åº·è¨˜éŒ„å¤±æ•—:', error);
        alert('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
    }
}

async function loadHealthRecords() {
    if (!currentChild) {
        document.getElementById('healthList').innerHTML = '<p class="no-data">è«‹å…ˆé¸æ“‡å­©å­</p>';
        return;
    }
    
    try {
        const records = await dbOperation('health', 'getByIndex', {
            indexName: 'childId',
            value: currentChild.id
        });
        
        const activeCategory = document.querySelector('.health-tab.active').dataset.category;
        const filteredRecords = records.filter(r => r.category === activeCategory);
        const sortedRecords = filteredRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        const healthList = document.getElementById('healthList');
        
        if (sortedRecords.length === 0) {
            healthList.innerHTML = '<p class="no-data">æš«ç„¡æ­¤é¡åˆ¥çš„è¨˜éŒ„</p>';
            return;
        }
        
        const categoryNames = {
            vaccine: 'ç–«è‹—æ¥ç¨®',
            medicine: 'ç”¨è—¥è¨˜éŒ„',
            checkup: 'é«”æª¢è¨˜éŒ„',
            illness: 'ç–¾ç—…è¨˜éŒ„',
            temperature: 'é«”æº«è¨˜éŒ„'
        };
        
        const categoryIcons = {
            vaccine: 'fas fa-syringe',
            medicine: 'fas fa-pills',
            checkup: 'fas fa-stethoscope',
            illness: 'fas fa-thermometer-half',
            temperature: 'fas fa-temperature-high'
        };
        
        healthList.innerHTML = sortedRecords.map(record => {
            let details = `<div class="record-detail">æ—¥æœŸ: ${formatDate(record.date)}</div>`;
            
            if (record.category === 'temperature') {
                details += record.temperature ? `<div class="record-detail">é«”æº«: ${record.temperature}Â°C</div>` : '';
                details += record.temperatureMethod ? `<div class="record-detail">æ¸¬é‡æ–¹å¼: ${
                    {oral: 'å£æº«', rectal: 'è‚›æº«', axillary: 'è…‹æº«', ear: 'è€³æº«', forehead: 'é¡æº«'}[record.temperatureMethod]
                }</div>` : '';
            }
            
            return `
                <div class="record-item">
                    <div class="record-header">
                        <div class="record-type">
                            <i class="${categoryIcons[record.category]}"></i>
                            ${categoryNames[record.category]} - ${record.title}
                        </div>
                        <div class="record-time">${formatDate(record.date)}</div>
                    </div>
                    <div class="record-details">
                        ${details}
                    </div>
                    ${record.description ? `<div class="record-content">${record.description}</div>` : ''}
                    ${record.notes ? `<div class="record-notes">${record.notes}</div>` : ''}
                    <div class="record-actions">
                        <button class="btn-icon" onclick="showHealthForm('${record.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon delete" onclick="deleteHealthRecord('${record.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('è¼‰å…¥å¥åº·è¨˜éŒ„å¤±æ•—:', error);
        document.getElementById('healthList').innerHTML = '<p class="no-data">è¼‰å…¥å¤±æ•—</p>';
    }
}

function deleteHealthRecord(recordId) {
    document.getElementById('confirmMessage').textContent = 'ç¢ºå®šè¦åˆªé™¤é€™ç­†å¥åº·è¨˜éŒ„å—ï¼Ÿ';
    document.getElementById('confirmDeleteBtn').onclick = async () => {
        try {
            await dbOperation('health', 'delete', recordId);
            await loadHealthRecords();
            closeModal('confirmModal');
            showToast('å¥åº·è¨˜éŒ„å·²åˆªé™¤');
        } catch (error) {
            console.error('åˆªé™¤å¥åº·è¨˜éŒ„å¤±æ•—:', error);
            alert('åˆªé™¤å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
        }
    };
    showModal('confirmModal');
}

// é‡Œç¨‹ç¢‘ç›¸é—œå‡½æ•¸
async function initDefaultMilestones() {
    try {
        const children = await dbOperation('children', 'getAll');
        
        for (const child of children) {
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“åˆå§‹åŒ–éé è¨­é‡Œç¨‹ç¢‘
            const existingMilestones = await dbOperation('milestones', 'getByIndex', {
                indexName: 'childId',
                value: child.id
            });
            
            if (existingMilestones.length === 0) {
                // ç‚ºæ¯å€‹é¡åˆ¥æ·»åŠ é è¨­é‡Œç¨‹ç¢‘
                for (const [category, milestones] of Object.entries(defaultMilestones)) {
                    for (const milestone of milestones) {
                        const milestoneData = {
                            id: generateId(),
                            childId: child.id,
                            category: category,
                            title: milestone.title,
                            description: milestone.description,
                            ageMonths: milestone.ageMonths,
                            isDefault: true,
                            achieved: false,
                            achievedDate: null,
                            notes: null,
                            createdAt: Date.now()
                        };
                        await dbOperation('milestones', 'add', milestoneData);
                    }
                }
            }
        }
    } catch (error) {
        console.error('åˆå§‹åŒ–é è¨­é‡Œç¨‹ç¢‘å¤±æ•—:', error);
    }
}

function showMilestoneForm(editId = null) {
    if (!currentChild) {
        alert('è«‹å…ˆé¸æ“‡å­©å­');
        return;
    }
    
    const modal = document.getElementById('milestoneModal');
    const title = document.getElementById('milestoneModalTitle');
    
    if (editId) {
        title.textContent = 'ç·¨è¼¯é‡Œç¨‹ç¢‘';
        editingRecordId = editId;
        loadMilestoneForEdit(editId);
    } else {
        title.textContent = 'æ–°å¢è‡ªå®šç¾©é‡Œç¨‹ç¢‘';
        editingRecordId = null;
        document.getElementById('milestoneCategory').value = 'custom';
    }
    
    showModal('milestoneModal');
}

async function loadMilestoneForEdit(milestoneId) {
    try {
        const milestone = await dbOperation('milestones', 'get', milestoneId);
        if (milestone) {
            document.getElementById('milestoneCategory').value = milestone.category;
            document.getElementById('milestoneTitle').value = milestone.title;
            document.getElementById('milestoneDate').value = milestone.achievedDate ? 
                new Date(milestone.achievedDate).toISOString().split('T')[0] : '';
            document.getElementById('milestoneNotes').value = milestone.notes || '';
        }
    } catch (error) {
        console.error('è¼‰å…¥é‡Œç¨‹ç¢‘å¤±æ•—:', error);
        alert('è¼‰å…¥è¨˜éŒ„å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
    }
}

async function handleMilestoneSubmit(e) {
    e.preventDefault();
    
    if (!currentChild) {
        alert('è«‹å…ˆé¸æ“‡å­©å­');
        return;
    }
    
    try {
        const achievedDateValue = document.getElementById('milestoneDate').value;
        const formData = {
            id: editingRecordId || generateId(),
            childId: currentChild.id,
            category: document.getElementById('milestoneCategory').value,
            title: document.getElementById('milestoneTitle').value,
            achieved: !!achievedDateValue,
            achievedDate: achievedDateValue ? new Date(achievedDateValue).getTime() : null,
            notes: document.getElementById('milestoneNotes').value || null,
            isDefault: false,
            createdAt: editingRecordId ? undefined : Date.now(),
            updatedAt: Date.now()
        };
        
        if (editingRecordId) {
            // ä¿ç•™åŸæœ‰çš„å…¶ä»–å±¬æ€§
            const existing = await dbOperation('milestones', 'get', editingRecordId);
            formData.isDefault = existing.isDefault;
            formData.ageMonths = existing.ageMonths;
            formData.description = existing.description;
        }
        
        await dbOperation('milestones', 'put', formData);
        
        closeModal('milestoneModal');
        await loadMilestones();
        showToast(editingRecordId ? 'é‡Œç¨‹ç¢‘å·²æ›´æ–°' : 'é‡Œç¨‹ç¢‘å·²æ–°å¢');
        
    } catch (error) {
        console.error('å„²å­˜é‡Œç¨‹ç¢‘å¤±æ•—:', error);
        alert('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
    }
}

async function loadMilestones() {
    if (!currentChild) {
        document.getElementById('milestoneList').innerHTML = '<p class="no-data">è«‹å…ˆé¸æ“‡å­©å­</p>';
        return;
    }
    
    try {
        const records = await dbOperation('milestones', 'getByIndex', {
            indexName: 'childId',
            value: currentChild.id
        });
        
        const activeCategory = document.querySelector('.category-tab.active').dataset.category;
        const filteredRecords = records.filter(r => r.category === activeCategory);
        
        // æŒ‰å¹´é½¡æœˆæ•¸æ’åºï¼Œè‡ªå®šç¾©é‡Œç¨‹ç¢‘æŒ‰å‰µå»ºæ™‚é–“æ’åº
        const sortedRecords = filteredRecords.sort((a, b) => {
            if (a.isDefault && b.isDefault) {
                return (a.ageMonths || 0) - (b.ageMonths || 0);
            } else if (a.isDefault) {
                return -1;
            } else if (b.isDefault) {
                return 1;
            } else {
                return b.createdAt - a.createdAt;
            }
        });
        
        const milestoneList = document.getElementById('milestoneList');
        
        if (sortedRecords.length === 0) {
            milestoneList.innerHTML = '<p class="no-data">æš«ç„¡æ­¤é¡åˆ¥çš„é‡Œç¨‹ç¢‘</p>';
            return;
        }
        
        const categoryNames = {
            motor: 'é‹å‹•ç™¼å±•',
            language: 'èªè¨€ç™¼å±•',
            social: 'ç¤¾äº¤ç™¼å±•',
            cognitive: 'èªçŸ¥ç™¼å±•',
            selfcare: 'è‡ªç†èƒ½åŠ›',
            custom: 'è‡ªå®šç¾©'
        };
        
        milestoneList.innerHTML = sortedRecords.map(record => {
            const ageText = record.ageMonths !== undefined ? `${record.ageMonths}å€‹æœˆ` : '';
            
            return `
                <div class="milestone-item ${record.achieved ? 'achieved' : ''}">
                    <div class="milestone-header">
                        <div class="milestone-title">${record.title}</div>
                        ${record.achieved && record.achievedDate ? 
                            `<div class="milestone-date">é”æˆæ–¼ ${formatDate(record.achievedDate)}</div>` : 
                            ageText ? `<div class="milestone-date">${ageText}</div>` : ''}
                    </div>
                    <div class="milestone-category">${categoryNames[record.category]}</div>
                    ${record.description ? `<div class="record-content">${record.description}</div>` : ''}
                    ${record.notes ? `<div class="record-notes">${record.notes}</div>` : ''}
                    <div class="milestone-actions">
                        ${!record.achieved ? `
                            <button class="btn-achieve" onclick="achieveMilestone('${record.id}')">
                                <i class="fas fa-check"></i> æ¨™è¨˜é”æˆ
                            </button>
                        ` : ''}
                        ${!record.isDefault ? `
                            <button class="btn-icon" onclick="showMilestoneForm('${record.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon delete" onclick="deleteMilestone('${record.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : `
                            <button class="btn-icon" onclick="showMilestoneForm('${record.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                        `}
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('è¼‰å…¥é‡Œç¨‹ç¢‘å¤±æ•—:', error);
        document.getElementById('milestoneList').innerHTML = '<p class="no-data">è¼‰å…¥å¤±æ•—</p>';
    }
}

async function achieveMilestone(milestoneId) {
    try {
        const milestone = await dbOperation('milestones', 'get', milestoneId);
        milestone.achieved = true;
        milestone.achievedDate = Date.now();
        milestone.updatedAt = Date.now();
        
        await dbOperation('milestones', 'put', milestone);
        await loadMilestones();
        showToast('é‡Œç¨‹ç¢‘å·²æ¨™è¨˜ç‚ºé”æˆï¼');
    } catch (error) {
        console.error('æ¨™è¨˜é‡Œç¨‹ç¢‘å¤±æ•—:', error);
        alert('æ“ä½œå¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
    }
}

function deleteMilestone(milestoneId) {
    document.getElementById('confirmMessage').textContent = 'ç¢ºå®šè¦åˆªé™¤é€™å€‹é‡Œç¨‹ç¢‘å—ï¼Ÿ';
    document.getElementById('confirmDeleteBtn').onclick = async () => {
        try {
            await dbOperation('milestones', 'delete', milestoneId);
            await loadMilestones();
            closeModal('confirmModal');
            showToast('é‡Œç¨‹ç¢‘å·²åˆªé™¤');
        } catch (error) {
            console.error('åˆªé™¤é‡Œç¨‹ç¢‘å¤±æ•—:', error);
            alert('åˆªé™¤å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
        }
    };
    showModal('confirmModal');
}

// æ´»å‹•è¨˜éŒ„ç›¸é—œå‡½æ•¸
function quickActivity(type) {
    if (!currentChild) {
        alert('è«‹å…ˆé¸æ“‡å­©å­');
        return;
    }
    
    // é å¡«è¡¨å–®ä¸¦é¡¯ç¤º
    showActivityForm();
    document.getElementById('activityType').value = type;
    toggleActivityFields();
}

function showActivityForm(editId = null) {
    if (!currentChild) {
        alert('è«‹å…ˆé¸æ“‡å­©å­');
        return;
    }
    
    editingRecordId = editId;
    if (editId) {
        loadActivityForEdit(editId);
    } else {
        // è¨­ç½®é»˜èªæ™‚é–“
        document.getElementById('activityTime').value = new Date().toISOString().slice(0, 16);
    }
    showModal('activityModal');
}

async function loadActivityForEdit(activityId) {
    try {
        const activity = await dbOperation('activities', 'get', activityId);
        if (activity) {
            document.getElementById('activityType').value = activity.type;
            toggleActivityFields();
            document.getElementById('activityTime').value = 
                new Date(activity.timestamp).toISOString().slice(0, 16);
            document.getElementById('activityDuration').value = activity.duration || '';
            document.getElementById('activityNotes').value = activity.notes ||